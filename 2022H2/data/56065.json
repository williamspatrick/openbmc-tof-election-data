{
    "project": "openbmc/openbmc",
    "branch": "master",
    "id": "I8a7921dffa6b756a4ab19a0e807e558ccd35f996",
    "number": 56065,
    "subject": "meta-ibm: monitor /tmp and /var in health monitor",
    "owner": {
        "name": "Corey Hardesty",
        "email": "corey.hardesty@icloud.com",
        "username": "NodeMan97"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openbmc/+/56065",
    "hashtags": [],
    "createdOn": 1659395975,
    "lastUpdated": 1661976209,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1659395975,
            "reviewer": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1659396029,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1659396029,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1659396036,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/12143/"
        },
        {
            "timestamp": 1659396187,
            "reviewer": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "message": "Patch Set 2: Published edit on patch set 1."
        },
        {
            "timestamp": 1659396249,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1659396254,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1659396254,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/12144/"
        },
        {
            "timestamp": 1659396279,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/12143/ : ABORTED"
        },
        {
            "timestamp": 1659397547,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/12144/ : SUCCESS"
        },
        {
            "timestamp": 1659398770,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1659398910,
            "reviewer": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "message": "Patch Set 3: Commit message was updated."
        },
        {
            "timestamp": 1659398923,
            "reviewer": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1660939558,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1660939639,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1660939639,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1660939645,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/12515/"
        },
        {
            "timestamp": 1660940811,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/12515/ : SUCCESS"
        },
        {
            "timestamp": 1660942073,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 4:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1661197306,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\nThis change is ready for review."
        },
        {
            "timestamp": 1661365973,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1661366057,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661454631,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661456362,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661785837,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661795065,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 4: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1661807702,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661808357,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661809217,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661810089,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661813600,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661861343,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661875953,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661949710,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1661976179,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4: Code-Review+2"
        },
        {
            "timestamp": 1661976209,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Change has been successfully rebased and submitted as ac37d615e7d3e9ea973f5e3d60e677678d5c28ac"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "b262ef2d500131b3bf19298818be7ee1aa203f88",
            "parents": [
                "043052ed0e31b596a078e4062fbbe9e5cae2f56c"
            ],
            "ref": "refs/changes/65/56065/1",
            "uploader": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "createdOn": 1659395975,
            "author": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/health/files/bmc_health_config.json",
                    "type": "ADDED",
                    "insertions": 89,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/health/phosphor-health-monitor_%.bbappend",
                    "type": "ADDED",
                    "insertions": 8,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 107,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "08a64cd4580efb4eb9f58522c75970cfff05d6ae",
            "parents": [
                "043052ed0e31b596a078e4062fbbe9e5cae2f56c"
            ],
            "ref": "refs/changes/65/56065/2",
            "uploader": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "createdOn": 1659396187,
            "author": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/health/files/bmc_health_config.json",
                    "type": "ADDED",
                    "insertions": 61,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/health/phosphor-health-monitor_%.bbappend",
                    "type": "ADDED",
                    "insertions": 8,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 79,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "a6fbf9a0c0d2ff60e143357d75a69827aed8dbd4",
            "parents": [
                "043052ed0e31b596a078e4062fbbe9e5cae2f56c"
            ],
            "ref": "refs/changes/65/56065/3",
            "uploader": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "createdOn": 1659398910,
            "author": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/health/files/bmc_health_config.json",
                    "type": "ADDED",
                    "insertions": 61,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/health/phosphor-health-monitor_%.bbappend",
                    "type": "ADDED",
                    "insertions": 8,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 89,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "3d9f27d0866a9b86d7bfef7ac41b3b23b2dda653",
            "parents": [
                "cb26287486d7d34acbe272804381a9bc3351c8a6"
            ],
            "ref": "refs/changes/65/56065/4",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1660939558,
            "author": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "I didn't see a default bmc_health_config.json file in meta-phosphor, although the CPU warning message is sometimes seen in the p10bmc system. Would we be overwriting the default with this new json file?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, the default file is actually in the health-monitor repo. This will overwrite that default file on IBM systems. Default is at https://grok.openbmc.org/xref/openbmc/phosphor-health-monitor/bmc_health_config.json?r=37f8b513. IBM version is a copy/paste but we replace the initramfs path with /tmp and /var."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "It would be nice if we could inject the extra pieces during the do_install step instead of overwriting the file entirely... we have a few other places where we merge YAML or JSON in bitbake recipes, right?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, agreed, that would be nice to have, although I also want to remove a part of the base file which may be a bit more complex. If we end up doing more with the health monitor in the future then we'll look into making this a bit more flexible. For now, we're just looking for the journal entry as a clue to other potential fails."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "Just my 2 cents but maintaining scripts that emit fragments of config files feels excessive.  Also, this way, you are not automatically opted-in to functions that you didn't know about, did not want, or did not audit.  If you want to be opted in to new features automatically, you would/should use the defaults.\n\nI don't really understand why we can't have defaults that work for everyone in this particular application.  Does someone have a (good) reason for not wanting /tmp and /var monitoring?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Seems Patrick is one of the maintainers of the health repo \ud83d\ude0a. Should these changes go to the default in the health repo or we can merge this change and continue the discussion off to the side about handling/merging/updating the default settings of the health monitoring going forward."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": ">  we can merge this change and continue the discussion off to the side\n\nI voted with a +1 to indicate exactly this^"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "> Should these changes go to the default in the health repo...\n\nWe can do a follow up over there if there are features you want to contribute.  I suspect the miss on /tmp and /var were either an oversight or due to differences in NOR vs eMMC behaviors.\n\n/tmp is ideally covered by the memory usage health already.  Generally, I think systemd mounts /tmp in a way that you can't run out of space unless you also run out of memory, right?  So I don't know why you're monitoring that specifically.\n\n/var is something unique to the eMMC implementation, if I understand correctly.  There isn't any reason we couldn't add a PACKAGECONFIG for eMMC vs NOR though."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "> /tmp is ideally covered by the memory usage health already.  Generally, I think systemd mounts /tmp in a way that you can't run out of space unless you also run out of memory, right?  So I don't know why you're monitoring that specifically.\n\n+1\n\n> /var is something unique to the eMMC implementation, if I understand correctly.  There isn't any reason we couldn't add a PACKAGECONFIG for eMMC vs NOR though.\n\nAnd the (default) config would include reasonable defaults for var monitoring, if the support is included in the binary (although I can't say I understand why the flash size or technology makes any difference here)."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "> although I can't say I understand why the flash size or technology makes any difference here\n\nMy recollection is that all the NOR implementations mount the overlay over /, so there is no reason to monitor anything except /, which is the default in the config but IBM implemented something different in the eMMC implementation where they only overlay mount /var, so for them the monitor of / is pointless because it is a read only volume."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "> /tmp is ideally covered by the memory usage health already.  Generally, I think systemd mounts /tmp in a way that you can't run out of space unless you also run out of memory, right?  So I don't know why you're monitoring that specifically.\n\nOn our p10bmc image, I see this via df:\ntmpfs                   460.5M         0    460.5M   0% /tmp\n\nI can fill that 460MB up but still have memory left. I'm not sure if there are ways around that limit but in my testing I just created a large 460MB file in /tmp, and got it to 100% usage and BMC memory was still ok."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "https://github.com/systemd/systemd/blob/main/units/tmp.mount#L25 .  Looks like systemd defaults to 50% of the memory.  I have no immediate opinion on if this is good for us or not.  If we chose to leave this at 50% for the whole project it is probably worthwhile to add monitoring of it into P-H-M as a default.\n\nDo you need similar monitoring on /run?  With 50%, could we end up with half the memory used in /tmp and half of it used in /run?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "ok, added the /tmp monitoring to PHM with  https://gerrit.openbmc.org/c/openbmc/phosphor-health-monitor/+/56885\n\nNot sure on the /run question. We haven't had any issue with /run usage (and it's really not used much by OpenBMC apps) so not as worried about it."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/recipes-phosphor/health/phosphor-health-monitor_%.bbappend",
                    "type": "ADDED",
                    "insertions": 8,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/recipes-phosphor/health/files/bmc_health_config.json",
                    "type": "ADDED",
                    "insertions": 63,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 93,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "ac37d615e7d3e9ea973f5e3d60e677678d5c28ac",
            "parents": [
                "4bee6dab5e6aebfa4fea77b5c55e3497c6c44e0f"
            ],
            "ref": "refs/changes/65/56065/5",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1661976209,
            "author": {
                "name": "Corey Hardesty",
                "email": "corey.hardesty@icloud.com",
                "username": "NodeMan97"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/recipes-phosphor/health/phosphor-health-monitor_%.bbappend",
                    "type": "ADDED",
                    "insertions": 8,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/recipes-phosphor/health/files/bmc_health_config.json",
                    "type": "ADDED",
                    "insertions": 63,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 93,
            "sizeDeletions": 0
        }
    ]
}