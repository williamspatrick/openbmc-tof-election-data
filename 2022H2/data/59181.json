{
    "project": "openbmc/dbus-sensors",
    "branch": "master",
    "id": "Ic99c1f2dd292ab99656df06228210d3c714e27d5",
    "number": 59181,
    "subject": "hwmontempsensor: Fix DBus update value after power on issue",
    "owner": {
        "name": "Joseph Fu",
        "email": "joseph.fu@quantatw.com",
        "username": "JosephFu1023"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/dbus-sensors/+/59181",
    "hashtags": [],
    "createdOn": 1670291217,
    "lastUpdated": 1670803636,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1670291217,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1670291255,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670291255,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1670291269,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/56742/ : FAILURE"
        },
        {
            "timestamp": 1670291648,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1670291685,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670291685,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1670291698,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/56743/ : FAILURE"
        },
        {
            "timestamp": 1670292448,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1670292470,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670292470,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1670292692,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/56745/ : SUCCESS"
        },
        {
            "timestamp": 1670293786,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1670323057,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3: Code-Review-1\n\n(1 comment)"
        },
        {
            "timestamp": 1670383031,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 4: Commit message was updated."
        },
        {
            "timestamp": 1670383038,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1"
        },
        {
            "timestamp": 1670383056,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670383056,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1670383095,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/56897/ : FAILURE"
        },
        {
            "timestamp": 1670391611,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 5: Commit message was updated."
        },
        {
            "timestamp": 1670391624,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified-1"
        },
        {
            "timestamp": 1670391626,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670391626,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1670391643,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5:\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/56905/ : FAILURE"
        },
        {
            "timestamp": 1670396086,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1670397002,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 6: Commit message was updated."
        },
        {
            "timestamp": 1670397014,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified-1"
        },
        {
            "timestamp": 1670397016,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670397017,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: -Ok-To-Test"
        },
        {
            "timestamp": 1670397247,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/56911/ : SUCCESS"
        },
        {
            "timestamp": 1670399106,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 6: -Code-Review\n\n(1 comment)"
        },
        {
            "timestamp": 1670401439,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1670404533,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 6:\n\n(2 comments)"
        },
        {
            "timestamp": 1670408409,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 7."
        },
        {
            "timestamp": 1670408423,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670408423,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: -Ok-To-Test"
        },
        {
            "timestamp": 1670408608,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        },
        {
            "timestamp": 1670408651,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/56920/ : SUCCESS"
        },
        {
            "timestamp": 1670448877,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 7:\n\n(3 comments)"
        },
        {
            "timestamp": 1670462831,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Uploaded patch set 8: Commit message was updated."
        },
        {
            "timestamp": 1670462854,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: Verified+1"
        },
        {
            "timestamp": 1670462871,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1670462871,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: -Ok-To-Test"
        },
        {
            "timestamp": 1670463091,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8:\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/57007/ : SUCCESS"
        },
        {
            "timestamp": 1670464675,
            "reviewer": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "message": "Patch Set 8:\n\n(2 comments)"
        },
        {
            "timestamp": 1670466983,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 8: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1670803462,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 8: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1670803636,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Change has been successfully rebased and submitted as 9bbeff75a4d202510901a4a464854cd0b387d1de"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "041d9e2c810ca85132c4b78364228b740f40fd20",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/1",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670291217,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 30,
            "sizeDeletions": 11
        },
        {
            "number": 2,
            "revision": "9ee033d97c8b86dd436d4994a9d9fa99814a2a6a",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/2",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670291648,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 30,
            "sizeDeletions": 11
        },
        {
            "number": 3,
            "revision": "77be965d105149daf887cc9fb3956e613bdce907",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/3",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670292448,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Zev can you please take a look at this?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "From the commit message and the comment (the latter unchanged despite the apparent semantics of the code changing to invalidate it I think) I don't really understand the exact nature of the problem, or how the patch fixes anything.  I tried reproducing the problem you've described via redfish (since I don't have an IPMI sensor stack configured at the moment) on a romed8hm3 system, using a backplane temperature sensor with 'PowerState: \"On\"' in its config...\n\nWith the host off, I see the expected null value from it:\n```\n$ curl https://$BMC/redfish/v1/Systems/system | jq .PowerState\n\"Off\"\n$ curl https://$BMC/redfish/v1/Chassis/ASRock_ROMED8HM3/Thermal | jq '.Temperatures|.[6]'\n{\n  \"@odata.id\": \"/redfish/v1/Chassis/ASRock_ROMED8HM3/Thermal#/Temperatures/6\",\n  \"@odata.type\": \"#Thermal.v1_3_0.Temperature\",\n  \"LowerThresholdCritical\": 0,\n  \"LowerThresholdNonCritical\": 5,\n  \"MaxReadingRangeTemp\": 127,\n  \"MemberId\": \"Backplane\",\n  \"MinReadingRangeTemp\": -128,\n  \"Name\": \"Backplane\",\n  \"ReadingCelsius\": null,\n  \"Status\": {\n    \"Health\": \"OK\",\n    \"State\": \"Enabled\"\n  },\n  \"UpperThresholdCritical\": 115,\n  \"UpperThresholdNonCritical\": 110\n}\n```\n\nAfter then turning the host on I see normal-looking readings again (that do retrieve different values at different times):\n```\n$ curl -X POST -d '{\"ResetType\":\"On\"}' https://$BMC/redfish/v1/Systems/system/Actions/ComputerSystem.Reset\n{\n  \"@Message.ExtendedInfo\": [\n    {\n      \"@odata.type\": \"#Message.v1_1_1.Message\",\n      \"Message\": \"The request completed successfully.\",\n      \"MessageArgs\": [],\n      \"MessageId\": \"Base.1.13.0.Success\",\n      \"MessageSeverity\": \"OK\",\n      \"Resolution\": \"None\"\n    }\n  ]\n}\n$ curl https://$BMC/redfish/v1/Systems/system | jq .PowerState\n\"On\"\n$ curl https://$MBC/redfish/v1/Chassis/ASRock_ROMED8HM3/Thermal | jq '.Temperatures|.[6]'\n{\n  \"@odata.id\": \"/redfish/v1/Chassis/ASRock_ROMED8HM3/Thermal#/Temperatures/6\",\n  \"@odata.type\": \"#Thermal.v1_3_0.Temperature\",\n  \"LowerThresholdCritical\": 0,\n  \"LowerThresholdNonCritical\": 5,\n  \"MaxReadingRangeTemp\": 127,\n  \"MemberId\": \"Backplane\",\n  \"MinReadingRangeTemp\": -128,\n  \"Name\": \"Backplane\",\n  \"ReadingCelsius\": 21,\n  \"Status\": {\n    \"Health\": \"OK\",\n    \"State\": \"Enabled\"\n  },\n  \"UpperThresholdCritical\": 115,\n  \"UpperThresholdNonCritical\": 110\n}\n$ curl https://$BMC/redfish/v1/Chassis/ASRock_ROMED8HM3/Thermal | jq '.Temperatures|.[6]'\n{\n  \"@odata.id\": \"/redfish/v1/Chassis/ASRock_ROMED8HM3/Thermal#/Temperatures/6\",\n  \"@odata.type\": \"#Thermal.v1_3_0.Temperature\",\n  \"LowerThresholdCritical\": 0,\n  \"LowerThresholdNonCritical\": 5,\n  \"MaxReadingRangeTemp\": 127,\n  \"MemberId\": \"Backplane\",\n  \"MinReadingRangeTemp\": -128,\n  \"Name\": \"Backplane\",\n  \"ReadingCelsius\": 20,\n  \"Status\": {\n    \"Health\": \"OK\",\n    \"State\": \"Enabled\"\n  },\n  \"UpperThresholdCritical\": 115,\n  \"UpperThresholdNonCritical\": 110\n}\n```\n\nLet me know if there's something I missing with this testing, but as far as I can tell hwmontempsensor itself is handling things as it should, which makes me suspect something misbehaving in the IPMI stack."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Joseph Fu",
                        "email": "joseph.fu@quantatw.com",
                        "username": "JosephFu1023"
                    },
                    "message": "The condition 'findI2CDev != devices.end()' will not activate sensors already exist when turning the host on. So I add this patch to HwmonTempSensor and it fixs this issue, or maybe you have other suggestions for modification.\n\nHere is my test on Redfish without this patch. \n```\n$ curl http://$BMC/redfish/v1/Systems/system | jq '.PowerState'\n\"On\"\n$ curl http://$BMC/redfish/v1/Chassis/Yertle/Thermal | jq '.Temperatures|.[1]'\n{\n  \"@odata.id\": \"/redfish/v1/Chassis/Yertle/Thermal#/Temperatures/1\",\n  \"@odata.type\": \"#Thermal.v1_3_0.Temperature\",\n  \"LowerThresholdCritical\": 0,\n  \"MaxReadingRangeTemp\": 127,\n  \"MemberId\": \"cputemp\",\n  \"MinReadingRangeTemp\": -128,\n  \"Name\": \"cputemp\",\n  \"ReadingCelsius\": 32.5,\n  \"Status\": {\n    \"Health\": \"OK\",\n    \"State\": \"Enabled\"\n  },\n  \"UpperThresholdCritical\": 105\n}\n$curl -k -H \"X-Auth-Token: $token\" -H \"Content-Type: application/json\" \\\n  -X POST http://$BMC/redfish/v1/Systems/system/Actions/ComputerSystem.Reset \\\n  -d '{\"ResetType\": \"ForceOff\"}''\n{\n  \"@Message.ExtendedInfo\": [\n    {\n      \"@odata.type\": \"#Message.v1_1_1.Message\",\n      \"Message\": \"The request completed successfully.\",\n      \"MessageArgs\": [],\n      \"MessageId\": \"Base.1.13.0.Success\",\n      \"MessageSeverity\": \"OK\",\n      \"Resolution\": \"None\"\n    }\n  ]\n}\n$curl http://$BMC/redfish/v1/Systems/system | jq '.PowerState''\n\"Off\"\n$ curl http://$BMC/redfish/v1/Chassis/Yertle/Thermal | jq '.Temperatures|.[1]'\n{\n  \"@odata.id\": \"/redfish/v1/Chassis/Yertle/Thermal#/Temperatures/1\",\n  \"@odata.type\": \"#Thermal.v1_3_0.Temperature\",\n  \"LowerThresholdCritical\": 0,\n  \"MaxReadingRangeTemp\": 127,\n  \"MemberId\": \"cputemp\",\n  \"MinReadingRangeTemp\": -128,\n  \"Name\": \"cputemp\",\n  \"ReadingCelsius\": null,\n  \"Status\": {\n    \"Health\": \"OK\",\n    \"State\": \"Enabled\"\n  },\n  \"UpperThresholdCritical\": 105\n}\n```\n\nAfter power on the host, it still can't get value.\n```\n$ curl -k -H \"X-Auth-Token: $token\" -H \"Content-Type: application/json\" \\\n  -X POST http://$BMC/redfish/v1/Systems/system/Actions/ComputerSystem.Reset \\\n  -d '{\"ResetType\": \"On\"}'\n{\n  \"@Message.ExtendedInfo\": [\n    {\n      \"@odata.type\": \"#Message.v1_1_1.Message\",\n      \"Message\": \"The request completed successfully.\",\n      \"MessageArgs\": [],\n      \"MessageId\": \"Base.1.13.0.Success\",\n      \"MessageSeverity\": \"OK\",\n      \"Resolution\": \"None\"\n    }\n  ]\n}\n$curl http://$BMC/redfish/v1/Systems/system | jq '.PowerState''\n\"On\"\n$curl http://$BMC/redfish/v1/Chassis/Yertle/Thermal | jq '.Temperatures|.[1]'\n{\n  \"@odata.id\": \"/redfish/v1/Chassis/Yertle/Thermal#/Temperatures/1\",\n  \"@odata.type\": \"#Thermal.v1_3_0.Temperature\",\n  \"LowerThresholdCritical\": 0,\n  \"MaxReadingRangeTemp\": 127,\n  \"MemberId\": \"cputemp\",\n  \"MinReadingRangeTemp\": -128,\n  \"Name\": \"cputemp\",\n  \"ReadingCelsius\": null,\n  \"Status\": {\n    \"Health\": \"OK\",\n    \"State\": \"Enabled\"\n  },\n  \"UpperThresholdCritical\": 105\n}\n```"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Okay, thanks for the more detailed description of what you're running to test and what you're seeing (and given the results with busctl it looks like we can rule out anything outside of hwmontempsensor itself).\n\nHowever, to understand things better I'd like to reproduce the problem, and thus far I haven't been able to with a 'PowerState: \"On\"` sensor on my system, so it seems like there must be some other factor involved.  Is your cputemp sensor a device that hwmontempsensor is dynamically instantiating and removing at runtime on host power transitions, or is it a static device from your device-tree?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Joseph Fu",
                        "email": "joseph.fu@quantatw.com",
                        "username": "JosephFu1023"
                    },
                    "message": "In this case, we use SBTSI driver sensors to test HwmonTempSensor.\nI found the of_node file path(https://github.com/openbmc/dbus-sensors/blob/7627c860fa551663436416aa12f5afe2f7136930/src/DeviceMgmt.cpp#L66) is present on our board no matter host is power off or power on. Therefor, it will not run in the condition https://github.com/openbmc/dbus-sensors/blob/7627c860fa551663436416aa12f5afe2f7136930/src/HwmonTempMain.cpp#L285, and then it will not activate sensor to update value.\n\nI am not sure of_node path cannot be used when determining whether the host is up or the host is down. Does the of_node path disappear on your machine when host off?\nDo you have anything scripts or process will bind/unbind device?\n\n> Okay, thanks for the more detailed description of what you're running to test and what you're seeing (and given the results with busctl it looks like we can rule out anything outside of hwmontempsensor itself).\n> \n> However, to understand things better I'd like to reproduce the problem, and thus far I haven't been able to with a 'PowerState: \"On\"` sensor on my system, so it seems like there must be some other factor involved.  Is your cputemp sensor a device that hwmontempsensor is dynamically instantiating and removing at runtime on host power transitions, or is it a static device from your device-tree?\n\nWe add static device on our device-tree, and it will not be binded/unbinded with any scripts or process."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Okay, sounds like you've got a static device, which looks like it was the difference that caused my testing to not reproduce the problem -- I had been using a dynamic device, but now trying with a static one I see the same behavior.\n\nThe of_node file in sysfs points to the device-tree node for a given device, which is why the code uses it to distinguish static devices from dynamic ones (devices instantiated by writing into the 'new_device' file don't have an of_node entry because they don't have a corresponding device-tree node).\n\n> Does the of_node path disappear on your machine when host off?\n\nNo; as above that's a purely static link to the device-tree node corresponding to the device (if there is one).\n\n> Do you have anything scripts or process will bind/unbind device?\n\nNo, I've made some changes in hwmontempsensor recently (https://github.com/openbmc/dbus-sensors/commit/a1456c4abafc697e7caa6b8e95ac9ddb35c4e7d1 being the main component of it) to allow it to handle that itself -- which is actually what led to this bug, but once it's fixed I'd recommend using that instead of tacking on shell scripts to duplicate the functionality elsewhere (if you're doing that anywhere else)."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 30,
            "sizeDeletions": 11
        },
        {
            "number": 4,
            "revision": "f791b20130f5cedca067d40da8c1ef7f62972cf9",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/4",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670383031,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 54,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 63,
            "sizeDeletions": 11
        },
        {
            "number": 5,
            "revision": "dec16b08d081cb0fe64153045003521dfab22b09",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/5",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670391611,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 55,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 64,
            "sizeDeletions": 11
        },
        {
            "number": 6,
            "revision": "0ba60fc3c2b10854b04cfcb6e6b2c37c19454796",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/6",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670397002,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "src/HwmonTempMain.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Okay, having now reproduced (and better understood) the problem, I *think* this logic looks right.  The comment, however, was written very specifically for the code in its previous form and now is kind of confusing applied to the new code -- to adjust it appropriately, I'd suggest removing everything from \"either (a)...\" through \"...or (b)\" so it just reads \"...underlying device was already there...\"."
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Joseph Fu",
                        "email": "joseph.fu@quantatw.com",
                        "username": "JosephFu1023"
                    },
                    "message": "Done. Thanks for your advice."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 61,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 70,
            "sizeDeletions": 11
        },
        {
            "number": 7,
            "revision": "0811ebe1bf0bac8f291e25b3fa5852bc0959524e",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/7",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670408409,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 11,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Since the bug didn't manifest with dynamic sensor devices, we should clarify here that it caused problems with static sensors."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 11,
                    "reviewer": {
                        "name": "Joseph Fu",
                        "email": "joseph.fu@quantatw.com",
                        "username": "JosephFu1023"
                    },
                    "message": "Done. Add brackets to indicate its contents about static sensors."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 26,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "For shell transcripts and such in commit messages, rather than backslash-escaping manual line breaks, you can surround blocks like this in markdown-style triple-backticks (or triple quotes) to exempt it from the line-length limits (which is more readable IMO, and nicer for copy/pasting and such if someone wants to reproduce your testing)."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 26,
                    "reviewer": {
                        "name": "Joseph Fu",
                        "email": "joseph.fu@quantatw.com",
                        "username": "JosephFu1023"
                    },
                    "message": "Done. I have updated all test data with triple-backticks from the commit messages."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Okay, I've now tested this out and it seems to work as it should for both static and dynamic sensors.  Just some minor commit-message tweaking and it should be good to go."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 61,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 68,
            "sizeDeletions": 11
        },
        {
            "number": 8,
            "revision": "cdf6b2002ebc47e7aa0f521848ac4bf060d52d3c",
            "parents": [
                "7627c860fa551663436416aa12f5afe2f7136930"
            ],
            "ref": "refs/changes/81/59181/8",
            "uploader": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "createdOn": 1670462831,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Alright, thanks.  Ed or Zhikui, can you take a look and merge assuming no objections?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "LGTM"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 55,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 62,
            "sizeDeletions": 11
        },
        {
            "number": 9,
            "revision": "9bbeff75a4d202510901a4a464854cd0b387d1de",
            "parents": [
                "79f5ebcd465bf476342fbb056158ea5ff6832049"
            ],
            "ref": "refs/changes/81/59181/9",
            "uploader": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "createdOn": 1670803636,
            "author": {
                "name": "Joseph Fu",
                "email": "joseph.fu@quantatw.com",
                "username": "JosephFu1023"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 55,
                    "deletions": 0
                },
                {
                    "file": "src/HwmonTempMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 62,
            "sizeDeletions": 11
        }
    ]
}