{
    "project": "openbmc/pam-ipmi",
    "branch": "master",
    "id": "I1963d26428fb31396b9485f4ab1d43601b303769",
    "number": 58550,
    "subject": "pam_ipmisave: fix ipmid authenticated message doesn't match in decryption",
    "owner": {
        "name": "Tim Lee",
        "email": "chli30@nuvoton.com",
        "username": "timlee66"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/pam-ipmi/+/58550",
    "hashtags": [],
    "createdOn": 1667879064,
    "lastUpdated": 1670023703,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1667879064,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1667879167,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1667879167,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1667879174,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Patch Set 2: Commit message was updated."
        },
        {
            "timestamp": 1667879195,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/54895/ : SUCCESS"
        },
        {
            "timestamp": 1667879204,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1"
        },
        {
            "timestamp": 1667879231,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1667879231,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1667879259,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/54896/ : SUCCESS"
        },
        {
            "timestamp": 1667879472,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1668030660,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1668047064,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1668103245,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1668128605,
            "reviewer": {
                "name": "Jiaqing Zhao",
                "email": "jiaqing.zhao@intel.com",
                "username": "jiaqingz-intel"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1668131315,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1668398657,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1668411442,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1668411508,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1668411508,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1668411528,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/55335/ : FAILURE"
        },
        {
            "timestamp": 1668411676,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1668411693,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1668411693,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1668411722,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/55336/ : SUCCESS"
        },
        {
            "timestamp": 1668412293,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1670016853,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1670023633,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1670023703,
            "reviewer": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "message": "Abandoned\n\nDue to there two commits already got approved to merge by authors. Thus, we abandon this commit."
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "2ad48554fecbd87c5e701aeaab0aea469ace6015",
            "parents": [
                "c971bebca35d9f697a7a9e3efae3c66867e5b68d"
            ],
            "ref": "refs/changes/50/58550/1",
            "uploader": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "createdOn": 1667879064,
            "author": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "src/pam_ipmisave/pam_ipmisave.c",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 34,
            "sizeDeletions": 5
        },
        {
            "number": 2,
            "revision": "b40ea0f0ab94d8c44aad498e150930ddba6667f4",
            "parents": [
                "c971bebca35d9f697a7a9e3efae3c66867e5b68d"
            ],
            "ref": "refs/changes/50/58550/2",
            "uploader": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "createdOn": 1667879174,
            "author": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "This seems like the wrong thing to have done.  Why didn't we keep them both size_t?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Tim Lee",
                        "email": "chli30@nuvoton.com",
                        "username": "timlee66"
                    },
                    "message": "That's why change to use uint32_t instead size_t. Below is commit for refer it. https://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/56296\n\nThe issue error message \"Authenticated message doesn't match\" from encryptDecryptData() in ipmid will not print it by default that use log<level::DEBUG>. When I change log level to log<level::ERR> then I found those error message and there is the same struct metapassstruct definition between ipmid and pam-ipmi, but member type didn't sync well. After sync pam-ipmi to ipmid, error message was gone.\n\nipmid:\nstruct MetaPassStruct\n{\n    char signature[10];\n    unsigned char reseved[2];\n    uint32_t hashSize;\n    uint32_t ivSize;\n    uint32_t dataSize;\n    uint32_t padSize;\n    uint32_t macSize;\n};\n\npam-ipmi:\ntypedef struct metapassstruct {\n    char signature[10];\n    unsigned char reseved[2];\n    size_t hashsize;\n    size_t ivsize;\n    size_t datasize;\n    size_t padsize;\n    size_t macsize;\n} metapassstruct;"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Shouldn't we revert the host-ipmid one?  I don't really understand why we made the ipmid one uint32_t but that doesn't seem right."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Tim Lee",
                        "email": "chli30@nuvoton.com",
                        "username": "timlee66"
                    },
                    "message": "We cannot revert the host-ipmid one, due to there is SEGV then cause ipmid crash.\nI just revert it to size_t and make sure the SEGV symptom still exist with latest ipmid and pam-ipmi as below:\n\nRevert to size_t in ipmid/user_channel/passwd_mgr.cpp\nstruct MetaPassStruct\n{\n    char signature[10];\n    unsigned char reseved[2];\n    size_t hashSize;\n    size_t ivSize;\n    size_t dataSize;\n    size_t padSize;\n    size_t macSize;\n};\n\nAfter flashing image and boot to openbmc prompt then find ipmid service was crash.\n\nroot@evb-npcm845:~# systemctl status phosphor-ipmi-host.service\nx phosphor-ipmi-host.service - Phosphor Inband IPMI\n     Loaded: loaded (/lib/systemd/system/phosphor-ipmi-host.service; enabled; preset: enabled)\n    Drop-In: /lib/systemd/system/phosphor-ipmi-host.service.d\n             `-10-override.conf\n     Active: failed (Result: core-dump) since Thu 1970-01-01 00:00:22 UTC; 2min 57s ago\n   Duration: 989ms\n    Process: 606 ExecStart=/usr/bin/env ipmid (code=dumped, signal=SEGV)\n   Main PID: 606 (code=dumped, signal=SEGV)\n\nJan 01 00:00:22 evb-npcm845 systemd[1]: Failed to start Phosphor Inband IPMI."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Tim Lee",
                        "email": "chli30@nuvoton.com",
                        "username": "timlee66"
                    },
                    "message": "Hi Patrick,\n\nI think you are right, I also don't understand why host-ipmid need change to use uint32_t instead size_t for fixing ipmid crash issue. Thus, I did some debugging and testing to clarify why didn't we keep host-ipmid and pam-ipmi both size_t. Yes, they both should keep use size_t and we should revert host-ipmid to use size_t.\n\nI found that real root cause seems relate to this original file /etc/ipmi_pass from pam-ipmi repo. Below is investigation for you refer it.\n\nFirst, I revert host-ipmid to use size_t then I will meet host-ipmid crash issue for sure.\n\nSecond, I keep pam-ipmi use size_t and without install original ipmi_pass file as I submit another commit as below:\nhttps://gerrit.openbmc.org/c/openbmc/pam-ipmi/+/58579\n\nThird, I try to generate new ipmi_pass file by command \"ipmitool user set password 1 0penBmc\" after I flash image-bmc. BTW, this image-bmc that use \"minlen=7\" in common-password that can let us generate \"0penBmc\" this password as default in ipmi_pass file.\n\nAfter that, I replace this ipmi_pass file by bbappend and generate image-bmc again. Then flash this new image-bmc. There is no more ipmid crash issue symptom after device boot up and no more auth failed error messages. However, ipmitool user set password for root also successful as below:\n\nroot@evb-npcm845:~# ipmitool user set password 1 0penBmc0\nSet User Password command successful (user 1)\n\nThus, I will submit one commit to revert host-ipmid this commit https://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/56296\n\nThen close this commit and update new ipmi_pass file into this commit https://gerrit.openbmc.org/c/openbmc/pam-ipmi/+/58579\n\nIf there is any suggestion, please don't hestiate to tell me. Thank you.\n\nBest regards,\nTim"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Tim Lee",
                        "email": "chli30@nuvoton.com",
                        "username": "timlee66"
                    },
                    "message": "Dear All,\nCould you please help to review this commit? Thank you.\n\nSincerely,\nTim"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 28,
                    "deletions": 0
                },
                {
                    "file": "src/pam_ipmisave/pam_ipmisave.c",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 33,
            "sizeDeletions": 5
        },
        {
            "number": 3,
            "revision": "bd7d7e4e1d4e4aa9557942ce83eed2c293c5b04a",
            "parents": [
                "c971bebca35d9f697a7a9e3efae3c66867e5b68d"
            ],
            "ref": "refs/changes/50/58550/3",
            "uploader": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "createdOn": 1668411442,
            "author": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "src/pam_ipmisave/pam_ipmisave.c",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -20
                }
            ],
            "sizeInsertions": 49,
            "sizeDeletions": 20
        },
        {
            "number": 4,
            "revision": "a9b8ffe148bae70b551e3017412bc638443944bf",
            "parents": [
                "c971bebca35d9f697a7a9e3efae3c66867e5b68d"
            ],
            "ref": "refs/changes/50/58550/4",
            "uploader": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "createdOn": 1668411676,
            "author": {
                "name": "Tim Lee",
                "email": "chli30@nuvoton.com",
                "username": "timlee66"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Tim Lee",
                        "email": "chli30@nuvoton.com",
                        "username": "timlee66"
                    },
                    "message": "Hi Patrick,\n\nFor compatible 32bit/64bit, we need to keep original /etc/ipmi_pass file in pam-ipmi repo. Previous method generated new ipmi_pass file could be only used for 64bit, but will fail in 32bit. Thus, we need to modify pam-ipmi use uint32_t as same as host-ipmid for doing encrypt/decrypt data. Please help me to review this commit and merge it. Thank you.\n\nBTW, I will abandon another commit about deleting original /etc/ipmi_pass file. \nhttps://gerrit.openbmc.org/c/openbmc/pam-ipmi/+/58579\n\nSincerely,\nTim"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I believe this will be abandoned, right?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Tim Lee",
                        "email": "chli30@nuvoton.com",
                        "username": "timlee66"
                    },
                    "message": "Yes, you're right. Due to below two commits already got approved to merge by authors. Thus, we will abandon this commit. Thanks your help.\n\n59035: Revert \"user_mgmt: Fix SEGV on 64bit\" | https://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/59035\n\n58579: pam-ipmi: fix ipmitool user set password failed in 64bit environment | https://gerrit.openbmc.org/c/openbmc/pam-ipmi/+/58579"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "src/pam_ipmisave/pam_ipmisave.c",
                    "type": "MODIFIED",
                    "insertions": 21,
                    "deletions": -20
                }
            ],
            "sizeInsertions": 50,
            "sizeDeletions": 20
        }
    ]
}