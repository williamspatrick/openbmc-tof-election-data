{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I4c03b0ae05d9fb7712d6ec3b6f2feaf034ca0750",
    "number": 56859,
    "subject": "Fix privileges on default handlers",
    "owner": {
        "name": "Ed Tanous",
        "email": "ed@tanous.net",
        "username": "edtanous"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/56859",
    "hashtags": [],
    "createdOn": 1661811284,
    "lastUpdated": 1666995296,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1661811284,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1661811353,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1661811353,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1661811861,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/50050/ : SUCCESS"
        },
        {
            "timestamp": 1661812119,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1661812815,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 2: Commit message was updated."
        },
        {
            "timestamp": 1661812850,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1661813835,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1661842697,
            "reviewer": {
                "name": "Jiaqing Zhao",
                "email": "jiaqing.zhao@intel.com",
                "username": "jiaqingz-intel"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1661889024,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1661958714,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1663958787,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1663959376,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1663959448,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1663959448,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1663959548,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1663960021,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/52371/ : SUCCESS"
        },
        {
            "timestamp": 1663967526,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1664038271,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1664234145,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1664234191,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1664234279,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1664235542,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1665590145,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1665590170,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: -Code-Review"
        },
        {
            "timestamp": 1665590274,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665592504,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665592731,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665594768,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1665605733,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665608247,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665614917,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665616244,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665679158,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1665679813,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1666995294,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1666995296,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully rebased and submitted as 0ea4b4e2343e486e233152a308c3c9762bd9ac65"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "577771950ded849f8e6a29d55a9cfe929abf0356",
            "parents": [
                "5d167952921fe40b0532491b3ae137cd974d00cf"
            ],
            "ref": "refs/changes/59/56859/1",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1661811284,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "The other two LGTM. But could you explain why 404 on /redfish/ requires login now?"
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I added more detail in the commit message.  It's not really a functional change, mostly just for documentation purposes."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 24,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "93b58b7e930caee15505c6638afb1e61d76ad4c8",
            "parents": [
                "5d167952921fe40b0532491b3ae137cd974d00cf"
            ],
            "ref": "refs/changes/59/56859/2",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1661812815,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Isn't this moving /redfish/v1/ to require login? Or does https://github.com/openbmc/bmcweb/blob/3acced2ce93ab735f147ba8204afcc18bdc0c3ea/include/authentication.hpp#L230 overwrite this? either way, I guess I don't see why this line is wanted"
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "The code you linked effectively already requires the Login privilege.  In theory that code isn't required, the privilege system is enough, but it's more of a pants and suspenders model to keep minor mistakes from becoming pre-authentication CVEs.\n\n\nThis line is wanted more for documentation purposes.  You must be logged in to get here, so this line coveys as much."
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Huh? \nI thought GET of service root (redfish/v1/) was unauthed (as the code in https://github.com/openbmc/bmcweb/blob/3acced2ce93ab735f147ba8204afcc18bdc0c3ea/include/authentication.hpp#L230 does.)\n\nsection 7.2.3 of redfish spec (I am looking at DSP0266 version 1.15.1)\n\n\"Service root request\n\nThe root URL for Redfish version 1.x services shall be /redfish/v1/.\n\nThe service returns the ServiceRoot resource, as defined by this specification, as a response for the root URL.\n\nServices shall not require authentication to retrieve the service root and /redfish resources.\""
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> I thought GET of service root (redfish/v1/) was unauthed\n\ncorrect.  But that's not this handler, the handler for redfish/v1 is here:\nhttps://github.com/openbmc/bmcweb/blob/4a0e1a0cf378e7bf4909c2ea8fc6e77e0d77ca6d/redfish-core/lib/service_root.hpp#L116\n\nThis is the 404 handler.  I rebased this to master, which makes this a lot more clear that this isn't the GET handler, but the \"route not found\" handler.  Let me know if that makes more sense."
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "Let me understand this, what will we get here?\n\n1. GET /redfish/abc with login privilege\n2. POST /redfish/abc with login privilege\n3. GET /redfish/abc without login privilege\n4. POST /redfish/abc without login privilege\n\nMy understanding is \n\n1. 404\n2. 405\n3. 401\n4. 401\n\nWhere do we set the methods?"
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> Let me understand this, what will we get here?\n> \n> 1. GET /redfish/abc with login privilege\n> 2. POST /redfish/abc with login privilege\n> 3. GET /redfish/abc without login privilege\n> 4. POST /redfish/abc without login privilege\n> \n> My understanding is \n> \n> 1. 404\n> 2. 405\n> 3. 401\n> 4. 401\n\nCorrect.\n\n> \n> Where do we set the methods?\n\n1 and 2 are set in redfish_v1.hpp\n\n3 and 4 are set in http_connection.hpp"
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "Thanks.\n\nFor my knowledge, is \"notFound\" a verb (same to methodNotAllowed)? How does that map to HTTP methods?"
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "notFound is not a http verb.  Http verbs are in the request, and map in the router.  notFound is what the router uses as a wildcard for \"all other routes\".  methodNotAllowed is used for \"all other verbs for which at least one verb route is defined\""
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "Got it."
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Ack."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 28,
            "sizeDeletions": 1
        },
        {
            "number": 3,
            "revision": "884412cce7a42a1d7b9f00d1cb3db07ec41817a6",
            "parents": [
                "4a0e1a0cf378e7bf4909c2ea8fc6e77e0d77ca6d"
            ],
            "ref": "refs/changes/59/56859/3",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1663959376,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "do you wanna create fake users to cover all the code path? Or that's not needed"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Sorry, didn't see you post this originally.\n\nI'm not following the question.  What do fake users have to do with this?  For all the privileges below, the default privilege registry defines a Login privilege, so I'm not sure what we'd be testing that the service validator hadn't already tested."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "You create a user which doesn't have Login privilege, and verify they are denied."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "All users have Login privilege today."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "Why is that?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Because that's the definition of the Login Privilege level.  \"User has logged in\""
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "FWIW, if there's a code path here to test, I'm happy to test it, I'm just not sure how, in the current implementation, to create a user without a Login Privilege, given that all 3 user levels have it."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "If you create a user which is not in group \"priv-admin\", \"priv-operator\", \"priv-user\", what privileges does this user have?\n\nI don't want to hold this commit though."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I don't believe there's a way to create a user with a valid password, but no group membership, but if you were able to do it through the shell, it wouldn't be able to hit any of this code, it would fail at this check here:\n\nhttps://github.com/openbmc/bmcweb/blob/bb759e3aeaadfec9f3aac4485f253bcc8a523e4c/include/authentication.hpp#L224\n\nand wouldn't make it to this code."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "Ack. IMO doesn't worth digging into it."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 32,
            "sizeDeletions": 2
        },
        {
            "number": 4,
            "revision": "0ea4b4e2343e486e233152a308c3c9762bd9ac65",
            "parents": [
                "4e7efda1ada02e626bbbd70cf35a742fbe9cfe54"
            ],
            "ref": "refs/changes/59/56859/4",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1666995296,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/redfish_v1.hpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 32,
            "sizeDeletions": 2
        }
    ]
}