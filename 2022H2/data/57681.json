{
    "project": "openbmc/openbmc",
    "branch": "master",
    "id": "Id88302732fe9d4c6e6c8cbb0004271d6ea2ac340",
    "number": 57681,
    "subject": "meta-google: Fix common-password to allow password change",
    "owner": {
        "name": "Oskar Senft",
        "email": "osk@google.com",
        "username": "osenft"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openbmc/+/57681",
    "hashtags": [],
    "createdOn": 1664973205,
    "lastUpdated": 1665534769,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1664973205,
            "reviewer": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1664973368,
            "reviewer": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "message": "Patch Set 2: Commit message was updated."
        },
        {
            "timestamp": 1664973525,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1664973525,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1664973534,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/13149/"
        },
        {
            "timestamp": 1664974637,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/13149/ : SUCCESS"
        },
        {
            "timestamp": 1664974646,
            "reviewer": {
                "name": "Jenkins OpenBMC Google",
                "email": "haojenkinsg00gle@gmail.com",
                "username": "jenkins-openbmc-g00gle"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nGoogle Internal CI : Google internal tests successfully started"
        },
        {
            "timestamp": 1664975836,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1664984186,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1664991058,
            "reviewer": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1664993535,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1664995834,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1664995855,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1664996088,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1665005951,
            "reviewer": {
                "name": "Josh Lehan",
                "email": "krellan@google.com",
                "username": "Krellan"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1665025357,
            "reviewer": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1665025594,
            "reviewer": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1665085200,
            "reviewer": {
                "name": "Josh Lehan",
                "email": "krellan@google.com",
                "username": "Krellan"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(2 comments)"
        },
        {
            "timestamp": 1665163931,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 2: Code-Review+2"
        },
        {
            "timestamp": 1665534769,
            "reviewer": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "message": "Change has been successfully rebased and submitted as 6cc57feb425d33e8f5921aad2716e8fc773285c4"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "d5724de3e0e58b6ff5299806ee97f3a4d8ff40da",
            "parents": [
                "54c8b29f9edb32f8fb9fa8bf48a3707583c817ff"
            ],
            "ref": "refs/changes/81/57681/1",
            "uploader": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "createdOn": 1664973205,
            "author": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 35,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "d981db86d0ca0789cea113aa27d12ea097f2f6a6",
            "parents": [
                "54c8b29f9edb32f8fb9fa8bf48a3707583c817ff"
            ],
            "ref": "refs/changes/81/57681/2",
            "uploader": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "createdOn": 1664973368,
            "author": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 23,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "The reason for needing awk instead of sed here, is that we need to limit the \"use_authtok\" substitution, so that it only happens on lines that start with \"password\", correct? Otherwise, we could simply use \"sed -i\" then we would not need a temporary file."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 23,
                    "reviewer": {
                        "name": "Oskar Senft",
                        "email": "osk@google.com",
                        "username": "osenft"
                    },
                    "message": "Correct, we only want to make this change on the FIRST line that starts with \"password\". Doing that with sed maybe possible, but the examples I found for sed were quite convoluted and not easy to understand. awk seems to be the right tool for this task."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 23,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "Oh, if it must be the first line only, that's important. That is more powerful than what sed can do."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "no need the `mv`. can `awk` to `${D}${sysconfdir}/pam.d/common-password` directly?"
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Oskar Senft",
                        "email": "osk@google.com",
                        "username": "osenft"
                    },
                    "message": "awk on its own doesn't do inplace updates. There's \"-i inplace\", but that requires GNU awk. Can we assume that we have that?"
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "Ack.\n\nI am now sure which one we have. But it doesn't look like it?\n\n```\nawk -i    \nawk: invalid option -- 'i'\nBusyBox v1.35.0 () multi-call binary.\n\nUsage: awk [OPTIONS] [AWK_PROGRAM] [FILE]...\n```\n\nI guess this is fine."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "I believe any inplace operations in bitbake should be avoided as they don't allow steps to be repeated idempotently."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "This includes doing an move over the old input file."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "oh oops, I guess we need to fix L14 where we did `sed` inplace."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "As for being idempotent, this is important. The sed command should be idempotent, as when repeated, it will not find the original string, since it has already been replaced. So, it will harmlessly make no change. This should be OK, and satisfy the criteria we need for idempotency, namely, safety when it's repeated."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Oskar Senft",
                        "email": "osk@google.com",
                        "username": "osenft"
                    },
                    "message": "Yes, the awk command is idempotent. I don't understand the requirement of not overwriting the original file. Can you please explain that? We ultimately do need to modify common-password.\n\nBTW: A completely different option would be to provide our own version of common-password instead of modifying the \"stock\" version.\n\nWhat's the right approach here?"
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Oskar Senft",
                        "email": "osk@google.com",
                        "username": "osenft"
                    },
                    "message": "Sorry, I just re-read this thread. In-place operations are NOT necessarily incompatible with the requirement of being idempotent. Both the existing `sed` and the new `awk` are idempotent. The existing `sed` removes all lines that contain `pam_cracklib.so` - so as soon as the line is removed, you can re-run the same command and it'll not modify the file further. The same goes for the new `awk` command: It only removes `use_authtok` from the first line that starts with `password` - once that happened, it won't change the file further through repeated runs. I'd say we achieved the goal of idempotency while still overwriting the original file. I can't see what else needs to be done here? Please re-open if you disagree."
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "line": 25,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "That makes sense to me. I agree."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 35,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "6cc57feb425d33e8f5921aad2716e8fc773285c4",
            "parents": [
                "63603d02bb3c9c156c4d90246b95411949c9f52c"
            ],
            "ref": "refs/changes/81/57681/3",
            "uploader": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "createdOn": 1665534769,
            "author": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-extended/pam/libpam_%.bbappend",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 35,
            "sizeDeletions": 0
        }
    ]
}