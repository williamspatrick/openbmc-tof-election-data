{
    "project": "openbmc/libmctp",
    "branch": "master",
    "topic": "astlpc-events",
    "id": "I693946dae5336aa5d0f07bcd66c36f1ccd391054",
    "number": 56318,
    "subject": "astlpc: Implement async support via buffer state tracking",
    "owner": {
        "name": "Andrew Jeffery",
        "email": "andrew@aj.id.au",
        "username": "amboar"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/libmctp/+/56318",
    "hashtags": [],
    "createdOn": 1659708485,
    "lastUpdated": 1660094002,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1659708485,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1659708532,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1659708532,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1659708574,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/48615/ : SUCCESS"
        },
        {
            "timestamp": 1659919539,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 1:\n\n(4 comments)"
        },
        {
            "timestamp": 1659925226,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1659925661,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1659928041,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1659928536,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1659930749,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1659930791,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1659930791,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1659931417,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/48702/ : SUCCESS"
        },
        {
            "timestamp": 1659931488,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1659941879,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2: Verified+1 Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1659942060,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Change has been successfully rebased and submitted as fe763e9820668b90c22b0101994ac6bd6cd41c09"
        },
        {
            "timestamp": 1660094002,
            "reviewer": {
                "name": "Rashmica K Gupta",
                "email": "rashmica@linux.ibm.com",
                "username": "RashmicaG"
            },
            "message": "Patch Set 3: Code-Review+1"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "88fdc1593c7fdbe8e5450d3577823a8a3127c148",
            "parents": [
                "43c0f6ad7680f8f4eef2514adb43a883538c307a"
            ],
            "ref": "refs/changes/18/56318/1",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1659708485,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "LGTM, just a few things inline though."
                },
                {
                    "file": "astlpc.c",
                    "line": 50,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Can we have some comments on the interpretation of these states? Prepared just means we're waiting on the release to complete, is that correct?"
                },
                {
                    "file": "astlpc.c",
                    "line": 50,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "> Can we have some comments on the interpretation of these states?\n\nAck.\n\n> Prepared just means we're waiting on the release to complete, is that correct?\n\nPrepared means that the buffer is ready to be accessed by the other side, just we're yet to successfully inform them of that."
                },
                {
                    "file": "astlpc.c",
                    "line": 50,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Done"
                },
                {
                    "file": "astlpc.c",
                    "line": 1094,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Any thoughts on passing the poll revents to _poll(), so we can only attempt the send() if a POLLOUT has occurred?\n\n(that will make the API somewhat fileio-specific though, so not sure whether that's a good idea...)"
                },
                {
                    "file": "astlpc.c",
                    "line": 1094,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Aside from the issue with making the function fileio specific, I did consider that but it felt more complex than was necessary given we know what the event should have been given the buffer states?"
                },
                {
                    "file": "astlpc.c",
                    "line": 1094,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Done"
                },
                {
                    "file": "astlpc.c",
                    "line": 1374,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "this just looks like:\n\n     pollfd->events = ([state check]) ? POLLOUT : POLLIN\n\nwith extra steps"
                },
                {
                    "file": "astlpc.c",
                    "line": 1374,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Sure, I can tidy that up, though I was toying with whether I could always keep POLLIN enabled. The practical answer looked to be no from the resulting boot failures, but I haven't pinned down exactly what's going on there. I suspect it's something to do with strict message sequencing assumptions in hostboot given we only recently grew support for message tags :S"
                },
                {
                    "file": "astlpc.c",
                    "line": 1374,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Since we're not modifying the _poll() behaviour based on the poll revent (from your comment above), I *think* the events may have to be exclusive. Otherwise, we'd have no way of distinguishing an incoming KCS read (POLLIN) vs. the prepared -> released transition (POLLOUT).\n\nHowever, I'm not certain that there's a valid protocol state where we could be waiting for either?\n\nGiven you're now the Global Expert in ASTLPC Transport Binding Protocol State Transitions, I'm going to leave that up to you \ud83d\ude0a"
                },
                {
                    "file": "astlpc.c",
                    "line": 1374,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "> Otherwise, we'd have no way of distinguishing an incoming KCS read (POLLIN) vs. the prepared -> released transition (POLLOUT).\n\nRight, but in theory it shouldn't matter as we'll fail to write the command to execute the prepared -> released transition as the KCS write buffer is still populated. We would complete this action once the other side has dequeued it."
                },
                {
                    "file": "astlpc.c",
                    "line": 1374,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "astlpc.c",
                    "type": "MODIFIED",
                    "insertions": 72,
                    "deletions": -17
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 17
        },
        {
            "number": 2,
            "revision": "f267ba368b92e64305de76c6ff75ab47a44d8eae",
            "parents": [
                "d4372121290fac5df4681f7d20e351d0876303bb"
            ],
            "ref": "refs/changes/18/56318/2",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1659930749,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "All looks good to me! +1 just because I have no way to test on HW."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "\ud83d\udef3"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "astlpc.c",
                    "type": "MODIFIED",
                    "insertions": 117,
                    "deletions": -17
                },
                {
                    "file": "tests/test_astlpc.c",
                    "type": "MODIFIED",
                    "insertions": 63,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 209,
            "sizeDeletions": 17
        },
        {
            "number": 3,
            "revision": "fe763e9820668b90c22b0101994ac6bd6cd41c09",
            "parents": [
                "8f53d6310bd166670b123b982c38b32e8a3a877b"
            ],
            "ref": "refs/changes/18/56318/3",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1659942060,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "astlpc.c",
                    "type": "MODIFIED",
                    "insertions": 117,
                    "deletions": -17
                },
                {
                    "file": "tests/test_astlpc.c",
                    "type": "MODIFIED",
                    "insertions": 63,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 209,
            "sizeDeletions": 17
        }
    ]
}