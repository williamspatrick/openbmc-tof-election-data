{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "Idd1a71ebb485a77795ba47b873624c8e53c36a4c",
    "number": 56737,
    "subject": "Aggregation: Improve handling of certain requests",
    "owner": {
        "name": "Carson",
        "email": "clabrado@google.com",
        "username": "carsonlab"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/56737",
    "hashtags": [],
    "createdOn": 1661299496,
    "lastUpdated": 1661826301,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1661299496,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1661299550,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1661299555,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1661300062,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/49746/ : SUCCESS"
        },
        {
            "timestamp": 1661310672,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1661310706,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1661310706,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1661310729,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/49747/ : FAILURE"
        },
        {
            "timestamp": 1661316955,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1661317012,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1661317012,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1661317521,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/49748/ : SUCCESS"
        },
        {
            "timestamp": 1661358089,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1661360147,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1661361125,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1661361168,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1661361168,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1661361683,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/49783/ : SUCCESS"
        },
        {
            "timestamp": 1661361744,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1661361779,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1661361779,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1661362294,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/49785/ : SUCCESS"
        },
        {
            "timestamp": 1661362729,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1661378932,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1661441788,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1661826299,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1661826301,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully rebased and submitted as db18fc98241b4fc9a4274f45c1d6b07d7bd1b93d"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "c061529e47e3acc423b7f3212d8442a488b12126",
            "parents": [
                "0d5f5cf4ff93e89e94a5291f856f3e6976ed2284"
            ],
            "ref": "refs/changes/37/56737/1",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1661299496,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 27,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 41,
            "sizeDeletions": 4
        },
        {
            "number": 2,
            "revision": "9c6a38cd41e421892c01ed3000c0aa61da5f87e0",
            "parents": [
                "0d5f5cf4ff93e89e94a5291f856f3e6976ed2284"
            ],
            "ref": "refs/changes/37/56737/2",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1661310672,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 37,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 39,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 76,
            "sizeDeletions": 3
        },
        {
            "number": 3,
            "revision": "9b00f417df3ec6b4884d27505ac0505f36c5d013",
            "parents": [
                "0d5f5cf4ff93e89e94a5291f856f3e6976ed2284"
            ],
            "ref": "refs/changes/37/56737/3",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1661316955,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 417,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "What case is this handling?  If we come into this method, don't we already know this needs aggregated?"
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 417,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "In the existing form we don't have a way to return a response if we don't have any satellite configs and we send a request to a valid satellite resource such as /redfish/v1/Systems/5B247A_system.  We'd get past the initial check in beginAggregation().  Then we'd reach this point and not find a matching prefix.\n\nTo handle this I added a check to aggregateAndHandle() to catch when there are no satellite configs found.  However, this check won't be sufficient when we add support for multiple satellites.\n\nThat initial check in beginAggregation() will only match the portion of the prefix that indicates it's tied to Redfish Aggregation.  In findSatellite() we'll try to match the entire prefix to a known satellite config.  This error statement would be reached when the prefix in the request looks valid, but does not actually exist.\n\nAdmittedly we don't need this error statement right now.  I added it since we'll need it in the future and it seems like a subtlety that could be forgotten when support for multiple satellite BMCs gets added."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 417,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> In the existing form we don't have a way to return a response if we don't have any satellite configs and we send a request to a valid satellite resource such as /redfish/v1/Systems/5B247A_system.  We'd get past the initial check in beginAggregation().  Then we'd reach this point and not find a matching prefix.\n\nACK.  DIdn't think about that case.\n\n> \n> To handle this I added a check to aggregateAndHandle() to catch when there are no satellite configs found.  However, this check won't be sufficient when we add support for multiple satellites.\n> \n> That initial check in beginAggregation() will only match the portion of the prefix that indicates it's tied to Redfish Aggregation.  In findSatellite() we'll try to match the entire prefix to a known satellite config.  This error statement would be reached when the prefix in the request looks valid, but does not actually exist.\n> \n> Admittedly we don't need this error statement right now.  I added it since we'll need it in the future and it seems like a subtlety that could be forgotten when support for multiple satellite BMCs gets added.\n\n\n\nWorks for me."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 487,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Should this be 500 if we don't expect it?"
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 487,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "Yeah you're right.  If this function gets called we expect it to be for either a collection or resource.  Really we shouldn't be able to hit this error statement since we already had to pass the above checks in beginAggregation() before we can call aggregateAndHandle()."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 487,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 37,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 40,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 77,
            "sizeDeletions": 3
        },
        {
            "number": 4,
            "revision": "2cb4d1c1a24cfed1cb8b40120fc0aabe830f1e36",
            "parents": [
                "0d5f5cf4ff93e89e94a5291f856f3e6976ed2284"
            ],
            "ref": "refs/changes/37/56737/4",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1661361125,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 37,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 75,
            "sizeDeletions": 3
        },
        {
            "number": 5,
            "revision": "f1ebdca04b692291c2de7a240acce609b3e2bf5f",
            "parents": [
                "0d5f5cf4ff93e89e94a5291f856f3e6976ed2284"
            ],
            "ref": "refs/changes/37/56737/5",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1661361744,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "LGTM"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 37,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 75,
            "sizeDeletions": 3
        },
        {
            "number": 6,
            "revision": "db18fc98241b4fc9a4274f45c1d6b07d7bd1b93d",
            "parents": [
                "84825f708e0bbd66e5bdf527970c1231aa219dfa"
            ],
            "ref": "refs/changes/37/56737/6",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1661826301,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 37,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 75,
            "sizeDeletions": 3
        }
    ]
}