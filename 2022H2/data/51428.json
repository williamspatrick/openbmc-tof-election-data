{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I3f116cc91eeadc949579deacbeb2d9f5e0f4fa53",
    "number": 51428,
    "subject": "WIP: nbd proxy and websocket cleanups",
    "owner": {
        "name": "Ed Tanous",
        "email": "ed@tanous.net",
        "username": "edtanous"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/51428",
    "hashtags": [],
    "createdOn": 1645508125,
    "lastUpdated": 1665248172,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1645508125,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1645508145,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645508145,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1645508175,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/37756/ : FAILURE"
        },
        {
            "timestamp": 1645517279,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1645517290,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645517290,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1645517713,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/37770/ : FAILURE"
        },
        {
            "timestamp": 1645517735,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1645517760,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645517760,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1645518311,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37771/ : SUCCESS"
        },
        {
            "timestamp": 1645551204,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1645551217,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645551217,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1645551939,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37793/ : SUCCESS"
        },
        {
            "timestamp": 1656697541,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1656697552,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1656697552,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1656698580,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/46308/ : SUCCESS"
        },
        {
            "timestamp": 1658742207,
            "reviewer": {
                "name": "jkalinox",
                "email": "jakubx.kalinowski@intel.com",
                "username": "jkalinox"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1658760703,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1660649477,
            "reviewer": {
                "name": "Michal Orzel",
                "email": "michalx.orzel@intel.com",
                "username": "morzelx"
            },
            "message": "Patch Set 5:\n\n(3 comments)"
        },
        {
            "timestamp": 1660673578,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5:\n\n(2 comments)"
        },
        {
            "timestamp": 1660728491,
            "reviewer": {
                "name": "Michal Orzel",
                "email": "michalx.orzel@intel.com",
                "username": "morzelx"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1660747838,
            "reviewer": {
                "name": "Michal Orzel",
                "email": "michalx.orzel@intel.com",
                "username": "morzelx"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1665247481,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 6: Patch Set 5 was rebased"
        },
        {
            "timestamp": 1665247541,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1665247541,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: -Ok-To-Test"
        },
        {
            "timestamp": 1665248172,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/53193/ : SUCCESS"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "2d3ba6a14a7e00dc7df888a8dcd5ee87273f2d6f",
            "parents": [
                "8f2ad1d2804c84f208282787642abbdaf8bc6885"
            ],
            "ref": "refs/changes/28/51428/1",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1645508125,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -36
                },
                {
                    "file": "http/http_client.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 20,
            "sizeDeletions": 41
        },
        {
            "number": 2,
            "revision": "bd0314a46ff315aa19380984c64387a37d3a28a4",
            "parents": [
                "f29c77ce35a2b6c865a788a7e275e37a60cf7655"
            ],
            "ref": "refs/changes/28/51428/2",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1645517279,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "type": "MODIFIED",
                    "insertions": 197,
                    "deletions": -308
                },
                {
                    "file": "http/http_client.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -5
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -2
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 92,
                    "deletions": -32
                }
            ],
            "sizeInsertions": 317,
            "sizeDeletions": 347
        },
        {
            "number": 3,
            "revision": "4c6c3c6f5693ece2d8ac8568021c655b90cb3753",
            "parents": [
                "f29c77ce35a2b6c865a788a7e275e37a60cf7655"
            ],
            "ref": "refs/changes/28/51428/3",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1645517735,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "type": "MODIFIED",
                    "insertions": 197,
                    "deletions": -308
                },
                {
                    "file": "http/http_client.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -5
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -2
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 92,
                    "deletions": -32
                }
            ],
            "sizeInsertions": 317,
            "sizeDeletions": 347
        },
        {
            "number": 4,
            "revision": "cf607d71b52ec012ea9cb803d744e325f52a45af",
            "parents": [
                "f29c77ce35a2b6c865a788a7e275e37a60cf7655"
            ],
            "ref": "refs/changes/28/51428/4",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1645551204,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "type": "MODIFIED",
                    "insertions": 203,
                    "deletions": -308
                },
                {
                    "file": "http/http_client.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -5
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -2
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 92,
                    "deletions": -32
                }
            ],
            "sizeInsertions": 323,
            "sizeDeletions": 347
        },
        {
            "number": 5,
            "revision": "b066c3e0c1e916d3ba2c87444708c629cb0f8dc0",
            "parents": [
                "e3009e4645d3a4ecaf2e65f75c6b997a5ed5dbfb"
            ],
            "ref": "refs/changes/28/51428/5",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1656697541,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "jkalinox",
                        "email": "jakubx.kalinowski@intel.com",
                        "username": "jkalinox"
                    },
                    "message": "This commit can help with this problem https://gerrit.openbmc.org/c/openbmc/bmcweb/+/54292\nI think it would be worth merging it "
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "NO disagreement, it needs better testing."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Michal Orzel",
                        "email": "michalx.orzel@intel.com",
                        "username": "morzelx"
                    },
                    "message": "I've tried to test this change on our platforms, by performing simple mount and unmount scenario on prepared image. Unfortunately, this code doesn't seem to work for now, as either mount was failing, or bmcweb crashed completely. I've pointed out some more details in comments below."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Excellent!  Thanks for testing it!"
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Michal Orzel",
                        "email": "michalx.orzel@intel.com",
                        "username": "morzelx"
                    },
                    "message": "In alternative scenario, when situation from another comment doesn't occur, this async_write always results with \"Bad file descriptor\" error. When attempting to call close() method, bmcweb crashes with a message that pure virtual method is trying to be called here. Below is gdb call-stack from crash moment for reference:\n\nProgram received signal SIGABRT, Aborted.\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n0x7687e5f4 in ?? () from target:/lib/libc.so.6\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nPython Exception <class 'ModuleNotFoundError'>: No module named 'gdb'\n#0  0x7687e5f4 in ?? () from target:/lib/libc.so.6\n#1  0x76844164 in raise () from target:/lib/libc.so.6\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n#2  0x76831638 in abort () from target:/lib/libc.so.6\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n#3  0x76a74e10 in __gnu_cxx::__verbose_terminate_handler() () from target:/usr/lib/libstdc++.so.6\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n#4  0x76a72e34 in ?? () from target:/usr/lib/libstdc++.so.6\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n#5  0x76a72eb8 in std::terminate() () from target:/usr/lib/libstdc++.so.6\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n#6  0x76a73cc4 in __cxa_pure_virtual () from target:/usr/lib/libstdc++.so.6\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n#7  0x0063a4cc in crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}::operator()(boost::system::error_code, unsigned int) const (\n    Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\n__closure=0x7eee35c4, __closure@entry=0x7eee35bc, ec=...) at ../../../../../../workspace/sources/bmcweb/include/nbd_proxy.hpp:140\n#8  0x00854ff8 in boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>::operator()(boost::system::error_code, unsigned int, int) (start=0, bytes_transferred=<optimized out>, ec=..., this=0x7eee35a8) at /usr/include/boost/asio/impl/write.hpp:363\n#9  boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>::operator()() (this=0x7eee35a8) at /usr/include/boost/asio/detail/bind_handler.hpp:289\n#10 boost_asio_handler_invoke_helpers::invoke<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>, boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int> >(boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>&, boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>&) (context=..., function=...) at /usr/include/boost/asio/detail/handler_invoke_helpers.hpp:51\n#11 boost::asio::detail::executor_function::complete<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>, std::allocator<void> >(boost::asio::detail::executor_function::impl_base*, bool) (base=<optimized out>, call=<optimized out>) at /usr/include/boost/asio/detail/executor_function.hpp:116\n#12 0x0080c088 in boost::asio::detail::executor_function::operator() (Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nthis=0x7eee35f8) at /usr/include/boost/asio/detail/executor_function.hpp:64\n#13 boost_asio_handler_invoke_helpers::invoke<boost::asio::detail::executor_function, boost::asio::detail::executor_function> (context=..., function=...) at /usr/include/boost/asio/detail/handler_invoke_helpers.hpp:51\n#14 boost::asio::io_context::basic_executor_type<std::allocator<void>, 4u>::execute<boost::asio::detail::executor_function> (this=0x7eee3688, Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nf=...) at /usr/include/boost/asio/impl/io_context.hpp:288\n#15 0x0080c180 in boost_asio_execution_execute_fn::impl::operator()<boost::asio::io_context::basic_executor_type<std::allocator<void>, 4u> const&, boost::asio::detail::executor_function> (f=..., t=..., this=<synthetic pointer>) at /usr/include/boost/asio/execution/execute.hpp:208\n#16 boost::asio::execution::detail::any_executor_base::execute_ex<boost::asio::io_context::basic_executor_type<std::allocator<void>, 4u> > (ex=..., f=...) at /usr/include/boost/asio/execution/any_executor.hpp:894\n#17 0x007da6fc in boost::asio::execution::detail::any_executor_base::execute<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int> >(boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>&&) const (Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nf=..., this=0x7eee3680) at /usr/include/boost/asio/execution/any_executor.hpp:611\n#18 boost_asio_execution_execute_fn::impl::operator()<boost::asio::any_io_executor, boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int> >(boost::asio::any_io_executor&&, boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>&&) const (f=..., t=..., this=<synthetic pointer>) at /usr/include/boost/asio/execution/execute.hpp:208\n#19 boost::asio::detail::handler_work_base<boost::asio::any_io_executor, void, boost::asio::io_context, boost::asio::executor, void>::dispatch<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>, boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}> >(boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>&, boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>&) (function=..., this=0x7eee3664) at /usr/include/boost/asio/detail/handler_work.hpp:439\n#20 boost::asio::detail::handler_work<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::asio::any_io_executor, void>::complete<boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int> >(boost::asio::detail::binder2<boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::system::error_code, unsigned int>&, boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>&) (handler=..., function=..., this=0x7eee3664) at /usr/include/boost/asio/detail/handler_work.hpp:516\n#21 boost::asio::detail::reactive_socket_send_op<boost::asio::const_buffer, boost::asio::detail::write_op<boost::asio::basic_stream_socket<boost::asio::local::stream_protocol, boost::asio::any_io_executor>, boost::asio::const_buffer, boost::asio::const_buffer const*, boost::asio::detail::transfer_all_t, crow::nbd_proxy::NbdProxyServer::send(std::basic_string_view<char, std::char_traits<char> >, std::function<void ()>&&)::{lambda(boost::system::error_code, unsigned int)#1}>, boost::asio::any_io_executor>::do_complete(void*, boost::asio::detail::scheduler_operation*, boost::system::error_code const&, unsigned int) (owner=owner@entry=0xf70d80, base=base@entry=0x12f81d8) at /usr/include/boost/asio/detail/reactive_socket_send_op.hpp:148\n#22 0x00523b8c in boost::asio::detail::scheduler_operation::complete (bytes_transferred=0, ec=..., owner=0xf70d80, this=0x12f81d8) at /usr/include/boost/asio/detail/scheduler_operation.hpp:40\n#23 boost::asio::detail::scheduler::do_run_one (Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nthis=this@entry=0xf70d80, Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nlock=..., this_thread=..., ec=...) at /usr/include/boost/asio/detail/impl/scheduler.ipp:492\n#24 0x005321b8 in boost::asio::detail::scheduler::run (this=0xf70d80, Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nec=...) at /usr/include/boost/asio/detail/impl/scheduler.ipp:210\n#25 0x00535100 in boost::asio::io_context::run (Python Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing\nthis=this@entry=0x0) at /usr/include/boost/asio/impl/io_context.ipp:63\n#26 0x005b80b0 in run () at /usr/include/c++/11.3.0/bits/shared_ptr_base.h:1295\n#27 0x005b8188 in main () at ../../../../../../workspace/sources/bmcweb/src/webserver_main.cpp:156\nPython Exception <class 'NameError'>: Installation error: gdb._execute_unwinders function is missing"
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "line": 319,
                    "reviewer": {
                        "name": "Michal Orzel",
                        "email": "michalx.orzel@intel.com",
                        "username": "morzelx"
                    },
                    "message": "In situation, when onMessage handler runs on parallel with onOpen, there might occur situation when NbdProxyServer instance is not yet created. In this situation, connection will immediately be closed even before onOpen handler completion. This can be observed in journal logs below (notice when onMessageEx is called, and when NbdProxyServer is actually constructed):\n\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":245] Websocket accepted connection\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":257] ConnectionImpl::doRead() entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":288] nbd-proxy.onopen(0x22e7120)\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":262] ConnectionImpl async read callback entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":318] nbd-proxy.onMessageEx(len = 18)\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":329] Couldn't find NbdProxyServer instance for connection 0x22e7120\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":224] ConnectionImpl::close(\"internal error\") entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":257] ConnectionImpl::doRead() entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":207] afterGetManagedObjects() entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":278] Session is null for connection 0x22e7120\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":56] NbdProxyServer constructor\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":80] NbdProxyServer::run() entry\nAug 15 12:49:46 intel-obmc virtual-media[312]: [Info    ] [initial_state.hpp:283] operator()(): [App]: Mount called on /xyz/openbmc_project/VirtualMedia/Proxy/Slot_0\nAug 15 12:49:46 intel-obmc virtual-media[312]: [Info    ] [state_machine.hpp:68] emitEvent(): Slot_0 received MountEvent while in ReadyState\nAug 15 12:49:46 intel-obmc virtual-media[312]: [Info    ] [state_machine.hpp:58] changeState(): Slot_0 state changed to ActivatingState\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":228] ConnectionImpl: websocket async close callback entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [ERROR \"websocket.hpp\":236] Error closing websocket asio.ssl.stream:1\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":237] Error details: stream truncated [asio.ssl.stream:1]\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":262] ConnectionImpl async read callback entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [ERROR \"websocket.hpp\":267] doRead error system:125\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"websocket.hpp\":268] Error details: Operation canceled [system:125]\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":303] nbd-proxy.onclose(reason = 'internal error')\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":66] NbdProxyServer destructor\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [DEBUG \"nbd_proxy.hpp\":83] NbdProxyServer: Async accept callback entry\nAug 15 12:49:46 intel-obmc bmcweb[391]: (2022-08-15 12:49:46) [ERROR \"nbd_proxy.hpp\":86] UNIX socket: async_accept error = Operation canceled\nAug 15 12:49:46 intel-obmc virtual-media[312]: [Info    ] [system.hpp:382] operator()(): [Process]: Start reading console from nbd-client\nAug 15 12:49:46 intel-obmc virtual-media[312]: [Info    ] [initial_state.hpp:214] operator()(): [App]: Unmount called on Slot_0\nAug 15 12:49:46 intel-obmc virtual-media[312]: [Info    ] [state_machine.hpp:68] emitEvent(): Slot_0 received UnmountEvent while in ActivatingState\nAug 15 12:49:46 intel-obmc virtual-media[312]: [Error   ] [activating_state.hpp:21] handleEvent(): Invalid event: UnmountEvent"
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "line": 319,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "In the above logs I'm seeing ConnectionImpl::close(\"internal error\")\n\nWhich doesn't exist in bmcweb master.  \n\nSame thing with\n\n> [DEBUG \"nbd_proxy.hpp\":329]\n\nWhich doesn't have a print statement on it.  If you've made modifications to this patch, can you push them somewhere that I can seem them?  If not, are you sure that this is the patch you loaded?\n\n\n> there might occur situation when NbdProxyServer instance is not yet created\n\ncan you describe this better?"
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "line": 319,
                    "reviewer": {
                        "name": "Michal Orzel",
                        "email": "michalx.orzel@intel.com",
                        "username": "morzelx"
                    },
                    "message": "> Which doesn't have a print statement on it.  If you've made modifications to this patch, can you push them somewhere that I can seem them?  If not, are you sure that this is the patch you loaded?\n\nThose additional logs have been by me in order to take a closer look on what might fail here. If You want, I'll open another work-in-progress article adding those traces for Your reference - of course with no intention to merge them later as I consider them debug-only.\n\n\n> \n> > there might occur situation when NbdProxyServer instance is not yet created\n> \n> can you describe this better?\n\nI thought that attached logs describe this situation pretty well, but I might have been wrong. If You take a look at them, You'll notice that nbd-proxy.onopen and nbd-proxy.onmessageex start pretty much one after another. OnOpen handler, after confirming that endpoint parameters are OK, creates an instance of NbdProxyServer (nbd_proxy.hpp:267). The problem is that onMessage handler, which has been run on parallel with onOpen, tried to obtain the NbdProxyServer instance in a moment when it had not yet been created. This results with immediate connection close with message \"internal error\" (nbd_proxy.hpp:314-319).\n\nI hope that this describes the situation better."
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "line": 319,
                    "reviewer": {
                        "name": "Michal Orzel",
                        "email": "michalx.orzel@intel.com",
                        "username": "morzelx"
                    },
                    "message": "You can find the insertion of additonal log messages here: https://gerrit.openbmc.org/c/openbmc/bmcweb/+/56587"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "type": "MODIFIED",
                    "insertions": 208,
                    "deletions": -307
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -2
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 75,
                    "deletions": -18
                }
            ],
            "sizeInsertions": 308,
            "sizeDeletions": 327
        },
        {
            "number": 6,
            "revision": "55c7561c62adfa0bd404502b22400078d7d8ac03",
            "parents": [
                "bb759e3aeaadfec9f3aac4485f253bcc8a523e4c"
            ],
            "ref": "refs/changes/28/51428/6",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1665247481,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "include/nbd_proxy.hpp",
                    "type": "MODIFIED",
                    "insertions": 208,
                    "deletions": -307
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -2
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 75,
                    "deletions": -18
                }
            ],
            "sizeInsertions": 308,
            "sizeDeletions": 327
        }
    ]
}