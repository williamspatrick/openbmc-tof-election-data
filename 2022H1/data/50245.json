{
    "project": "openbmc/phosphor-dbus-monitor",
    "branch": "master",
    "id": "I72a49a59e6f3f9fcc24a69b0752cbb7b122be940",
    "number": 50245,
    "subject": "snmp_trap: send AdditionalData contents",
    "owner": {
        "name": "Paul Fertser",
        "email": "fercerpav@gmail.com",
        "username": "paulfertser"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-dbus-monitor/+/50245",
    "commitMessage": "snmp_trap: send AdditionalData contents\n\nThe log messages often contain essential diagnostics information in a\nkey-value list in AdditionalData. Add it in space-separated form to the\nSNMP trap.\n\nSigned-off-by: Paul Fertser <fercerpav@gmail.com>\nChange-Id: I72a49a59e6f3f9fcc24a69b0752cbb7b122be940\n",
    "createdOn": 1641814459,
    "lastUpdated": 1643380940,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1641814459,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1641814478,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1641814478,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1641814506,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/35165/ : FAILURE"
        },
        {
            "timestamp": 1641814852,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1641882845,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1:\n\n(1 comment)\n\nThis change is ready for review."
        },
        {
            "timestamp": 1641882907,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1642067063,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1642341784,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1642341791,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1642342773,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1: Code-Review-1\n\n(1 comment)"
        },
        {
            "timestamp": 1642343651,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1642425881,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1642427179,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1642430328,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1642589395,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1642589411,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1642589412,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1642589496,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/35743/ : SUCCESS"
        },
        {
            "timestamp": 1643002011,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1643316666,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "barton17pb@gmail.com",
                "username": "msbarth"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1643374102,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1643378085,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "barton17pb@gmail.com",
                "username": "msbarth"
            },
            "message": "Patch Set 2: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1643380940,
            "reviewer": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "ef6664dcce7091c0e12e0bec5c6bd60d33f8398e",
            "parents": [
                "0a3fe497b41d4530e0f6ce6f19a8612b41986514"
            ],
            "ref": "refs/changes/45/50245/1",
            "uploader": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "createdOn": 1641814459,
            "author": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Paul Fertser",
                        "email": "fercerpav@gmail.com",
                        "username": "paulfertser"
                    },
                    "message": "Hello,\nA question to those who actually uses phosphor-snmp functionality: what are your typical usecases and why the MIB currently is so rudimentary? Many log messages are essentialy C++ exception type names, without any details, how is this useful for SNMP monitoring in real life?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "MARRI DEVENDER RAO",
                        "email": "devenrao@in.ibm.com",
                        "username": "devenrao"
                    },
                    "message": "what is MIB?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "MARRI DEVENDER RAO",
                        "email": "devenrao@in.ibm.com",
                        "username": "devenrao"
                    },
                    "message": "can you change back to WorkInProgress I somehow overwritten it?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Paul Fertser",
                        "email": "fercerpav@gmail.com",
                        "username": "paulfertser"
                    },
                    "message": "MIB is a machine-readable description of information and its structure for interaction with particular equipment using SNMP. For OpenBMC see https://github.com/openbmc/phosphor-snmp/blob/master/mibs/NotificationMIB.txt . I think this change is ready for review other than needing the sdbusplus change I sent separately."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "MARRI DEVENDER RAO",
                        "email": "devenrao@in.ibm.com",
                        "username": "devenrao"
                    },
                    "message": "some output data in the tested section would have been useful."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "MARRI DEVENDER RAO",
                        "email": "devenrao@in.ibm.com",
                        "username": "devenrao"
                    },
                    "message": "CI is failued due to clang check, do this on your files and pus again.\n\nclang-format-12 -i <file name>\n\ndo check here for the error message https://jenkins.openbmc.org/job/ci-repository/35165/console"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Paul Fertser",
                        "email": "fercerpav@gmail.com",
                        "username": "paulfertser"
                    },
                    "message": "Hello MARRI,\n\nThank you for the review. Where exactly should I add output data to?\n\nI'll do that and fix the CI failure in the next version (will push after the merge_variants_t sdbusplus change is merged).\n\nCan someone who actually uses SNMP traps tell where exactly you're getting them from? Can you please add someone to Reviewers or Cc to clarify this? For my testing I added a hack to phosphor-sel-logger to get at least something remotely useful:\n\n diff --git a/src/sel_logger.cpp b/src/sel_logger.cpp\n index 8368f3b9e8e5..b725a96d2e89 100755\n --- a/src/sel_logger.cpp\n +++ b/src/sel_logger.cpp\n @@ -157,7 +157,7 @@ static uint16_t\n      /*auto entryID = */report<SELCreated>(\n          Created::RECORD_TYPE(selSystemType), Created::GENERATOR_ID(genId),\n          Created::SENSOR_DATA(selDataStr.c_str()), Created::EVENT_DIR(assert),\n -        Created::SENSOR_PATH(path.c_str()));\n +        Created::SENSOR_PATH((path + \" MSG=\\\"\" + message + \"\\\"\").c_str()));\n      //return static_cast<uint16_t>(entryID);\n  \n      unsigned int recordId = getNewRecordId();\n @@ -187,7 +187,7 @@ static uint16_t selAddOemRecord(const std::string& message,\n      /*auto entryID = */report<SELCreated>(\n          Created::RECORD_TYPE(recordType), Created::GENERATOR_ID(0),\n          Created::SENSOR_DATA(selDataStr.c_str()), Created::EVENT_DIR(0),\n -        Created::SENSOR_PATH(\"\"));\n +        Created::SENSOR_PATH((\" MSG=\\\"\" + message + \"\\\"\").c_str()));\n      //return static_cast<uint16_t>(entryID);"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "MARRI DEVENDER RAO",
                        "email": "devenrao@in.ibm.com",
                        "username": "devenrao"
                    },
                    "message": "As per my understanding SNMP traps are send from phosphor-dbus-monitor when and error log object entry is created. you can do that by hacking in some application just to create an error and commit\n\nhttp://fstone07p1.aus.stglabs.ibm.com:8080/source/xref/openbmc/phosphor-hwmon/fan_pwm.cpp?r=6a391de4#35\n\nhere an writefailure error is created and committed, we can fake this in some small app/service and restart it, you can create different error with different data and see how SNMP is getting it."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Paul Fertser",
                        "email": "fercerpav@gmail.com",
                        "username": "paulfertser"
                    },
                    "message": "I know how to add log messages, yes, and with the code in question I was getting SNMP traps like this:\n\n SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: OPENBMC-NOTIFICATION-MIB::obmcErrorNotification        OPENBMC-NOTIFICATION-MIB::obmcErrorID = Gauge32: 101      OPENBMC-NOTIFICATION-MIB::obmcErrorTimestamp = Opaque: UInt64: 16071483831667917181       OPENBMC-NOTIFICATION-MIB::obmcErrorSeverity = INTEGER: 6        OPENBMC-NOTIFICATION-MIB::obmcErrorMessage = STRING: \"xyz.openbmc_project.Logging.SEL.Error.Created EVENT_DIR=1 GENERATOR_ID=32 RECORD_TYPE=2 SENSOR_DATA=05FFFF SENSOR_PATH=/xyz/openbmc_project/sensors/oemdiscreteeventonly/CPU0HostErr MSG=\\\"CPU0HostErr sensor asserted offset 5.\\\" _PID=13246\"\n SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: OPENBMC-NOTIFICATION-MIB::obmcErrorNotification        OPENBMC-NOTIFICATION-MIB::obmcErrorID = Gauge32: 102      OPENBMC-NOTIFICATION-MIB::obmcErrorTimestamp = Opaque: UInt64: 16071484673481507197       OPENBMC-NOTIFICATION-MIB::obmcErrorSeverity = INTEGER: 6        OPENBMC-NOTIFICATION-MIB::obmcErrorMessage = STRING: \"xyz.openbmc_project.Logging.SEL.Error.Created EVENT_DIR=1 GENERATOR_ID=32 RECORD_TYPE=2 SENSOR_DATA=05FFFF SENSOR_PATH=/xyz/openbmc_project/sensors/oemdiscreteeventonly/CPU1HostErr MSG=\\\"CPU1HostErr sensor asserted offset 5.\\\" _PID=13246\"\n SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: OPENBMC-NOTIFICATION-MIB::obmcErrorNotification        OPENBMC-NOTIFICATION-MIB::obmcErrorID = Gauge32: 103      OPENBMC-NOTIFICATION-MIB::obmcErrorTimestamp = Opaque: UInt64: 16071485824532742525       OPENBMC-NOTIFICATION-MIB::obmcErrorSeverity = INTEGER: 6        OPENBMC-NOTIFICATION-MIB::obmcErrorMessage = STRING: \"xyz.openbmc_project.Logging.SEL.Error.Created EVENT_DIR=1 GENERATOR_ID=32 RECORD_TYPE=2 SENSOR_DATA=02FFFF SENSOR_PATH=/xyz/openbmc_project/sensors/oemdiscreteeventonly/GenericHostErr MSG=\\\"GenericHostErr sensor asserted offset 2.\\\" _PID=13246\"\n\nDo people who receive SNMP traps like that from OpenBMC actually find them useful?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "MARRI DEVENDER RAO",
                        "email": "devenrao@in.ibm.com",
                        "username": "devenrao"
                    },
                    "message": "ratan any idea on this?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "src/data_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -3
                },
                {
                    "file": "src/snmp_trap.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 32,
            "sizeDeletions": 6
        },
        {
            "number": 2,
            "revision": "74dc24adab6e83cc3058efc458dd5698933b87b5",
            "parents": [
                "0a3fe497b41d4530e0f6ce6f19a8612b41986514"
            ],
            "ref": "refs/changes/45/50245/2",
            "uploader": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "createdOn": 1642589395,
            "author": {
                "name": "Paul Fertser",
                "email": "fercerpav@gmail.com",
                "username": "paulfertser"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/snmp_trap.cpp",
                    "line": 42,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "barton17pb@gmail.com",
                        "username": "msbarth"
                    },
                    "message": "Not able to use `Entry::AdditionalData` here? I thought dbus arrays were converted to vector types."
                },
                {
                    "file": "src/snmp_trap.cpp",
                    "line": 42,
                    "reviewer": {
                        "name": "Paul Fertser",
                        "email": "fercerpav@gmail.com",
                        "username": "paulfertser"
                    },
                    "message": "I am afraid that is not possible. sdbusplus currently generates only server bindings, so creating an Entry actually means creating a new object on D-Bus. Moreover, in this particular case we do not want a client object attached to some D-Bus server object, we just have a properties map received from a signal. Is this common enough so that you think I should work on adding this functionality to sdbusplus? I'm afraid it's not that easy and straightforward, and not worth the effort for this rare usecase (which seems to be not used by anyone anyway judging by the amount of replies I received asking about the quality of the current MIB structure!)."
                },
                {
                    "file": "src/snmp_trap.cpp",
                    "line": 42,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "barton17pb@gmail.com",
                        "username": "msbarth"
                    },
                    "message": "Ack, no this is fine."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "src/data_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -3
                },
                {
                    "file": "src/snmp_trap.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 34,
            "sizeDeletions": 6
        }
    ]
}