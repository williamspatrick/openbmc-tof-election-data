{
    "project": "openbmc/entity-manager",
    "branch": "master",
    "id": "I38251fec2857923356d324e01af77795186560eb",
    "number": 52249,
    "subject": "fru-device: use off_t/size_t for FRU IO offsets & lengths",
    "owner": {
        "name": "Zev Weiss",
        "email": "zev@bewilderbeest.net",
        "username": "zevweiss"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/entity-manager/+/52249",
    "commitMessage": "fru-device: use off_t/size_t for FRU IO offsets & lengths\n\nWhile the 8-bit and 16-bit types that had been used for these were\nadequate for the small devices typically used for most FRU EEPROMs, some\ndo get within striking distance of the limits of 16-bit types, and we\nmight as well use the more \"natural\" types that are intended for these\nsorts of parameters, which avoid the risk of range problems and signal\nintent more clearly & explicitly.\n\nTested: on an ASRock Rack romed8hm3, fru-device successfully recognizes\nand parses the baseboard FRU EEPROM as it did prior to this patch.\n\nSigned-off-by: Zev Weiss <zev@bewilderbeest.net>\nChange-Id: I38251fec2857923356d324e01af77795186560eb\n",
    "createdOn": 1647991409,
    "lastUpdated": 1651109860,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1647991409,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1647991429,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1647991429,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1647991485,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/39460/ : FAILURE"
        },
        {
            "timestamp": 1647992180,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1647992192,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1647992192,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1647992745,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/39461/ : SUCCESS"
        },
        {
            "timestamp": 1648615366,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1648615377,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648615377,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1648615665,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40080/ : SUCCESS"
        },
        {
            "timestamp": 1648644298,
            "reviewer": {
                "name": "Oskar Senft",
                "email": "osk@google.com",
                "username": "osenft"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1648718361,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1649877978,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1649878068,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1650444957,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1651100557,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1651109860,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Change has been successfully rebased and submitted as 1525e85952d6067df03f473e5ac42c0b1be6d35f"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "530f3c1509d4526670549921c4f35b7195339424",
            "parents": [
                "7135f3d9fef886a3e683b56e0a7f7cfa3f9b47ef"
            ],
            "ref": "refs/changes/49/52249/1",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1647991409,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "include/FruUtils.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                },
                {
                    "file": "src/FruDevice.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -4
                },
                {
                    "file": "test/test_fru-utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -7
                },
                {
                    "file": "src/FruUtils.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 40,
            "sizeDeletions": 24
        },
        {
            "number": 2,
            "revision": "19ee7cd660b708293ba64ac2da2e32a254c4266f",
            "parents": [
                "7135f3d9fef886a3e683b56e0a7f7cfa3f9b47ef"
            ],
            "ref": "refs/changes/49/52249/2",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1647992180,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "include/FruUtils.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                },
                {
                    "file": "src/FruDevice.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -4
                },
                {
                    "file": "test/test_fru-utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": -8
                },
                {
                    "file": "src/FruUtils.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 41,
            "sizeDeletions": 25
        },
        {
            "number": 3,
            "revision": "fc400505db2e6d1342ea3a623a094c2f34daba70",
            "parents": [
                "f8ae2ba5c82f15320176cb15a8598927b2bca6f3"
            ],
            "ref": "refs/changes/49/52249/3",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1648615366,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "include/FruUtils.hpp",
                    "line": 87,
                    "reviewer": {
                        "name": "Oskar Senft",
                        "email": "osk@google.com",
                        "username": "osenft"
                    },
                    "message": "Apologies for having been misleading in prior discussions.\n\nI just read up about the difference between size_t and off_t: \"size_t is part of the C++ (and C) standards, and refers to the type of a sizeof expression. off_t is defined by the Posix standard, and refers to the size of a file.\" and \"off_t is signed whereas size_t is unsigned\" (from https://stackoverflow.com/questions/10634629/what-are-the-usage-differences-between-size-t-and-off-t).\n\nAssuming this is true, I wonder if using size_t for both \"address\" and \"offset\" is really what we should be using? I noticed that there are a few \"uint8_t address\" declarations, which I assume relate to the i2c-device-address, but I'd say that all declarions of \"uint16_t address\" and \"uint16_t offset\" should really be size_t.\n\nThoughts?"
                },
                {
                    "file": "include/FruUtils.hpp",
                    "line": 87,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "> I wonder if using size_t for both \"address\" and \"offset\" is really what we should be using?\n\nYeah, the signedness of off_t is probably unnecessary for what we're likely to be doing with it, but given that it's got plenty of range for FRU EEPROM sized things I don't think it'll ever be a problem, and seems preferable to me in terms of communicating intent.\n\n> I noticed that there are a few \"uint8_t address\" declarations, which I assume relate to the i2c-device-address, but I'd say that all declarions of \"uint16_t address\" and \"uint16_t offset\" should really be size_t.\n\nAfter this patch I don't see any instances of `uint16_t offset` remaining, and I'm pretty sure that all the remaining `uint16_t address` instances are I2C bus addresses -- I2C addresses are typically 8 bits (or 7 really I suppose) but can in some cases be 10 bits, so uint16_t seems like an appropriate type for them (and arguably the `uint8_t address` instances should be converted to it, but I'll leave that for another patchset)."
                },
                {
                    "file": "include/FruUtils.hpp",
                    "line": 87,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Rule of thumb is:\n\nIs this going to be used to index into an stl container (vector, array) or buffer?  Use size_t\n\nIs this going to be used on a hardware interface that has a hard limit or signeness imposed by the standard (ie, i2c only has 7/11 bits of address fields), use the type that best fits the case, or match the type that the underlying sysfs API uses.\n\nIn this case, address is limited to 11 unsigned bits by the standard, so uint16_t makes sense there.  offset is almost certainly going to be used to directly index or slice into some kind of buffer (ie buffer[offset]) so it should probably be size_t.\n\n\nWith the above said, we're wildly inconsistent here.   I do think off_t is the wrong thing to be using when we're not operating on a file.\n\n\n>Yeah, the signedness of off_t is probably unnecessary for what we're likely to be doing with it, but given that it's got plenty of range for FRU EEPROM sized things I don't think it'll ever be a problem, and seems preferable to me in terms of communicating intent.\n\nThe problem becomes when you try to use it on a buffer, now every time you want to do;\n\nbuffer[myOffT], you have to do two range checks, one for < 0 and one for > buffer.size(), and with the compiler options, you have to do a static_cast<size_t>(myOffT) to make the compiler happy with you.  That ends up being kinda messy."
                },
                {
                    "file": "include/FruUtils.hpp",
                    "line": 87,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Oh.... except we are operating on a file in some (most) cases.......   off_t is probably fine then?"
                },
                {
                    "file": "include/FruUtils.hpp",
                    "line": 87,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Alright, so does this patch look OK to proceed with then?  (The other three patches following this one are also still awaiting review/comment replies.)"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "include/FruUtils.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                },
                {
                    "file": "src/FruDevice.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -4
                },
                {
                    "file": "test/test_fru-utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -9
                },
                {
                    "file": "src/FruUtils.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 42,
            "sizeDeletions": 26
        },
        {
            "number": 4,
            "revision": "1525e85952d6067df03f473e5ac42c0b1be6d35f",
            "parents": [
                "1dda2b32c6d87153ae3c2cf06d241ea05efe36ee"
            ],
            "ref": "refs/changes/49/52249/4",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1651109860,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "include/FruUtils.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                },
                {
                    "file": "src/FruDevice.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -4
                },
                {
                    "file": "test/test_fru-utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -9
                },
                {
                    "file": "src/FruUtils.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 42,
            "sizeDeletions": 26
        }
    ]
}