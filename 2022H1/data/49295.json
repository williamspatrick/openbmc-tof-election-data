{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "topic": "remove-priv-noaccess",
    "id": "I76c0a01c152d0019ce0713da013c565ed420d0ad",
    "number": 49295,
    "subject": "Disallow no-access user login",
    "owner": {
        "name": "Sunitha Harish",
        "email": "sunithaharish04@gmail.com",
        "username": "sunharis"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/49295",
    "commitMessage": "Disallow no-access user login\n\nAn authenticated user with the NoAccess role can login but they cannot\nlogout.\n\nThis commit is to block the login for a user with priv-noaccess\nDetails are at https://github.com/openbmc/bmcweb/issues/227\n\nTestedby:\n 1. Create an LDAP user with priv-noaccess. Verify the login attempt fails\n    with accessDenied error\n 2. Verified the other role users can login\n\nSigned-off-by: Sunitha Harish <sunharis@in.ibm.com>\nChange-Id: I76c0a01c152d0019ce0713da013c565ed420d0ad\n",
    "createdOn": 1638537112,
    "lastUpdated": 1648195606,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1638537112,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1638537144,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1638537480,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/31162/ : FAILURE"
        },
        {
            "timestamp": 1638734338,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1638734479,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1638764527,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1638787089,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1638818276,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1640583846,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1640584079,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1640684857,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1640728383,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1641312395,
            "reviewer": {
                "name": "Joseph Reynolds",
                "email": "joseph-reynolds@charter.net",
                "username": "joseph-reynolds"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1641488463,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1641495714,
            "reviewer": {
                "name": "Joseph Reynolds",
                "email": "joseph-reynolds@charter.net",
                "username": "joseph-reynolds"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1641550108,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1641550119,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1641550119,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1641550218,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1641550560,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/35066/ : SUCCESS"
        },
        {
            "timestamp": 1641578305,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1641788168,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1641824214,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1641824848,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1641834672,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1641894095,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1641956759,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1641957066,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1641969453,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1642019549,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1642067715,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1642107125,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1642523373,
            "reviewer": {
                "name": "Alexander Filippov",
                "email": "a.filippov@yadro.com",
                "username": "nest1ing"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1643627853,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1643639429,
            "reviewer": {
                "name": "Alexander Filippov",
                "email": "a.filippov@yadro.com",
                "username": "nest1ing"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1643720221,
            "reviewer": {
                "name": "Alexander Filippov",
                "email": "a.filippov@yadro.com",
                "username": "nest1ing"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1643778704,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1645030150,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1645055206,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1645071560,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1646815668,
            "reviewer": {
                "name": "Alexander Filippov",
                "email": "a.filippov@yadro.com",
                "username": "nest1ing"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1646823286,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Topic set to remove-priv-noaccess"
        },
        {
            "timestamp": 1646824771,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1646834173,
            "reviewer": {
                "name": "Alexander Filippov",
                "email": "a.filippov@yadro.com",
                "username": "nest1ing"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1646924546,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648195205,
            "reviewer": {
                "name": "Asmitha Karunanithi",
                "email": "asmitk01@in.ibm.com",
                "username": "asmithakarun"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1648195219,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648195219,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1648195297,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/39716/ : FAILURE"
        },
        {
            "timestamp": 1648195568,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1648195606,
            "reviewer": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "message": "Abandoned\n\nno-access user will be removed from all layers"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "2c134f69615bef86af325b87debb86f8d5697dd6",
            "parents": [
                "6afb06d91fbf0017840eb9189dc4f8ee771cb046"
            ],
            "ref": "refs/changes/95/49295/1",
            "uploader": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "createdOn": 1638537112,
            "author": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Joseph Reynolds",
                        "email": "joseph-reynolds@charter.net",
                        "username": "joseph-reynolds"
                    },
                    "message": "I think BMCWeb should check if the user trying to log in has the \"Login\" privilege."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Joseph Reynolds",
                        "email": "joseph-reynolds@charter.net",
                        "username": "joseph-reynolds"
                    },
                    "message": "Regardless of if we have disabled user accounts, I think BMCWeb login operations should be enhanced so they only allow the login operation to succeed if the user trying to login has the Redfish Login privilege."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "So long as you mean \"So the user behavior works correctly\" I'm fine with that.  But given that this looks like a phosphor-user-manager failure, I don't want that business logic to be in bmcweb.  If we're on the same page there, great."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 230,
                    "reviewer": {
                        "name": "Joseph Reynolds",
                        "email": "joseph-reynolds@charter.net",
                        "username": "joseph-reynolds"
                    },
                    "message": "Per my proposed design (see notes below), this line of code should be changed to:\nUse the user's role to retrieve the set of Privileges, then check if the \"Login\" privelege is present.   If so then proceed, otherwise error out with \"accessDenied\"."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 230,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Done"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This kind of business logic should not be in bmcweb.  If users with no-access shouldn't be allowed to log in, then they should be rejected by PAM/phosphor-user-manager."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "To be more concrete, this is the check to determine if a user is allowed to log in, using the standard pam mechanisms.\n\nhttps://github.com/openbmc/bmcweb/blob/889ff6943d62762eeaf58824b651d2edaf940d1d/include/pam_authenticate.hpp#L98\n\nIf this is succeeding for NoAccess users that means that phosphor-user-manager has failed its API guarantees, and hasn't disabled the user properly."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Yes Ed. I was also checking in the same lines after pushing the commit. I will check and see how to handle this at the user manager and will update here"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "I made these changes to get the https://github.com/openbmc/bmcweb/blob/master/http/routing.hpp#L1415 logic applied when the redfish session is getting created. This will validate the remote user's privilege while logging in. \n\nI believe the pam authentication does not cover the validation for roles, priv etc for the remote users. Am i missing something here?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> I made these changes to get the https://github.com/openbmc/bmcweb/blob/master/http/routing.hpp#L1415 logic applied when the redfish session is getting created. This will validate the remote user's privilege while logging in. \n> \n> I believe the pam authentication does not cover the validation for roles, priv etc for the remote users. Am i missing something here?\n\nYes.  Pam handles authentication, dbus handles authorization.  If a user should not have access then the user itself should be disabled, and that pam check should fail.\n\nIdeally we shouldn't be using dbus at all for role generation (we previously used only PAM) but a lot of code got stuck in as part of the LDAP work that complicated the design.\n\nIn a perfect world, if we're going to authenticate/authorize over dbus, we should ONLY be using dbus.  If we're using pam, we should ONLY be using pam.  We shouldn't do the pam/dbus hybrid we have now, that's what leads to bugs like this."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Agree. But this will be a considerable effort in re-designing things.\n\nWhat do you think should be the short-term solution for this from the security point of view? \n\nAny 3rd party No-Access user can create many and many login sessions and exhaust the bmc without logging out. Logout logic checks for the user access, and a No-Access user can not perform logout."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> Agree. But this will be a considerable effort in re-designing things.\n\n> \n> What do you think should be the short-term solution for this from the security point of view? \n> \n\nMake sure that phosphor-user-manager properly disables (in linux) no-access users as it should.  bmcweb already checks to see if users are disabled, so if phosphor-user-manager isn't disabling users set to no-access, then clearly something needs fixed there.\n\n> Any 3rd party No-Access user can create many and many login sessions and exhaust the bmc without logging out. Logout logic checks for the user access, and a No-Access user can not perform logout.\n\n\nNo-access users should  ot be given a session at all."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "> bmcweb already checks to see if users are disabled\n\nCan you please point me to the bmcweb code which checks if the users are disabled at the phosphor-user-manager while creating the session?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Please see the reply on this thread that contains the text \"this is the check to determine if a user is allowed to log in\"  I've already pointed you to the code."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Joseph Reynolds",
                        "email": "joseph-reynolds@charter.net",
                        "username": "joseph-reynolds"
                    },
                    "message": "I see two alternate ways to solve this issue.\n\n1. Change the phosphor-user-manager to disable users who have the \"no access\" role.  In this way, Linux PAM account management checks will determine the user should not be allowed to login  because their account is disabled.  As I mentioned in https://github.com/openbmc/bmcweb/issues/227 I still don't understand the purpose for the NoAccess role. Is it okay for such users to be \"disabled\".  That doesn't feel like the right solution to me.\n\n2. Change BMCWeb to add a \"Login\" privilege check as part of its authentication process.  Specifically the proposed design is: if authentication succeeds, then BMCWeb knows the user's role and can retrieve the user's Redfish privileges, and check if the user has the \"Login\" privilege.  This solution feels right to me, and I think it is what Sunitha is proposing."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I never understood the difference in use case between \"no access\" and \"disabled\".  They seem like synonyms.  #1 would be my preference here, as it keeps business logic out of bmcweb, and ensures that all portions of the system work without having to encode specific role logic in every single user facing daemon."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Joseph Reynolds",
                        "email": "joseph-reynolds@charter.net",
                        "username": "joseph-reynolds"
                    },
                    "message": "I don't fully understand the use case for either a no-access account or a disabled account, and my efforts to answer that question are not yet successful.  IMHO, we should get that answer before proceeding with a fix.  Otherwise:\n1. What is the point of having a disabled account?  What is it used for?\n2. For an enabled account which has the no-access role, I believe BMCWeb should handle it in the same way as any other role.  Specifically, after a successful authentication, I believe PAM account management checks should succeed, and the user's privileges should be retrieved.  In this case the privileges will be the empty set.  The login operations should then fail.  <-- That is what I proposed in my comment above.  Specifically, the login operation(s) should ensure the user trying to login has the Redfish Login privilege."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Did changes as per the #2 approach. The first approach can be a long term solution, and need community help in getting that design implemented."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "So is this patch no longer required?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Yes - needed since the current design is to contain the check at bmcweb. The design #2"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "#1 from above would be my preference. \n\n> Did changes as per the #2 approach. The first approach can be a long term solution, and need community help in getting that design implemented.\n\n> Yes - needed since the current design is to contain the check at bmcweb. The design #2\n\nOkay, I still don't understand why this patch is still needed.? You mentioned this is the current design but sounds like we are in agreement on moving forward with #1? You want this as a short term solution? why? How is this a bad enough bug to merit that?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "At the routing.hpp ; bmcweb relays on the user-manager dbus calls to see if the user at the incoming request is authorized or not using the same logic which i have implemented in this commit. \n\nI am doing this - because, while creating the session, there is no authorization check for the user at the currently available pam library authentication mechanism. As mentioned in the previous discussions, the authentication is with pam library and authorization is with the user-manager app(dbus)\n\nThe #1 solution needs an agreement with the phosphor-user-manager maintainers and a bit more re-design of the authorization checks. This needs more analysis and time. I am not an expert in that areas. Thus i would like to go ahead with this #2, until we have that #1 concluded. We already have this similar check at routing.hpp - so its not a new thing at bmcweb.\n\nI think this commit and the routing.hpp can be re-visited together when the user-manager has the required changes to disable the no-access user and link the pam module to the same."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> Okay, I still don't understand why this patch is still needed.? \n\n+1\n\n\n> \n> The #1 solution needs an agreement with the phosphor-user-manager maintainers and a bit more re-design of the authorization checks. This needs more analysis and time. I am not an expert in that areas.\n\nHave you engaged with the relevant experts (ie maintainers of phosphor-user-management)?  I don't see them commenting on this review.  I've added them so they can comment.\n\n\n\n> I don't fully understand the use case for either a no-access account or a disabled account, and my efforts to answer that question are not yet successful.\n\nUser disabled I can understand if you're an admin that wants to temporarily remove access from a user without blowing away their credentials or something.  What I don't understand is why you need both user disabled and NoAccess, as they're essentially synonyms. \nI propose we remove the NoAccess user role, given that it's redundant to user disabled, and given that this patch exists, has never worked as designed.  That seems simpler than trying to go through complex patches to make something work that's redundant and has better solutions."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ratan Gupta",
                        "email": "ratankgupta31@gmail.com",
                        "username": "ratagupt"
                    },
                    "message": "Priv-Noaccess is coming from IPMI world where user is enabled but no-access, Richard can explain more here.\n\nFollowing commits which were used to add the code related to the priv-noaccess in user-manager and bmcweb.\n \nhttps://github.com/openbmc/bmcweb/commit/e9e6d240ab85e515f8d264e39b47a75043b73374\nhttps://github.com/openbmc/phosphor-user-manager/commit/7c6e7cffaf061aabfe5489ef52442e2f7cbd0fb7\n\n\nEarlier in phosphor-user-manager priv-noaccess was not there and If user has been created with IPMI interface with no privileges that was creating issues for the Redfish where user exists but it's privileges not exist in Redfish All privileges property.\n\nHence the above two commits were added to support the priv-noaccess."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Thanks Ratan, that means that we can not remove this priv. \nRatan/Richard - Please suggest a way user-manager can contain this change as suggested by Ed."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Ratan, can you be more specific?  section 6.8 of IPMI shows Callback, User, Operator, and Administrator privilege level.  There is no \"no access\" privilege that I'm seeing. Can you please point to where in the spec you're looking?\n\n\n\n> Earlier in phosphor-user-manager priv-noaccess was not there and If user has been created with IPMI interface with no privileges that was creating issues for the Redfish where user exists but it's privileges not exist in Redfish All privileges property.\n\nI'm not understanding why that would be an issue.  A user that has no role should be given no privileges.  This change arguably caused the bug that Sunitha is trying to fix in this patch.\n\n\nI'm still of the opinion that this is a phosphor-user-manager bug.  NoAccess users should not be able to pass a PAM authentication check, which is checking for whether they have access.  Ratan, can you please speak to that point?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ratan Gupta",
                        "email": "ratankgupta31@gmail.com",
                        "username": "ratagupt"
                    },
                    "message": "> Ratan, can you be more specific?  section 6.8 of IPMI shows Callback, User, Operator, and Administrator privilege level.  There is no \"no access\" privilege that I'm seeing. Can you please point to where in the spec you're looking?\n\nI will let Richard to reply on the same, whether the IPMI callback is mapped to priv-noaccess.\n\n> Earlier in phosphor-user-manager priv-noaccess was not there and If user has been created with IPMI interface with no privileges that was creating issues for the Redfish where user exists but it's privileges not exist in Redfish All privileges property.\n\nI'm not understanding why that would be an issue.  A user that has no role should be given no privileges.  This change arguably caused the bug that Sunitha is trying to fix in this patch.\n\n\nOn Redfish, User exist but with no privilege. Are you saying that is/was not an issue wrt Redfish?\n\n> I'm still of the opinion that this is a phosphor-user-manager bug.  NoAccess users should not be able to pass a PAM authentication check, which is checking for whether they have access.  Ratan, can you please speak to that point?\n\nWhat is the phopshor-user-manager bug here? Pam authentication is not going through phosphor-user-manager.\n\nAre you saying that we should introduce a new pam module which should check for the role of the user and allow the pam module(pam_unix.so) to be proceed further if the role is != no access.\n\nCurrently following is the pam configuration file for the bmcweb(supplied by the bmcweb)\n\nhttps://github.com/openbmc/bmcweb/blob/master/pam-webserver\n\n#%PAM-1.0\n\nauth     include  common-auth\n# skip redfish group check for non-local user (ldap)\nauth     [success=ok perm_denied=1 default=ignore] pam_localuser.so\nauth     required pam_succeed_if.so user ingroup redfish\naccount  include  common-account\npassword include  common-password\n\nAs per the above configuration file we are not adding any custom pam module here.\n\nAre you proposing that we should introduce a new pam module and all the callers pam configuration file will add that module in their configuration so during pam_authentication check it will fail for those users which have the no access role."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> > Ratan, can you be more specific?  section 6.8 of IPMI shows Callback, User, Operator, and Administrator privilege level.  There is no \"no access\" privilege that I'm seeing. Can you please point to where in the spec you're looking?\n> \n> I will let Richard to reply on the same, whether the IPMI callback is mapped to priv-noaccess.\n\nLooking forward to him jumping on this thread.\n\n> \n> > Earlier in phosphor-user-manager priv-noaccess was not there and If user has been created with IPMI interface with no privileges that was creating issues for the Redfish where user exists but it's privileges not exist in Redfish All privileges property.\n> \n> I'm not understanding why that would be an issue.  A user that has no role should be given no privileges.  This change arguably caused the bug that Sunitha is trying to fix in this patch.\n\nThe problem becomes that a user is given no privileges, but is still able to log in, which causes a bug where they're not able to log out, because they have no privileges.  IMO, NoAccess users should not be allowed to log in at all.\n\n> \n> \n> On Redfish, User exist but with no privilege. Are you saying that is/was not an issue wrt Redfish?\n\nI'm saying this was an issue that was created when the \"NoAccess\" privilege level was added, outside of what the defaults in redfish promote.\n\n> \n> > I'm still of the opinion that this is a phosphor-user-manager bug.  NoAccess users should not be able to pass a PAM authentication check, which is checking for whether they have access.  Ratan, can you please speak to that point?\n> \n> What is the phopshor-user-manager bug here? Pam authentication is not going through phosphor-user-manager.\n\nNo, but it's going through the user database, which phosphor-user-manager controls.  The bug is that phosphor-user-manager is not disabling NoAccess users accounts, so they can still log in.\n\n> \n> Are you saying that we should introduce a new pam module which should check for the role of the user and allow the pam module(pam_unix.so) to be proceed further if the role is != no access.\n\nNo.  The users account should be disabled or locked in linux.\n\n> \n> Currently following is the pam configuration file for the bmcweb(supplied by the bmcweb)\n> \n> https://github.com/openbmc/bmcweb/blob/master/pam-webserver\n> \n> #%PAM-1.0\n> \n> auth     include  common-auth\n> # skip redfish group check for non-local user (ldap)\n> auth     [success=ok perm_denied=1 default=ignore] pam_localuser.so\n> auth     required pam_succeed_if.so user ingroup redfish\n> account  include  common-account\n> password include  common-password\n> \n> As per the above configuration file we are not adding any custom pam module here.\n> \n\ncommon-account and common-password (which are included above) are provided by the greater project, and provide custom pam modules, including some from phosphor-user-manager.  See the meta-phosphor layer for more details on them.  With that said, this file only gets invoked for pam_authenticate, not for checking the health of the user account that I posted earlier in this thread.\n\n> Are you proposing that we should introduce a new pam module and all the callers pam configuration file will add that module in their configuration so during pam_authentication check it will fail for those users which have the no access role.\n\nNo, I'm proposing that users that are given a \"NoAccess\" role should be disabled, such that the pam health check that I linked above fails.  This should just require phosphor-user-manager to properly adjust the users enabled-ness."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ratan Gupta",
                        "email": "ratankgupta31@gmail.com",
                        "username": "ratagupt"
                    },
                    "message": "> The problem becomes that a user is given no privileges, but is still able to log in, which causes a bug where they're not able to log out, because they have no privileges.  IMO, NoAccess users should not be allowed to log in at all.\n\nWhy do we need such user which is not having any privilege, Why to create a user that all?\nIf somebody is creating a user with no privilege and user manager makes that user disable that doesn't make sense(it is of no use), Instead of we should not allow that user to be created.\n\nBut seems we need to understand from the IPMI perspective too, why do we need such user?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> > The problem becomes that a user is given no privileges, but is still able to log in, which causes a bug where they're not able to log out, because they have no privileges.  IMO, NoAccess users should not be allowed to log in at all.\n> \n> Why do we need such user which is not having any privilege, Why to create a user that all?\n\nI asked this question earlier when I asked why NoAccess is distinct from disabled.  There is an enterprise case for disabling someones access temporarily, given that user passwords are hashed on the device, you generally can't destroy and create a user losslessly, so instead there's a way to disable a given user for a period of time without destroying their credentials.\n\n> If somebody is creating a user with no privilege and user manager makes that user disable that doesn't make sense(it is of no use), Instead of we should not allow that user to be created.\n\nThat would be fine too if we just want to disallow NoAccess users from existing.\n\n> \n> But seems we need to understand from the IPMI perspective too, why do we need such user?\n\n+1"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Alexander Filippov",
                        "email": "a.filippov@yadro.com",
                        "username": "nest1ing"
                    },
                    "message": "It seems to me the IPMI spec was wrongly interpreted. `NO ACCESS` says that the user has no access to the specified channel, but doesn't describe his global privilege.\n\nMy proposal (likely Offtopic for this PR):\n- `no-access` role should be removed from BMC at all.\n   There is the users disabling, that already properly works even through IPMI.\n- Default minimal privilege in the BMC should be `read-only`.\n  It solves the issue for LDAP users which ones are not members of groups mapped to BMC roles.\n- Users that really shouldn't have access to the BMC can be just disabled."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Thanks Alex for sharing your thoughts. \n\nShould the support for no-access user be removed from the bmcweb ? Meaning revert these 2 commits https://github.com/openbmc/bmcweb/commit/e9e6d240ab85e515f8d264e39b47a75043b73374\nhttps://github.com/openbmc/phosphor-user-manager/commit/7c6e7cffaf061aabfe5489ef52442e2f7cbd0fb7\n\nI am a bit clueless here as how to proceed."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Alexander Filippov",
                        "email": "a.filippov@yadro.com",
                        "username": "nest1ing"
                    },
                    "message": "I suppose those two commits should definitely be reverted, but I suspect there are more places where the support for no-access should be removed.\n\nI guess `phosphor-host-ipmi` also requires some reworking to make it properly handling the command like `ipmitool user priv <user-id> 0xF [channel-id]`.\nAnd I see here two possible ways:\n - reject this request with the correct completion code. For example 0xC9 (Param is out of range).\n - rework the code to set the correct permissions for the current or specified IPMI channel without modifying the user's global role.\n \nLDAP users can still have no valid roles and this should be properly handled.\nAs one of the possible solutions is using `priv-user` instead of undefined role.\nBut most likely it would be more correct and securely to filter the such users at the PAM level, as it proposed Ed."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Alexander Filippov",
                        "email": "a.filippov@yadro.com",
                        "username": "nest1ing"
                    },
                    "message": "I've pushed the proposed changes for phosphor-host-ipmid:\n  https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-host-ipmid/+/50824\n  https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-host-ipmid/+/50825"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Ed & Ratan, any thoughts ?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ratan Gupta",
                        "email": "ratankgupta31@gmail.com",
                        "username": "ratagupt"
                    },
                    "message": "Sunitha, I don't see any activity on the phospho-host-ipmid commits, If those patches gets in, Then you can remove the support of priv access from the user-manager and you need to make the necessary changes in the bmcweb too.\n\nEd, is that fine to you too?"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Removing no-access entirely from bmcweb is I think what I proposed elsewhere, and based on the above discussion, yes, is what I think we should do."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Excellent! Thank you\nLets wait for the phosphor-host-ipmid commits to get merged, and then I can revert the bmcweb commits which added the no access user to bmcweb scope."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Alexander Filippov",
                        "email": "a.filippov@yadro.com",
                        "username": "nest1ing"
                    },
                    "message": "> Lets wait for the phosphor-host-ipmid commits to get merged, and then I can revert the bmcweb commits which added the no access user to bmcweb scope.\n\nI guess it's time. ;)\nCould you push these pull-requests with a topic `remove-priv-noaccess`?\nI guess it will improve understanding of our intentions."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Done Alex."
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Alexander Filippov",
                        "email": "a.filippov@yadro.com",
                        "username": "nest1ing"
                    },
                    "message": "I meant pull-requests that you mentioned earlier:\n\n> Should the support for no-access user be removed from the bmcweb ? Meaning revert these 2 commits https://github.com/openbmc/bmcweb/commit/e9e6d240ab85e515f8d264e39b47a75043b73374\n> https://github.com/openbmc/phosphor-user-manager/commit/7c6e7cffaf061aabfe5489ef52442e2f7cbd0fb7"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "Got it ! Sure i will do this by next week"
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Sunitha Harish",
                        "email": "sunithaharish04@gmail.com",
                        "username": "sunharis"
                    },
                    "message": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-user-manager/+/52363\nhttps://gerrit.openbmc-project.xyz/c/openbmc/bmcweb/+/52365/\n\nare created with the same topic"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "type": "MODIFIED",
                    "insertions": 113,
                    "deletions": -66
                }
            ],
            "sizeInsertions": 134,
            "sizeDeletions": 66
        },
        {
            "number": 2,
            "revision": "b6059bfa7afa4e2c9c4f428528a29affc3de8163",
            "parents": [
                "e1cc482880d7b47dcf19609cedba7df80368ae3c"
            ],
            "ref": "refs/changes/95/49295/2",
            "uploader": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "createdOn": 1641550108,
            "author": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "type": "MODIFIED",
                    "insertions": 117,
                    "deletions": -66
                }
            ],
            "sizeInsertions": 138,
            "sizeDeletions": 66
        },
        {
            "number": 3,
            "revision": "e4a6ac053a4605b071ed64f473cf9797a68fb703",
            "parents": [
                "e76cd86812f29f1153a50c7de177945c7e4fb3e3"
            ],
            "ref": "refs/changes/95/49295/3",
            "uploader": {
                "name": "Asmitha Karunanithi",
                "email": "asmitk01@in.ibm.com",
                "username": "asmithakarun"
            },
            "createdOn": 1648195205,
            "author": {
                "name": "Sunitha Harish",
                "email": "sunithaharish04@gmail.com",
                "username": "sunharis"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/redfish_sessions.hpp",
                    "type": "MODIFIED",
                    "insertions": 128,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 149,
            "sizeDeletions": 4
        }
    ]
}