{
    "project": "openbmc/openbmc",
    "branch": "master",
    "id": "I76ecc49d9a77fc4846b71f1f1ce5398ca3873d72",
    "number": 53494,
    "subject": "meta-phosphor: initrdscript: Monotonic date setting",
    "owner": {
        "name": "William A. Kennington III",
        "email": "wak@google.com",
        "username": "wak-google"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openbmc/+/53494",
    "commitMessage": "meta-phosphor: initrdscript: Monotonic date setting\n\nThis change intends to make the BMC date monotonic with respect to each\npowercycle or reboot. It's not a perfect mechanism for maintaining\naccurate time, but it's better than resetting to the epoch every single\nreboot.\n\nChange-Id: I76ecc49d9a77fc4846b71f1f1ce5398ca3873d72\nSigned-off-by: William A. Kennington III <wak@google.com>\n",
    "createdOn": 1651683848,
    "lastUpdated": 1655929897,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1651683848,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1651683928,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1651683933,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1651683936,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/10684/"
        },
        {
            "timestamp": 1651683941,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1651684011,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1651684011,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1651684014,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/10684/ : ABORTED"
        },
        {
            "timestamp": 1651684021,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/10685/"
        },
        {
            "timestamp": 1651685070,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/10685/ : SUCCESS"
        },
        {
            "timestamp": 1651686295,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1651686337,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1651686929,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1651686993,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1651686993,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1651686996,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1651687001,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/10686/"
        },
        {
            "timestamp": 1651687232,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1651688029,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/10686/ : SUCCESS"
        },
        {
            "timestamp": 1651689227,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 3:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1651704911,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1651709373,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1651720363,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1652224689,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1652812091,
            "reviewer": {
                "name": "John Broadbent",
                "email": "jebr@google.com",
                "username": "jebr224"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1655847449,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1655848715,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1655849068,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1655852319,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1655929540,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1655929897,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "6eb5143f374b270dd1f6530e62c563350e0f8f1d",
            "parents": [
                "cb3143ef9e4208485e2a6259db54fa7bd99060a0"
            ],
            "ref": "refs/changes/94/53494/1",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1651683848,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 22,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "c13a664f9e21150f05510ee8f8e4c56d8e9bdd38",
            "parents": [
                "cb3143ef9e4208485e2a6259db54fa7bd99060a0"
            ],
            "ref": "refs/changes/94/53494/2",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1651683941,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 417,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Don't we only need to do this for systems which don't have a HW-RTC?  If you have a HW-RTC, how do you avoid overwriting it with this code?"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 417,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "I assumed this was done later in the boot process, fixed it to account for existing good date / time."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 417,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "We could also arguably use some kind of measure based on `date +%s` being near 0. (Maybe within 3600 seconds or something to be safe)"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 22,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "62674caac99ba8be02b0f8bc3e59a4d41ba2de47",
            "parents": [
                "cb3143ef9e4208485e2a6259db54fa7bd99060a0"
            ],
            "ref": "refs/changes/94/53494/3",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1651686929,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "John Broadbent",
                        "email": "jebr@google.com",
                        "username": "jebr224"
                    },
                    "message": "Looks fine to me"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Sorry I wrote 95% of this in May and never pressed the reply button.  I did update my comments on the chosen files."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "This can be useful to make sure the BMC's time is inline with the TLS certificate's validate dates.\n\nI don't think any certificate will be accepted if the date is 1970."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "maybe this is not an issue. so ignore it. Still good to have this anyway."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Is there any possibility of an unreasonable time that we want to take care to avoid?  My only suspect would be file system corruption that pushes the date to 3022."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Maybe, although I'm hesitant to actually try and perform such restrictions as we don't know how long an image will validly run in the wild and we don't know if the build environment / source of time is really old for determinism purposes (some people build at epoch to guarantee consistency)."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "there's already some anti rollback in systemd but it's been years since I read it.  can you check? \n\nthis feels like something that should be suppressed under the runtime options see line 227 for an example\n\nalso what's the benefit to looking before the overlay is mounted?   wouldn't the paths be simpler after it's mounted?"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "AFAIK I have no idea where that support lives and none of the typical keywords work to locate it. If you have a better idea that would be nice. That said, I don't see why this would conflict with that support in an undesirable way.\n\nAre you asking to add an option to suppress it?\n\nI wanted to guarantee we don't update any mtimes of files in the cow region. I don't think it's a big deal either way, but I wanted to guarantee we read a file from the ro image and not a clone with an updated mtime + rwfs file."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "ok it's in me to search if systemd has anything.\n\nyes I'm asking for a configuration to skip this feature (stat and time)\n\n\nlooking again, find sort tail when there are exactly two files might be a bit excessive.  can we just call stat twice and choose?\n\nWe should check the timestamp of the real copy in /usr/lib not the symlink from /etc to avoid one more place we need to change.\n\nThe random-seed is written at boot not near shutdown but I'm not sure there is a better file to stat."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Imo using find is nice because is it concise compared to the alternative\n```\ntime=0\nfor file in $upper/var/lib/systemd/random-seed $rodir/etc/os-release; do\n  [ -e $file ] || continue\n  ctime=$(stat -c %Y $file)\n  [ $ctime -gt $time ] && time=$ctime\ndone\n```\n\nSure I can use /usr/lib/os-release, it is pointing at the $rodir though so it couldn't be mutated either way.\n\nYeah, I don't have a better idea for a file in the rwfs to use without just scanning all of it."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "maybe var/log ?  still multiple files"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "line": 421,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Yeah, it could be something to add. Our systems don't necessarily store anything there though which is why random-seed was the most reliable. I don't think anyone is filling all of /var/log with tons of small files so it should be fine."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 25,
            "sizeDeletions": 0
        }
    ]
}