{
    "project": "openbmc/dbus-sensors",
    "branch": "master",
    "id": "I923bcb809be023c4fa94dadf4f873e0ad860edb9",
    "number": 54467,
    "subject": "Fix for PSU2 Power-lost RedFish events",
    "owner": {
        "name": "Jayaprakash Mutyala",
        "email": "mutyalax.jayaprakash@intel.com",
        "username": "jayaprakashmutyala"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/dbus-sensors/+/54467",
    "commitMessage": "Fix for PSU2 Power-lost RedFish events\n\nIn a dual power supply system, after Removing the PSU2 power\ncable/module, power-lost RedFish events are not getting logged in the\nRedFish logs. Only SEL entries are getting logged for PSU2. But all the\nevents are getting logged for PSU1 in the redfish logs.\n\nTo get PSU2 events also, replace async_wait instead of async_read_until\nwhile reading the hwmon files.\n\nTested:\n1. The system should have connected with dual PSU's which are drawing\nsame power.\n2. Verified both PSU are connected by executing below ipmitool command.\n\"ipmitool fru\"\n3. Removed one of 1600W PSU, which server holding 2 PSU's drawing 1600W.\n4. Above step try for both PSU1 and PSU2 by removing and connecting.\n5. Verified for both PSU1 and PSU2, eventlogs generated on Redfish\nrespectively.\nGet: https://<BMC-IP>/redfish/v1/Systems/system/LogServices/\n             EventLog/Entries\n\nSigned-off-by: Jitendra Tripathy <jitendra.kumarx.tripathy@intel.com>\nSigned-off-by: Jayaprakash Mutyala <mutyalax.jayaprakash@intel.com>\nChange-Id: I923bcb809be023c4fa94dadf4f873e0ad860edb9\n",
    "createdOn": 1654847424,
    "lastUpdated": 1656441658,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1654847424,
            "reviewer": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1654847443,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1654847443,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1654847457,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/44785/ : FAILURE"
        },
        {
            "timestamp": 1654847767,
            "reviewer": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1654847806,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1654847811,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1654847989,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/44786/ : SUCCESS"
        },
        {
            "timestamp": 1655137084,
            "reviewer": {
                "username": "vikash-chandola"
            },
            "message": "Patch Set 2:\n\n(3 comments)"
        },
        {
            "timestamp": 1655137375,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1655481291,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1655492952,
            "reviewer": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1655492966,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1655492966,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1655493568,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/45263/ : SUCCESS"
        },
        {
            "timestamp": 1655494528,
            "reviewer": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "message": "Patch Set 3:\n\n(4 comments)"
        },
        {
            "timestamp": 1655498885,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1655814199,
            "reviewer": {
                "username": "vikash-chandola"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1656392940,
            "reviewer": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1656437993,
            "reviewer": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1656441658,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "4017fec0074a70bdfe9db615446d4b5699685eda",
            "parents": [
                "dccd1d4b1189ef3aece98f4c9c0a44aa3cf7f9ec"
            ],
            "ref": "refs/changes/67/54467/1",
            "uploader": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "createdOn": 1654847424,
            "author": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 30,
                    "deletions": 0
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -21
                }
            ],
            "sizeInsertions": 47,
            "sizeDeletions": 21
        },
        {
            "number": 2,
            "revision": "8e5caeacdb67b47a6be146ebea5454d65fbb1703",
            "parents": [
                "dccd1d4b1189ef3aece98f4c9c0a44aa3cf7f9ec"
            ],
            "ref": "refs/changes/67/54467/2",
            "uploader": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "createdOn": 1654847767,
            "author": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 31,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Can you please take a look at the io_uring patches still in review, and see if they solve your problem.  They're intended to make async filesystems reads more correct."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 31,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "@Ed is this the one you are referring: https://gerrit.openbmc.org/c/openbmc/dbus-sensors/+/46918"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 31,
                    "reviewer": {
                        "name": "Jayaprakash Mutyala",
                        "email": "mutyalax.jayaprakash@intel.com",
                        "username": "jayaprakashmutyala"
                    },
                    "message": "We try to build with this change. Currently getting build error. So not applied on this change."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 31,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Did you try with both:\nhttps://gerrit.openbmc.org/c/openbmc/openbmc/+/46919\nand \nhttps://gerrit.openbmc.org/c/openbmc/dbus-sensors/+/46918\n\n?  Both are required to make io_uring work."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 31,
                    "reviewer": {
                        "name": "Jayaprakash Mutyala",
                        "email": "mutyalax.jayaprakash@intel.com",
                        "username": "jayaprakashmutyala"
                    },
                    "message": "@Ed, we tried by applying both the patches in our build. But still getting build error. Shall we proceed without io_uring patches for now."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 31,
                    "reviewer": {
                        "name": "Jayaprakash Mutyala",
                        "email": "mutyalax.jayaprakash@intel.com",
                        "username": "jayaprakashmutyala"
                    },
                    "message": "@Ed, Please ignore above comment.  With io_uring changes itself PSU events are logged correctly in redfish logs. So Current patch changes not required. We have verified with your patches. Working fine.\nhttps://gerrit.openbmc.org/c/openbmc/openbmc/+/46919\nand \nhttps://gerrit.openbmc.org/c/openbmc/dbus-sensors/+/46918\n\nSo shall we abandon this change.?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 31,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> So shall we abandon this change.?\n\nI think io-uring is the right thing to do, and it's meant to solve this problem."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 221,
                    "reviewer": {
                        "username": "vikash-chandola"
                    },
                    "message": "I think we can drop readBuf from class atributes as well. handleResponse is creating a local variable and updating value with that."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 221,
                    "reviewer": {
                        "name": "Jayaprakash Mutyala",
                        "email": "mutyalax.jayaprakash@intel.com",
                        "username": "jayaprakashmutyala"
                    },
                    "message": "Removed now. Thanks"
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 244,
                    "reviewer": {
                        "username": "vikash-chandola"
                    },
                    "message": "This part is outside patch but I think it will be good if we can put a error message here. In case read loop stop because of this error it will just silently stop updates without any log in journal. Maintainers can suggest if it's good to have."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 244,
                    "reviewer": {
                        "name": "Jayaprakash Mutyala",
                        "email": "mutyalax.jayaprakash@intel.com",
                        "username": "jayaprakashmutyala"
                    },
                    "message": "Added cout statement. Thanks"
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 256,
                    "reviewer": {
                        "username": "vikash-chandola"
                    },
                    "message": "What if sensor that is being monitored is not boolean or store integer value that is more than one characters long. In that case current fix will only read first character and leave rest for next read cycle. Won't that will be misleading ?"
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 256,
                    "reviewer": {
                        "name": "Jayaprakash Mutyala",
                        "email": "mutyalax.jayaprakash@intel.com",
                        "username": "jayaprakashmutyala"
                    },
                    "message": "Fixed by taking variable \"psuBufLen\". Please confirm on this change. Thanks"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 30,
                    "deletions": 0
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 42,
            "sizeDeletions": 16
        },
        {
            "number": 3,
            "revision": "0842952210a5c74f5bdf07eec91b01a07a81d551",
            "parents": [
                "dccd1d4b1189ef3aece98f4c9c0a44aa3cf7f9ec"
            ],
            "ref": "refs/changes/67/54467/3",
            "uploader": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "createdOn": 1655492952,
            "author": {
                "name": "Jayaprakash Mutyala",
                "email": "mutyalax.jayaprakash@intel.com",
                "username": "jayaprakashmutyala"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "username": "vikash-chandola"
                    },
                    "message": "LGTM"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 31,
                    "deletions": 0
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "type": "MODIFIED",
                    "insertions": 0,
                    "deletions": -1
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 16,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 47,
            "sizeDeletions": 17
        }
    ]
}