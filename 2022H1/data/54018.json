{
    "project": "openbmc/openpower-occ-control",
    "branch": "master",
    "id": "Ifd91cfc063718e484ec8886df8357d115c6b41e3",
    "number": 54018,
    "subject": "Log a PEL for communication, presence mismatch, and safe state errors",
    "owner": {
        "name": "Edward A. James",
        "email": "eajames@us.ibm.com",
        "username": "eddiejames"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openpower-occ-control/+/54018",
    "commitMessage": "Log a PEL for communication, presence mismatch, and safe state errors\n\nAdd code to log a PEL in various error scenarios. Refactor some of the\nerror handling to get the return code out of the driver.\n\nSigned-off-by: Eddie James <eajames@linux.ibm.com>\nChange-Id: Ifd91cfc063718e484ec8886df8357d115c6b41e3\n",
    "createdOn": 1653511559,
    "lastUpdated": 1654004775,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1653511559,
            "reviewer": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1653511601,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1653511601,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1653511632,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/43823/ : FAILURE"
        },
        {
            "timestamp": 1653511977,
            "reviewer": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1653512036,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1653512036,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1653512169,
            "reviewer": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "message": "Patch Set 2: Ok-To-Test+1"
        },
        {
            "timestamp": 1653512169,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/43824/ : ABORTED"
        },
        {
            "timestamp": 1653512307,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/43825/ : SUCCESS"
        },
        {
            "timestamp": 1653517942,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1653579538,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(6 comments)"
        },
        {
            "timestamp": 1653580250,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1653592480,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1653680168,
            "reviewer": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "message": "Patch Set 2:\n\n(5 comments)"
        },
        {
            "timestamp": 1653680549,
            "reviewer": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1653680625,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1653680625,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1653680716,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/43991/ : SUCCESS"
        },
        {
            "timestamp": 1653685530,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(2 comments)"
        },
        {
            "timestamp": 1654004772,
            "reviewer": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "message": "Patch Set 3: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1654004775,
            "reviewer": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "f91944d165ed8ccd3f6786e041a68e8b9fed4d56",
            "parents": [
                "c8dd45999f3f284b791eb226d0643e35a403c079"
            ],
            "ref": "refs/changes/18/54018/1",
            "uploader": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "createdOn": 1653511559,
            "author": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "occ_ffdc.cpp",
                    "type": "MODIFIED",
                    "insertions": 56,
                    "deletions": -3
                },
                {
                    "file": "occ_status.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -2
                },
                {
                    "file": "occ_device.hpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -7
                },
                {
                    "file": "occ_status.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -2
                },
                {
                    "file": "occ_ffdc.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "occ_errors.hpp",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -2
                },
                {
                    "file": "occ_errors.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -5
                },
                {
                    "file": "occ_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -2
                },
                {
                    "file": "occ_presence.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "occ_device.cpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -6
                },
                {
                    "file": "occ_presence.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 177,
            "sizeDeletions": 31
        },
        {
            "number": 2,
            "revision": "1fcfce2cd39d51361de6aa2b9d6e50728fb2a298",
            "parents": [
                "c8dd45999f3f284b791eb226d0643e35a403c079"
            ],
            "ref": "refs/changes/18/54018/2",
            "uploader": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "createdOn": 1653511977,
            "author": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "occ_device.cpp",
                    "line": 94,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Looks like the OCC repo uses its own ReadFailure errors, like over in powermode.cpp:\n\nusing namespace sdbusplus::org::open_power::OCC::Device::Error;\n\n\n            report<ReadFailure>(\n                phosphor::logging::org::open_power::OCC::Device::ReadFailure::\n                    CALLOUT_ERRNO(readErrno),\n                phosphor::logging::org::open_power::OCC::Device::ReadFailure::\n                    CALLOUT_DEVICE_PATH(ipsStatusFile.c_str()));\n\nI think it would be best to just use that one here - \n\"org.open_power.OCC.Device.ReadFailure\"\n\nHowever, I don't see it in the message registry, so it would need to be added."
                },
                {
                    "file": "occ_device.cpp",
                    "line": 94,
                    "reviewer": {
                        "name": "Edward A. James",
                        "email": "eajames@us.ibm.com",
                        "username": "eddiejames"
                    },
                    "message": "Done"
                },
                {
                    "file": "occ_errors.hpp",
                    "line": 18,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "currently the OCC uses the 'old style' error logging with those commit/report APIs where the errors have to be defined in YAML - ./org/open_power/OCC/Device.errors.yaml\n\nto be consistent, it seems like these new errors should be defined there, though functionally that report() API is a bit of a bummer because it uses the journal for IPC and many times the log daemon has to restart the journal daemon just to get the metadata fields to show up so it can get them into an error log, so I don't think we'd need to actually use it."
                },
                {
                    "file": "occ_errors.hpp",
                    "line": 18,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "Should we use the \"new style\"? for these errors and then migrate the old to the new in a later release?"
                },
                {
                    "file": "occ_errors.hpp",
                    "line": 18,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "That's fine with me."
                },
                {
                    "file": "occ_errors.hpp",
                    "line": 18,
                    "reviewer": {
                        "name": "Edward A. James",
                        "email": "eajames@us.ibm.com",
                        "username": "eddiejames"
                    },
                    "message": "Ack"
                },
                {
                    "file": "occ_ffdc.cpp",
                    "line": 101,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "this is support to be just the raw errno in case the  error handling code would want to do something different based on it.\nMaybe down below you can emplace the string meaning of it."
                },
                {
                    "file": "occ_ffdc.cpp",
                    "line": 101,
                    "reviewer": {
                        "name": "Edward A. James",
                        "email": "eajames@us.ibm.com",
                        "username": "eddiejames"
                    },
                    "message": "Well, additionalData holds strings, so I have to turn the errno into a string, like \"-6\", I think. It doesn't get the error string like strerror, if that's what you were concerned about."
                },
                {
                    "file": "occ_ffdc.cpp",
                    "line": 101,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "oh right, yea for some reason I thought it was strerror."
                },
                {
                    "file": "occ_ffdc.cpp",
                    "line": 120,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "since you don't need the FFDC files, you can just use this version of the dbus method:\n\nbusctl call xyz.openbmc_project.Logging /xyz/openbmc_project/logging xyz.openbmc_project.Logging.Create Create ssa{ss} xyz.openbmc_project.Common.Error.Timeout xyz.openbmc_project.Logging.Entry.Level.Error 1 TIMEOUT_IN_MSEC 5\n\nthough then that is using a different call than in the other function, so I guess I don't care that much either way."
                },
                {
                    "file": "occ_ffdc.cpp",
                    "line": 120,
                    "reviewer": {
                        "name": "Edward A. James",
                        "email": "eajames@us.ibm.com",
                        "username": "eddiejames"
                    },
                    "message": "Done"
                },
                {
                    "file": "occ_ffdc.cpp",
                    "line": 136,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "since you aren't using the plid this can probably be a void function"
                },
                {
                    "file": "occ_ffdc.cpp",
                    "line": 136,
                    "reviewer": {
                        "name": "Edward A. James",
                        "email": "eajames@us.ibm.com",
                        "username": "eddiejames"
                    },
                    "message": "Done"
                },
                {
                    "file": "occ_manager.cpp",
                    "line": 1291,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Chris, what would the call out be for this error?"
                },
                {
                    "file": "occ_manager.cpp",
                    "line": 1291,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "HTMGT already does the detection for multiple masters and would not go active if that happened.\nIf we hit this case it would probably be a firmware bug."
                },
                {
                    "file": "occ_manager.cpp",
                    "line": 1291,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Ack"
                },
                {
                    "file": "occ_manager.cpp",
                    "line": 1291,
                    "reviewer": {
                        "name": "Edward A. James",
                        "email": "eajames@us.ibm.com",
                        "username": "eddiejames"
                    },
                    "message": "Ack"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "occ_ffdc.cpp",
                    "type": "MODIFIED",
                    "insertions": 56,
                    "deletions": -3
                },
                {
                    "file": "occ_status.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -2
                },
                {
                    "file": "occ_device.hpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -7
                },
                {
                    "file": "occ_status.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -2
                },
                {
                    "file": "occ_ffdc.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "occ_errors.hpp",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -2
                },
                {
                    "file": "occ_errors.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -5
                },
                {
                    "file": "occ_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -2
                },
                {
                    "file": "occ_presence.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "occ_device.cpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -6
                },
                {
                    "file": "occ_presence.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 177,
            "sizeDeletions": 31
        },
        {
            "number": 3,
            "revision": "9789e71f254c4f543c5eabffb0c4ac963b605eb9",
            "parents": [
                "c8dd45999f3f284b791eb226d0643e35a403c079"
            ],
            "ref": "refs/changes/18/54018/3",
            "uploader": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "createdOn": 1653680549,
            "author": {
                "name": "Edward A. James",
                "email": "eajames@us.ibm.com",
                "username": "eddiejames"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "occ_ffdc.cpp",
                    "type": "MODIFIED",
                    "insertions": 46,
                    "deletions": -3
                },
                {
                    "file": "occ_status.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -2
                },
                {
                    "file": "occ_device.hpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -7
                },
                {
                    "file": "occ_status.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -2
                },
                {
                    "file": "occ_ffdc.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "occ_errors.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -2
                },
                {
                    "file": "occ_errors.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -5
                },
                {
                    "file": "occ_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -2
                },
                {
                    "file": "occ_presence.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "occ_device.cpp",
                    "type": "MODIFIED",
                    "insertions": 24,
                    "deletions": -6
                },
                {
                    "file": "occ_presence.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 167,
            "sizeDeletions": 31
        }
    ]
}