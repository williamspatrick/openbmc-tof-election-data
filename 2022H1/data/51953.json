{
    "project": "openbmc/phosphor-bmc-code-mgmt",
    "branch": "master",
    "id": "Ifa8ec1a96bc9c1ecf0dbdcc5d11435c0f594d66b",
    "number": 51953,
    "subject": "Create ActivationBlocksTransition before write HOST BIOS image",
    "owner": {
        "email": "thuutran@amperecomputing.com",
        "username": "thangtran-ampere"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-bmc-code-mgmt/+/51953",
    "commitMessage": "Create ActivationBlocksTransition before write HOST BIOS image\n\nCurrently, Host can be turned on and the BMC can reboot during HOST BIOS\nimage is flashing. it can make the flashing fails.\nEnable ActivationBlocksTransition before write HOST BIOS image to block\nturning on HOST or reboot BMC when flashing did not complete.\n\nTested:\n      1. Request to write new Host bios image via Redfish.\n      2. Turn on HOST.\n      3. HOST still is off until flashing completed.\n      4. New HOST BIOS image is flashed.\n\nSigned-off-by: Thang Tran <thuutran@amperecomputing.com>\nChange-Id: Ifa8ec1a96bc9c1ecf0dbdcc5d11435c0f594d66b\n",
    "createdOn": 1647272441,
    "lastUpdated": 1647977793,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1647272441,
            "reviewer": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1647272451,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1647272451,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1647272526,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/38929/ : SUCCESS"
        },
        {
            "timestamp": 1647272655,
            "reviewer": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1647292775,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1647312505,
            "reviewer": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1647312528,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1647312533,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1647312606,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/38995/ : SUCCESS"
        },
        {
            "timestamp": 1647312949,
            "reviewer": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1647462600,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1647484231,
            "reviewer": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1647829760,
            "reviewer": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1647936517,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1647937711,
            "reviewer": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1647938510,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1647977643,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3: Patch Set 2 was rebased"
        },
        {
            "timestamp": 1647977651,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1647977651,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1647977732,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/39449/ : SUCCESS"
        },
        {
            "timestamp": 1647977764,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1647977793,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "f1100ffc1283292c5f36ca4dc3046ec600756305",
            "parents": [
                "88ba1f9ec712d82e8111952df0524bb460c2acb0"
            ],
            "ref": "refs/changes/53/51953/1",
            "uploader": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "createdOn": 1647272441,
            "author": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Hi all, \nI just updated the code to active block transition before write HOST BIOS image. This action is used to make HOST can not be turned on when flashing did not completed. Please help me review this change.\nThanks"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "The reboot guard blocks the BMC from rebooting.\nBut I do not see the related code to block t he Host BIOS boot.\nCould you kindly point the related changes?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Hi @Lei YU,\n\nWhen BMC turns on the HOST, it will trigger obmc-power-start-pre@.taget unit. This target file waits until \"xyz.openbmc_project.Software.ActivationBlocksTransition\" interface has been deleted https://github.com/openbmc/phosphor-state-manager/blob/master/target_files/obmc-power-start-pre%40.target#L5.\n\nBy adding ActivationBlocksTransition before flashing HOST BIOS image it will create \"xyz.openbmc_project.Software.ActivationBlocksTransition\" interface. Therefore, BMC will block HOST booting until flashing is finished.\n\nThanks,\nThang Tran"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Got it"
                },
                {
                    "file": "activation.cpp",
                    "line": 117,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Thanks for the submission, makes sense. Just to avoid duplication in adding the BlocksTransition in Host update and then later in line 160 below for BMC updates, could you instead move this whole \"#ifdef HOST_BIOS_UPGRADE\" block underneath line 166 below \"activationProgress->progress(10);\"? I think that'll make the code even make more sense, it'd look like:\n\n- verify signatures\n<-- host update was here, remove it\n- verify min ship level\n- add progress interface\n- add activationBlocksTransition\n- set progress to 10% (update is about to start)\n- NEW host update block moves here (progress is set to 20% and the host is updated)"
                },
                {
                    "file": "activation.cpp",
                    "line": 117,
                    "reviewer": {
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Thanks for your comments. I updated the code as your suggestion, but I swap 2 last steps to avoid duplication setting progress if the purpose is updating HOST BIOS."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 27,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "241172d7ffb4ca2c914d25b023685ead1976a951",
            "parents": [
                "88ba1f9ec712d82e8111952df0524bb460c2acb0"
            ],
            "ref": "refs/changes/53/51953/2",
            "uploader": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "createdOn": 1647312505,
            "author": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Thang Q. Nguyen",
                        "email": "thang@os.amperecomputing.com",
                        "username": "thangqn-ampere"
                    },
                    "message": "Checked on Ampere Mt.Jade"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Hi all,\nDo you have any comments for this commit?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -23
                }
            ],
            "sizeInsertions": 38,
            "sizeDeletions": 23
        },
        {
            "number": 3,
            "revision": "bee6243a981156409c7504fe7ce7f72b78b43c08",
            "parents": [
                "554757b9a876b4b1d1757191c5744fb17c5c7f23"
            ],
            "ref": "refs/changes/53/51953/3",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1647977643,
            "author": {
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -23
                }
            ],
            "sizeInsertions": 38,
            "sizeDeletions": 23
        }
    ]
}