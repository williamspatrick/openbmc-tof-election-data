{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I1c6c91f126b734e1b5573d5ef204fe2bf6ed6c26",
    "number": 46989,
    "subject": "Add asyncResp support to handleUpgrade",
    "owner": {
        "name": "P Dheeraj Srujan Kumar",
        "email": "p.dheeraj.srujan.kumar@intel.com",
        "username": "dheerajpdsk"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/46989",
    "commitMessage": "Add asyncResp support to handleUpgrade\n\nThis commit enables paasing down the asyncResp (of the connection) to\nthe handler of upgraded connections. This is already in place for normal\nrequests (i.e. Class Router -> handle())\n\nThis change would enable any async calls that would be required during\nupgrade of the connection. For example, as on today, we have only\nAuthentication of user in place for upgraded connection, but not\nAuthorization. So, this asyncResp could further be used for such dbus\ncalls to return informative response. This could also enable further OEM\nchecks during upgrade of the connection.\n\nThis commit updates the signature of all the handleUpgrade() functions\npresent in router.hpp to take in asyncResp object instead of normal\nresponse.\n\nThis commit further adds an additional parametric constructor in the\nResponse class to enable constructing a Response by taking in\nwebsocket::response_type object (used in websocket.hpp)\n\nTested :\n - websocket_test.py Passed\n - KVM was functional in WebUI.\n - POST to /redfish/v1/EventService/Subscriptions/SSE returned an error\n   message as expected and the connection was kept alive.\n - GET on /redfish/v1/EventService/Subscriptions/SSE (SSE subscription)\n   was successful. The existing connection was successfully closed and\n   upgraded to SSE connection.\n\nChange-Id: I1c6c91f126b734e1b5573d5ef204fe2bf6ed6c26\nSigned-off-by: P Dheeraj Srujan Kumar <p.dheeraj.srujan.kumar@intel.com>\nSigned-off-by: Abhishek Patel <Abhishek.Patel@ibm.com>\n",
    "createdOn": 1631909094,
    "lastUpdated": 1657460700,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1631909094,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1631909116,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1631909540,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/26540/ : SUCCESS"
        },
        {
            "timestamp": 1631911938,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1631912730,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1648759288,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1648759302,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648759302,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1648759474,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648759556,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1648759571,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648759571,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1648759576,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/40268/ : ABORTED"
        },
        {
            "timestamp": 1648759596,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1648760146,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40269/ : SUCCESS"
        },
        {
            "timestamp": 1649790819,
            "reviewer": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1649794541,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1650141347,
            "reviewer": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1650141361,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1650141361,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1650141440,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/41330/ : FAILURE"
        },
        {
            "timestamp": 1650141592,
            "reviewer": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1650141605,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1650141605,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1650141684,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/41331/ : FAILURE"
        },
        {
            "timestamp": 1650145434,
            "reviewer": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "message": "Uploaded patch set 6."
        },
        {
            "timestamp": 1650145452,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1650145452,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: -Ok-To-Test"
        },
        {
            "timestamp": 1650146048,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/41332/ : SUCCESS"
        },
        {
            "timestamp": 1650146311,
            "reviewer": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1650297726,
            "reviewer": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1650297838,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 6: Code-Review-1\n\n(1 comment)"
        },
        {
            "timestamp": 1650297838,
            "reviewer": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1650298368,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1655377654,
            "reviewer": {
                "name": "AppaRao Puli",
                "email": "apparao.puli@intel.com",
                "username": "apuli1"
            },
            "message": "Patch Set 6:\n\n(2 comments)"
        },
        {
            "timestamp": 1655413371,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Uploaded patch set 7."
        },
        {
            "timestamp": 1655413413,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1655413413,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: -Ok-To-Test"
        },
        {
            "timestamp": 1655413433,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/45186/ : FAILURE"
        },
        {
            "timestamp": 1655413919,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Uploaded patch set 8."
        },
        {
            "timestamp": 1655413947,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1655413948,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: -Ok-To-Test"
        },
        {
            "timestamp": 1655413963,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/45187/ : FAILURE"
        },
        {
            "timestamp": 1655414352,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Uploaded patch set 9."
        },
        {
            "timestamp": 1655414373,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 9: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1655414373,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 9: -Ok-To-Test"
        },
        {
            "timestamp": 1655414887,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 9: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/45189/ : SUCCESS"
        },
        {
            "timestamp": 1655511421,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Uploaded patch set 10."
        },
        {
            "timestamp": 1655511459,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 10: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1655511459,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 10: -Ok-To-Test"
        },
        {
            "timestamp": 1655511966,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 10: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/45282/ : SUCCESS"
        },
        {
            "timestamp": 1655842917,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Uploaded patch set 11."
        },
        {
            "timestamp": 1655842933,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 11: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1655842933,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 11: -Ok-To-Test"
        },
        {
            "timestamp": 1655843247,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 11: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/45514/ : FAILURE"
        },
        {
            "timestamp": 1656324064,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 11:\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/45889/ : FAILURE"
        },
        {
            "timestamp": 1656368987,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Patch Set 12: Patch Set 11 was rebased"
        },
        {
            "timestamp": 1656369009,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 12: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1656369009,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 12: -Ok-To-Test"
        },
        {
            "timestamp": 1656369523,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 12: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/45976/ : SUCCESS"
        },
        {
            "timestamp": 1657460700,
            "reviewer": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "message": "Patch Set 12:\n\n(2 comments)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "813cb23c020737b825c33a5ba25121b9a0f48130",
            "parents": [
                "ad22fefecaf7988fd7072dc71042efbf86fc5162"
            ],
            "ref": "refs/changes/89/46989/1",
            "uploader": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "createdOn": 1631909094,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "http/http_connection.hpp",
                    "line": 374,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Why are we checking explicitly against 200 for errors?  200 is used for HTTP requests, and we shouldn't be reusing those codes for that.  Arguably a handler could want to return 200 from a websocket route instead of upgrading, so if we're going to allow the concept of \"the bmc route rejected the upgrade\" we'll need some other flag."
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 374,
                    "reviewer": {
                        "name": "P Dheeraj Srujan Kumar",
                        "email": "p.dheeraj.srujan.kumar@intel.com",
                        "username": "dheerajpdsk"
                    },
                    "message": "As mentioned in the comment below, the default response of http::response is 200. \nThe reason this explicit check is done is because, if everything was smooth and upgradation was done, the response would contain 200, so since the upgradation is already done, we wouldn't need to reply through this connection. That's why calling the else section to destroy this connection.\nIncase of any errors, say like privilege check error, we would need to reply through the same connection without upgrading.\nSo, only unsuccessful messages needs to be communicated through this channel.\n\nEither ways, on success i.e. on upgrade, we wouldn't have this adaptor anymore to send the OK response."
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 374,
                    "reviewer": {
                        "name": "Abhishek Patel",
                        "email": "Abhishek.Patel@ibm.com",
                        "username": "patelabhishek9893"
                    },
                    "message": "I think flags here will be 1000 and 1001?\nIf we like to post error info.\nright?\nhttps://github.com/Luka967/websocket-close-codes"
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 374,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> upgradation was done, the response would contain 200\n\nTechnically if everything worked, we would expect to see a 101 Switching Protocols, right?  I think this is kind of the core of the problem, we're trying to inject behavior post-upgrade that needs to be done pre-upgrade.  Beast handles this already on line 106 of websocket.hpp.  If we need to expose that callback to each individual route, I suspect we need a separate callback from onopen(), because onopen happens after the websocket has been negotiated."
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 374,
                    "reviewer": {
                        "name": "Abhishek Patel",
                        "email": "Abhishek.Patel@ibm.com",
                        "username": "patelabhishek9893"
                    },
                    "message": "this will respond 101 after upgred"
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 382,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Why do we need to post this?  can't we just call completeRequest directly?"
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 382,
                    "reviewer": {
                        "name": "P Dheeraj Srujan Kumar",
                        "email": "p.dheeraj.srujan.kumar@intel.com",
                        "username": "dheerajpdsk"
                    },
                    "message": "This is the current implementation as seen in line 361."
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 382,
                    "reviewer": {
                        "name": "Abhishek Patel",
                        "email": "Abhishek.Patel@ibm.com",
                        "username": "patelabhishek9893"
                    },
                    "message": "Hello, Ed \nDo you mean we do not need to return any error info, only close the connection?"
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 385,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Prefer to return early instead of calling else."
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 385,
                    "reviewer": {
                        "name": "P Dheeraj Srujan Kumar",
                        "email": "p.dheeraj.srujan.kumar@intel.com",
                        "username": "dheerajpdsk"
                    },
                    "message": "We cannot return here as the connection needs to be destroyed. For which CompleteRequestHAndler needs to be set to NULL."
                },
                {
                    "file": "http/http_connection.hpp",
                    "line": 385,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 27,
                    "deletions": -5
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 21,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 73,
            "sizeDeletions": 23
        },
        {
            "number": 2,
            "revision": "fdc3b8a82f6942cb5ab6dafffb29aa4d63a3cd17",
            "parents": [
                "456cd875f3c56b45605d8a017e91d810876a035c"
            ],
            "ref": "refs/changes/89/46989/2",
            "uploader": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "createdOn": 1648759288,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Patchset 2 is a rebase of this change to the latest"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 26,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 16,
                    "deletions": -12
                }
            ],
            "sizeInsertions": 71,
            "sizeDeletions": 18
        },
        {
            "number": 3,
            "revision": "d13a70d44e562031562063ede23690b697e6c6b0",
            "parents": [
                "456cd875f3c56b45605d8a017e91d810876a035c"
            ],
            "ref": "refs/changes/89/46989/3",
            "uploader": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "createdOn": 1648759556,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 14,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This patchset was idle long enough that I've forgotten all context for it.\n\nLets start with updating this commit message to \"why is this necessary\" ideally with cases of user-facing behavior that this improves.  From my perspective, websocket routes don't really have good reasons where they need to \"fail\" at a response level, and can quite easily fail once the connection is already open.  With that said, I'm open to the possibility that this could be needed, so I'm curious what user facing feature this would allow for.\n\nThe code that this was originally patching has changed a bit since originally written, so I suspect some of the initial reasoning behind this might not be present anymore, but lets walk through it in the commit message text."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 14,
                    "reviewer": {
                        "name": "AppaRao Puli",
                        "email": "apparao.puli@intel.com",
                        "username": "apuli1"
                    },
                    "message": "Apologies for late response on this. Commit message will be modified to reflect the actual changes. Meanwhile, Let me clarify the intent of this patch.\n\nThis patch is pass the response object to down handlers for upgraded routes ( Note: For normal routes, its already done https://github.com/openbmc/bmcweb/blob/master/http/http_connection.hpp#L391) and handle error scenarios. This change is needed for below use cases.\n\n- To add Authorization to all upgrade routes. Today for upgrade routes( Websocket or SSE etc.) we have only authentication, no authorization check. Normal requests its done in handle() (https://github.com/openbmc/bmcweb/blob/master/http/routing.hpp#L1304-L1407) for upgrade routes its not there (Ex: /kvm/0/  or /vm/0/0 or /nbd/<> or SSE etc..). So passing asyncResp object will let us allow to adding authorization for upgrade routes. This commit is baby step to towards it.  Adding authorization check for upgrade routes is done at https://gerrit.openbmc.org/c/openbmc/bmcweb/+/46991\n\n - Some of the upgrade routes may have some extra validation checks (Example: OEM implementation may block KVM session if its crosses x number, Or some OEM check before establishing communication etc..). So passing asyncRes to upgrade start() will allow making few more verification and return response to user. This is extra change added by Abhishek Patel. When i checked that code, i thought can't it be done before creating new connection? Yes, It can be but that requires considerable amount of design changes for all upgrade routes. Passing asyncRes is easy method in doing that ( or may be starting step for it).\n\n\nDheeraj, Can you update commit message accordingly.  Also refresh the patch to latest master which has merge conflicts."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 14,
                    "reviewer": {
                        "name": "P Dheeraj Srujan Kumar",
                        "email": "p.dheeraj.srujan.kumar@intel.com",
                        "username": "dheerajpdsk"
                    },
                    "message": "Updated commit message to reflect the intent of the patch.\nAlso, resolved merge conflicts"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 16,
                    "deletions": -12
                }
            ],
            "sizeInsertions": 70,
            "sizeDeletions": 18
        },
        {
            "number": 4,
            "revision": "734826a85627fd05b2d9dbe0e0f32e208f991dd9",
            "parents": [
                "4f568f74b8bf1aa8dc50f0a2f6d12f2e11ed9383"
            ],
            "ref": "refs/changes/89/46989/4",
            "uploader": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "createdOn": 1650141347,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 26,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 21,
                    "deletions": -20
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 83,
            "sizeDeletions": 29
        },
        {
            "number": 5,
            "revision": "fb9e36f715963033759192a917b40a0957935f40",
            "parents": [
                "4f568f74b8bf1aa8dc50f0a2f6d12f2e11ed9383"
            ],
            "ref": "refs/changes/89/46989/5",
            "uploader": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "createdOn": 1650141592,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 26,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 21,
                    "deletions": -20
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 83,
            "sizeDeletions": 29
        },
        {
            "number": 6,
            "revision": "2450ca51d4adaffb8f8e44a74a718b530b09061f",
            "parents": [
                "4f568f74b8bf1aa8dc50f0a2f6d12f2e11ed9383"
            ],
            "ref": "refs/changes/89/46989/6",
            "uploader": {
                "name": "Abhishek Patel",
                "email": "Abhishek.Patel@ibm.com",
                "username": "patelabhishek9893"
            },
            "createdOn": 1650145434,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "New patchset doesn't address comments.  Please at least reply to all comments when pushing a new patchset."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "P Dheeraj Srujan Kumar",
                        "email": "p.dheeraj.srujan.kumar@intel.com",
                        "username": "dheerajpdsk"
                    },
                    "message": "Done"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 64,
                    "reviewer": {
                        "name": "Abhishek Patel",
                        "email": "Abhishek.Patel@ibm.com",
                        "username": "patelabhishek9893"
                    },
                    "message": "this will remove out completeRequestHandler which we \nadded. so no idea how to fix that"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 64,
                    "reviewer": {
                        "name": "Abhishek Patel",
                        "email": "Abhishek.Patel@ibm.com",
                        "username": "patelabhishek9893"
                    },
                    "message": "After I copy the request, I can add that 101 check code. That is one way to solve this."
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 64,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Checking for 101 code doesn't help in this case.  I really have no idea what you're trying to accomplish with this patchset, so lets start with writing up a commit message for what you want the user-facing behavior to be, then we can work backwards to what the implementation looks like."
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 64,
                    "reviewer": {
                        "name": "AppaRao Puli",
                        "email": "apparao.puli@intel.com",
                        "username": "apuli1"
                    },
                    "message": "Ed, I added a comment in commit message explaining the need and use cases. Can you check and see if if looks fine."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 26,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": -22
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 84,
            "sizeDeletions": 31
        },
        {
            "number": 7,
            "revision": "622e1d51980b8447783f908313a28649ed128a72",
            "parents": [
                "14bd7d9a82aa5302d57ff5ca29e933148ddff330"
            ],
            "ref": "refs/changes/89/46989/7",
            "uploader": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "createdOn": 1655413371,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": -22
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 97,
            "sizeDeletions": 31
        },
        {
            "number": 8,
            "revision": "ef08145b0c70150af43f716eaddd82f7dcc4f0a3",
            "parents": [
                "14bd7d9a82aa5302d57ff5ca29e933148ddff330"
            ],
            "ref": "refs/changes/89/46989/8",
            "uploader": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "createdOn": 1655413919,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": -22
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 97,
            "sizeDeletions": 31
        },
        {
            "number": 9,
            "revision": "8d685d57fec18dc5ed18371335f1a92125b016bc",
            "parents": [
                "14bd7d9a82aa5302d57ff5ca29e933148ddff330"
            ],
            "ref": "refs/changes/89/46989/9",
            "uploader": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "createdOn": 1655414352,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": -22
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 97,
            "sizeDeletions": 31
        },
        {
            "number": 10,
            "revision": "a22eaec328fd800d903542222a1d16319643fe86",
            "parents": [
                "14bd7d9a82aa5302d57ff5ca29e933148ddff330"
            ],
            "ref": "refs/changes/89/46989/10",
            "uploader": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "createdOn": 1655511421,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -23
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 100,
            "sizeDeletions": 32
        },
        {
            "number": 11,
            "revision": "6846a70e45a59afbde396c9272621603bd1bf257",
            "parents": [
                "14bd7d9a82aa5302d57ff5ca29e933148ddff330"
            ],
            "ref": "refs/changes/89/46989/11",
            "uploader": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "createdOn": 1655842917,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 23,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -23
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 98,
            "sizeDeletions": 32
        },
        {
            "number": 12,
            "revision": "3d17720e3886973c566f9e0c3f5c437d463ba001",
            "parents": [
                "1ef4c3423f1f13ba6a804f72427641e6f8287dba"
            ],
            "ref": "refs/changes/89/46989/12",
            "uploader": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "createdOn": 1656368987,
            "author": {
                "name": "P Dheeraj Srujan Kumar",
                "email": "p.dheeraj.srujan.kumar@intel.com",
                "username": "dheerajpdsk"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "http/app.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -2
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 23,
                    "deletions": -4
                },
                {
                    "file": "http/routing.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -23
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "http/websocket.hpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 98,
            "sizeDeletions": 32
        }
    ]
}