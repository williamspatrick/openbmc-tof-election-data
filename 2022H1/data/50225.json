{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "Id079ae3f387e9a39f9e0ac74e36a7095b4999ea2",
    "number": 50225,
    "subject": "Make the task match string more flexible",
    "owner": {
        "name": "Jason Bills",
        "email": "jason.m.bills@linux.intel.com",
        "username": "jmbills"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/50225",
    "commitMessage": "Make the task match string more flexible\n\nInstead of hardcoding the match string used for the task,\nthis allows the match string to be set depending on the\nOEMDiagnosticDataType.\n\nTested:\nConfirmed that the TaskMonitor still correctly updates\nwhen the collection task completes.\n\nChange-Id: Id079ae3f387e9a39f9e0ac74e36a7095b4999ea2\nSigned-off-by: Jason M. Bills <jason.m.bills@intel.com>\n",
    "createdOn": 1641593849,
    "lastUpdated": 1646082851,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1641593849,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1641593861,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1641593861,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1641594386,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/35103/ : SUCCESS"
        },
        {
            "timestamp": 1643755144,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1645148082,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1645148638,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1645534593,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1645575715,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1645585840,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1645585854,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645585854,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1645586273,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/37839/ : FAILURE"
        },
        {
            "timestamp": 1645586913,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1645586929,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645586929,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1645587014,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1645587552,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37841/ : SUCCESS"
        },
        {
            "timestamp": 1645594211,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1645601836,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1645627064,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 4: Patch Set 3 was rebased"
        },
        {
            "timestamp": 1645627078,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645627078,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1645627630,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37882/ : SUCCESS"
        },
        {
            "timestamp": 1646070844,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4: Code-Review+2"
        },
        {
            "timestamp": 1646070892,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5: Patch Set 4 was rebased"
        },
        {
            "timestamp": 1646070913,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1646070913,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1646071409,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/38169/ : SUCCESS"
        },
        {
            "timestamp": 1646074246,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully rebased and submitted as c5a4c82ad109fc7d6ca7af3ca3dfe4481c9b2346\n\n4 is the latest approved patch-set.\nNo files were changed between the latest approved patch-set and the submitted one.\n"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "55c479b45f1bd145ba8406148e7dbbf2d30253f6",
            "parents": [
                "e2a6006704e277231af13b6470d05de9b010f049"
            ],
            "ref": "refs/changes/25/50225/1",
            "uploader": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "createdOn": 1641593849,
            "author": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Ping.  Any feedback on this change?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Ping. Is there any feedback on this change?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Sorry;  I pulled this down a couple times, but I couldn't wrap my head around what the shared_ptr was doing.... I finally figured it out today;  Look at the below, I think it's simpler."
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "line": 2913,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Rather than making this a shared_ptr<std::string> then filling it in in a later context (which while correct, is super subtle) should we instead just duplicate the two types a little and do\n\n\nenum class diagnosticType{\n  OnDemand\n  Telemetry\n  Error\n};\n\nDiagnosticType getDiagType(std::string_view str){\n...\n}\n\nto convert to an enum that's correct and switchable, then do\nDiagnosticType type = getDiagType(oemDiagnosticDataType);\nif (type == DiagnosticType::Error){\n   actionParameterValueFormatError;\n   return;\n}\nstd::string taskMatchStr;\nif (type == DiagnosticType::OnDemand){\n   taskMatchStr = \"type='signal',interface='org.freedesktop.DBus.\"\n                                \"Properties',member='PropertiesChanged',\"\n                                \"arg0namespace='com.intel.crashdump'\";\n} else {\n   taskMatchStr = \"type='signal',interface='org.freedesktop.DBus.\"\n                                \"Properties',member='PropertiesChanged',\"\n                                \"arg0namespace='com.intel.crashdump'\";\n}\n\n\nauto collectCrashdumpCallback =\n    [asyncResp, payload(task::Payload(req)),\n    taskMatchStr](const boost::system::error_code ec,\n                  const std::string&) mutable {\n...\n}\n\n\nThen leave the switch statement on line 2957 alone?\n\nYes, we duplicate the if/else statement, but we avoid the shared_ptr entirely.  I could also be convinced that the enum class is unimportant, but I really don't like the idea of having a shared_ptr, just because we don't want to make a decision before we construct something."
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "line": 2913,
                    "reviewer": {
                        "name": "Krzysztof Grobelny",
                        "email": "krzysztof.grobelny@intel.com",
                        "username": "krzysztof-i"
                    },
                    "message": "+1\n\nIf done like this we could also avoid duplicated if condition. It seem that only difference between two async_method_calls is interface.\n\n            std::string taskMatchStr;\n            std::string interface;\n            if (oemDiagnosticDataType == \"OnDemand\")\n            {\n                taskMatchStr = \"type='signal',interface='org.freedesktop.DBus.\"\n                                \"Properties',member='PropertiesChanged',\"\n                                \"arg0namespace='com.intel.crashdump'\";\n                interface = crashdumpOnDemandInterface;\n            }\n            else if (oemDiagnosticDataType == \"Telemetry\")\n            {\n                taskMatchStr = \"type='signal',interface='org.freedesktop.DBus.\"\n                                \"Properties',member='PropertiesChanged',\"\n                                \"arg0namespace='com.intel.crashdump'\";\n                interface = crashdumpTelemetryInterface;\n            }"
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "line": 2913,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Yep, Krysztofs is even simpler.  I like it."
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "line": 2913,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "type": "MODIFIED",
                    "insertions": 49,
                    "deletions": -41
                }
            ],
            "sizeInsertions": 67,
            "sizeDeletions": 41
        },
        {
            "number": 2,
            "revision": "6ea185451012c23632f96ad8a1e872605e7f0787",
            "parents": [
                "e93c08650d75ec93292f7153d1dbd5c769e2eccb"
            ],
            "ref": "refs/changes/25/50225/2",
            "uploader": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "createdOn": 1645585840,
            "author": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "type": "MODIFIED",
                    "insertions": 102,
                    "deletions": -59
                }
            ],
            "sizeInsertions": 120,
            "sizeDeletions": 59
        },
        {
            "number": 3,
            "revision": "9bc81c4a8decab0b458fa772d8c7e43f75378e7a",
            "parents": [
                "e93c08650d75ec93292f7153d1dbd5c769e2eccb"
            ],
            "ref": "refs/changes/25/50225/3",
            "uploader": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "createdOn": 1645586913,
            "author": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "LGTM."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "type": "MODIFIED",
                    "insertions": 89,
                    "deletions": -53
                }
            ],
            "sizeInsertions": 107,
            "sizeDeletions": 53
        },
        {
            "number": 4,
            "revision": "b320625cada1a29ec539aac13fcc5af9e782b8e9",
            "parents": [
                "32a9c91edd4476aa810320db8d339399c88b2232"
            ],
            "ref": "refs/changes/25/50225/4",
            "uploader": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "createdOn": 1645627064,
            "author": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "type": "MODIFIED",
                    "insertions": 89,
                    "deletions": -53
                }
            ],
            "sizeInsertions": 107,
            "sizeDeletions": 53
        },
        {
            "number": 5,
            "revision": "9ee2ba8004169ca3a54856973a47e1ca3bd1ac1d",
            "parents": [
                "2b20ef6ee2a8ca656aaa49b181d9205e30ede451"
            ],
            "ref": "refs/changes/25/50225/5",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1646070892,
            "author": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "type": "MODIFIED",
                    "insertions": 89,
                    "deletions": -53
                }
            ],
            "sizeInsertions": 107,
            "sizeDeletions": 53
        },
        {
            "number": 6,
            "revision": "c5a4c82ad109fc7d6ca7af3ca3dfe4481c9b2346",
            "parents": [
                "1668ce6d0d427088b7bb8ab7c2927763fb57c8c3"
            ],
            "ref": "refs/changes/25/50225/6",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1646074246,
            "author": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/log_services.hpp",
                    "type": "MODIFIED",
                    "insertions": 89,
                    "deletions": -53
                }
            ],
            "sizeInsertions": 107,
            "sizeDeletions": 53
        }
    ]
}