{
    "project": "openbmc/phosphor-power",
    "branch": "master",
    "id": "I724e4f335c4347ad6789e2d68cfb58c6387e6073",
    "number": 53122,
    "subject": "regulators: Add phosphor-regulators service dependencies",
    "owner": {
        "name": "Zev Weiss",
        "email": "zev@bewilderbeest.net",
        "username": "zevweiss"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-power/+/53122",
    "commitMessage": "regulators: Add phosphor-regulators service dependencies\n\n'regsctl' can't do anything useful until phosphor-regulators is running,\nso add systemd unit dependencies to ensure it's started before\nregulators-config and regulators-monitor-{enable,disable}.\n\nWhile we're at it, change phosphor-regulators.service to be of type dbus\nso we get a more meaningful check that it's really up and running, and\ntweak the instantiation of ManagerObject so that it emits the necessary\nsignals.\n\nSigned-off-by: Zev Weiss <zev@bewilderbeest.net>\nChange-Id: I724e4f335c4347ad6789e2d68cfb58c6387e6073\n",
    "createdOn": 1650416487,
    "lastUpdated": 1650743409,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1650416487,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1650416498,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1650416498,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1650416691,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 2: Commit message was updated."
        },
        {
            "timestamp": 1650417082,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/41643/ : SUCCESS"
        },
        {
            "timestamp": 1650553719,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1650567517,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1650569648,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1650574390,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1650579208,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1650579219,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1650579219,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1650579236,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1650579244,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/41873/ : FAILURE"
        },
        {
            "timestamp": 1650579733,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1650579744,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1650579744,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1650580433,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/41874/ : SUCCESS"
        },
        {
            "timestamp": 1650586479,
            "reviewer": {
                "name": "Brandon J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1650586591,
            "reviewer": {
                "name": "Brandon J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1650638199,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1650645692,
            "reviewer": {
                "name": "Brandon J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1650743361,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 5: Commit message was updated."
        },
        {
            "timestamp": 1650743398,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1650743409,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "2b70a388099f4463dd218c2f8e553371d1fee8c9",
            "parents": [
                "2a054922f3fe7a96182d5c2631dd8187d44728e0"
            ],
            "ref": "refs/changes/22/53122/1",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1650416487,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-config.service",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 17,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "8472e09e276c92f25200735a2c102fd91ca3cb2e",
            "parents": [
                "2a054922f3fe7a96182d5c2631dd8187d44728e0"
            ],
            "ref": "refs/changes/22/53122/2",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1650416691,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Hi,\n\nThanks for submitting this change.\n\nIt would be good to update the following regulators service files as well:\n* phosphor-regulators-monitor-enable.service\n* phosphor-regulators-monitor-disable.service\n\nThey also call a D-Bus method on the regulators app to start/stop regulator monitoring.  So they have the same dependency.\n\nDo you mind adding that to your commit?\n\nAlso, rather than have all three dependent services copy/paste the same mapper-wait lines, I think the recommended approach would be to add the following to the phosphor-regulators.service instead:\n  Type=dbus\n  BusName=xyz.openbmc_project.Power.Regulators\n\nI believe this causes systemd to not consider the phosphor-regulators application started until it claims that bus name.\n\nWould that accomplish what you are looking for?  If so, the mapper-wait lines could be removed from the dependent services.  That would remove a dependency on the mapper to provide synchronization."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "> Do you mind adding that to your commit?\n\nSure, happy to do that.\n\n> I believe this causes systemd to not consider the phosphor-regulators application started until it claims that bus name.\n> \n> Would that accomplish what you are looking for?  If so, the mapper-wait lines could be removed from the dependent services.  That would remove a dependency on the mapper to provide synchronization.\n\nThat does seem like a cleaner approach, though I'd be somewhat worried that it would still leave a (probably narrow) race window between claiming the bus name and actually instantiating the dbus object, during which the regulators-config unit (and/or others) could get started but still fail.  Is there anything to prevent that from potentially happening?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "The D-Bus object, which is of type ManagerObject, is created in the initialization list of the Manager constructor:\n\nhttps://github.com/openbmc/phosphor-power/blob/master/phosphor-regulators/src/manager.cpp#L75\n\nThe D-Bus service name is claimed later in that constructor:\n\nhttps://github.com/openbmc/phosphor-power/blob/master/phosphor-regulators/src/manager.cpp#L101\n\nMy understanding is that these should happen synchronously, and thus there isn't a race condition.  I'm not a D-Bus expert so if you are aware of a possible issue let me know.\n\nHowever, in looking at the call to the ManagerObject constructor (which creates the D-Bus object), I see that it is specifying the third parameter to defer emitting an ObjectAdded/InterfacesAdded signal.  I think if we want to make this service file change, we should remove that parameter and let it default to emitting the signal.  I believe someone else wrote that code, and I don't see a reason we need to defer the signal.\n\nSo if you could also change\n  ManagerObject{bus, managerObjPath, ManagerObject::action::defer_emit},\nto\n  ManagerObject{bus, managerObjPath},\n\nI think we'd be in good shape.  Let me know if that doesn't work for you."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "> My understanding is that these should happen synchronously, and thus there isn't a race condition.  I'm not a D-Bus expert so if you are aware of a possible issue let me know.\n\nAh, got it -- I had thought those happened in the opposite order for some reason, thanks for the correction.  I'm far from a dbus expert myself, but that certainly sounds like it should be OK.\n\n> I think if we want to make this service file change, we should remove that parameter and let it default to emitting the signal.  I believe someone else wrote that code, and I don't see a reason we need to defer the signal.\n\nAlright, I'll test it out with all of the above changes incorporated and post an updated version of the patch -- thanks for the pointer there."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-config.service",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 17,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "f75328d49f842b6d4aef96ceaaac412f8759044b",
            "parents": [
                "2a054922f3fe7a96182d5c2631dd8187d44728e0"
            ],
            "ref": "refs/changes/22/53122/3",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1650579208,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "phosphor-regulators/src/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "services/phosphor-regulators.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-config.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-monitor-enable.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-monitor-disable.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 28,
            "sizeDeletions": 1
        },
        {
            "number": 4,
            "revision": "194b94ee32127d0947f56638b75971bb5c82703e",
            "parents": [
                "2a054922f3fe7a96182d5c2631dd8187d44728e0"
            ],
            "ref": "refs/changes/22/53122/4",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1650579733,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Brandon J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Makes me wonder if phosphor-psu-monitor.service should be claiming that PSUMonitor bus name.\nhttps://github.com/openbmc/phosphor-power/blob/master/services/phosphor-psu-monitor.service\n"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I am not an expert, but I think it is mainly needed if another service is dependent on yours and shouldn't start until yours has claimed the bus name.\n\nIf there are no dependencies like that, you could probably omit it for now.  One less place where the bus name is hard-coded."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Brandon J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "I am not aware of any dependency, so, we are probably good leaving that out...for the power supply monitor service."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "phosphor-regulators/src/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                },
                {
                    "file": "services/phosphor-regulators.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-config.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-monitor-enable.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-monitor-disable.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 31,
            "sizeDeletions": 3
        },
        {
            "number": 5,
            "revision": "d13072949ca24a54948b544c569fdcc6769b839c",
            "parents": [
                "2a054922f3fe7a96182d5c2631dd8187d44728e0"
            ],
            "ref": "refs/changes/22/53122/5",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1650743361,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "phosphor-regulators/src/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -3
                },
                {
                    "file": "services/phosphor-regulators.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-config.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-monitor-enable.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-regulators-monitor-disable.service",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 31,
            "sizeDeletions": 3
        }
    ]
}