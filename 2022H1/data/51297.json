{
    "project": "openbmc/pldm",
    "branch": "master",
    "id": "If6eafabbbd33a41ef12d178067649043c902e4a6",
    "number": 51297,
    "subject": "pldmsoftoff : Add --notimeout option for pldm soft off app",
    "owner": {
        "name": "ManojKiran Eda",
        "email": "manojkiran.eda@gmail.com",
        "username": "manojkiraneda"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/pldm/+/51297",
    "commitMessage": "pldmsoftoff : Add --notimeout option for pldm soft off app\n\nThis commit would add a runtime override option for the\npldm softoff application, when --notimeout option is\nspecified in /etc/default/softoff file, the soft off application\nwould not start any timer & would wait for the host to gracefully\nshutdown.\n\nThis feature is driven by situations where the PLDM messages are lost\nin the mctp layer, there by host never see's a power off request from\nBMC, there by forcing the host to shutdown abrubtly leading to\nhost memory corruption issues.\n\nThis feature would give host some time to collect debug data, as we dont\nshutdown and hang there for eternity untill we get a response from host.\n\nSigned-off-by: Manojkiran Eda <manojkiran.eda@gmail.com>\nChange-Id: If6eafabbbd33a41ef12d178067649043c902e4a6\n",
    "createdOn": 1645089638,
    "lastUpdated": 1651023194,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1645089638,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1645089655,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645089655,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1645089661,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-repository-ppc64le/3886/ (1/2)\n\nppc64le CI Build Started"
        },
        {
            "timestamp": 1645090478,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-repository-ppc64le/3886/ : ppc64le CI Build Successful\n\nhttps://jenkins.openbmc.org/job/ci-repository/37467/ : SUCCESS"
        },
        {
            "timestamp": 1645095489,
            "reviewer": {
                "name": "Sampa Misra",
                "email": "sampmisr@in.ibm.com",
                "username": "sampmisr"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1645156664,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@inspur.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1649133162,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1649133180,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1649133180,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1649133186,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-repository-ppc64le/3950/ (2/2)\n\nppc64le CI Build Started"
        },
        {
            "timestamp": 1649134040,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40501/ : SUCCESS\n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-repository-ppc64le/3950/ : ppc64le CI Build Successful"
        },
        {
            "timestamp": 1649134059,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1649204645,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@inspur.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1649238730,
            "reviewer": {
                "name": "Pavithra Barithaya",
                "email": "pavithra.b@ibm.com",
                "username": "Pavithrab7"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1649305424,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1649646292,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1649814108,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1650943220,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Abandoned"
        },
        {
            "timestamp": 1651023194,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "ce92c6a20df637069140d092412d141df57a2163",
            "parents": [
                "6f2a2489b6f688ff9f23c77cbfa1a5d8726354bd"
            ],
            "ref": "refs/changes/97/51297/1",
            "uploader": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "createdOn": 1645089638,
            "author": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "softoff/softoff.hpp",
                    "line": 29,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@inspur.com",
                        "username": "lxwinspur"
                    },
                    "message": "please add a default value\n`bool noTimeOut = true or false`"
                },
                {
                    "file": "softoff/softoff.hpp",
                    "line": 29,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "Done"
                },
                {
                    "file": "softoff/softoff.hpp",
                    "line": 48,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@inspur.com",
                        "username": "lxwinspur"
                    },
                    "message": "Nit:\nreturn noTimeOut ? false : timer.isExpired();"
                },
                {
                    "file": "softoff/softoff.hpp",
                    "line": 48,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "softoff/softoff.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                },
                {
                    "file": "softoff/softoff.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -23
                },
                {
                    "file": "softoff/services/pldmSoftPowerOff.service",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -1
                },
                {
                    "file": "softoff/main.cpp",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": -2
                },
                {
                    "file": "softoff/meson.build",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                },
                {
                    "file": "softoff/softoff",
                    "type": "ADDED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 102,
            "sizeDeletions": 27
        },
        {
            "number": 2,
            "revision": "c165e2c157923d9ca490f8dce24d01b00530ddfc",
            "parents": [
                "5c7253ada19e11e5ff2f7e24d35a7c60df7ada0b"
            ],
            "ref": "refs/changes/97/51297/2",
            "uploader": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "createdOn": 1649133162,
            "author": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "1. Do we have PLDM retry mechanism for soft-off? This might be interesting topic, since retry mechanism in pldm daemon. softoff is one-off pldm knowing app at the moment. Do we see more pldm knowing apps in the future..etc. A good topic for community discussion and not to hold this patch.\n\n2.\n>the soft off application would not start any timer & would wait for the host to gracefullyshutdown.\n\nWhat will be the behavior if host never sees the power off request and the graceful shutdown RF API never completes?\nI am thinking we need to articulate the flow better, in the context of error paths."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "> Do we have PLDM retry mechanism for soft-off? This might be interesting topic, since retry mechanism in pldm daemon. softoff is one-off pldm knowing app at the moment. Do we see more pldm knowing apps in the future..etc. A good topic for community discussion and not to hold this patch.\n\nNo , we dont have any retries & yes i do see apps directly talking to host is gonna be a usecase which needs to have a better design and discussion with in the community.\n\n> What will be the behavior if host never sees the power off request and the graceful shutdown RF API never completes?\n\nSo, currently this is what happens :\n1. softoff app requests a power off request & start a timer.\n2. host will shutdown the partitions & send a sensor event back (telling that they are now ready & then we can go ahead and pull the chassis power).\n3. if the timer expires before getting the sensor event from host - we will forcefully remove the chassis power after a standard timeout.\n\nNow, we have seen cases where host complains that they have not received the power off request , but on the bmc side we see that we trigerred the request (and got a response as well).\nIn this case - when the timer expires we will go ahead and remove the chassis power forcefully. The problem with this is once the host goes down we cannot collect any debug data - which is primarily the usecase that drove this feature.\n\nThis commit would add - a runtime override config support for softoff to not have any timeouts. So that chassis power off target will never be invoked(as there is no timer expiry). This would give time for some one to collect the debug data on host side."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "> Now, we have seen cases where host complains that they have not received the power off request ,\nThis seems counter-intuitive, by power off request I am thinking it is the set effecter. If set effecter is not received, host will never initiate graceful shutdown. So indefinite timeout is a moot point.\n\n\n> This commit would add - a runtime override config support for softoff to not have any timeouts. So that chassis power off target will never be invoked(as there is no timer expiry). This would give time for some one to collect the debug data on host side.\n\nMy concern and what I am trying to understand is whether expectation around softoff application has changed. The design was for BMC (user uses GracefulShutdown RF API) to use PLDM mechanisms to gracefully shutdown host and power off the chassis. From this comment I am inferring that for unclear reason/congestion PLDM mechanisms didn't work and soft off app waits indefinitely. Is it the case that with timeout flag, soft-off app never completes?\n\nThis seems like a workaround. I am not sure whether we should upstream this. The correct thing would be to retry pldm requests and if host is unresponsive, then soft-off application fail.\n\n> 1. softoff app requests a power off request & start a timer.\nIf would be great if you can document this flow as README under softoff/README.md"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "Ack.\n\nFrom the review comments , it does not seem like the community is really interested in a feature like this.\n\nSo abandoning the commit. Thanks for all the review comments."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "softoff/softoff.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -2
                },
                {
                    "file": "softoff/softoff.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -23
                },
                {
                    "file": "softoff/services/pldmSoftPowerOff.service",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -1
                },
                {
                    "file": "softoff/main.cpp",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": -2
                },
                {
                    "file": "softoff/meson.build",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                },
                {
                    "file": "softoff/softoff",
                    "type": "ADDED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 100,
            "sizeDeletions": 28
        }
    ]
}