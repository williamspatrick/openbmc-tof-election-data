{
    "project": "openbmc/obmc-console",
    "branch": "master",
    "id": "I7647b8e21747ea98f68e4bc7c5bbf1339354bd75",
    "number": 52470,
    "subject": "log_trim: Rotate log instead of truncate",
    "owner": {
        "name": "Lei YU",
        "email": "yulei.sh@bytedance.com",
        "username": "mine260309"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/obmc-console/+/52470",
    "commitMessage": "log_trim: Rotate log instead of truncate\n\nWhen the log buffer file's size exceeds, the log_trim() was using\nmoving the file's content and truncate it to a specific size.\nThis results in a behavior that the log file is always changing its\nwhole content when log_trim() is called.\n\nIt could be better to change the behavior like logrotate, that move the\noriginal file to a new one, and create a new log file for log buffer.\nThis way it makes sure that the log file is always appended with new\ncontent and thus is friendly to rsyslog.\n\nTested: Verify rsyslog could use imfile module to handle this log file\n        normally. Before this change, rsyslog will handle it incorrectly\n\twhen log_trim() is called.\n\nSigned-off-by: Lei YU <mine260309@gmail.com>\nChange-Id: I7647b8e21747ea98f68e4bc7c5bbf1339354bd75\n",
    "createdOn": 1648616943,
    "lastUpdated": 1649117967,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1648616943,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1648616972,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648616972,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1648617008,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40096/ : SUCCESS"
        },
        {
            "timestamp": 1648619213,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 1:\n\n(8 comments)"
        },
        {
            "timestamp": 1648621493,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1648621502,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648621502,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1648621522,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(8 comments)"
        },
        {
            "timestamp": 1648621538,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40100/ : SUCCESS"
        },
        {
            "timestamp": 1648624371,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 2: Code-Review+2\n\n(4 comments)"
        },
        {
            "timestamp": 1648625205,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648625892,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648626631,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648628957,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648629522,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648630654,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1648631935,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1648631962,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648631962,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1648631998,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40112/ : SUCCESS"
        },
        {
            "timestamp": 1648632273,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 3: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1648638948,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1648639933,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1648641432,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(2 comments)"
        },
        {
            "timestamp": 1648684568,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1648702394,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1648711591,
            "reviewer": {
                "name": "Jeremy Kerr",
                "email": "jk@ozlabs.org",
                "username": "jk-ozlabs"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1648715058,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1648715065,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1648715079,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648715080,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1648715113,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40201/ : SUCCESS"
        },
        {
            "timestamp": 1648722501,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1648730473,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1648730477,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 4:\n\n(2 comments)"
        },
        {
            "timestamp": 1648730491,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648730491,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1648730528,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/40242/ : SUCCESS"
        },
        {
            "timestamp": 1648791561,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1648793987,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1648813501,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 5: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1649117961,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1649117967,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "7d81d926a6a3e85f34e268ca8cce049363ecfb60",
            "parents": [
                "467d3010344d974f3051162d29f13f49c0eb8ea3"
            ],
            "ref": "refs/changes/70/52470/1",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1648616943,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Looks good - seeing as we don't have logrotate available, I'm fine doing this within obmc-console (we will want to review that if we ever do include logrotate though).\n\nA couple of comments on the code, but they're fairly minor."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Even with logrotate, it depends on logrotate to be run timely. If the BMC receives too many SOL content in short time, the buffer will exeeds the size limit until logrotate to be run.\n\nThe code in obmc-console-server makes sure the log file does not exeeds the limit."
                },
                {
                    "file": "log-handler.c",
                    "line": 41,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "use the convention above for the placement of '*'."
                },
                {
                    "file": "log-handler.c",
                    "line": 41,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                },
                {
                    "file": "log-handler.c",
                    "line": 62,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "This wording is a little ambiguous; maybe invert the logic:\n\n/* don't return, as we need to re-open the logfile */\n\nhowever, it's also possible to defer the close() until after you know the rotate is successful...\n\nall other comments in this project are C-style, would be good to keep that consistent."
                },
                {
                    "file": "log-handler.c",
                    "line": 62,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done.\n\nCould we rename the file without closing it?"
                },
                {
                    "file": "log-handler.c",
                    "line": 62,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Yes, that's fine, but note that the fd will now refer to the renamed file.\n\nSo:\n\n- if the rename succeeds, you can close() the old fd and open(O_CREAT) the new file.\n\n- if the rename fails, you can lseek() and ftruncate().\n\n(continued in the next comment though)"
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "I don't think there's any need to exit (or even warn, really) here. The fd will be at offset zero, so the new log data will overwrite the old."
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "In case rename fails, the old file still exists and thus I need to truncate it.\nIn case it fails, make it return -1 so that log_data() will not write the data to the fd."
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "... in that latter case, where rename() fails, the only critical thing is the lseek(). If that fails, the file will continue to grow. If the ftruncate() fails, the old file content will remain, but will be overwritten as new log data is received - I don't think that should be an error, but happy either way if you have strong opinions on that.\n\n[keep in mind this is only relevant if the rename() also fails, so will be very rare!]"
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "In the case of the rename failing but the lseek succeeding we'd avoid the problem of the log file growing too large, but wouldn't we then end up with the new problem of readers being unaware of the boundary between the new data at the start of the file and the old data following it?  That seems like it could lead to hard-to-predict awkwardness downstream (I certainly don't know offhand what rsyslog would do in that case)."
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Yep, we'd end up with the start of the new log in the file, and the end of the old.\n\nI'd say that's better than dropping log data, but the confusing file contents could be an issue. I'm OK either way."
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Yeah, I'd certainly agree that exiting would be an overreaction, but it does seem like a sufficiently weird/confusing situation to merit the `warn()` call it's currently got IMO.  (Could definitely be a helpful clue for someone attempting to debug post-mortem in the event it ever actually occurs.)"
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Though actually...should we just toss O_TRUNC into the open() flags and obviate this path entirely?  I suppose in principle it would basically glom the two error cases together due to making them a single syscall, but maybe it's sort of academic anyway in practice?  (Shrug.)"
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "O_TRUNC looks better.\nPossibly we could remove the ftruncate() calls in both init() and trim() cases."
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "sounds good! does this mean we should do a rotate during init then?"
                },
                {
                    "file": "log-handler.c",
                    "line": 75,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Usually it's not necessary, because the obmc-console-server is started during BMC boot and is never restarted unless it's crashed and restarted."
                },
                {
                    "file": "log-handler.c",
                    "line": 171,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "declarations at the top, for consistency."
                },
                {
                    "file": "log-handler.c",
                    "line": 171,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                },
                {
                    "file": "log-handler.c",
                    "line": 172,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "no need to cast"
                },
                {
                    "file": "log-handler.c",
                    "line": 172,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                },
                {
                    "file": "log-handler.c",
                    "line": 173,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "just strcat here, no need to re-format."
                },
                {
                    "file": "log-handler.c",
                    "line": 173,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Then it needs strcpy and strcat.\nI feel a bit simpler with snprintf()"
                },
                {
                    "file": "log-handler.c",
                    "line": 173,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "OK, sure."
                },
                {
                    "file": "log-handler.c",
                    "line": 188,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "no need for the braces here"
                },
                {
                    "file": "log-handler.c",
                    "line": 188,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "log-handler.c",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": -20
                }
            ],
            "sizeInsertions": 58,
            "sizeDeletions": 20
        },
        {
            "number": 2,
            "revision": "a87b069fce2676b65cb58f8df5013c08450d2946",
            "parents": [
                "467d3010344d974f3051162d29f13f49c0eb8ea3"
            ],
            "ref": "refs/changes/70/52470/2",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1648621493,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Some comments on handling error conditions, but I'd be OK with the patchset as-is."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "log-handler.c",
                    "type": "MODIFIED",
                    "insertions": 33,
                    "deletions": -20
                }
            ],
            "sizeInsertions": 57,
            "sizeDeletions": 20
        },
        {
            "number": 3,
            "revision": "45ba2f9828bd0f9baf6c2f49c5489ec8b0db09ee",
            "parents": [
                "467d3010344d974f3051162d29f13f49c0eb8ea3"
            ],
            "ref": "refs/changes/70/52470/3",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1648631935,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "Very clean, I like it!"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "One last tiny nitpick that could be addressed, but it basically looks good to me."
                },
                {
                    "file": "log-handler.c",
                    "line": 65,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "One other thing that just occurred to me...is 0644 the right mode to be passing here?  I suspect in most existing deployments OpenBMC effectively runs as a single-user system (with nearly all processes running as root), but I think there are some efforts underway working towards changing that, which makes me wonder if maybe it shouldn't be world-readable.  Maybe 0600 instead?"
                },
                {
                    "file": "log-handler.c",
                    "line": 65,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "That's fairly straightforward to apply globally with a umask.\n\nHowever, I haven't had much traction with the security folks about this kind of thing; filesystem access has been considered to be protected to privileged users anyway, so I don't think this would be a high priority.\n\nBut yep, not something to address in this patch."
                },
                {
                    "file": "log-handler.c",
                    "line": 153,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "And likewise here, though arguably it's tangential to this particular patch and should be done separately."
                },
                {
                    "file": "log-handler.c",
                    "line": 153,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Right, if we are going to change the mode, let's do it in a separate patch."
                },
                {
                    "file": "log-handler.c",
                    "line": 162,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "We're building without specifying -std= and are using gcc, so we default to -std=gnu17. Given that we can use asprintf() (we should also be more explicit about what C dialect the source is written in, but that's a problem for a different patch).\n\nFurther, \"%s%s\" is a bit much when the second string is also a constant. We can just use:\n\n rc = asprintf(&lh->rotate_filename, \"%s.1\", filename);\n if (rc < 0) { ..."
                },
                {
                    "file": "log-handler.c",
                    "line": 162,
                    "reviewer": {
                        "name": "Jeremy Kerr",
                        "email": "jk@ozlabs.org",
                        "username": "jk-ozlabs"
                    },
                    "message": "... and we use asprintf elsewhere in obmc-console, so this won't affect compatibility."
                },
                {
                    "file": "log-handler.c",
                    "line": 162,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                },
                {
                    "file": "log-handler.c",
                    "line": 178,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "`free(NULL)` is guaranteed to be a safe no-op, so the `if` checks here could be removed."
                },
                {
                    "file": "log-handler.c",
                    "line": 178,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Yeah, I prefer we clean that up now."
                },
                {
                    "file": "log-handler.c",
                    "line": 178,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "log-handler.c",
                    "type": "MODIFIED",
                    "insertions": 28,
                    "deletions": -27
                }
            ],
            "sizeInsertions": 52,
            "sizeDeletions": 27
        },
        {
            "number": 4,
            "revision": "a43d9db3f4ef0be6898e3226a5c6f46752a99e77",
            "parents": [
                "467d3010344d974f3051162d29f13f49c0eb8ea3"
            ],
            "ref": "refs/changes/70/52470/4",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1648715065,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "log-handler.c",
                    "line": 163,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "I don't think we want err() here, and passing rc to err() is wrong regardless (it should either be EXIT_SUCCESS or EXIT_FAILURE).\n\nI think we just warn() and return -1 like we do in the body of the condition on line 154."
                },
                {
                    "file": "log-handler.c",
                    "line": 163,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "log-handler.c",
                    "type": "MODIFIED",
                    "insertions": 27,
                    "deletions": -27
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 27
        },
        {
            "number": 5,
            "revision": "93fd8a39d8d20cdf965490f594a2d6f6d90f506c",
            "parents": [
                "467d3010344d974f3051162d29f13f49c0eb8ea3"
            ],
            "ref": "refs/changes/70/52470/5",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1648730473,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "log-handler.c",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Was this required? We should probably do this in CFLAGS rather than using in-file #defines"
                },
                {
                    "file": "log-handler.c",
                    "line": 17,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Yes, without this, build error occurs:\n\n error: implicit declaration of function \u2018asprintf\u2019; did you mean \u2018vsprintf\u2019? [-Werror=implicit-function-declaration]\n\nThe code using `asprintf()` defines it in its source, e.g. console-server.c\n\nShould we modify the configure.ac or Makefile.am to define _GNU_SOURCE?"
                },
                {
                    "file": "log-handler.c",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "No it's fine for now, was just thinking out loud"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "log-handler.c",
                    "type": "MODIFIED",
                    "insertions": 27,
                    "deletions": -25
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 25
        }
    ]
}