{
    "project": "openbmc/phosphor-debug-collector",
    "branch": "master",
    "id": "Ia61c2c5372be5c127285dac66008ca49bfcb7fd2",
    "number": 51207,
    "subject": "Make dump offload an async method",
    "owner": {
        "name": "Dhruvaraj S",
        "email": "dhruvaraj@gmail.com",
        "username": "dhruvibm"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-debug-collector/+/51207",
    "commitMessage": "Make dump offload an async method\n\nWhen the dump offload is called from the d-Bus method and\nthe download speed is very low for larger dumps, a timeout\nis observed, and the caller is getting a timeout error.\nTo avoid this making the dump offload as an async method.\n\nTests:\n   Offloading dumps with different sizes\n\nSigned-off-by: Dhruvaraj Subhashchandran <dhruvaraj@in.ibm.com>\nChange-Id: Ia61c2c5372be5c127285dac66008ca49bfcb7fd2\n",
    "createdOn": 1644896054,
    "lastUpdated": 1646575761,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1644896054,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1644896066,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1644896066,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1644896130,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37259/ : SUCCESS"
        },
        {
            "timestamp": 1644917010,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1644917061,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1644917061,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1644917130,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37291/ : SUCCESS"
        },
        {
            "timestamp": 1644924292,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 2:\n\n(6 comments)"
        },
        {
            "timestamp": 1644928971,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1644932617,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Patch Set 2:\n\n(4 comments)"
        },
        {
            "timestamp": 1644946030,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Uploaded patch set 3: Patch Set 2 was rebased."
        },
        {
            "timestamp": 1644946074,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1644946074,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1644946147,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37312/ : SUCCESS"
        },
        {
            "timestamp": 1644994394,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1644994413,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1644994413,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1644994477,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37346/ : SUCCESS"
        },
        {
            "timestamp": 1645030425,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1645030434,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645030434,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1645030495,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37369/ : SUCCESS"
        },
        {
            "timestamp": 1645049607,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5: Code-Review-1\n\n(2 comments)"
        },
        {
            "timestamp": 1645049665,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1645071479,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Patch Set 5:\n\n(3 comments)"
        },
        {
            "timestamp": 1645072581,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5:\n\n(3 comments)"
        },
        {
            "timestamp": 1645767519,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Removed reviewer MARRI DEVENDER RAO."
        },
        {
            "timestamp": 1646575761,
            "reviewer": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "message": "Abandoned"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "16f8cc5c160cd6c68a18a2bd727da4b0c46b237d",
            "parents": [
                "9adaa6eeaf8d4ee1f05b486b5bae5d8b72a44991"
            ],
            "ref": "refs/changes/07/51207/1",
            "uploader": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "createdOn": 1644896054,
            "author": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "bmc_dump_entry.cpp",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -2
                },
                {
                    "file": "bmc_dump_entry.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 43,
            "sizeDeletions": 2
        },
        {
            "number": 2,
            "revision": "55b3ead542ee77071684cd401f35128c6754533e",
            "parents": [
                "25a0064461c44c6533d4ece705d32a772cea13af"
            ],
            "ref": "refs/changes/07/51207/2",
            "uploader": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "createdOn": 1644917010,
            "author": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "Dhruv If user is async d-bus requests will solve this issue? \n\nPtarick sdbusplus  provides any async d-bus method_call?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "An async dbus method call likely still doesn't solve what you need.  dbus client-side operations have a timeout which will be long passed by the time the offload is complete."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Dhruvaraj S",
                        "email": "dhruvaraj@gmail.com",
                        "username": "dhruvibm"
                    },
                    "message": "Tested downloading to clients with slow connection so a 10 minutes download worked with both async and sync methods\n\nbut if there is another dbus call coming with sync offload that dbus call is timing out and the offload also is failing.\n\nthat issue is not there with async method"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Ok.  I don\u2019t understand why it didn\u2019t timeout.  It should timeout after 25 seconds by default.\n\nhttps://man7.org/linux/man-pages/man3/sd_bus_get_method_call_timeout.3.html\n\nhttps://github.com/systemd/systemd/blob/be7148ebed5d73c4a76bc6089ebe2e82d8fa33e0/src/libsystemd/sd-bus/sd-bus.c#L1916"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 14,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "The new proposal allows  multiple dump offload requests. is this allowed from BMCweb?  Based on the current design this is going to fail right? are we logging useful error information/response to user here? it will be good to add tested details here related to this."
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 20,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "Alway's returning 0 , is this return is really required?"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 20,
                    "reviewer": {
                        "name": "Dhruvaraj S",
                        "email": "dhruvaraj@gmail.com",
                        "username": "dhruvibm"
                    },
                    "message": "void was not allowed by the method"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 22,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "requestOffload thrwos exceptions. do we need to restart the service for any failures?"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 22,
                    "reviewer": {
                        "name": "MARRI DEVENDER RAO",
                        "email": "devenrao@in.ibm.com",
                        "username": "devenrao"
                    },
                    "message": "then we need to do try..catch and commit the error, as I understand exceptions are not propagated to the main method"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 22,
                    "reviewer": {
                        "name": "Dhruvaraj S",
                        "email": "dhruvaraj@gmail.com",
                        "username": "dhruvibm"
                    },
                    "message": "no if the download is not complete, the client need to restart the download"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 23,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "INFO?"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 23,
                    "reviewer": {
                        "name": "Dhruvaraj S",
                        "email": "dhruvaraj@gmail.com",
                        "username": "dhruvibm"
                    },
                    "message": "Done"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 49,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "IONFO?"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 49,
                    "reviewer": {
                        "name": "Dhruvaraj S",
                        "email": "dhruvaraj@gmail.com",
                        "username": "dhruvibm"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 43,
            "sizeDeletions": 2
        },
        {
            "number": 3,
            "revision": "fb961cbeba0a77756349758f1db94a6c0fe4f8b2",
            "parents": [
                "5dbf45bbcb1ec19e0ecaf3f5d058f312b79dac06"
            ],
            "ref": "refs/changes/07/51207/3",
            "uploader": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "createdOn": 1644946030,
            "author": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 43,
            "sizeDeletions": 2
        },
        {
            "number": 4,
            "revision": "85f11dc87e08ba1f33b2209cdc4848eea1c81498",
            "parents": [
                "5dbf45bbcb1ec19e0ecaf3f5d058f312b79dac06"
            ],
            "ref": "refs/changes/07/51207/4",
            "uploader": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "createdOn": 1644994394,
            "author": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "type": "MODIFIED",
                    "insertions": 19,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 46,
            "sizeDeletions": 2
        },
        {
            "number": 5,
            "revision": "851256158be9055741c92b9aba0336567cf76e2d",
            "parents": [
                "5dbf45bbcb1ec19e0ecaf3f5d058f312b79dac06"
            ],
            "ref": "refs/changes/07/51207/5",
            "uploader": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "createdOn": 1645030425,
            "author": {
                "name": "Dhruvaraj S",
                "email": "dhruvaraj@gmail.com",
                "username": "dhruvibm"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 23,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "dbus is not thread-safe.  You can't set a property (which has the side-effect of raising a PropertiesChanged signal) from anything except the main thread.\n\nThis is a sd_bus limitation, not just sdbusplus."
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 23,
                    "reviewer": {
                        "name": "Dhruvaraj S",
                        "email": "dhruvaraj@gmail.com",
                        "username": "dhruvibm"
                    },
                    "message": "This will be a problem, need some callback to main thread after the completion of the offload"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 23,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Yes.  You\u2019ll need to trigger some kind of sd_event back to the main thread likely."
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 52,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "The 'asyncOffloadThread.valid()' will be valid until someone calls 'get' on the future after it has completed.  I don't see any path where that happens, so how does the future become invalid after completion?  Doesn't this mean that you can only initiate offload a single time per entry?\n\nhttps://en.cppreference.com/w/cpp/thread/future/valid"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 52,
                    "reviewer": {
                        "name": "Dhruvaraj S",
                        "email": "dhruvaraj@gmail.com",
                        "username": "dhruvibm"
                    },
                    "message": "Yes future will become invalid after completion because there is one socket file used by BMC web for each dump, so we cannot have simultaneous offloads of same dump"
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "line": 52,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Can you elaborate how it becomes invalid?  Meaning, what code causes it?  I don\u2019t see anything in place now."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "bmcstored_dump_entry.cpp",
                    "type": "MODIFIED",
                    "insertions": 26,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 53,
            "sizeDeletions": 2
        }
    ]
}