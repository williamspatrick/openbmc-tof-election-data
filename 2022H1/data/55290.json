{
    "project": "openbmc/docs",
    "branch": "master",
    "topic": "design",
    "id": "Iaaccc40e54e0cdee7ff1038aac585c0193200e9b",
    "number": 55290,
    "subject": "design: propose a shell-based firmware update daemon",
    "owner": {
        "name": "Justin Ledford",
        "email": "justinledford@google.com",
        "username": "justinledford"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/docs/+/55290",
    "commitMessage": "design: propose a shell-based firmware update daemon\n\nSigned-off-by: Justin Ledford <justinledford@google.com>\nChange-Id: Iaaccc40e54e0cdee7ff1038aac585c0193200e9b\n",
    "createdOn": 1657590456,
    "lastUpdated": 1657691204,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1657590456,
            "reviewer": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1657590550,
            "reviewer": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "message": "Uploaded patch set 2: Commit message was updated."
        },
        {
            "timestamp": 1657633893,
            "reviewer": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "message": "Topic set to design"
        },
        {
            "timestamp": 1657634594,
            "reviewer": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1657643280,
            "reviewer": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1657656718,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1657657170,
            "reviewer": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "message": "Patch Set 4: Commit message was updated."
        },
        {
            "timestamp": 1657691204,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(17 comments)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "1af99424d21f462690c424788df9dc483a5a0c65",
            "parents": [
                "bc8205063946cb6f2e357d22188c5dd6dfbcfd92"
            ],
            "ref": "refs/changes/90/55290/1",
            "uploader": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "createdOn": 1657590456,
            "author": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "type": "ADDED",
                    "insertions": 290,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 300,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "2db663a2298c5003bd4c29ea458214cdf32ee441",
            "parents": [
                "bc8205063946cb6f2e357d22188c5dd6dfbcfd92"
            ],
            "ref": "refs/changes/90/55290/2",
            "uploader": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "createdOn": 1657590550,
            "author": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 80,
                    "reviewer": {
                        "name": "Justin Ledford",
                        "email": "justinledford@google.com",
                        "username": "justinledford"
                    },
                    "message": "This is rendered on Github, please see https://github.com/Edmond-Mo/device_update_daemon/blob/main/update_seq.md"
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 122,
                    "reviewer": {
                        "name": "Justin Ledford",
                        "email": "justinledford@google.com",
                        "username": "justinledford"
                    },
                    "message": "This is rendered on Github, please see https://github.com/Edmond-Mo/device_update_daemon/blob/main/version_seq.md"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "type": "ADDED",
                    "insertions": 290,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 300,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "e4b0e058cbc62abb1e31e399cc1ec0f90757cfd1",
            "parents": [
                "bc8205063946cb6f2e357d22188c5dd6dfbcfd92"
            ],
            "ref": "refs/changes/90/55290/3",
            "uploader": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "createdOn": 1657643280,
            "author": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 272,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Additional info in case it may be relevant, the phosphor-bmc-code-mgmt performs the updates via shell scripts, example: https://github.com/openbmc/phosphor-bmc-code-mgmt/blob/master/obmc-flash-bmc\n\nNot sure if having a separate repo would cause code duplication."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "type": "ADDED",
                    "insertions": 288,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 298,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "cc30ed3e6a822d02475418b1bec59e7a7a117ecd",
            "parents": [
                "bc8205063946cb6f2e357d22188c5dd6dfbcfd92"
            ],
            "ref": "refs/changes/90/55290/4",
            "uploader": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "createdOn": 1657657170,
            "author": {
                "name": "Justin Ledford",
                "email": "justinledford@google.com",
                "username": "justinledford"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 10,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Might want to call out the effort here.  Technically if your time is free, it's not expensive, but I get your meaning."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 13,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "?  Why not?  systemctl for example does it by simply having a daeamon, then the CLI talks to the daemon to do any \"work\""
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 15,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Assuming it's not already a daemon, like fwupd."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 23,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Might want to phrase \"Isn't generalized\""
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 28,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This is kind of a stretch.  Given that a well behaved redfish API has a progress interface via task service, this would imply that you need some form of bmc-specific communication with the update CLI, or you jump directly from 0 to 100%"
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 35,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Please make this more concrete.  What does \"user friendly\" mean?"
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 36,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Isn't this an implementation detail of the device being updated?  In the google case, yes, we use a lot of the same signature verification across, but this doesn't generalize to a redfish API that would exist outside the system."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 144,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "????  It seems like going the opposite direction, as it's implementing a totally different daemon, which is contrary to one daemon per device/transport."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 146,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This kind of implies that we shouldn't accept code upstream that uses this then?"
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 172,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "These parameters break the primary principals of entity-manager.\n\n1. They hardcode linux specifics (commands).\n2. They hardcode software resources into an EM config file.  EM config files should represent entities that physically exist.\n\nGenerally you would model this with \n\nType: \"ADMxxxVR\"\n\nin your exposes record, and that's it.  Software should know what update mechanisms exist for that device type, and if part of that involves calling shell, so be it.\n\nAlso, because exposes records are user facing, we can't be calling exec on arbitrary user-provided runtime strings, as it would break a lot of security assumptions.\n\n\nMaybe most of these need to go into a lookup table, similar to what we use in PSU sensor for mapping device -> linux device?"
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 176,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This would imply that they need to be different exposes records if you can have one or both capabilities, but I think there's going to be change due to the comment above."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 201,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This woudl imply that we're launching and destroying a process every 10 seconds, which is an anti-pattern.  Dbus-sensors used to do this, and the facebook openbmc stack did this for sensor reading, and it caused problems.  We probably need to drop support for this.  If you need to get an instantaneous version number, you need to implement a daemon."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 210,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "?  What would be hosting this file?  Can we use a more realistic example?"
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 251,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Why not?  Presumably we could still have a single \"simple update\" daemon, but that just calls library code instead of a CLI?  If we're importing tools without a proper library interface we might want to be worried."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 255,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "?  If it's not necessary, then just delete it?  I don't necessarily disagree with the conclusion here, but the path to get there is a little hazy."
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 267,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "\"care should be taken\" isn't really a good enough statement.\n\nAre there any standards/specs we need to meet with regards to firmware update?"
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "line": 271,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Why couldn't it go in one of the existing daemons?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "designs/shell-based-fw-update-daemon.md",
                    "type": "ADDED",
                    "insertions": 288,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 298,
            "sizeDeletions": 0
        }
    ]
}