{
    "project": "openbmc/phosphor-state-manager",
    "branch": "master",
    "id": "Iddcc09dc34133806abe33570c5422bde51981bdb",
    "number": 51766,
    "subject": "secure-boot: check sysfs debug settings",
    "owner": {
        "name": "Andrew Geissler",
        "email": "andrew@geissonator.com",
        "username": "geissonator"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-state-manager/+/51766",
    "commitMessage": "secure-boot: check sysfs debug settings\n\nThese aspeed-specific settings are provided via the kernels sysfs\nfilesystem. They provide information on the security of the BMC.\n\nFollow on commits will check if the BMC is in manufacturing mode and log\nan error if the system does not pass the security check.\n\nSigned-off-by: Andrew Geissler <geissonator@yahoo.com>\nChange-Id: Iddcc09dc34133806abe33570c5422bde51981bdb\n",
    "createdOn": 1646687214,
    "lastUpdated": 1651021345,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1646687214,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1646687228,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1646687228,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1646687363,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/38556/ : SUCCESS"
        },
        {
            "timestamp": 1646687749,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 2: New patch set was added with same tree, parent, and commit message as Patch Set 1."
        },
        {
            "timestamp": 1646687760,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1"
        },
        {
            "timestamp": 1646687761,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1646687761,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1646687931,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/38562/ : SUCCESS"
        },
        {
            "timestamp": 1646841911,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1646949434,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1647323820,
            "reviewer": {
                "name": "Joel Stanley",
                "email": "joel@jms.id.au",
                "username": "shenki"
            },
            "message": "Patch Set 2:\n\n(4 comments)"
        },
        {
            "timestamp": 1647630096,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1647630096,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3:\n\n(6 comments)"
        },
        {
            "timestamp": 1647630105,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1647630105,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1647630238,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/39265/ : SUCCESS"
        },
        {
            "timestamp": 1647722533,
            "reviewer": {
                "name": "Chris Engel",
                "email": "cjengel@us.ibm.com",
                "username": "cjengel"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1647895880,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1647974059,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1650327454,
            "reviewer": {
                "name": "Joel Stanley",
                "email": "joel@jms.id.au",
                "username": "shenki"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1651021325,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1651021345,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Change has been successfully rebased and submitted as 8d8d731d6a638331527c64f6a8e3fa3c830ba04c"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "9a54e1ba248b16d188edde49ecd4609f894d8943",
            "parents": [
                "5ddeea0aba0e03c524d3dfa453fb4576bdc440a0"
            ],
            "ref": "refs/changes/66/51766/1",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1646687214,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "secure_boot_check.cpp",
                    "type": "MODIFIED",
                    "insertions": 65,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 81,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "71a1fc1d288ee26086d950729f1944164f0691be",
            "parents": [
                "29e4ab728bba3da92ca679e1814dfbd0612f32a1"
            ],
            "ref": "refs/changes/66/51766/2",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1646687749,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "NO_CHANGE",
            "comments": [
                {
                    "file": "secure_boot_check.cpp",
                    "line": 11,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "I'm concerned that we have a BMC-hardware-specific path now (i.e. aspeed). This probably is not going to be something we can merge until we find a way to make this generic or at least a config option passed in. Thoughts appreciated. Reviews still appreciated too."
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 11,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "yeah these can be a meson config option and default to the aspeed paths."
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 11,
                    "reviewer": {
                        "name": "Joel Stanley",
                        "email": "joel@jms.id.au",
                        "username": "shenki"
                    },
                    "message": "The paths have been updated to /sys/kernel/debug/aspeed/sbc/ as of the latest version of the patch."
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 11,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "ok, I made config values"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 11,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 13,
                    "reviewer": {
                        "name": "Joel Stanley",
                        "email": "joel@jms.id.au",
                        "username": "shenki"
                    },
                    "message": "This one is not behaving the way we expect it to. We're waiting on clarification from aspeed, but for now I think we should drop it.\n\nChris said on slack:\n\n> The main concerns we had were to verify secure_boot and the abr image"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 13,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "ok, I'll take this one out."
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 43,
                    "reviewer": {
                        "name": "Joel Stanley",
                        "email": "joel@jms.id.au",
                        "username": "shenki"
                    },
                    "message": "Do you want to handle being unable to open the file? (a file you don't have permission to open)"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 43,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 66,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Seems that all sysfs files need to exist to deem the system secure, is it worth trying to read all the sysfs if one doesn't exist since the check is going to fail in line 83? perhaps instead of creating an info log they should each call to create the error?:\n\nvalue = -1;\nif (std::filesystem::exists(sysfsFile_1))\n{\n    read value;\n}\nif value != 1\n{\n    createError();\n    return;\n}"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 66,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "For debug purposes, Joel had requested in the github issue we read them all and log them to the journal so I figured I'd just read them all and do the logic at the end with a single log if in mfg mode."
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 84,
                    "reviewer": {
                        "name": "Joel Stanley",
                        "email": "joel@jms.id.au",
                        "username": "shenki"
                    },
                    "message": "abrImage!=1 an important error to know about outside of manufacturing. It will only be set if the first u-boot copy is corrupt. (It's not an A/B side thing like on Witherspoon).\n\nShould we test it separately and raise it's own error (even outside of manufacturing mode?)"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 84,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Joel, from https://github.com/ibm-openbmc/dev/issues/3462#issuecomment-1056063496, you said \"abr_image is a per-boot setting. It should always be 0. Raise an error if set to 1.\". So just to be sure, you're saying that has changed and we should log an error if it's !=1?\n\nFor the question on whether we should always check this, that would be a change in the initial requirements, which is ok if we think it makes sense but having this all wrapped around a manufacturing mode check gives us some lee-way in testing and error paths. Would Chris E. be the one to make the decision on this question?"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 84,
                    "reviewer": {
                        "name": "Chris Engel",
                        "email": "cjengel@us.ibm.com",
                        "username": "cjengel"
                    },
                    "message": "interesting questions.  I could see some sort of predictive failure being logged or maybe an attempt to sync the secondary onto the primary and boot again from primary (for some number of attempts).  Think this should be included in discussions we have on how we handle updates to the secondary uboot image which at this point we said are not GA1"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "secure_boot_check.cpp",
                    "type": "MODIFIED",
                    "insertions": 65,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 81,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "2d10cf215a7cbe870b9407ef6c9c34025602f77b",
            "parents": [
                "29e4ab728bba3da92ca679e1814dfbd0612f32a1"
            ],
            "ref": "refs/changes/66/51766/3",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1647630096,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "secure_boot_check.cpp",
                    "line": 88,
                    "reviewer": {
                        "name": "Joel Stanley",
                        "email": "joel@jms.id.au",
                        "username": "shenki"
                    },
                    "message": "Perhaps this is too pedantic, but the system is still secure if abrImage != 0. It's more of a predicative fault, and we want to raise an error for manufacturing.\n\nI'm not sure if it should be lumped with the secure boot state, or made it's own thing.\n\n(I see we had that discussion just above...)"
                },
                {
                    "file": "secure_boot_check.cpp",
                    "line": 88,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, given that in later commits we only log this message (and error) if in manufacturing mode, lets just leave it. A nice simple message like this seems easier then trying to explain it all out."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "meson_options.txt",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "secure_boot_check.cpp",
                    "type": "MODIFIED",
                    "insertions": 66,
                    "deletions": 0
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 95,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "8d8d731d6a638331527c64f6a8e3fa3c830ba04c",
            "parents": [
                "6b9421b9323cf0b9fa9a655140eed729915f4e94"
            ],
            "ref": "refs/changes/66/51766/4",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1651021345,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "meson_options.txt",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "secure_boot_check.cpp",
                    "type": "MODIFIED",
                    "insertions": 66,
                    "deletions": 0
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 95,
            "sizeDeletions": 0
        }
    ]
}