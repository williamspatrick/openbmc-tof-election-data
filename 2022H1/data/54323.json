{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "Ia8635d041f7153198d0582948db6fde1baa142ff",
    "number": 54323,
    "subject": "query params: handle AutoExpand resources correctly",
    "owner": {
        "name": "Nan Zhou",
        "email": "nanzhoumails@gmail.com",
        "username": "FighterNan"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/54323",
    "commitMessage": "query params: handle AutoExpand resources correctly\n\nExisting codes handles $expand wrong when the resource collection is\nannotated with \"AutoExpand\". For example,\n'/redfish/v1/Managers/bmc/LogServices/Dump/Entries?$expand=.' will\nactually do two levels of expand.\n\nThis commit corrects the behavior by inpecting the intermediate\nresponse. If the response is already expanded without any expand\nparamters, the commit will consider the corresponding resource\ncollection is AutoExpand, and it will decrease the parsed expand level\nby one.\n\nTested:\n1. Unit test;\n2. on my mock environment, query parameter works as expected.\n`/redfish/v1/Managers/bmc/LogServices/Dump/Entries?$expand=.` gets the\nsame result as `/redfish/v1/Managers/bmc/LogServices/Dump/Entries`.\n\nSigned-off-by: Nan Zhou <nanzhoumails@gmail.com>\nChange-Id: Ia8635d041f7153198d0582948db6fde1baa142ff\n",
    "createdOn": 1654531679,
    "lastUpdated": 1655932556,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1654531679,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1654531711,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1654531711,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1654532115,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/44445/ : FAILURE"
        },
        {
            "timestamp": 1654537174,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1654537206,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1654537206,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1654537212,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1654537236,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1654537236,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1654537236,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/44451/ : ABORTED"
        },
        {
            "timestamp": 1654537547,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/44452/ : FAILURE"
        },
        {
            "timestamp": 1654537649,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 4: Published edit on patch set 3."
        },
        {
            "timestamp": 1654537696,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1654537696,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1654538207,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/44454/ : SUCCESS"
        },
        {
            "timestamp": 1654548032,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1654549527,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1655825097,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1655858472,
            "reviewer": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1655932556,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "1cd653174a307bba9fd663fe0292e99208f424b7",
            "parents": [
                "966356d6103c25cb8c3960f2914332f3ab99f2a5"
            ],
            "ref": "refs/changes/23/54323/1",
            "uploader": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "createdOn": 1654531679,
            "author": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 27,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/query.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                },
                {
                    "file": "redfish-core/include/utils/query_param_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 66,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/utils/query_param.hpp",
                    "type": "MODIFIED",
                    "insertions": 41,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 137,
            "sizeDeletions": 5
        },
        {
            "number": 2,
            "revision": "6e42798876236b356e299496e670c058987dba28",
            "parents": [
                "c9b5fad5e7858ad133c8afdbe12c27fd45a4e1bc"
            ],
            "ref": "refs/changes/23/54323/2",
            "uploader": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "createdOn": 1654537174,
            "author": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 27,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/query.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "redfish-core/include/utils/query_param_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 66,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/utils/query_param.hpp",
                    "type": "MODIFIED",
                    "insertions": 41,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 135,
            "sizeDeletions": 3
        },
        {
            "number": 3,
            "revision": "8fde576ae8a19b24ad2257d432d7446f68a86ab3",
            "parents": [
                "c9b5fad5e7858ad133c8afdbe12c27fd45a4e1bc"
            ],
            "ref": "refs/changes/23/54323/3",
            "uploader": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "createdOn": 1654537212,
            "author": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 27,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/query.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                },
                {
                    "file": "redfish-core/include/utils/query_param_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 66,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/utils/query_param.hpp",
                    "type": "MODIFIED",
                    "insertions": 41,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 137,
            "sizeDeletions": 5
        },
        {
            "number": 4,
            "revision": "a9ba89cc2c827db0214ed05d08d4bdf2e33ce15c",
            "parents": [
                "c9b5fad5e7858ad133c8afdbe12c27fd45a4e1bc"
            ],
            "ref": "refs/changes/23/54323/4",
            "uploader": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "createdOn": 1654537649,
            "author": {
                "name": "Nan Zhou",
                "email": "nanzhoumails@gmail.com",
                "username": "FighterNan"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I took a skim of this, and I think it's making some bad assumptions about autoexpand, and how the \"Resource\" object in redfish works in general.\n\n1. This patchset assumes that only Redfish-defined collections (with a Members variable) can be auto expanded.  There are in fact two definitions, \"AutoExpand\" and \"AutoExpandReferences\" which are different, and have different behavior in the response, but expand needs to account for both.\n2. The expand requirements apply the same to an entire parent resource.  It is perfectly legal for a resource to have an both an auto expanded resource and a non auto expanded resource within the same tree, so I suspect this behavior needs to be handled as part of walking the resource tree per property.\n3. Handling of \"complex\" type objects is different in terms of auto expand, and needs handled in concert with the \"links\".\n\n\nAlso, FWIW, I don't know if the standard has specific wording around how the expand parameter works in this case.  It's probably worth getting some wording into the standard to this effect."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "> This patchset assumes that only Redfish-defined collections (with a Members variable) can be auto expanded.  There are in fact two definitions, \"AutoExpand\" and \"AutoExpandReferences\" which are different, and have different behavior in the response, but expand needs to account for both.\n\nI don't quite understand what AutoExpandReferences is in the Redfish context. I do find \"entity references\" in OData protocol, but not explained in the Redfish spec. \n\nhttps://github.com/oasis-tcs/odata-vocabularies/blob/main/vocabularies/Org.OData.Core.V1.xml#L440:~:text=%3CTerm%20Name=%22-,AutoExpandReferences,-%22\n\n> The expand requirements apply the same to an entire parent resource.  It is perfectly legal for a resource to have an both an auto expanded resource and a non auto expanded resource within the same tree, so I suspect this behavior needs to be handled as part of walking the resource tree per property.\n\nwhat's your expectation? If a property is AutoExpand and the request is expand with $level=1, then we do not expand these properties?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I don't fully understand what the spec behavior is.  Next steps probably involve logging into the interop lab, and determine what other systems have implemented, then take that information to DMTF and get more clarity in the standard."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Nan Zhou",
                        "email": "nanzhoumails@gmail.com",
                        "username": "FighterNan"
                    },
                    "message": "What's \"interop lab\"?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "https://github.com/DMTF/Redfish/wiki/Redfish-testing-lab"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 27,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/query.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                },
                {
                    "file": "redfish-core/include/utils/query_param_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 66,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/utils/query_param.hpp",
                    "type": "MODIFIED",
                    "insertions": 41,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 137,
            "sizeDeletions": 5
        }
    ]
}