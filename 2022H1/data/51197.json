{
    "project": "openbmc/openpower-proc-control",
    "branch": "master",
    "id": "If41f86b287b70c48d17c6f4b2af9aa0adfb81488",
    "number": 51197,
    "subject": "PHAL: Add service dependency to DEVTREE creation",
    "owner": {
        "name": "Adriana Kobylak",
        "email": "anoo@linux.ibm.com",
        "username": "anoo1"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openpower-proc-control/+/51197",
    "commitMessage": "PHAL: Add service dependency to DEVTREE creation\n\nStart the services that require DEVTREE after the\nopenpower-update-bios-attr-table.service since that's the one that\nsets up the DEVTREE symlink. Also update the path to DEVTREE to the one\ndefined by the meson options.\n\nTested: Verified phal started after the bios attr service file, powered\non, and issued reboot at power on without any errors. Verified service\nfiles had devtree path of:\nEnvironment=\"PDBG_DTB=/media/hostfw/running/DEVTREE\"\n\nSigned-off-by: Adriana Kobylak <anoo@us.ibm.com>\nChange-Id: If41f86b287b70c48d17c6f4b2af9aa0adfb81488\n",
    "createdOn": 1644873502,
    "lastUpdated": 1645522572,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1644873502,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1644873514,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1644873514,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1644873580,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37224/ : SUCCESS"
        },
        {
            "timestamp": 1644874634,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1644878060,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1644878068,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1644878069,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1644878087,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1644878135,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37230/ : SUCCESS"
        },
        {
            "timestamp": 1644906940,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 2:\n\n(3 comments)"
        },
        {
            "timestamp": 1644907155,
            "reviewer": {
                "name": "Ramesh Iyyar",
                "email": "rameshi1@in.ibm.com",
                "username": "RameshIyyar"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1645044049,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1645044060,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1645044060,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1645044080,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4: Commit message was updated."
        },
        {
            "timestamp": 1645044128,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/37407/ : SUCCESS"
        },
        {
            "timestamp": 1645044174,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4:\n\n(4 comments)"
        },
        {
            "timestamp": 1645187125,
            "reviewer": {
                "name": "Ramesh Iyyar",
                "email": "rameshi1@in.ibm.com",
                "username": "RameshIyyar"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1645194044,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1645195549,
            "reviewer": {
                "name": "Ramesh Iyyar",
                "email": "rameshi1@in.ibm.com",
                "username": "RameshIyyar"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1645203458,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1645205445,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1645220694,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1645431691,
            "reviewer": {
                "name": "Ramesh Iyyar",
                "email": "rameshi1@in.ibm.com",
                "username": "RameshIyyar"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1645522548,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 4: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1645522572,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "7b9f41363319bd5dbee03e7db5df453f24717957",
            "parents": [
                "e5ba5fd00ab54cba255825248a2819c79f38d32d"
            ],
            "ref": "refs/changes/97/51197/1",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1644873502,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "service_files/phal-reinit-devtree.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 15,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "e257ab85c46d23a4a24f467c315b8e29c3892ef0",
            "parents": [
                "e5ba5fd00ab54cba255825248a2819c79f38d32d"
            ],
            "ref": "refs/changes/97/51197/2",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1644878060,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "This is PHAL specific change . Please start commit message PHAL:"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 12,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "op-reset-host-check@.service.in  also consumes devtree. some error scenario. this service triggers . I think need to add the same dependncy here also."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 12,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Added the dependency to the other service files."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Found another instances that needed updating."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ramesh Iyyar",
                        "email": "rameshi1@in.ibm.com",
                        "username": "RameshIyyar"
                    },
                    "message": "Hi Adriana,\n\nI am not much expert on the OpenBMC state management and different systemd targets that are used in the host start/stop but, I know we are using the PHAL device tree in the below service files (op-proc-control commands) so, I like to know whether those paths need to cover or not based on the service dependency. Maybe, we can wait for Andrew and Jayanth since they introduced most of these service files.\n\n```\nop-reset-host-check@.service.in\nop-reset-host-clear.service.in\nop-stop-instructions@.service.in\nphal-export-devtree@.service.in\nphal-import-devtree@.service.in\nproc-pre-poweroff@.service.in\nxyz.openbmc_project.Control.Host.NMI\n\nstart_host@.service - meta-openpower\n```\n\nand, when does the `openpower-update-bios-attr-table` service get triggered?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Added dependency to the above service files."
                },
                {
                    "file": "extensions/phal/pdbg_utils.cpp",
                    "line": 129,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "https://github.com/openbmc/openpower-proc-control/blob/master/meson_options.txt#L14 already have constants defined related to PDBG_DTB_pATH. based on your earlier discussion , added this change. can you copnfirm what is the final path. This need to be updated various places in PHAL applications."
                },
                {
                    "file": "extensions/phal/pdbg_utils.cpp",
                    "line": 129,
                    "reviewer": {
                        "name": "Ramesh Iyyar",
                        "email": "rameshi1@in.ibm.com",
                        "username": "RameshIyyar"
                    },
                    "message": "+1 we need to update in a few other places as well."
                },
                {
                    "file": "extensions/phal/pdbg_utils.cpp",
                    "line": 129,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Using variable from meson options file."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "extensions/phal/pdbg_utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "service_files/op-enter-mpreboot@.service.in",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "service_files/op-continue-mpreboot@.service.in",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "service_files/phal-reinit-devtree.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 21,
            "sizeDeletions": 3
        },
        {
            "number": 3,
            "revision": "d2ad3727cb14dd1e5ca6cdcdfda0ffb25451a9d0",
            "parents": [
                "e5ba5fd00ab54cba255825248a2819c79f38d32d"
            ],
            "ref": "refs/changes/97/51197/3",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1645044049,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-reset-host-clear.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "extensions/phal/pdbg_utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -4
                },
                {
                    "file": "service_files/phal-export-devtree@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/proc-pre-poweroff@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-enter-mpreboot@.service.in",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "service_files/op-reset-host-check@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-continue-mpreboot@.service.in",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "service_files/xyz.openbmc_project.Control.Host.NMI.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/phal-reinit-devtree.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-stop-instructions@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/phal-import-devtree@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 38,
            "sizeDeletions": 6
        },
        {
            "number": 4,
            "revision": "bbb53393c5e2eb2ad4d3ef8401f8481732b84ed0",
            "parents": [
                "e5ba5fd00ab54cba255825248a2819c79f38d32d"
            ],
            "ref": "refs/changes/97/51197/4",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1645044080,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ramesh Iyyar",
                        "email": "rameshi1@in.ibm.com",
                        "username": "RameshIyyar"
                    },
                    "message": "When that \"openpower-update-bios-attr-table.service\" unit is called? Does it call in the added files path? What happens if the BIOS service did not call in that path since we added `After` so the original service will fail to start or is it will start?  I think `After` just make sure the order dependency so it will start - @Andrew, can you help me here?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "The \"openpower-update-bios-attr-table.service\" starts when the BMC starts up, it's part of the openpower code update app. That's correct, \"After\" just makes sure the dependency is enforced, and since the bios attr service is set to start when the BMC boots up, then any services that have the \"After\" directive will wait for it to finish."
                },
                {
                    "file": "service_files/xyz.openbmc_project.Control.Host.NMI.service.in",
                    "line": 5,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "This is only used for P9 , this service is availble in p9 based systems?"
                },
                {
                    "file": "service_files/xyz.openbmc_project.Control.Host.NMI.service.in",
                    "line": 5,
                    "reviewer": {
                        "name": "Ramesh Iyyar",
                        "email": "rameshi1@in.ibm.com",
                        "username": "RameshIyyar"
                    },
                    "message": "Looks it is packaged into all POWER systems as per meson build (https://github.com/openbmc/openpower-proc-control/blob/master/meson.build#L197) and I can see it in the p10 systems."
                },
                {
                    "file": "service_files/xyz.openbmc_project.Control.Host.NMI.service.in",
                    "line": 5,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "Adriana, Question is openpower-update-bios-attr-table.service is supported in P9 or not. want to see any sideeffect , with this incase for not supported boxes"
                },
                {
                    "file": "service_files/xyz.openbmc_project.Control.Host.NMI.service.in",
                    "line": 5,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Ah, openpower-update-bios-attr-table.service is not supported in P9, the After will be a no-op since the service doesn't exist, but I can remove it if that's preferred."
                },
                {
                    "file": "service_files/xyz.openbmc_project.Control.Host.NMI.service.in",
                    "line": 5,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "Incase no sideeffect we are good , in future we may need to enable nmi support for p10 , then it is usefull"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-reset-host-clear.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "extensions/phal/pdbg_utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -4
                },
                {
                    "file": "service_files/phal-export-devtree@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/proc-pre-poweroff@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-enter-mpreboot@.service.in",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "service_files/op-reset-host-check@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-continue-mpreboot@.service.in",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "service_files/xyz.openbmc_project.Control.Host.NMI.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/phal-reinit-devtree.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/op-stop-instructions@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "service_files/phal-import-devtree@.service.in",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 38,
            "sizeDeletions": 6
        }
    ]
}