{
    "project": "openbmc/docs",
    "branch": "master",
    "topic": "power-recovery",
    "id": "I3bead46df5d7ad4344d47affc066c7e36379e0db",
    "number": 47816,
    "subject": "power-recovery: bmc and system recovery paths",
    "owner": {
        "name": "Andrew Geissler",
        "email": "andrew@geissonator.com",
        "username": "geissonator"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/docs/+/47816",
    "commitMessage": "power-recovery: bmc and system recovery paths\n\nProvide a mechanism for the power recovery software to not run in\nsituations where a user has manually intervened to try and recover the\nsystem.\n\nFor example, if a system is unresponsive and a user manually resets\nit in some way (for example via a pin hole reset), then do not run\nthe power recovery logic. This allows the user to manually work with\nthe system to debug and not worry about it automatically doing things\non them.\n\nChange-Id: I3bead46df5d7ad4344d47affc066c7e36379e0db\nSigned-off-by: Andrew Geissler <geissonator@yahoo.com>\n",
    "createdOn": 1634159876,
    "lastUpdated": 1645213529,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1634159876,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1634834181,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 1: Code-Review+1\n\n(1 comment)\n\nRequirements seem correct to me, and design does as well assuming it's implemented (or at least checked that it was handled) in determineInitialState()."
        },
        {
            "timestamp": 1635188689,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1635190530,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1635364437,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1635364437,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1635370234,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1635432094,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Topic set to power-recovery"
        },
        {
            "timestamp": 1635448350,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1635798242,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1635798242,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1635801128,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1635967306,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1636045760,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1636145362,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1636145362,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1636485842,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1636645938,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1637268705,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1637268705,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 5:\n\n(2 comments)"
        },
        {
            "timestamp": 1637270636,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 5: Code-Review+1"
        },
        {
            "timestamp": 1637273661,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 5: Code-Review+1"
        },
        {
            "timestamp": 1638809789,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5: Verified+1 Code-Review+2"
        },
        {
            "timestamp": 1638809925,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Change has been successfully rebased and submitted as f3d60e3d1ec71069a1fd1d793ebc967192e4e07d by Patrick Williams"
        },
        {
            "timestamp": 1645213529,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 6:\n\n(2 comments)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "b2948755f5c7e51cca327ed9801d07c93893920f",
            "parents": [
                "a93893ec1d8f613a102194dfc5d56870baedffa2"
            ],
            "ref": "refs/changes/16/47816/1",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1634159876,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 107,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "I'm assuming logging the error and skipping the power recovery policy will be done in Chassis::determineInitialState()?"
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 107,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "I was thinking the logic would be added to the standalone power recovery app to look at the reboot reason and not run if pinhole (https://github.com/openbmc/phosphor-state-manager/blob/master/discover_system_state.cpp).\n\nThis does bring up an interesting question though. If someone pinhole resets a system with the chassis power on, do they expect the firmware to turn off the chassis power when the BMC comes back up? Currently determineInitialState() would just see chassis power is on and leave it on."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 107,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "On our systems, firmware doesn't have a choice actually - the hw engineers hooked up the PHR to the power sequencer (UCD) so it cuts power to the system at the same time - so we'd see the chassis power is off (unless there is a race condition I don't know about so the data is stale)."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 107,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "I see, so yeah we need to avoid the \"blackout\" error when a PHR is done. I'll add that requirement."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 107,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 41,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 61,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "73e5bbe4abebd9fd3e20593eb07393384849b9eb",
            "parents": [
                "a93893ec1d8f613a102194dfc5d56870baedffa2"
            ],
            "ref": "refs/changes/16/47816/2",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1635364437,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 104,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "nit: \"its\""
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 104,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 67,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "55f12ee1390bfeea9abb3a80fe7fc0aff56a0b0a",
            "parents": [
                "7a83811cfa08b578bbeaa2197eb6fbc320371138"
            ],
            "ref": "refs/changes/16/47816/3",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1635798242,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 106,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "The current BMC reset reason is detected by looking at values in the watchdog driver, right?  Is there a particular watchdog signal to look for?  What is the relationship between this GPIO and the watchdog values (how do they get prioritized)?\n\n---\n\nI'm not totally positive that what I'm saying here is currently implemented 100% correct by the Aspeed driver and probably needs to be enhanced.  These 'RebootCause' enumerations in the BMC dbus interface were added by someone working on Nuvoton and I believe he added userspace code to figure this out using some existing kernel watchdog sysfs API.  I've seen some hacky code from a few companies using Aspeed that instead detect this in u-boot and pass it along the kernel cmdline parameters.  This should be changed / commonized between the platforms.  Once we do that we need to make an assertion about the relationship between the existing RebootCauses, which come from the watchdog, and this subset(?) enumeration of PinholeReset."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 106,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, the code currently looks at /sys/class/watchdog/watchdog0/bootstatus. I don't believe aspeed supports it and I'm not interested in it currently for IBM systems. I will assert in this document that we only look at the GPIO if the watchdog reason is 0 (which is what it always is on aspeed systems). If we do get support some day in the aspeed watchdog driver then I think this will still behave how I want (and if it doesn't, I'll fix it)."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 106,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Given our discussion over in the GPIO naming review, we've changed things a bit here. The GPIO now provides more detailed information for something like a EXTRST. Although, currently we have no support for detecting a EXTRST. So for now, the code is going to work as the latest update states. First look at sysfs, if non-zero, utilize it else look at the GPIO. If and when we get support for a EXTRST reason in sysfs, we can update this doc on how the logic will utilize the GPIO for potential additional info on EXTRST reasons."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 106,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 67,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "6c5fb75fe20a8293967bab95fb080ea22c776410",
            "parents": [
                "de77feb6ec78eb05bf4570a72f7a22a272f1d2d0"
            ],
            "ref": "refs/changes/16/47816/4",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1636145362,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 110,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I think there is still some wording changes here to align with what we arrived at for the dbus-interface.  Effectively: sysfs is right unless 0 or EXTRST is the cause, in which case there might be other GPIOs that give additional details."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 110,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 112,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "PDI review has this at PinholeReset"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 51,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 71,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "d6db4a532e97ac3b96846a3a2deee5446c4f5bf8",
            "parents": [
                "de77feb6ec78eb05bf4570a72f7a22a272f1d2d0"
            ],
            "ref": "refs/changes/16/47816/5",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "createdOn": 1637268705,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 57,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 77,
            "sizeDeletions": 0
        },
        {
            "number": 6,
            "revision": "f3d60e3d1ec71069a1fd1d793ebc967192e4e07d",
            "parents": [
                "94687a164488e63f841e356de6a990f78ad74f38"
            ],
            "ref": "refs/changes/16/47816/6",
            "uploader": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "createdOn": 1638809925,
            "author": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 57,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 77,
            "sizeDeletions": 0
        }
    ]
}