{
    "project": "openbmc/debug-trigger",
    "branch": "master",
    "topic": "sources-and-sinks",
    "id": "I126b0118faaa793011268a785eeb955139739eaf",
    "number": 50405,
    "subject": "main: Add a 'dbus' set of sink actions",
    "owner": {
        "name": "Andrew Jeffery",
        "email": "andrew@aj.id.au",
        "username": "amboar"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/debug-trigger/+/50405",
    "commitMessage": "main: Add a 'dbus' set of sink actions\n\nThe sysrq sink actions are are intended for use with kdump, which will\ncapture relevant kernel and userspace memory. It's implementation is\nthus pretty straight forward.\n\nMost BMCs don't use kdump, so implement a set of sink actions that talk\nvia D-Bus to generate a dump and gracefully reboot the BMC.\n\nSigned-off-by: Andrew Jeffery <andrew@aj.id.au>\nChange-Id: I126b0118faaa793011268a785eeb955139739eaf\n",
    "createdOn": 1642164229,
    "lastUpdated": 1642725391,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1642164229,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1642385331,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1642385462,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1642546070,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2:\n\n(4 comments)"
        },
        {
            "timestamp": 1642562872,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(4 comments)"
        },
        {
            "timestamp": 1642575205,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(4 comments)"
        },
        {
            "timestamp": 1642577042,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1642606804,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1642606804,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1642607041,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/35751/ : FAILURE"
        },
        {
            "timestamp": 1642628282,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1642628307,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1642628307,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1642628342,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/35788/ : SUCCESS"
        },
        {
            "timestamp": 1642716592,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1642722429,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1642722479,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 5: Patch Set 4 was rebased."
        },
        {
            "timestamp": 1642722504,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1642722504,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1642722542,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/35864/ : SUCCESS"
        },
        {
            "timestamp": 1642725373,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1642725391,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "e9c2d6ee0059dc65226b402c3e94bbd34baab0cd",
            "parents": [
                "306569c434a69168151b1dbb7a5755ca03736fd1"
            ],
            "ref": "refs/changes/05/50405/1",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1642164229,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "main.c",
                    "type": "MODIFIED",
                    "insertions": 313,
                    "deletions": -13
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 341,
            "sizeDeletions": 14
        },
        {
            "number": 2,
            "revision": "fa7483be6fd3c5eae14d0657bf885cbb2e18c590",
            "parents": [
                "306569c434a69168151b1dbb7a5755ca03736fd1"
            ],
            "ref": "refs/changes/05/50405/2",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1642385331,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "main.c",
                    "line": 158,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Is there a timeout built in somewhere here with how long we'll wait for a dump to complete before triggering a reboot? How long does PHYP give us before they trigger the hard reset?"
                },
                {
                    "file": "main.c",
                    "line": 158,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "> Is there a timeout built in somewhere here with how long we'll wait for a dump to complete before triggering a reboot?\n\nNo. I don't think we have a need for that complexity yet.\n\n> How long does PHYP give us before they trigger the hard reset?\n\n10 minutes."
                },
                {
                    "file": "main.c",
                    "line": 158,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Done"
                },
                {
                    "file": "main.c",
                    "line": 158,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "We've definitely needed timeouts for other dumps. The BMC is in theory, in a bad state, there's a good chance the dump is going to get hung up. My main concern is we'll now get no FFDC. If we had a 5 min timeout, at least we could trigger the default sysrq path and get a basic dump when we come back up. But I'm ok if we want to wait and see if we really hit this or not."
                },
                {
                    "file": "main.c",
                    "line": 158,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Yeah I think I'd prefer to wait and see."
                },
                {
                    "file": "main.c",
                    "line": 269,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Please add some comments, not clear to me what's going on here."
                },
                {
                    "file": "main.c",
                    "line": 269,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "I'll add comments and link to the `sd_bus_slot_set_floating(3)`."
                },
                {
                    "file": "main.c",
                    "line": 269,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Done"
                },
                {
                    "file": "main.c",
                    "line": 296,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Not clear to me how the callbacks are occurring in this function. Any reason you don't just utilize sdbusplus and the utilities that come with it. I guess this is a c++-averse repo? I feel like sdbusplus offers a lot simpler (and more familiar code) to most of us in OpenBMC."
                },
                {
                    "file": "main.c",
                    "line": 296,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "> Not clear to me how the callbacks are occurring in this function.\n\nThey're not. We're explicitly calling `sd_bus_get_property_string()` above and processing that response. This is done to fetch the current value of the property after we install the match/callback to cover a race condition where the dump has completed before we've registered the match on the dump object. If that were to happen we'd never receive the \"completed\" event and we'd just sit here until the BMC is forcefully rebooted e.g. via EXTRST or power-cycle.\n\n> Any reason you don't just utilize sdbusplus and the utilities that come with it. \n\nFor better or worse I started writing this in C because it was literally just reading from one file descriptor and writing to another. However, it's now grown. I've left it in C because that's how it started.\n\n> I guess this is a c++-averse repo? \n\nIt's not C++ averse so much as just evolving what was there.\n\n> I feel like sdbusplus offers a lot simpler (and more familiar code) to most of us in OpenBMC.\n\nSure, but I don't plan on transitioning it right now."
                },
                {
                    "file": "main.c",
                    "line": 296,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Done"
                },
                {
                    "file": "main.c",
                    "line": 318,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "From the systemd d-bus API doc: \" Note that this does not shut down any services and immediately transitions into the reboot process. These functions are normally only called as last step of shutdown, and should not be called directly.\" I assume given the special circumstances here, you want this \"hard reboot\" behavior? The BMC state code calls the reboot.target and passes the replace-irreversibly option to ensure it doesn't get interrupted."
                },
                {
                    "file": "main.c",
                    "line": 318,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Oh, right, it should be starting the reboot target. I assumed that's what this did and didn't read the documentation \ud83d\ude15"
                },
                {
                    "file": "main.c",
                    "line": 318,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "main.c",
                    "type": "MODIFIED",
                    "insertions": 350,
                    "deletions": -13
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 378,
            "sizeDeletions": 14
        },
        {
            "number": 3,
            "revision": "365d06eb5243d7ea4012c3fe38209e8e2b01fc44",
            "parents": [
                "9ebcc9fdcdff73c33b1b2be3f9594487713d941a"
            ],
            "ref": "refs/changes/05/50405/3",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1642577042,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "main.c",
                    "type": "MODIFIED",
                    "insertions": 372,
                    "deletions": -14
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 400,
            "sizeDeletions": 15
        },
        {
            "number": 4,
            "revision": "e6c5644f2e484bd4d8e7f420ff7a81c618fa1b16",
            "parents": [
                "49acb8494b1af5a67ab43bbac21486e2c3304d74"
            ],
            "ref": "refs/changes/05/50405/4",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1642628282,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "main.c",
                    "type": "MODIFIED",
                    "insertions": 373,
                    "deletions": -14
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 401,
            "sizeDeletions": 15
        },
        {
            "number": 5,
            "revision": "86094694a28e0c50a4f10bc18b9ac6e9c11c0f52",
            "parents": [
                "b1ea254e6c3b1578127f97356612dffa85073698"
            ],
            "ref": "refs/changes/05/50405/5",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1642722479,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "main.c",
                    "type": "MODIFIED",
                    "insertions": 373,
                    "deletions": -14
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 401,
            "sizeDeletions": 15
        }
    ]
}