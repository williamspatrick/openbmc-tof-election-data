{
    "project": "openbmc/phosphor-power",
    "branch": "master",
    "id": "I29695b641fb81515680a478e872bac29a6de560a",
    "number": 51685,
    "subject": "psu-ng: Set the PowerSystemInputs status on Brownout condition",
    "owner": {
        "name": "Adriana Kobylak",
        "email": "anoo@linux.ibm.com",
        "username": "anoo1"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-power/+/51685",
    "commitMessage": "psu-ng: Set the PowerSystemInputs status on Brownout condition\n\nWhen a brownout condition is detected, set the PowerSystemInputs status\nproperty to Fault to avoid an autorestart, reference design doc:\nhttps://gerrit.openbmc-project.xyz/c/openbmc/docs/+/48015\n\nAdd a Before=xyz.openbmc_project.State.Chassis.service to the psu\nmonitor service file since the chassis service is the one that will be\nreading the property.\n\nAdd additional data to the Blackout error log.\n\nTested: On simulation:\n\n1. Clear brownout at runtime:\n- At power on, inject a power fault to all PSUs to trigger a brownout\n  and verify the CurrentPowerStatus is set to Fault:\n\nMar 20 19:49:14 p10bmc phosphor-log-manager[318]: Created PEL 0x5000000d\n(BMC ID 13) with SRC 110000AC\nMar 20 19:49:14 p10bmc phosphor-power-control[307]:\ncallbackSetPowerSupplyError:\nxyz.openbmc_project.State.Shutdown.Power.Error.Blackout\n\n\u2023 Type=signal  Endian=l  Flags=1  Version=1 Cookie=94  Timestamp=\"Sun\n2022-03-20 19:49:14.241856 UTC\"\n  Sender=:1.1296\nPath=/xyz/openbmc_project/power/power_supplies/chassis0/psus\nInterface=org.freedesktop.DBus.Properties  Member=PropertiesChanged\n...\n          STRING\n\"xyz.openbmc_project.State.Decorator.PowerSystemInputs\";\n...\n                                  STRING\n\"xyz.openbmc_project.State.Decorator.PowerSystemInputs.Status.Fault\";\n\n- Additional data on the error log:\n\n\"User Data 1\": {\n    \"Section Version\": \"1\",\n    \"Sub-section type\": \"1\",\n    \"Created by\": \"0x2000\",\n    \"NOT_PRESENT_COUNT\": \"2\",\n    \"VIN_FAULT_COUNT\": \"2\",\n    \"_PID\": \"10244\"\n}\n\n- Clear the brownout condition and verify the status is set to Good.\n\nChange-Id: I29695b641fb81515680a478e872bac29a6de560a\nSigned-off-by: Adriana Kobylak <anoo@us.ibm.com>\n",
    "createdOn": 1646250651,
    "lastUpdated": 1649458484,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1646250651,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1646250667,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1646250667,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1646251304,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/38375/ : SUCCESS"
        },
        {
            "timestamp": 1646252023,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "andrew@geissonator.com",
                "username": "geissonator"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1646322681,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1647894343,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1647894358,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1647894358,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1647894396,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1647894410,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/39368/ : FAILURE"
        },
        {
            "timestamp": 1647894666,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1647974114,
            "reviewer": {
                "name": "Brandon J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1647974390,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1647983791,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1648048949,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1648048965,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648048965,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1648049336,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1648049346,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1648049537,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/39532/ : SUCCESS"
        },
        {
            "timestamp": 1648061588,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1648061601,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648061601,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1648061621,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1648061641,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1648062113,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/39564/ : SUCCESS"
        },
        {
            "timestamp": 1648067520,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1648071478,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1648071490,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648071491,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1648071519,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/39586/ : FAILURE"
        },
        {
            "timestamp": 1648072301,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 6: Patch Set 5 was rebased."
        },
        {
            "timestamp": 1648072313,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648072313,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: -Ok-To-Test"
        },
        {
            "timestamp": 1648072877,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/39590/ : SUCCESS"
        },
        {
            "timestamp": 1648078673,
            "reviewer": {
                "name": "Brandon J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 6: Code-Review+1"
        },
        {
            "timestamp": 1648138691,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1648139663,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1648140146,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1648145740,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1648146062,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1648146629,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1648148163,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1648149378,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 7."
        },
        {
            "timestamp": 1648149389,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1648149389,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: -Ok-To-Test"
        },
        {
            "timestamp": 1648149826,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 7:\n\n(2 comments)"
        },
        {
            "timestamp": 1648149955,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/39669/ : SUCCESS"
        },
        {
            "timestamp": 1648233307,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 7: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1648233743,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        },
        {
            "timestamp": 1648237118,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 7: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1648492932,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        },
        {
            "timestamp": 1648492993,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 7: Code-Review+2"
        },
        {
            "timestamp": 1648493078,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Change has been successfully rebased and submitted as e5b1e0875c983356467d092d17fc87d91a0e2e6d"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "eb3461a2bc762e43bc7ae546d35d0bd42ec52aaa",
            "parents": [
                "f6f0da9d862aed8f4758e1daff79015d23246660"
            ],
            "ref": "refs/changes/85/51685/1",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1646250651,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "andrew@geissonator.com",
                        "username": "geissonator"
                    },
                    "message": "Hmm, so from that design doc, the goal was that this phosphor-power-supply app would host a generic interface that represents the power to the chassis. The phosphor-chassis-manager would use mapper to look for these interface(s) and subscribe to event changes and use that to feed into it's logic on what to set the chassis power status to. Basically the same thing we did for UPS's. The problem with this code directly interacting with the phosphor-state-chassis-manager property is that it can get us out of synch if say, there is also a UPS event going on. That's why we need phosphor-state-chassis-manager to be the only one that can set the property."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 32,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 58,
                    "deletions": -9
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 102,
            "sizeDeletions": 9
        },
        {
            "number": 2,
            "revision": "dd0f2f8a94d3d93b0765c0177eb6a0520a986af4",
            "parents": [
                "718e916c7c57f45459866c7928fa146da8672166"
            ],
            "ref": "refs/changes/85/51685/2",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1647894343,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Depends on P-D-I change: https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-dbus-interfaces/+/51712"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Brandon J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "That p-d-i change merged, I think that missing caused the CI failure:\nFAILED: phosphor-power-supply/phosphor-psu-monitor.p/psu_manager.cpp.o \nc++ -Iphosphor-power-supply/phosphor-psu-monitor.p -Iphosphor-power-supply -I../phosphor-power-supply -I. -I.. -I/usr/local/include -fdiagnostics-color=never -D_FILE_OFFSET_BITS=64 -Wall -Winvalid-pch -Wnon-virtual-dtor -Wextra -Wpedantic -Werror -std=c++20 -g -DBOOST_ASIO_DISABLE_THREADS -DBOOST_ALL_NO_LIB -DBOOST_SYSTEM_NO_DEPRECATED -DBOOST_ERROR_CODE_HEADER_ONLY -DBOOST_COROUTINES_NO_DEPRECATION_WARNING -MD -MQ phosphor-power-supply/phosphor-psu-monitor.p/psu_manager.cpp.o -MF phosphor-power-supply/phosphor-psu-monitor.p/psu_manager.cpp.o.d -o phosphor-power-supply/phosphor-psu-monitor.p/psu_manager.cpp.o -c ../phosphor-power-supply/psu_manager.cpp\nIn file included from ../phosphor-power-supply/psu_manager.cpp:1:\n../phosphor-power-supply/psu_manager.hpp:12:10: fatal error: xyz/openbmc_project/State/Decorator/PowerSystemInputs/server.hpp: No such file or directory\n   12 | #include <xyz/openbmc_project/State/Decorator/PowerSystemInputs/server.hpp>\n      |          ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\ncompilation terminated."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Yeah, the recipe finally got merged: https://gerrit.openbmc-project.xyz/c/openbmc/openbmc/+/52228"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 873,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "it might be interesting to see notPresentCount and hasVINUVFaultCount in the additionaldata."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 873,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Ack, let me make the change."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 873,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 44,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 26,
                    "deletions": -9
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 82,
            "sizeDeletions": 9
        },
        {
            "number": 3,
            "revision": "03aa833f80ab9ec0fde69e9a501bde63662d9fcd",
            "parents": [
                "858246b352613fc24130be680251446c7e018942"
            ],
            "ref": "refs/changes/85/51685/3",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1648048949,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 44,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 26,
                    "deletions": -9
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 82,
            "sizeDeletions": 9
        },
        {
            "number": 4,
            "revision": "b85d98eb8595b3038e18cc701e70854168f78f01",
            "parents": [
                "858246b352613fc24130be680251446c7e018942"
            ],
            "ref": "refs/changes/85/51685/4",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1648061588,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 57,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": -9
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 9
        },
        {
            "number": 5,
            "revision": "a4b8bc6accca5cc091c5f73adeae1f49cae9c627",
            "parents": [
                "a3769185ef93c4ca030141c871bccb8b0131c0ad"
            ],
            "ref": "refs/changes/85/51685/5",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1648071478,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 57,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": -9
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 9
        },
        {
            "number": 6,
            "revision": "84c5a99167902dc541bea2de90dfc6cb3937525e",
            "parents": [
                "76a33a795c9c6a7e4fa94f974d8bfdf4d38a8cfb"
            ],
            "ref": "refs/changes/85/51685/6",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1648072301,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "What happens if the brownout starts while the chassis is powered on and then continues?\n\n* Chassis on\n* Brownout detected\n* Chassis powers down\n* Chassis is now off, so brownout property is cleared by the code above (but it is still happening)\n\nDoes chassis state manager notice the interface states the brownout is over and do an auto-power-restart?\n\nI think PSUManager::analyze() runs when the chassis is powered off, but the brownout stuff is within an \"if (powerOn)\" branch.  So it won't set the property back to brownout status I think.  Even if it did, would there be a race condition there?\n\nSorry, I might be in the weeds here.  Just trying to understand."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "Right, we are doing surveillance on the psu's when the chassis is off as well, so we'd want to clear the brownout status when AC comes back, not just because we went through a power off transition (if I'm understanding the concern)."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Yes, I wasn't sure why we'd unconditionally clear the brownout property when the chassis power changes to off.\n\nAlso, I think the analyze() function runs when chassis power is off.  However, it looks like (I think) the code that sets or clears the brownout property is within a branch that only runs if chassis power is on.\n\nI realize it is probably tricky, in that while the chassis is off maybe there are some errors we don't want to log.  Maybe they are replacing PSUs and certain conditions that are bad when the chassis is powered on are OK when it is powered off.\n\nHowever, I'd think (?) we'd want to maintain the brownout property.  Otherwise how does chassis state manager know when a brownout stops or starts while the chassis is off.\n\nSorry if I am just not up to speed on the design.  I haven't followed this as closely as others."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "You are correct.  We don't want to log AC loss errors at standby, but we do want to maintain/provide accurate status at all times (Brandon has confirmed we do monitor the psu at standby).  \n\nBrandon shouldn't this clearBrownout() be done when we see the psu input voltage come back into range (in analyze())?"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "Or maybe the call in PSUManager::analyze() handles when it's detected to have came back in PowerSupply::analyze()?"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "The conversation above makes sense. Will remove this clearBrownout() from the power off path. Then change the following logic in PSUManager::analyze() from:\n\nPSUManager::analyze() \n{\n    PowerSupply::analyze()\n    if (powerOn)\n    {\n        if Brownout: setBrownout()\n        else: clearBrownout()\n\n        analyze faults\n    }\n}\n\nto:\n\nPSUManager::analyze() \n{\n    PowerSupply::analyze()\n    if Brownout: if powerOn: setBrownout()\n    else: clearBrownout()\n\n    if (powerOn)\n    {\n        analyze faults\n    }\n}"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "If a brownout is occurring, and the power is off, we'd still want to update the D-Bus interface right?  Based on Derek's comment, maybe we wouldn't log the error though if power is off (not sure on this part).\n\nIf so maybe it is\n  if Brownout: setBrownout()\n  else: clearBrownout()\n\nand in setBrownout, it always sets the interface property but only logs an error if the power is on?"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 364,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Yeah, that sounds it meets the requirements."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 57,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": -9
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 9
        },
        {
            "number": 7,
            "revision": "8d0ea762f3c912df5e200ce5411ef364f8c0b4d9",
            "parents": [
                "48fef908650cbcac0d56394b4af31779328f2971"
            ],
            "ref": "refs/changes/85/51685/7",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1648149378,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 15,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Andrew asked for the dependency in the review comment for the state manager changes: https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-state-manager/+/52283"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I think there may still be a brief window for a race condition, but I'm not sure.  Would be interested in Andrew's and Brandon's thoughts.\n\nIf there is a window, it could probably be addressed in a separate commit.\n\nRight now I think this is the sequence and the small window, but I might be misunderstanding something:\nStep 1. systemd starts this application\n  * Executable is loaded and starts running\nStep 2. systemd starts the chassis state manager application\n\nStep ?? (1.5?, 2.5?)\n  * PSUManager::PSUManager() creates the D-Bus object that implements PowerSystemInputs.  \n  * The initial/default state of the Status property is Good.\n  * The bus name is claimed.\n  * PSUManager::PSUManager() finishes\n  * We are back in main() and enter the event loop\n  * One second later analyze() is run and looks for a brownout\n\nI don't think we know how many of the Step ?? bullets are performed before Step 2 happens.\n\nYou can add two more lines to the service file to cause systemd to wait until you claim the bus name before considering your app started.  That would take you through the first 3 bullets of Step ??.  But the rest could potentially still happen after chassis state manager has started?                                                                                                                                              "
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "What could make this more complex is that we don't necessarily get all the power supply information when this application starts, right?  Is there uncertainty whether EntityManager will have published all the PSU information at the time the PSU app starts?  If so, we may need to wait for both EM events and subsequent polls to really know if we have a brownout?\n\nOne option would be to set Status to a value like Unknown until we have determined whether a brownout is happening.  There doesn't seem to be an Unknown value right now; only Good or Fault.  Would it be safer to set to Fault until we know the actual status?  I'm not sure if that would have other unintended consequences."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "Good catch, perhaps we need to add a delay for the ps info to show up in EM like we did for checking for valid ps configuration?\n\nI'm ok if this is done as a separate commit as well... I'll +1 this as I think a brownout that doesn't result in the BMC resetting will be handled fine... the problematic scenario is the BMC coming out of reset during/into a brownout, which is less likely."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Talking with Andrew, we discussed that it's better to not delay the power on in order to wait for all the EM information to be available in d-bus. This may cause the power on to be stopped due to the system not having enough power (handled by a separate phosphor-power logic), and eventually the property would be set to Fault (brownout) and the autorestart would stop. This means there's a risk of \"thrashing\" the system (interrupting the power ons) but theoretically it's limited to once, maybe twice, until the property is set. We can discuss further and address any concerns in a follow-up commit."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 57,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 51,
                    "deletions": -34
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-psu-monitor.service",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 124,
            "sizeDeletions": 34
        },
        {
            "number": 8,
            "revision": "e5b1e0875c983356467d092d17fc87d91a0e2e6d",
            "parents": [
                "c9b05736f43c9e16737a31140ff2b7a36373da81"
            ],
            "ref": "refs/changes/85/51685/8",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1648493078,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 57,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 51,
                    "deletions": -34
                },
                {
                    "file": "phosphor-power-supply/psu_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "services/phosphor-psu-monitor.service",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 124,
            "sizeDeletions": 34
        }
    ]
}