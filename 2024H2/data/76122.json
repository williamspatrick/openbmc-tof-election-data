{
    "project": "openbmc/phosphor-objmgr",
    "branch": "master",
    "id": "Ibf8e951e6abd513a5cccf3c8bba8c9f9b8fda442",
    "number": 76122,
    "subject": "mapper: avoid too many async calls",
    "owner": {
        "name": "Jian Zhang",
        "email": "zhangjian3032@gmail.com",
        "username": "zhangjian3032"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-objmgr/+/76122",
    "hashtags": [],
    "createdOn": 1732724165,
    "lastUpdated": 1734326376,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1732724165,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1732724244,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1732724244,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1732724467,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/95460/ : SUCCESS"
        },
        {
            "timestamp": 1732766340,
            "reviewer": {
                "name": "Lei YU",
                "email": "mine260309@gmail.com",
                "username": "mine260309"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1733840451,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1733840485,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733840485,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1733840522,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/96205/ : FAILURE"
        },
        {
            "timestamp": 1733840530,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1733840626,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1733840660,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733840660,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1733840725,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/96206/ : FAILURE"
        },
        {
            "timestamp": 1733841594,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 4: Commit message was updated.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1733841610,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733841610,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1733841836,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/96208/ : SUCCESS"
        },
        {
            "timestamp": 1733842414,
            "reviewer": {
                "name": "Lei YU",
                "email": "mine260309@gmail.com",
                "username": "mine260309"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1733871076,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1733939604,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(3 comments)"
        },
        {
            "timestamp": 1733949743,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 5: Commit message was updated.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1733949774,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733949775,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1733949927,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/96369/ : FAILURE"
        },
        {
            "timestamp": 1733950552,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 6: Commit message was updated.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1733950589,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733950590,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: -Ok-To-Test"
        },
        {
            "timestamp": 1733950615,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 4:\n\n(4 comments)"
        },
        {
            "timestamp": 1733952058,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/96370/ : SUCCESS"
        },
        {
            "timestamp": 1734015340,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1734326265,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1734326376,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "f6670ddfb413ee388ad6632ab617a3473bc61ea9",
            "parents": [
                "ea0e5d27a869a88ab40617675d2af4e6b9fbed92"
            ],
            "ref": "refs/changes/22/76122/1",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1732724165,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "mine260309@gmail.com",
                        "username": "mine260309"
                    },
                    "message": "Elaborate how it avoids triggering new async calls to make it clear. (Although the code is clear, but it's better to improve the commit message as well)"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "libmapper/mapper.c",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 50,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "5af87834154dbb441e869aefda7438003a50b18c",
            "parents": [
                "ea0e5d27a869a88ab40617675d2af4e6b9fbed92"
            ],
            "ref": "refs/changes/22/76122/2",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1733840451,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "libmapper/mapper.c",
                    "type": "MODIFIED",
                    "insertions": 39,
                    "deletions": -7
                }
            ],
            "sizeInsertions": 60,
            "sizeDeletions": 7
        },
        {
            "number": 3,
            "revision": "44108392805e9efccc1cb9f2442a9375c8b791cf",
            "parents": [
                "ea0e5d27a869a88ab40617675d2af4e6b9fbed92"
            ],
            "ref": "refs/changes/22/76122/3",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1733840626,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "libmapper/mapper.c",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -7
                }
            ],
            "sizeInsertions": 58,
            "sizeDeletions": 7
        },
        {
            "number": 4,
            "revision": "e5ce3fe5fcf2552695eedf3c3e0ebe3ba599e802",
            "parents": [
                "ea0e5d27a869a88ab40617675d2af4e6b9fbed92"
            ],
            "ref": "refs/changes/22/76122/4",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1733841594,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "mine260309@gmail.com",
                        "username": "mine260309"
                    },
                    "message": "typo"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "Done"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 18,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "This could stand to use a bit more of an elaboration.  I think it needs at least 10ms without a signal until it actually tries again?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 18,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I think it would also be good to show some data on what this does for us.  How much does this improve?  Does it reduce BMC boot up time?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 18,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "> This could stand to use a bit more of an elaboration.\nThe 10ms here doesn't have any special meaning; it's just a very short time used to filter out excessive calls.\n> I think it needs at least 10ms without a signal until it actually tries again?\nyes!\n> How much does this improve?\nIn our system, there are 5 mappers waiting for some debugging from the entity manager. Some calculations have been made here that can reduce over 500 GetObject calls.\n> Does it reduce BMC boot up time?\nupdate in commit."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 303,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I'm not super pleased that we lost the \"introspection_complete\" naming of these functions."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 303,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "Both \"introspection_complete\" and \"interfaces added\" use this callback... so I think renaming it is feasible."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 325,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Is this somehow combining all the triggers together into one handle event?  Can we comment what the side-effects of this are better?"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 325,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "The previous behavior was also within the same handler... I believe there should be no side effects."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 325,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "How is the behavior the same?  You said that the main purpose of this commit was to reduce the pending async callbacks.  It looks like these lines do some magic to ensure that we are coalescing the callbacks in a 10ms window.  That was never done before."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 325,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "Sorry, maybe I didn\u2019t describe it clearly. What I meant was that two matches share the same callback."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 325,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "At first, I wanted to match the InterfacesAdded path, but if the params like `mapper wait /xyz/openbmc_project/inventory/system/board`. In fact, this path doesn't emit any signals.\nLater, I considered that if we use a path namespace, such as a large namespace like this, it could still lead to excessive calls.\n\n* The current issue is that this wait operation makes mapperx overly busy, to the extent that some initialization processes occasionally fail unexpectedly.\n\nRegarding the current behavior:\nFrom a functional perspective, a one-shot delay in the overall logic shouldn't cause any issues. If it was retrievable before, it should still be retrievable now.\nFrom a real-time perspective, this delay might cause a slight delay in triggering. In extreme cases, for example, if we have 500 InterfacesAdded events, each stuck for 9ms, the first call might only happen after 4.5 seconds.\nHowever, without this delay, based on my observation of the startup process, the time taken could very well exceed 4.5 seconds."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "libmapper/mapper.c",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -7
                }
            ],
            "sizeInsertions": 58,
            "sizeDeletions": 7
        },
        {
            "number": 5,
            "revision": "c3a5423baeee9cb5cd302378f5a5b95caf5fbfac",
            "parents": [
                "ea0e5d27a869a88ab40617675d2af4e6b9fbed92"
            ],
            "ref": "refs/changes/22/76122/5",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1733949743,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 33,
                    "deletions": 0
                },
                {
                    "file": "libmapper/mapper.c",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -7
                }
            ],
            "sizeInsertions": 70,
            "sizeDeletions": 7
        },
        {
            "number": 6,
            "revision": "85e8913ac2834a9ddc4e0fbd14d8f274ecdec9b1",
            "parents": [
                "ea0e5d27a869a88ab40617675d2af4e6b9fbed92"
            ],
            "ref": "refs/changes/22/76122/6",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1733950552,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 34,
                    "deletions": 0
                },
                {
                    "file": "libmapper/mapper.c",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -7
                }
            ],
            "sizeInsertions": 71,
            "sizeDeletions": 7
        }
    ]
}