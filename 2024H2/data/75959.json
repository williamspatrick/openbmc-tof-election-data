{
    "project": "openbmc/pldm",
    "branch": "master",
    "id": "I7586cdca5cd77c3d0a62979ca962745bd0e0970e",
    "number": 75959,
    "subject": "requester: Validate MCTP EID before removal",
    "owner": {
        "name": "Eric Yang",
        "email": "eric.yang.wiwynn@gmail.com",
        "username": "fornchu110"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/pldm/+/75959",
    "hashtags": [],
    "createdOn": 1732606103,
    "lastUpdated": 1733304211,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1732606103,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1732606160,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1732606160,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1732606185,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/95248/ : FAILURE"
        },
        {
            "timestamp": 1732606694,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1732606769,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1732606770,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1732606796,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/95250/ : FAILURE"
        },
        {
            "timestamp": 1732608306,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Uploaded patch set 3: New patch set was added with same tree, parent tree, and commit message as Patch Set 2.\n\nCopied Votes:\n* Verified-1 (copy condition: \"**changekind:NO_CHANGE**\")\n"
        },
        {
            "timestamp": 1732608324,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1732608324,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1732608379,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/95255/ : FAILURE"
        },
        {
            "timestamp": 1732609181,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Uploaded patch set 4.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1732609209,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1732609209,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1732609234,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/95257/ : FAILURE"
        },
        {
            "timestamp": 1732609916,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Uploaded patch set 5.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1732609965,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1732609965,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1732610704,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/95260/ : SUCCESS"
        },
        {
            "timestamp": 1732612540,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Uploaded patch set 6.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1732612590,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1732612590,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: -Ok-To-Test"
        },
        {
            "timestamp": 1732613286,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/95299/ : SUCCESS"
        },
        {
            "timestamp": 1732696416,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1732809487,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1732809746,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1732850737,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1732870384,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1732870893,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1732872411,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1732872935,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1733304205,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1733304211,
            "reviewer": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "message": "Set Work In Progress"
        }
    ],
    "wip": true,
    "patchSets": [
        {
            "number": 1,
            "revision": "cc4374b925182159982cdc5fcc45226b0221e204",
            "parents": [
                "79f9ff6bfcc9f257397b857967f3a1af2c28779d"
            ],
            "ref": "refs/changes/59/75959/1",
            "uploader": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "createdOn": 1732606103,
            "author": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 29,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "01737bb660d0c0f7750213545d7f67a8e6579b64",
            "parents": [
                "79f9ff6bfcc9f257397b857967f3a1af2c28779d"
            ],
            "ref": "refs/changes/59/75959/2",
            "uploader": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "createdOn": 1732606694,
            "author": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "type": "MODIFIED",
                    "insertions": 19,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 34,
            "sizeDeletions": 4
        },
        {
            "number": 3,
            "revision": "2a3bcf366cf85076e1c5ff15129cbeeb6fe9cf89",
            "parents": [
                "79f9ff6bfcc9f257397b857967f3a1af2c28779d"
            ],
            "ref": "refs/changes/59/75959/3",
            "uploader": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "createdOn": 1732608306,
            "author": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "kind": "NO_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "type": "MODIFIED",
                    "insertions": 19,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 34,
            "sizeDeletions": 4
        },
        {
            "number": 4,
            "revision": "c825b0abff903b9e296feddeb2bdaf0913a824e6",
            "parents": [
                "79f9ff6bfcc9f257397b857967f3a1af2c28779d"
            ],
            "ref": "refs/changes/59/75959/4",
            "uploader": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "createdOn": 1732609181,
            "author": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 33,
            "sizeDeletions": 4
        },
        {
            "number": 5,
            "revision": "ef02d13e5d8a41a2883686ddb05315cdd2801a85",
            "parents": [
                "79f9ff6bfcc9f257397b857967f3a1af2c28779d"
            ],
            "ref": "refs/changes/59/75959/5",
            "uploader": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "createdOn": 1732609916,
            "author": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 30,
            "sizeDeletions": 1
        },
        {
            "number": 6,
            "revision": "5a11ffb9d5293b84bc4ede1f7a226b2f3df36739",
            "parents": [
                "79f9ff6bfcc9f257397b857967f3a1af2c28779d"
            ],
            "ref": "refs/changes/59/75959/6",
            "uploader": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "createdOn": 1732612540,
            "author": {
                "name": "Eric Yang",
                "email": "eric.yang.wiwynn@gmail.com",
                "username": "fornchu110"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Thu Nguyen",
                        "email": "thu@os.amperecomputing.com",
                        "username": "ThuBaNguyen"
                    },
                    "message": "Get-Property when the object is removed will cause the error log. Can we use different to check the available of object instead of read it directly?"
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Eric Yang",
                        "email": "eric.yang.wiwynn@gmail.com",
                        "username": "fornchu110"
                    },
                    "message": "I understand your concern.\nCould you please clarify what method you mean by \"different\"?\nIf it involves using getsubtree and comparing, I worry that it might still result in inconsistencies with the actual MCTP tree.\n\nThank you very much for your suggestion."
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Eric Yang",
                        "email": "eric.yang.wiwynn@gmail.com",
                        "username": "fornchu110"
                    },
                    "message": "I have tried using the same method as handling the interface added signal to read the remove signal with msg.read, in order to accurately delete the PLDM device corresponding to the EID that was actually removed.\nHowever, I found that errors such as \"no such device\" or \"address\" would occur."
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Thu Nguyen",
                        "email": "thu@os.amperecomputing.com",
                        "username": "ThuBaNguyen"
                    },
                    "message": "Do you mean the `GetSubTree` and `GetSubTreePaths` does not response all of EP object paths?\n\n```\nvoid MctpDiscovery::removeEndpoints(sdbusplus::message_t&)\n{\n    MctpInfos mctpInfos;\n    MctpInfos removedInfos;\n    std::map<MctpInfo, Availability> currentMctpInfoMap;\n    getMctpInfos(currentMctpInfoMap);\n    for (const auto& mapIt : currentMctpInfoMap)\n    {\n        mctpInfos.push_back(mapIt.first);\n    }\n    removeFromExistingMctpInfos(mctpInfos, removedInfos);\n    handleRemovedMctpEndpoints(removedInfos);\n}\n```\nIn the current pldmd code, to identify the removed MCTP object paths, we check the available MCTP EP object paths by call `getSubtree` method. Then comparing the stored object paths with currently available object paths to find the removed ones.\nI wonder how the object still available in `handleRemovedMctpEndpoints` steps?\n\nIs it because `getSubtree` in `getMctpInfos` does not work correctly? Does it missed some available EP object path?"
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Eric Yang",
                        "email": "eric.yang.wiwynn@gmail.com",
                        "username": "fornchu110"
                    },
                    "message": "Yes, it seems the current `getSubtree` function is not working correctly.\n\nFrom my understanding, `pldm` uses `getSubtree` to determine the available object paths and then removes the object paths in `existingMctpInfos` that are not in `getSubtree`.\n\nHowever, it appears that the available object paths obtained from `getSubtree` may not be accurate, causing `pldm` to mistakenly remove available object paths.\n\nWith my commit applied, if the `getSubtree` results are accurate, the code should reach:\n\n```cpp\ncatch (const sdbusplus::exception::SdBusError& e)\n{\n    removedInfos.emplace_back(mctpInfo);\n}\n```\n\nbecause those object paths are actually not available. \nBut in our system, it is possible to reach:\n\n```cpp\ntry\n{\n    pldm::utils::DBusHandler().getDbusPropertyVariant(MCTPObject.c_str(), \"EID\", MCTPInterface);\n    info(\"Endpoint with EID '{EID}' exists at object path '{OBJECT}', not removing\",\n         \"EID\", std::get<0>(mctpInfo), \"OBJECT\", MCTPObject);\n}\n```\n\nwhich prints the additional debug message I added.\n\nAdditionally, in our system, when performing a 12V off on a server board, multiple MCTP EIDs are removed almost simultaneously.\nI have observed that the `getSubtree` results can be inconsistent during these instances."
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Eric Yang",
                        "email": "eric.yang.wiwynn@gmail.com",
                        "username": "fornchu110"
                    },
                    "message": "The results of getSubtree are sometimes inconsistent with the actual situation. When this happens, it can lead to the erroneous removal of existing pldm devices."
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Thu Nguyen",
                        "email": "thu@os.amperecomputing.com",
                        "username": "ThuBaNguyen"
                    },
                    "message": "Can you ask Patric about that inconsistent of `GetSubTree` in discord?\nApplied this patch set will cause the D-Bus error message every time we remove one MCTP endpoint from D-Bus. That is unexpected behavior for `pldmd`.\nCan you try to use `dbus-monitor` to watch the MCTP signal to confirm there is no \"AddInterfaces\" signals for removing EP before `pldmd` remove the EP from watch list?"
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Thu Nguyen",
                        "email": "thu@os.amperecomputing.com",
                        "username": "ThuBaNguyen"
                    },
                    "message": "If the `GetSubTree` is inconsistent, I would like to use other solution to find the available MCTP EP D-Bus object paths to identify the removed EP correctly, rather than try to get the property of the removed EP which causes error message for each of removed EP. What do you think about that?"
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "line": 172,
                    "reviewer": {
                        "name": "Eric Yang",
                        "email": "eric.yang.wiwynn@gmail.com",
                        "username": "fornchu110"
                    },
                    "message": "Sorry for the late reply.\nI noticed that `getSubTree` seems to be retrieving MCTP EP D-Bus objects that have already been removed, rather than missing existing ones.\nThis causes an error during `getMctpInfos`:\n\n```\n   error(\n        \"Error reading MCTP Endpoint property at path '{PATH}' and service '{SERVICE}', error - {ERROR}\",\n        \"ERROR\", e, \"SERVICE\", service, \"PATH\", path);\n}\n\n```\n\nThis error leads to a return, preventing PLDM from obtaining subsequent MCTP EP D-Bus object information and removing them.\n\nHowever, I noticed that your recent merge (https://gerrit.openbmc.org/c/openbmc/pldm/+/73005) removed the following code:\n\n```cpp\ncatch (const sdbusplus::exception_t& e)\n{\n    error(\n        \"Error reading MCTP Endpoint property at path '{PATH}' and service '{SERVICE}', error - {ERROR}\",\n        \"ERROR\", e, \"SERVICE\", service, \"PATH\", path);\n    return;\n}\n```\n\nI believe that without returning on read failure, we might successfully retrieve all existing MCTP EP D-Bus objects without erroneously removing them.\nTherefore, this commit might no longer be necessary.\n\nI will verify this on the latest PLDM version, including the changes from 73005.\n\nThank you very much."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "requester/mctp_endpoint_discovery.cpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 29,
            "sizeDeletions": 1
        }
    ]
}