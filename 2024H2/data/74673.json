{
    "project": "openbmc/entity-manager",
    "branch": "master",
    "topic": "fru-write-support",
    "id": "If2e33ae2e5d639fc9bad4d5f3eafedbf4cea0679",
    "number": 74673,
    "subject": "feat: add a backup mechanism for eeprom files",
    "owner": {
        "name": "Oliver Brewka",
        "email": "mox669.dev@gmail.com",
        "username": "mox669"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/entity-manager/+/74673",
    "hashtags": [],
    "createdOn": 1726581566,
    "lastUpdated": 1727291103,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1726581566,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1726581594,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1726581594,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1726581873,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/91900/ : SUCCESS"
        },
        {
            "timestamp": 1726583168,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1726647793,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 1:\n\n(5 comments)"
        },
        {
            "timestamp": 1726674945,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1726674996,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1726674996,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1726675029,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Patch Set 2:\n\n(5 comments)\n\nThis change is ready for review."
        },
        {
            "timestamp": 1726675315,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/91959/ : SUCCESS"
        },
        {
            "timestamp": 1726768596,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1726770952,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1726826760,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1726827800,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1726829577,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1727126059,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1727205618,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1727205637,
            "reviewer": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1727205654,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1727205654,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1727206132,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/92217/ : SUCCESS"
        },
        {
            "timestamp": 1727289545,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3:\n\n(6 comments)"
        },
        {
            "timestamp": 1727291103,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(14 comments)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "1cf34fd1e418e0604cffcb0e0742793f19aca241",
            "parents": [
                "7a37ddf4f49a61401515e8d08eaba7b587b981b5"
            ],
            "ref": "refs/changes/73/74673/1",
            "uploader": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "createdOn": 1726581566,
            "author": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/fru_device.cpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "in case fs::exists returns false, the backup is also not found.\n\nSo the log message applies in both branches."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "you are right, I have added the log to the restoreFromBackup function, where this information actually is relevant and should be treated as an error. The other calls to hasBackupFile should not be logged as error, rather as debug. Would that work?"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 142,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "Yes. i was a little confused. Should be good."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 161,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "lg2::error here"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 161,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "Acknowledged"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 166,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "Since overwriting the FRU eeprom is a pretty significant event for the bmc,\ni would prefer we change the log level to lg2::info.\n\n```\nlg2::info(\"restoring FRU eeprom: copying {FROM} to {TO}\", \"FROM\", backupPath, \"TO\", eepromPath);\n```"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 166,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "Acknowledged"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 180,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "lg2::error here"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 180,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "Acknowledged"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1200,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "since the backup is only created initially for this implementation, it could also be interesting to have a log in the journal when the backup was done.\n\nSo it might be worth it to do an lg2::info here."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1200,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "Acknowledged"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "src/fru_device.cpp",
                    "type": "MODIFIED",
                    "insertions": 93,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 118,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "48ffe351f98631f265a86114a85ad8d7b61a4742",
            "parents": [
                "7a37ddf4f49a61401515e8d08eaba7b587b981b5"
            ],
            "ref": "refs/changes/73/74673/2",
            "uploader": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "createdOn": 1726674945,
            "author": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "What's the use case for this?  Do you have some upcoming code that's going to be calling it?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "This is already used in https://gerrit.openbmc.org/c/openbmc/entity-manager/+/74672 when calling UpdateFruProperty."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "Correction: this is used in this patch when calling updateFRUProperty."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "In addition: there is usage for a backup mechanism besides fru-device by some of our customers, that are using custom tooling to update fru data. Thats why we added the option to manually backup fru data aswell. I assume other users that do similar editing of fru data with their own tooling would benefit of a backup mechanism aswell."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": ">  there is usage for a backup mechanism besides fru-device by some of our customers, that are using custom tooling to update fru data. \n\nThanks.  Could you add that to the commit message?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Oliver Brewka",
                        "email": "mox669.dev@gmail.com",
                        "username": "mox669"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "src/fru_device.cpp",
                    "type": "MODIFIED",
                    "insertions": 103,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 128,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "ea0e873d66ff76f882c77510ff8f63899093abf3",
            "parents": [
                "37895feb26dbfa3175bcc0e8ecb40be4766e0069"
            ],
            "ref": "refs/changes/73/74673/3",
            "uploader": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "createdOn": 1727205618,
            "author": {
                "name": "Oliver Brewka",
                "email": "mox669.dev@gmail.com",
                "username": "mox669"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Remove \"feat\". that's not a convention we use, and capitalize \"Add\""
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 14,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This change takes FRUDevice from being largely stateless, to being a stateful interface.  Considering we already have double buffering in IPMI for this interface, it's not clear from this commit message what this accomplishes?\n\nHow would a user of the BMC use this interface through the existing user-facing interfaces for this (ipmi).  If you intend to add new user-facing interfaces to this, please state that."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 18,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Why?  This seems like all frus would boot in manufacturing empty, and \"back up\" the empty versions?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 23,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "bus numbers are not consistent boot to boot or if components are changed.  You'll need to key by something else."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 28,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I'm not sure how qemu could possibly test this well, considering we're writing to hardware?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Not quite understanding how this fits into the big picture.  As an internal debug interface, I don't understand why it's useful beyond what can already be done on command line with a basic \"cp\".\n\nAs a user-facing interface, I would expect that these give too much power to force hardware interfaces to change, and the interfaces aren't really something we could expose to the user\n\nLets get documented which of these we're trying to accomplish and go from there."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "nit, std::string would make this parameter more clear what it is.  That same advice can be applied throughout the file."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 139,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Please just use the ec version of fs::exists."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 158,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "What's creating /var/lib/entity-manager/backups/?  I don't think fs::copy does."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 158,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "+1.  Not sure how this could've worked."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1214,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "don't need the \\n"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1215,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Should lack of a backup prevent the FRU update?  I don't feel that strongly, but probably not."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1450,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "please don't do wildcard captures in lambdas.  They obscure lifetimes."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1451,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Doesn't this check mean that BackupFru will only work once, since after the first call the file would already exist?  What if they want to call UpdateFru and then back it up again?"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1458,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Please make these a normal function."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1461,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "ResetFRU is a little ambiguous, how about RestoreFruFromBackup?"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1461,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "we already have objects that represent each individual FRU.  We should attach these methods to the fru objects themselves, not add them to the root.  A dbus user isn't going to know the concept of a \"bus\" to go update."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1467,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "?  Why are we rescanning all the busses.  We double buffer things already, this should just be a reset of a single FRU."
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1471,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "??"
                },
                {
                    "file": "src/fru_device.cpp",
                    "line": 1471,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Matt, it says 5 time, your comment should've been\n\n?????"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 31,
                    "deletions": 0
                },
                {
                    "file": "src/fru_device.cpp",
                    "type": "MODIFIED",
                    "insertions": 112,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 143,
            "sizeDeletions": 0
        }
    ]
}