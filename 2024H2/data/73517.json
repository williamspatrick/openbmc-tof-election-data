{
    "project": "openbmc/phosphor-virtual-sensor",
    "branch": "master",
    "id": "I11389ca88923e0010007ee52bc803b94d3e4b10a",
    "number": 73517,
    "subject": "Add addinterface signals to update virtual sensor",
    "owner": {
        "name": "Ian Chien",
        "email": "ianchien.wiwynn@gmail.com",
        "username": "Ian-I-Chien"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-virtual-sensor/+/73517",
    "hashtags": [],
    "createdOn": 1723516097,
    "lastUpdated": 1724202356,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1723516097,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1723516141,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1723516142,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1723516159,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/89612/ : FAILURE"
        },
        {
            "timestamp": 1723516660,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1723516736,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1723516737,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1723516753,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/89614/ : FAILURE"
        },
        {
            "timestamp": 1723517190,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1723517231,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1723517231,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1723517633,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/89616/ : SUCCESS"
        },
        {
            "timestamp": 1723517786,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Uploaded patch set 4.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1723517878,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1723517883,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1723518192,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/89620/ : SUCCESS"
        },
        {
            "timestamp": 1723525821,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Uploaded patch set 5.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1723525837,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1723525837,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1723526029,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/89627/ : SUCCESS"
        },
        {
            "timestamp": 1723546415,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Patch Set 5:\n\nThis change is ready for review."
        },
        {
            "timestamp": 1723556718,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1723600114,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1723600585,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1723639452,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1723820371,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1723822690,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1723823814,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1723879470,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1724063946,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1724080243,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1724085977,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Patch Set 5:\n\n(2 comments)"
        },
        {
            "timestamp": 1724149762,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1724202356,
            "reviewer": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        }
    ],
    "wip": true,
    "patchSets": [
        {
            "number": 1,
            "revision": "4334db43dff11c09430a019f4a94824a677e717e",
            "parents": [
                "5f07fa36bbca2e9c02cb2b7f1dba0fa618a48cf9"
            ],
            "ref": "refs/changes/17/73517/1",
            "uploader": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "createdOn": 1723516097,
            "author": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "dbusSensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "dbusSensor.hpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 58,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "b7ac86a754d743e970b0c089265c213d9c1c4472",
            "parents": [
                "5f07fa36bbca2e9c02cb2b7f1dba0fa618a48cf9"
            ],
            "ref": "refs/changes/17/73517/2",
            "uploader": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "createdOn": 1723516660,
            "author": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "dbusSensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": -1
                },
                {
                    "file": "dbusSensor.hpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 57,
            "sizeDeletions": 1
        },
        {
            "number": 3,
            "revision": "83b02b6decfa402508bcbd8b3521137154b0d3aa",
            "parents": [
                "5f07fa36bbca2e9c02cb2b7f1dba0fa618a48cf9"
            ],
            "ref": "refs/changes/17/73517/3",
            "uploader": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "createdOn": 1723517190,
            "author": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "dbusSensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": -1
                },
                {
                    "file": "dbusSensor.hpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 57,
            "sizeDeletions": 1
        },
        {
            "number": 4,
            "revision": "38fc742aaa3499d78aadddaf0ad5f331ba2f0789",
            "parents": [
                "5f07fa36bbca2e9c02cb2b7f1dba0fa618a48cf9"
            ],
            "ref": "refs/changes/17/73517/4",
            "uploader": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "createdOn": 1723517786,
            "author": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "dbusSensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": -1
                },
                {
                    "file": "dbusSensor.hpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 57,
            "sizeDeletions": 1
        },
        {
            "number": 5,
            "revision": "3c6be8b1345a1dcb851ba8c0c64056e95117d28b",
            "parents": [
                "5f07fa36bbca2e9c02cb2b7f1dba0fa618a48cf9"
            ],
            "ref": "refs/changes/17/73517/5",
            "uploader": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "createdOn": 1723525821,
            "author": {
                "name": "Ian Chien",
                "email": "ianchien.wiwynn@gmail.com",
                "username": "Ian-I-Chien"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "dbusSensor.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Ian Chien",
                        "email": "ianchien.wiwynn@gmail.com",
                        "username": "Ian-I-Chien"
                    },
                    "message": "Is it suggested to added an [after] other sensor services in PVS service config since PVS monitors sensors from other sensor service?\ne.g.\nAfter=psusensor.service adcsensor.service fansensor.service\nand other sensors reltaed services.\n\nhttps://github.com/openbmc/phosphor-virtual-sensor/blob/master/phosphor-virtual-sensor.service.in\n\nservName can be set in PSV init function."
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "No, it is not suggested to add additional `After` calls like that.  One major issue is that we don't know which processes will expose the sensors needed by the config.  In addition to the dbus-sensor based entities you mentioned here (likely used by your system), sensors could be coming from PLDM, etc.  All of this is system-specific."
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Ian Chien",
                        "email": "ianchien.wiwynn@gmail.com",
                        "username": "Ian-I-Chien"
                    },
                    "message": "Some sensor services might be system-specific, so I use ```After``` without ```Requires``` in the service configuration \u2014 just for ordering purposes. Even though we don\u2019t know which processes will expose the necessary sensors, should PVS always be running after all sensor services have started? I'm not sure if my thinking is correct, so please let me know if there are any issues with it. Thank you!"
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Ian Chien",
                        "email": "ianchien.wiwynn@gmail.com",
                        "username": "Ian-I-Chien"
                    },
                    "message": "I\u2019ve considered that there might some  system-specific senosor services.Hence, using"
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I'd prefer we do not add service dependencies, even for \"known\" ones.  There is no hard dependency that you use any of these dbus-sensor services."
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Ian Chien",
                        "email": "ianchien.wiwynn@gmail.com",
                        "username": "Ian-I-Chien"
                    },
                    "message": "I see. Thanks for the information!"
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "I think you can get the service name from the message itself? The mapper is processing the signal at the same  time, so it could be a race on if it even has it yet."
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Ian Chien",
                        "email": "ianchien.wiwynn@gmail.com",
                        "username": "Ian-I-Chien"
                    },
                    "message": "I think the service name is not included in the message.\nI have monitored the interfacesadded signal through bus-monitor. The message does not contain the service name.\n\nLog:\n```\nType=signal  Endian=l  Flags=1  Version=1 Cookie=51  Timestamp=\"Tue 2023-11-14 02:16:34.231193 UTC\"\n  Sender=:1.24019  Path=/xyz/openbmc_project/inventory  Interface=org.freedesktop.DBus.ObjectManager  Member=InterfacesAdded\n  UniqueName=:1.24019\n  MESSAGE \"oa{sa{sv}}\" {\n          OBJECT_PATH \"/xyz/openbmc_project/inventory/system/board/Yosemite_4_Floating_Falls_Slot_6/CXL\";\n          ARRAY \"{sa{sv}}\" {\n                  DICT_ENTRY \"sa{sv}\" {\n                          STRING \"xyz.openbmc_project.Configuration.MCTPEndpoint\";\n                          ARRAY \"{sv}\" {\n```\n\nThanks for pointing out that there might be a race.\nWould adding a mutex for the servName be a suitable approach?"
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Ian Chien",
                        "email": "ianchien.wiwynn@gmail.com",
                        "username": "Ian-I-Chien"
                    },
                    "message": "I will study if there is another way to avoid the race."
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "The Sender field is the unique name, just not  the well known name.  So while it would work, it could change after a restart.  The mapper handles it by also listening to NameOwnerChanged signals to map between the two, but that isn't really possible here.\n\nMaybe Patrick has an idea."
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "A mutex doesn't help because this is a race condition with another process that is also processing this signal.  You can't know when that process is done completing its processing.\n\n[@Matt - For what it is worth, this is why Mapper was suppose to have causal ordering, but it got removed in the Python -> C++ rewrite that was done years ago now.]\n\nCan we defer the service lookup until the first access after the timer?  If the `servName.empty()`, check with mapper?"
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "> causal ordering\n\nWhat was that exactly?"
                },
                {
                    "file": "dbusSensor.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "https://en.wikipedia.org/wiki/Causal_consistency\n\nIn this case we have something like this:\n\n```\nAdd(1) -> Mapper\n       |         ^\n       -> PVS(2) | \n```\n\nSince the Add \"causes\" action in both PVS and Mapper, PVS shouldn't be able to get an answer from Mapper indicating that the action hasn't happened yet.\n\n1 caused 2, so 2 shouldn't get an answer that indicated 1 hasn't happened yet."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "dbusSensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": -1
                },
                {
                    "file": "dbusSensor.hpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 57,
            "sizeDeletions": 1
        }
    ]
}