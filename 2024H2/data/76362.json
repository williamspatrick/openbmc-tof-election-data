{
    "project": "openbmc/phosphor-psu-code-mgmt",
    "branch": "master",
    "id": "I933386e94f43a915b301d6aef7d91691816a0548",
    "number": 76362,
    "subject": "Improve error handling for exceptions and asserts",
    "owner": {
        "name": "Shawn McCarney",
        "email": "shawnmm@us.ibm.com",
        "username": "smccarney"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-psu-code-mgmt/+/76362",
    "hashtags": [],
    "createdOn": 1733705249,
    "lastUpdated": 1733844044,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1733705249,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1733705283,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733705283,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1733705640,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/96092/ : FAILURE"
        },
        {
            "timestamp": 1733706696,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1733706728,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733706728,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1733707231,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/96093/ : SUCCESS"
        },
        {
            "timestamp": 1733707380,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1733763376,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1733783024,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(3 comments)"
        },
        {
            "timestamp": 1733783992,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2:\n\n(3 comments)"
        },
        {
            "timestamp": 1733784821,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(3 comments)"
        },
        {
            "timestamp": 1733785588,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1733785627,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1733785627,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1733785823,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/96156/ : SUCCESS"
        },
        {
            "timestamp": 1733785826,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1733790762,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1733841835,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1733844044,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "fa25d79d199580f74635d90d98442dee61531e70",
            "parents": [
                "d57bd2f2b15738da1a38e3caaa193a7cc713adca"
            ],
            "ref": "refs/changes/62/76362/1",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1733705249,
            "author": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "src/main.cpp",
                    "type": "MODIFIED",
                    "insertions": 30,
                    "deletions": -15
                },
                {
                    "file": "src/item_updater.hpp",
                    "type": "MODIFIED",
                    "insertions": 43,
                    "deletions": -14
                },
                {
                    "file": "src/utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 113,
                    "deletions": -51
                },
                {
                    "file": "src/activation.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "src/runtime_warning.hpp",
                    "type": "ADDED",
                    "insertions": 45,
                    "deletions": 0
                },
                {
                    "file": "src/utils.hpp",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -4
                },
                {
                    "file": "src/activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 71,
                    "deletions": -36
                },
                {
                    "file": "src/item_updater.cpp",
                    "type": "MODIFIED",
                    "insertions": 197,
                    "deletions": -113
                },
                {
                    "file": "test/test_item_updater.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 567,
            "sizeDeletions": 236
        },
        {
            "number": 2,
            "revision": "4ae1c4c3418c91a3c6a652aa1a3437147b099a46",
            "parents": [
                "d57bd2f2b15738da1a38e3caaa193a7cc713adca"
            ],
            "ref": "refs/changes/62/76362/2",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1733706696,
            "author": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Note to reviewers: The diffs are not helpful for the changes to scanDirectory().  I did not change the core logic.  I converted a bunch of log() + return statements to exceptions.  I also refactored the first third of this method into a new method named findModelDirectory(). This was done because scanDirectory() was so long and was getting hard to follow."
                },
                {
                    "file": "src/main.cpp",
                    "line": 31,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "why do you want to prevent a core dump here?"
                },
                {
                    "file": "src/main.cpp",
                    "line": 31,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I was hoping to ensure that the exception message is logged.  Also, I'm not sure if we want to trigger a core dump and BMC dump?  If you think we do want that, I can remove the try/catch here."
                },
                {
                    "file": "src/main.cpp",
                    "line": 31,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "here's an example of when there is no catch:\n mboxd[992]: terminate called after throwing an instance of 'sdbusplus::exception::SdBusError'\n mboxd[992]:   what():  sd_bus_call: org.freedesktop.DBus.Error.Timeout: Connection timed out\n \nso it does print the message.\n \nI think the core dump may be useful since with all the code in this commit it should never actually happen, so it may be a tough debug to find otherwise."
                },
                {
                    "file": "src/main.cpp",
                    "line": 31,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Done"
                },
                {
                    "file": "src/utils.cpp",
                    "line": 103,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "The convention is to catch the sdbusplus exception.  Was there a particular reason you changed it?"
                },
                {
                    "file": "src/utils.cpp",
                    "line": 103,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Some of the D-Bus related code in this application can throw exceptions that are not derived from sdbusplus::exception_t.  For example, getProperty() in utils.hpp and several methods in item_updater.cpp use std::get() to get values from a std::variant.  If there is a data type mixup, it compiles in some cases and throws a std::exception at run-time.\n\nMy goal was to avoid an exception escaping to main() or to the sdbusplus event handling code.  So I thought it was safer to catch std::exception in all cases.\n\nIs there an advantage to catching the more specific class here?"
                },
                {
                    "file": "src/utils.cpp",
                    "line": 103,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "It probably doesn't matter much.  In this particular case, you're not using any of those helper functions is all."
                },
                {
                    "file": "src/utils.cpp",
                    "line": 103,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I think I'll leave it more generic rather than go through each DBus-related block and try to determine if any non-sdbusplus exceptions can be thrown.\n\nIf I make some of them more specific, and someone else makes changes to the code, they might add something that throws an unhandled exception type and not realize they need to update the catch."
                },
                {
                    "file": "src/utils.hpp",
                    "line": 32,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "nit: strange spacing"
                },
                {
                    "file": "src/utils.hpp",
                    "line": 32,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I was trying to match the other doxygen in this file.  I'm not sure why they lined up param descriptions at this column.  I can fix if you think that is better."
                },
                {
                    "file": "src/utils.hpp",
                    "line": 32,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "If you have a reason for it that's fine."
                },
                {
                    "file": "src/utils.hpp",
                    "line": 32,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "In looking at it, it is strange.  Fixed."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "src/main.cpp",
                    "type": "MODIFIED",
                    "insertions": 30,
                    "deletions": -15
                },
                {
                    "file": "src/item_updater.hpp",
                    "type": "MODIFIED",
                    "insertions": 43,
                    "deletions": -14
                },
                {
                    "file": "src/utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 113,
                    "deletions": -51
                },
                {
                    "file": "src/activation.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "src/runtime_warning.hpp",
                    "type": "ADDED",
                    "insertions": 45,
                    "deletions": 0
                },
                {
                    "file": "src/utils.hpp",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -4
                },
                {
                    "file": "src/activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 71,
                    "deletions": -36
                },
                {
                    "file": "src/item_updater.cpp",
                    "type": "MODIFIED",
                    "insertions": 197,
                    "deletions": -113
                },
                {
                    "file": "test/test_item_updater.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 567,
            "sizeDeletions": 236
        },
        {
            "number": 3,
            "revision": "487e2e19bf667a668d67034d86548031ce2313d4",
            "parents": [
                "d57bd2f2b15738da1a38e3caaa193a7cc713adca"
            ],
            "ref": "refs/changes/62/76362/3",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1733785588,
            "author": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "src/item_updater.hpp",
                    "type": "MODIFIED",
                    "insertions": 43,
                    "deletions": -14
                },
                {
                    "file": "src/utils.cpp",
                    "type": "MODIFIED",
                    "insertions": 113,
                    "deletions": -51
                },
                {
                    "file": "src/activation.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "src/runtime_warning.hpp",
                    "type": "ADDED",
                    "insertions": 45,
                    "deletions": 0
                },
                {
                    "file": "src/utils.hpp",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -4
                },
                {
                    "file": "src/activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 71,
                    "deletions": -36
                },
                {
                    "file": "src/item_updater.cpp",
                    "type": "MODIFIED",
                    "insertions": 197,
                    "deletions": -113
                },
                {
                    "file": "test/test_item_updater.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 537,
            "sizeDeletions": 221
        }
    ]
}