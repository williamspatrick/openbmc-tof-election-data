{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I6e002153ca37b4eb3d4538a64fa61ab35e9dab85",
    "number": 75593,
    "subject": "Fix snmp port out of range",
    "owner": {
        "name": "George Liu",
        "email": "liuxiwei@ieisystem.com",
        "username": "lxwinspur"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/75593",
    "hashtags": [],
    "createdOn": 1730426581,
    "lastUpdated": 1730823673,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1730426581,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1730426657,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1730426657,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1730426780,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/93962/ : FAILURE"
        },
        {
            "timestamp": 1730428278,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Uploaded patch set 2: Commit message was updated.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1730428332,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1730428332,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1730429082,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/93964/ : SUCCESS"
        },
        {
            "timestamp": 1730474127,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gunnar@gmills.xyz",
                "username": "gtmills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1730474389,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gunnar@gmills.xyz",
                "username": "gtmills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1730474412,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gunnar@gmills.xyz",
                "username": "gtmills"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1730517504,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1730517516,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1730517551,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1730517551,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1730518331,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/93987/ : SUCCESS"
        },
        {
            "timestamp": 1730645436,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gunnar@gmills.xyz",
                "username": "gtmills"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1730708826,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Code-Review-2\n\n(1 comment)"
        },
        {
            "timestamp": 1730709342,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1730741613,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1730769359,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1730769463,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: -Code-Review\n\n(1 comment)"
        },
        {
            "timestamp": 1730771072,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1730772184,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1730772671,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1730823669,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1730823673,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "a20446371f0503173a85a2d7eb1e58458656ab61",
            "parents": [
                "02ea923f13de196726ac2f022766a6f80bee1c0a"
            ],
            "ref": "refs/changes/93/75593/1",
            "uploader": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "createdOn": 1730426581,
            "author": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 121,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 130,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "07484fb40e815afa7573b5ac25cacd08d0fa6900",
            "parents": [
                "02ea923f13de196726ac2f022766a6f80bee1c0a"
            ],
            "ref": "refs/changes/93/75593/2",
            "uploader": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "createdOn": 1730428278,
            "author": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 52,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gunnar@gmills.xyz",
                        "username": "gtmills"
                    },
                    "message": "Posting the full -vv seems overkill for a commit msg where the important part of the testing is \n```\n{\n  \"Destination@Message.ExtendedInfo\": [\n    {\n      \"@odata.type\": \"#Message.v1_1_1.Message\",\n      \"Message\": \"The value '\\\"snmp://xx.xx.xx.76:65537\\\"' for the property Destination is of a different format than the property can accept.\",\n      \"MessageArgs\": [\n        \"\\\"snmp://xx.xx.xx.76:65537\\\"\",\n        \"Destination\"\n      ],\n      \"MessageId\": \"Base.1.16.0.PropertyValueFormatError\",\n      \"MessageSeverity\": \"Warning\",\n      \"Resolution\": \"Correct the value for the property in the request body and resubmit the request if the operation failed.\"\n    }\n  ]\n```\n\nmaybe just trim this down to the actual error and like line 63 ?\n\n```\n\n$ curl --header \"Content-Type: application/json\" X POST -i -k -u root:0penBmc https://{bmc}/redfish/v1/EventService/Subscriptions --data-raw '{\"Destination\": \"snmp://xx.xx.xx.76:65537\",\"SubscriptionType\": \"SNMPTrap\", \"Protocol\": \"SNMPv2c\"}' -vv\n...\n\n< HTTP/1.1 400 Bad Request\n...\n\n{\n  \"Destination@Message.ExtendedInfo\": [\n    {\n      \"@odata.type\": \"#Message.v1_1_1.Message\",\n      \"Message\": \"The value '\\\"snmp://xx.xx.xx.76:65537\\\"' for the property Destination is of a different format than the property can accept.\",\n      \"MessageArgs\": [\n        \"\\\"snmp://xx.xx.xx.76:65537\\\"\",\n        \"Destination\"\n      ],\n      \"MessageId\": \"Base.1.16.0.PropertyValueFormatError\",\n      \"MessageSeverity\": \"Warning\",\n      \"Resolution\": \"Correct the value for the property in the request body and resubmit the request if the operation failed.\"\n    }\n  ]\n* Connection #0 to host 127.0.0.1 left intact\n}\n\n\n```"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 52,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "Done"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 357,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gunnar@gmills.xyz",
                        "username": "gtmills"
                    },
                    "message": "This works because \n\nhttps://www.boost.org/doc/libs/master/doc/antora/url/reference/boost/urls/url_view_base/port_number.html#_description\n\nDescription\n\nIf a port is present and the numerical value is representable, it is returned as an unsigned integer. Otherwise, the number zero is returned.\n\n\nCan you add that comment ?\n\n// port_number returns zero if it is not a valid representable port"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 357,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 121,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 130,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "b07942e362fd4e33d9aca9860b6341e995543a5d",
            "parents": [
                "02ea923f13de196726ac2f022766a6f80bee1c0a"
            ],
            "ref": "refs/changes/93/75593/3",
            "uploader": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "createdOn": 1730517504,
            "author": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This code looks like it breaks setting destinations without a port.\n\nIf we're truly trying to avoid 0, that's something the snmp daemon needs to verify.\n\nI see the error is already handled here:\nhttps://github.com/openbmc/bmcweb/blob/02ea923f13de196726ac2f022766a6f80bee1c0a/redfish-core/include/snmp_trap_event_clients.hpp#L138\n\nSo it's not clear why that's not working in this case."
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "> This code looks like it breaks setting destinations without a port.\n\nIf port is 0, this will not hit this if\n\n> I see the error is already handled here:\nhttps://github.com/openbmc/bmcweb/blob/02ea923f13de196726ac2f022766a6f80bee1c0a/redfish-core/include/snmp_trap_event_clients.hpp#L138\n\nIf an incorrect port is passed, the port_number() method will return 0, so the following setPortDefaults method will set the port to the default value, so there will be no error when calling the addSnmpTrapClient method"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> If port is 0, this will not hit this if\n\nah, I see that now.\n\nBut the second part is still valid.  Why is the SNMP daemon accepting bad ports over dbus?"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "> > If port is 0, this will not hit this if\n> \n> ah, I see that now.\n> \n> But the second part is still valid.  Why is the SNMP daemon accepting bad ports over dbus?\n\nsetPortDefaults will get the port number through the port_number() method.\nIf the port number is wrong or there is no port number, the return value is 0.\nhttps://github.com/openbmc/bmcweb/blob/master/http/utility.hpp#L495\n\nAt this time, a default port number will be set:\nhttps://github.com/openbmc/bmcweb/blob/master/http/utility.hpp#L513"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Ah, I understand better now.  Do we understand why boost url accepts ports outside of the valid range?"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "Sorry, I haven't explored this issue in depth, but from testing, if it is an invalid port, has_port will return true, and port_number() will return 0."
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "that sounds like a bug in boost url then?"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "I'm not sure, maybe this is the intentional design of boost::url?"
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "line": 359,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I understand now, fine as is."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/event_service.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 0
        }
    ]
}