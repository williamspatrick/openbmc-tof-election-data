{
    "project": "openbmc/libpldm",
    "branch": "main",
    "topic": "remove-reinterpret-cast",
    "id": "I71158bd6b062c6e6522dc4a4cdcb089a139cd841",
    "number": 74449,
    "subject": "base: Add size and buffer macros for struct pldm_msg",
    "owner": {
        "name": "Andrew Jeffery",
        "email": "andrew@codeconstruct.com.au",
        "username": "amboar"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/libpldm/+/74449",
    "hashtags": [],
    "createdOn": 1725866526,
    "lastUpdated": 1727314777,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1725866526,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1725866554,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1725866554,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1725866881,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/91570/ : SUCCESS"
        },
        {
            "timestamp": 1726205601,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1726463499,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1726534447,
            "reviewer": {
                "name": "ManojKiran Eda",
                "email": "manojkiran.eda@gmail.com",
                "username": "manojkiraneda"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1727313735,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1727313768,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1727313768,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1727313787,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1727314090,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/92319/ : SUCCESS"
        },
        {
            "timestamp": 1727314317,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1727314352,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1727314352,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1727314673,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/92322/ : SUCCESS"
        },
        {
            "timestamp": 1727314756,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1727314777,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "324ff8455623dbfa9519cb236f2f638f03bbff79",
            "parents": [
                "5166ad637d5b1c99c5eee72f619fd8b5cee23456"
            ],
            "ref": "refs/changes/49/74449/1",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "createdOn": 1725866526,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "include/libpldm/base.h",
                    "line": 177,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "may be use \n\n```\n#define PLDM_MSG_SIZE(size) \\\n    (offsetof(struct pldm_msg, payload) + (size))\n\n``` \ninstead ? seems much more safer ?"
                },
                {
                    "file": "include/libpldm/base.h",
                    "line": 177,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "Can you unpack why you think it's safer? From C17 the definition of `sizeof` states (6.5.3.4):\n\n> The sizeof operator yields the size (in bytes) of its operand, which may be an expression or the parenthesized name of a type. The size is determined from the type of the operand. The result is an integer. If the type of the operand is a variable length array type, the operand is evaluated; otherwise, the operand is not evaluated and the result is an integer constant.\n\nWe don't have a variable length array, so the operand is not evaluated, which means the fact that we use `NULL` here as the pointer value is not relevant.\n\n\"Take the size, remove the sketchy bit, then add on the variable bit\" is more intuitive to me than \"the offset of this member represents the size of the struct, now add the variable bit\"."
                },
                {
                    "file": "include/libpldm/base.h",
                    "line": 177,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "well, the existing code is not really unsafe, when i meant safer, its just the use of `((struct pldm_msg *)NULL)->payload` may raise concern for people unfamiliar with this pattern even though it's safe in this context because the sizeof() operator does not evaluate its operand (it just determines the size at compile time). However, i felt that this pattern is somewhat obscure and might be better replaced with something more intuitive :) , but i am okay if you wanna leave it as-is since you think it otherwise."
                },
                {
                    "file": "include/libpldm/base.h",
                    "line": 179,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "may be change this to\n\n```\n#define PLDM_MSG_BUFFER(name, size) \\\n    alignas(struct pldm_msg) unsigned char name[PLDM_MSG_SIZE(size)]\n```\nits a little more intuitive ?"
                },
                {
                    "file": "include/libpldm/base.h",
                    "line": 179,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "The parentheses are needed to handle name as an expression. The unintuitive whitespace shenanigans are the result of clang-format."
                },
                {
                    "file": "include/libpldm/base.h",
                    "line": 179,
                    "reviewer": {
                        "name": "ManojKiran Eda",
                        "email": "manojkiran.eda@gmail.com",
                        "username": "manojkiraneda"
                    },
                    "message": "Acknowledged"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "include/libpldm/base.h",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 15,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "3c07f01b53ecc480eaf54f8eca80415e23177512",
            "parents": [
                "74c9a5469802dc05d42dd39b64b9be61f82fc1c7"
            ],
            "ref": "refs/changes/49/74449/2",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "createdOn": 1727313735,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "include/libpldm/base.h",
                    "type": "MODIFIED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "tests/oem/ibm/host.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -58
                }
            ],
            "sizeInsertions": 92,
            "sizeDeletions": 58
        },
        {
            "number": 3,
            "revision": "7a3c14ecebf0b165850e484d3ca202af9a4fc59a",
            "parents": [
                "74c9a5469802dc05d42dd39b64b9be61f82fc1c7"
            ],
            "ref": "refs/changes/49/74449/3",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "createdOn": 1727314317,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "CHANGELOG.md",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": 0
                },
                {
                    "file": "include/libpldm/base.h",
                    "type": "MODIFIED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "tests/oem/ibm/host.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -58
                }
            ],
            "sizeInsertions": 96,
            "sizeDeletions": 58
        }
    ]
}