{
    "project": "openbmc/phosphor-state-manager",
    "branch": "master",
    "id": "I51aa143523ec722a27eb41a1f76c3614ab6e4914",
    "number": 73456,
    "subject": "bmc: change BMC's state to UpdateInProgress while BMC is in Update mode",
    "owner": {
        "name": "Thang Tran",
        "email": "thuutran@amperecomputing.com",
        "username": "thangtran-ampere"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-state-manager/+/73456",
    "hashtags": [],
    "createdOn": 1722924952,
    "lastUpdated": 1734332457,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1722924952,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1722924979,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1722924979,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1722925352,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/89257/ : SUCCESS"
        },
        {
            "timestamp": 1722953350,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 1:\n\n(4 comments)"
        },
        {
            "timestamp": 1723017091,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1723020823,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1723037502,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1723099059,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1723099101,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1723099101,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1723099478,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/89382/ : SUCCESS"
        },
        {
            "timestamp": 1723100106,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(5 comments)"
        },
        {
            "timestamp": 1723543967,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(3 comments)"
        },
        {
            "timestamp": 1723575295,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1723603553,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1723746746,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@us.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1723776355,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1723817805,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@us.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1723817818,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@us.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1723824791,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1724086418,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1724145672,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1724864987,
            "reviewer": {
                "name": "Jagpal S Gill",
                "email": "paligill@gmail.com",
                "username": "jagpalgill"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1724890442,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1734332457,
            "reviewer": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "message": "Abandoned\n\nThis commit has ben replaced by https://gerrit.openbmc.org/c/openbmc/phosphor-state-manager/+/75665"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "4e92ac3409afcdc956aae440fb6a6644b15fc71c",
            "parents": [
                "b27eef54434198443848b016a659b59564a8e9a6"
            ],
            "ref": "refs/changes/56/73456/1",
            "uploader": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "createdOn": 1722924952,
            "author": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "The bmcweb logic over in https://github.com/openbmc/bmcweb/blob/master/redfish-core/lib/managers.hpp#L2121 will also need to be updated to look for this new state."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 0,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Do you mean that the `asyncResp->res.jsonValue[\"Status\"][\"State\"]` property should be set to `Updating`?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, we'll want the Redfish API to correctly report when the BMC state is updating."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 0,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I see that we have a discussion about how to update this property https://discord.com/channels/775381525260664832/1027583818783264841, should we change this one?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 0,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "About the bmcweb, I think we can update is later. I believe this commit does not change the behavior of bmcweb."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "The ambiguity to me is that I felt like when the BMC State is UpdateInProgress, then that means the BMC flash itself is being updated. If we're updating host firmware, or some other flash chip in the system, we don't want the BMC state to go to UpdateInProgress."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I asked your concern on the Discord to get more view. https://discord.com/channels/775381525260664832/775381525260664836/1270596296474103859"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "\ud83d\udc4d"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I seem that when BMC is updating BIOS firmwares, the BMC's state can be set to UpdateInProgress, but not all of them need to change this. But I think we should make a common solution for all of them to make more safe for system."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I think that we can use ActivationBlocksTransition interface to indicate that the BMC is in Update mode."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "I'm not sure we've resolved this one yet. A quick grok shows this interface is added for PSU code update, PNOR code updates, and BMC code updates. I understand why PSU and PNOR want to block BMC reboots during this time (avoid corruption of the devices) but the BMC itself is not being updated during those steps so we shouldn't say the BMC state is UpdateInProgress. Is there something specific we can look up to know that the BMC itself is being updated?\nhttps://grok.openbmc.org/search?full=%22xyz.openbmc_project.Software.ActivationBlocksTransition%22&defs=&refs=&path=&hist=&type=&xrd=&nn=1&si=full&searchall=true&si=full"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "The phosphor-bmc-code-mgmt is creating ActivationBlocksTransition interface to prevent reboot action while copying `img-*` files from `/tmp/images` folder to `/run/initramfs` folder if user request to flash new BMC https://github.com/openbmc/phosphor-bmc-code-mgmt/blob/master/static/flash.cpp#L54. BMC does not write data to itself flash until user request BMC rebooting. During copying time, I think the BMC could be set to Update Mode.\n\nWhen users reboot BMC, the BMC looks for `/run/initramfs/img-<bmc|kernel|ubbot-|...>` files, if those files are available, BMC flashes they to according to `mtd-*` devices https://github.com/openbmc/openbmc/blob/master/meta-phosphor/recipes-phosphor/initrdscripts/files/obmc-shutdown.sh#L40. This is how BMC is flashing itself."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@us.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "That flow applies to systems with a single BMC version. Other configurations support dual versions and instead of writing to the BMC flash on reboot, the BMC writes to the alternate version without being rebooted."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Hi @Adriana, I just want to make clearly how to BMC flashes itself, why do we need to prevent BMC reboot action during the copying image-* files."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@us.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Copying to /run/initramfs is like writing to flash, because on reboot whatever is on /run/initramfs will be written to flash. Therefore if the copy is interrupted and only a partial image-u-boot file is copied for example, that partial file will be written during the reboot and corrupt the BMC, same as if a write operation to the flash was interrupted."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@us.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "> During copying time, I think the BMC could be set to Update Mode.\n\nI'm trying to understand this comment. Is the proposal that the code update app, when it starts a BMC activation, sets the BMC state to \"UpdateInProgress\"?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I means while copying files to /run/initramfs, BMC's state should be set to \"UpdateInProgress\""
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "We have examples of doing this elsewhere with the chassis and host (poweringOn/poweringOff) being set via a service in the corresponding systemd targets. But the issue is when the code update is done, we kind of need to re-run the discovery logic (to discover if we're NotReady or Quiesced). There's currently no way to trigger that logic externally (other then restarting bmc state manager).\n\nI'm starting to wonder if we're overthinking this and the better direction is to just treat the BMC state (in regards to UpdateInProgress) to just be set anytime the BMC is doing any type of firmware update to any device. So we could update the PDI to indicate this and see how that review goes. Then we can just go with the original code here and set it whenever any update event occurs on d-bus."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I created new commit in the PDIs to update UpdateInProgress \n value, please take a look https://gerrit.openbmc.org/c/openbmc/phosphor-dbus-interfaces/+/73845"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Thanks for working on this Thang. It's always been on the TODO list to get that state properly supported."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Make OpenBmc better day by day \ud83d\ude04"
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 136,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Is this interface only when a BMC update is occurring or could it be any type of firmware update?"
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 136,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I see that any type of firmware update is creating that interface."
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 136,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Done"
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 155,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "We'll need to redetect this. What if BMC was in NotReady or Quiesced prior to start of code update? Or went to Quiesce during update. Can hopefully just call discoverInitialState()"
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 155,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "I will update this point"
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 155,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "bmc_state_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 118,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "42438833c58ff77a24404ec9e18f39c9aef13aaa",
            "parents": [
                "b27eef54434198443848b016a659b59564a8e9a6"
            ],
            "ref": "refs/changes/56/73456/2",
            "uploader": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "createdOn": 1723099059,
            "author": {
                "name": "Thang Tran",
                "email": "thuutran@amperecomputing.com",
                "username": "thangtran-ampere"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Do you have any comment?"
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 152,
                    "reviewer": {
                        "name": "Jagpal S Gill",
                        "email": "paligill@gmail.com",
                        "username": "jagpalgill"
                    },
                    "message": "Does discoverInitialState means no update in progress? If yes, isn't it suppose to be the case when NO ACT_BLOCK_TRANS_INTERFACE is found?"
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "line": 152,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "The discoverInitialState method checks the obmc-bmc-service-quiesce@0.target and multi-user.target to get the BMC state, it can be Ready/NotReady/Quiesce.\n\nWhen NO ActivationBlocksTransition is found, it means other interfaces are added, not ActivationBlocksTransition, firmwareIsUpdated method does nothing."
                },
                {
                    "file": "bmc_state_manager.hpp",
                    "line": 80,
                    "reviewer": {
                        "name": "Jagpal S Gill",
                        "email": "paligill@gmail.com",
                        "username": "jagpalgill"
                    },
                    "message": "I suppose this matcher will watch for any interfaces on subtree paths as well, for example /xyz/openbmc_project/software/<xxx>?"
                },
                {
                    "file": "bmc_state_manager.hpp",
                    "line": 80,
                    "reviewer": {
                        "name": "Thang Tran",
                        "email": "thuutran@amperecomputing.com",
                        "username": "thangtran-ampere"
                    },
                    "message": "Yes, this matcher monitors all `InterfaceAdded` signal with the prefix `/xyz/openbmc_project/software` not only for `ActivationBlocksTransition` interface. In the firmwareIsUpdating method, we will check this interface later."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "bmc_state_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "bmc_state_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 118,
            "sizeDeletions": 1
        }
    ]
}