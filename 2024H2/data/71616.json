{
    "project": "openbmc/slpd-lite",
    "branch": "master",
    "id": "I17a8a013bcd90e083b1156f794f059fc1b830a63",
    "number": 71616,
    "subject": "Do not use input header for error responses",
    "owner": {
        "name": "Andrew Geissler",
        "email": "geissonator@yahoo.com",
        "username": "geissonator"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/slpd-lite/+/71616",
    "hashtags": [],
    "createdOn": 1716582602,
    "lastUpdated": 1722438487,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1716582602,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1716585089,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1716663583,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1716883882,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 3: Code-Review+2\n\n(2 comments)"
        },
        {
            "timestamp": 1716883945,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 3: -Code-Review"
        },
        {
            "timestamp": 1716884077,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1716904091,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1716910166,
            "reviewer": {
                "name": "Chris Engel",
                "email": "cjengel@us.ibm.com",
                "username": "cjengel"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1716911818,
            "reviewer": {
                "name": "Joseph Reynolds",
                "email": "joseph.reynolds1@ibm.com",
                "username": "joseph-reynolds"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1716922727,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 4.\n\nOutdated Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n"
        },
        {
            "timestamp": 1716922727,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(3 comments)"
        },
        {
            "timestamp": 1716926366,
            "reviewer": {
                "name": "Chris Engel",
                "email": "cjengel@us.ibm.com",
                "username": "cjengel"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1716929090,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 5: Patch Set 4 was rebased.\n\nCopied Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR **changekind:TRIVIAL_REBASE** OR is:MIN\")\n"
        },
        {
            "timestamp": 1716929399,
            "reviewer": {
                "name": "Joseph Reynolds",
                "email": "joseph.reynolds1@ibm.com",
                "username": "joseph-reynolds"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1716984503,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1716988691,
            "reviewer": {
                "name": "Joseph Reynolds",
                "email": "joseph.reynolds1@ibm.com",
                "username": "joseph-reynolds"
            },
            "message": "Patch Set 5: Code-Review+1"
        },
        {
            "timestamp": 1716989932,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1716990398,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 5: Code-Review+1"
        },
        {
            "timestamp": 1716994273,
            "reviewer": {
                "name": "Ratan Gupta",
                "email": "ratankgupta31@gmail.com",
                "username": "ratagupt"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1722438202,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1722438251,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Unset private"
        },
        {
            "timestamp": 1722438392,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1722438393,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1722438445,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/88947/ : SUCCESS"
        },
        {
            "timestamp": 1722438487,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "96a977055913d44ff0107585d9dc2497fe223b2d",
            "parents": [
                "e1630cab8c7def9c0f848e4badbff23991b1c142"
            ],
            "ref": "refs/changes/16/71616/1",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1716582602,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "slp_message_handler.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 34,
            "sizeDeletions": 4
        },
        {
            "number": 2,
            "revision": "da21f68f0db937671e6811b627f235552eabd1ff",
            "parents": [
                "5b975abb9f606980802813d5513483cdc737c110"
            ],
            "ref": "refs/changes/16/71616/2",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1716585089,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "slp_message_handler.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 34,
            "sizeDeletions": 4
        },
        {
            "number": 3,
            "revision": "4886c0482d240202b8c9ccac7c218af327efb9ea",
            "parents": [
                "5b975abb9f606980802813d5513483cdc737c110"
            ],
            "ref": "refs/changes/16/71616/3",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1716663583,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Chris Engel",
                        "email": "cjengel@us.ibm.com",
                        "username": "cjengel"
                    },
                    "message": "No additional comments"
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 391,
                    "reviewer": {
                        "name": "Ratan Gupta",
                        "email": "ratankgupta31@gmail.com",
                        "username": "ratagupt"
                    },
                    "message": "we don't need to put this here, Suggestion is to print the RC here.\nhttps://github.com/openbmc/slpd-lite/blob/99f391bafe6ecb91ea46515808431f185ceb0a32/main.cpp#L53"
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 391,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "I'm not sure why it matters? Lets keep it in here in case some other code ends up calling this function."
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 392,
                    "reviewer": {
                        "name": "Ratan Gupta",
                        "email": "ratankgupta31@gmail.com",
                        "username": "ratagupt"
                    },
                    "message": "Can we also put up the error response format here?\n```      0                   1                   2                   3\n      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n     |        Service Location header (function = SrvRply = 2)       |\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n     |        Error Code             |        URL Entry count        |\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n     |       <URL Entry 1>          ...       <URL Entry N>          \\\n     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+```"
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 392,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 396,
                    "reviewer": {
                        "name": "Ratan Gupta",
                        "email": "ratankgupta31@gmail.com",
                        "username": "ratagupt"
                    },
                    "message": "We can not just pass all 0, How the caller knows that this error is for which request."
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 396,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, it's a tough one. Do we try to at least send something back or nothing? It looks like openslp just doesn't return anything on invalid headers. Would you prefer that? I think the main rule should be that we don't try and use the invalid header from the caller, that has too many attack vectors and it would be a lot of code to try and mark which parts of the input header were \"valid\". How much time and effort to we spend on responding to an invalid packet from the caller?"
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 396,
                    "reviewer": {
                        "name": "Joseph Reynolds",
                        "email": "joseph.reynolds1@ibm.com",
                        "username": "joseph-reynolds"
                    },
                    "message": "It seems to me any user agent will want better error handling.\n\nRFC2608, Section 7 (\"Errors\"):\n> If the Error Code in a SLP reply message is nonzero, the rest of the\n> message MAY be truncated.  No data is necessarily transmitted or\n> should be expected after the header and the error code....\n\nThe problem we are discussing is because the Error Code comes after the header whose size itself may be the reason for the error.  The Header is complex and has variable size Extensions and variable size Language Tag.\n\nWhen the request header is in error, is a solution to reconstruct it?  The essential request header fields seem to be version, Function ID, XID, Language Tag, and of course the Length.  Can we very carefully copy these into a new reply?\n1. Allocate a reply message.\n2. Fill the reply with all zeroes.\n3. Copy specific portions of the request header into the reply: Version, Function ID (incremented to become the reply?), omit any extension offsets (so they are zero), XID.  In case the request was less than 14 bytes, only copy data that was provided.\n4. Copy the Language Tag & its Length (truncated to perhaps 32 bytes -- big enough to handle any 2&3 letter languages codes, including Klingon).  Truncation is in the spirit of the RFC.\n5. Then add the Error Code and set the Length.\n\nThis seems complex.  Does anyone foresee any complications which could lead to additional security vulnerabilities?"
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 396,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "ok, feels like there's a general desire to have a better response here. I can at least copy in the \"safe\" stuff but I think keeping language tag at 0 is best."
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 396,
                    "reviewer": {
                        "name": "Joseph Reynolds",
                        "email": "joseph.reynolds1@ibm.com",
                        "username": "joseph-reynolds"
                    },
                    "message": "A 0 (zero) length language tag (empty string) seems like an acceptable compromise.  With this approach:\n- The fixed-size portion of the request header has its essential fields (Version, XID, etc.).\n- The Language Tag always comes back as the empty string.\n- There is always space for the Error Code field.\n- The overall \"Length\" is fixed size.  (The message is \"truncated\" as allowed by the spec.)\n\n\nSlight correction to my previous comment.  The Extension Offset field within the Header is a fixed-size 3 byte field.  The spec says we should parse the Extension, but it looks like the slpd-lite code simply ignores this field and does not attempt to access or interpret the Extension.  This appears to violate the SLP spec, but might be okay for a \"lite\" implementation.  I would approve zeroing this out for the reply message."
                },
                {
                    "file": "slp_message_handler.cpp",
                    "line": 396,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Acknowledged"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "slp_message_handler.cpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 40,
            "sizeDeletions": 5
        },
        {
            "number": 4,
            "revision": "baacf8ee92e09f4f51ac09d3dfdaf0b0cd70cf5a",
            "parents": [
                "1c73a2e4aad5a0ec63629405db817d31c4d2191b"
            ],
            "ref": "refs/changes/16/71616/4",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1716922727,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 23,
                    "deletions": 0
                },
                {
                    "file": "slp_message_handler.cpp",
                    "type": "MODIFIED",
                    "insertions": 55,
                    "deletions": -5
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "test/slp_message_handler_test.cpp",
                    "type": "ADDED",
                    "insertions": 101,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 193,
            "sizeDeletions": 5
        },
        {
            "number": 5,
            "revision": "6f01edce2e38bea3d70e3be1e725aed730d39b7c",
            "parents": [
                "eebd0815512b9987c2e5c65e6bd78ab467c39c4a"
            ],
            "ref": "refs/changes/16/71616/5",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1716929090,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 23,
                    "deletions": 0
                },
                {
                    "file": "slp_message_handler.cpp",
                    "type": "MODIFIED",
                    "insertions": 55,
                    "deletions": -5
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "test/slp_message_handler_test.cpp",
                    "type": "ADDED",
                    "insertions": 101,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 193,
            "sizeDeletions": 5
        }
    ]
}