{
    "project": "openbmc/phosphor-sel-logger",
    "branch": "master",
    "id": "Ibd65a257eecda853759b75d28978fda5a0982b57",
    "number": 66309,
    "subject": "fix race condition on initial sel add burst",
    "owner": {
        "name": "Alexander",
        "email": "alexander.hansen@9elements.com",
        "username": "pointbazaar"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-sel-logger/+/66309",
    "hashtags": [],
    "createdOn": 1692975937,
    "lastUpdated": 1698941436,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1692975937,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1692975968,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1692975968,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1692975992,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/73528/ : FAILURE"
        },
        {
            "timestamp": 1692976102,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1692976138,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1692976138,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1692976187,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/73529/ : SUCCESS"
        },
        {
            "timestamp": 1693428988,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1693671323,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1693948256,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1693989261,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1694031242,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1694071336,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1694101512,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1694102185,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1695658839,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1695659239,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1695721450,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1698941436,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Abandoned\n\nresolved in another patch"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "a7e2b3ebc2ff80335e9180409796acbd3984a5a2",
            "parents": [
                "a70bfe0474981db2e480133f383d20b9a139bece"
            ],
            "ref": "refs/changes/09/66309/1",
            "uploader": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "createdOn": 1692975937,
            "author": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "src/sel_logger.cpp",
                    "type": "MODIFIED",
                    "insertions": 69,
                    "deletions": -5
                },
                {
                    "file": "README.md",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": 0
                },
                {
                    "file": "include/sel_logger.hpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 114,
            "sizeDeletions": 5
        },
        {
            "number": 2,
            "revision": "98c7793a6b1873a9f33683dde1a0dc4b6bc7aa0d",
            "parents": [
                "a70bfe0474981db2e480133f383d20b9a139bece"
            ],
            "ref": "refs/changes/09/66309/2",
            "uploader": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "createdOn": 1692976102,
            "author": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "It looks like this commit was already merged to solve this problem: https://github.com/openbmc/phosphor-sel-logger/commit/9f476e82f72e78d2be6cdeb95f7d5552c19d97a7.\n\nHave you tried enabling the `clears-sel` option and using the phosphor-sel-logger `clearSelLogFiles()` function to see if it solves the problem?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "the 'Solution' to the problem made it worse IMO because now there is even more configurations to keep track of. But you are right that there is a 'right' configuration where stuff works.\n\nComparing \ndbus-sdr/storagecommands.cpp:1167\nand\nsel_logger.cpp:119\n\nit is exactly the same code.\n\nLets have only one way of clearing the SEL that works and does not have to be configured every time in 2 separate projects.\n\nThere is no benefit to having this configurable, or did i miss it?\n\nMy suggestion would be to let ipmid clear the SEL since thats like the centerpiece of the IPMI implementation whereas sel-logger may not always be present.\n\nIf you agree then i would be willing to create the required patches."
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Vernon Mauery",
                        "email": "vernon.mauery@linux.intel.com",
                        "username": "vmauery"
                    },
                    "message": "If the problem is that the file doesn't exist, might it be a better idea to delete the older (rotated) files and only truncate the current file? I am not sure if that would work for rsyslogd (does it keep an open file handle? maybe we need to also send SIGHUP or something to rsyslogd.)"
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "interesting. https://www.rsyslog.com/doc/v8-stable/compatibility/v4compatibility.html\n\nso HUP should close the file and then it could be truncated. \nBut since rsyslogd can receive new journal entries matching the filter in the meantime, it might try to open the file again, right?\n\nI view /var/log/ipmi_sel as specific to rsyslogd and don't think it would be a good idea to have other programs writing to that file. Also the behavior of SIGHUP in rsyslogd could change anytime in the future.\n\nWhat is your opinion on unifying the SEL clear behavior?"
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "> (does it keep an open file handle? maybe we need to also send SIGHUP or something to rsyslogd.)\n\nYes, it keeps the file handle open. In IPMI after deleting the files, it reloads the rsyslog service to send it the HUP to restart the new file: https://github.com/openbmc/phosphor-host-ipmid/blob/master/dbus-sdr/storagecommands.cpp#L1172-L1177.\n\nIf I remember correctly, there is a configuration option in rsyslog to tell it to immediately create an empty file or wait until it gets a new log to create the file. We currently use the latter, but could change to immediately create a new file, if it would help."
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "But then in the case of not having SEL_LOGGER_CLEARS_SEL enabled, the record ID's would not be reset upon clearing the SEL right?"
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "That's true. Additional changes would still be required to handle the empty file.\n\nIf the SEL_LOGGER_CLEARS_SEL option works, could we change that to the default and deprecate and eventually remove the old method?  Or are there additional improvements needed?"
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "One implementation is enough and the possibility to configure something creates doubt in people that it will actually work. What ends up happening is that some configurations are not compiled -> code rot and then they don't work anymore. \n\nAnd reviewers need to constantly think through all the permutations of the compile time configuration of multiple projects when reviewing code.\n\nWe could maybe only keep the SEL_LOGGER_CLEARS_SEL variant, delete the other and if there is any problems with it, just patch it.\n\nIf there is agreement, i can create patch for sel-logger and ipmid."
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "I'm okay with this approach.  Vernon?"
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Vernon Mauery",
                        "email": "vernon.mauery@linux.intel.com",
                        "username": "vmauery"
                    },
                    "message": "I am all for making things simpler. I really don't like how there are ifdefs sprinkled everywhere to make special behavior for every vendor."
                },
                {
                    "file": "src/sel_logger.cpp",
                    "line": 134,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "Nice. The topic is underway at\nhttps://gerrit.openbmc.org/q/topic:sel-cleanup\n\nSince this is my first time creating a topic, there might be some mistakes.\n\nLooking forward to your feedback :)"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "src/sel_logger.cpp",
                    "type": "MODIFIED",
                    "insertions": 69,
                    "deletions": -5
                },
                {
                    "file": "README.md",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": 0
                },
                {
                    "file": "include/sel_logger.hpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 114,
            "sizeDeletions": 5
        }
    ]
}