{
    "project": "openbmc/dbus-sensors",
    "branch": "master",
    "id": "I71d9a4c43363d9f95c380c20726c5a26138b87ce",
    "number": 68189,
    "subject": "ADC: Check CPU Present as creating sensor",
    "owner": {
        "name": "Thu Nguyen",
        "email": "thu@os.amperecomputing.com",
        "username": "ThuBaNguyen"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/dbus-sensors/+/68189",
    "hashtags": [],
    "createdOn": 1702009001,
    "lastUpdated": 1702853330,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1702009001,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1702009026,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1702009026,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1702009273,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/76954/ : FAILURE"
        },
        {
            "timestamp": 1702009715,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1702009761,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1702009761,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1702010047,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/76955/ : SUCCESS"
        },
        {
            "timestamp": 1702253203,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1702262520,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1702262812,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1702279957,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1702418538,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1702426418,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1702621926,
            "reviewer": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "4539b913b5687bfc73c9748f84c3595682bf7d89",
            "parents": [
                "21b9c9e111ff7476286b410ea8cfd84bd94681ea"
            ],
            "ref": "refs/changes/89/68189/1",
            "uploader": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "createdOn": 1702009001,
            "author": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "src/ADCSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 83,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 118,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "421e5a87ef6906ae06691a727bef13ed0c407824",
            "parents": [
                "21b9c9e111ff7476286b410ea8cfd84bd94681ea"
            ],
            "ref": "refs/changes/89/68189/2",
            "uploader": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "createdOn": 1702009715,
            "author": {
                "name": "Thu Nguyen",
                "email": "thu@os.amperecomputing.com",
                "username": "ThuBaNguyen"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "This seems a bit vague to me. How does it get missed? Do we have a bus capture (pcap) that demonstrates the problem?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thu Nguyen",
                        "email": "thu@os.amperecomputing.com",
                        "username": "ThuBaNguyen"
                    },
                    "message": "I'm sure that ADC service missed the signal. I tried to add the debug message to CPU the `propertyChanged` and `InterfaceAdded` match functional, some time there is no debug message and in that case, the ADC sensors with `CPURequired` configuration are not created.\nI don't know the cause, just know how to fix that.\nThe issue is not always happens, In my stress BMC reboot testing, the failed rate is about 1%."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "Right, my concern is that we might have other software depending on the property of reliable signal delivery and it seems we're failing at that? Fixing adcsensor specifically doesn't address the class of error \ud83d\ude1e\n\nMaybe that's not your problem to resolve, but if you've got a method to reproduce the symptoms it would be great to have more information about how it manifests."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thu Nguyen",
                        "email": "thu@os.amperecomputing.com",
                        "username": "ThuBaNguyen"
                    },
                    "message": "Currently, ADC service have to be configured run before the service which creates the CPU Present D-Bus Interface. This requires adding `before` dependency to `xyz.openbmc_project.adcsensor.service` https://github.com/openbmc/dbus-sensors/blob/master/service_files/xyz.openbmc_project.adcsensor.service\nThis patch set will also remove that requirement.\n\nPlease note that in my stress testing, I already adds before dependence."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "I think the logic in the main function should be:\n1. setup interfaceAdded and propertyChanged match with handler\n2. get current cpuPresence status \nI see the current code is not doing #2. Once added, the startup race condition should be resolved."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "example: https://github.com/openbmc/dbus-sensors/blob/819eb3230820b0babf49b71586176f6cd414f8cf/src/PSUSensorMain.cpp#L1338"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 17,
                    "reviewer": {
                        "name": "Thu Nguyen",
                        "email": "thu@os.amperecomputing.com",
                        "username": "ThuBaNguyen"
                    },
                    "message": "The problem of #2 is if the CPUPresent is not available at the time we call `get current cpuPresence status` and for some reason the #1 is missed the `interfaceAdded` and `propertyChanged` signal (Actually it happened in my stress testing then we will never get the CPUPresent again. The logic of the current patch set just change #2. When the CPUPresent is include in the configuration and the CPU Present variable in ADC service is not updated then try to check the CPU Present."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "src/ADCSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 83,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 118,
            "sizeDeletions": 0
        }
    ]
}