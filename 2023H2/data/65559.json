{
    "project": "openbmc/openbmc",
    "branch": "master",
    "topic": "sbp1",
    "id": "I33b1e5f2cd1d8222613e6cc2e2d39446628c8f37",
    "number": 65559,
    "subject": "meta-ibm: sbp1: Set default FAN RPM",
    "owner": {
        "name": "Patrick Rudolph",
        "email": "patrick.rudolph@9elements.com",
        "username": "PatrickRudolph"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openbmc/+/65559",
    "hashtags": [],
    "createdOn": 1690787138,
    "lastUpdated": 1697501571,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1690787138,
            "reviewer": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1690787847,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1690787847,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1690795969,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/18849/"
        },
        {
            "timestamp": 1690796751,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/18849/ : FAILURE"
        },
        {
            "timestamp": 1690877450,
            "reviewer": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "message": "Uploaded patch set 2: Patch Set 1 was rebased.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1690878185,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1690878186,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1690918227,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/18894/"
        },
        {
            "timestamp": 1690919466,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/18894/ : FAILURE"
        },
        {
            "timestamp": 1692655538,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Uploaded patch set 3: Patch Set 2 was rebased.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1692655645,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1692655645,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1692655652,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/19296/"
        },
        {
            "timestamp": 1692656564,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/19296/ : SUCCESS"
        },
        {
            "timestamp": 1692656574,
            "reviewer": {
                "name": "Jenkins OpenBMC Google",
                "email": "haojenkinsg00gle@gmail.com",
                "username": "jenkins-openbmc-g00gle"
            },
            "message": "Patch Set 3:\n\nBuild Successful \n\nGoogle Internal CI : Google internal tests successfully started"
        },
        {
            "timestamp": 1692657866,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 3:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1693319209,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 3: Code-Review-1\n\n(2 comments)"
        },
        {
            "timestamp": 1693558199,
            "reviewer": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1693580392,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1693999451,
            "reviewer": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1694015546,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1695306742,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1695307005,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 3: -Code-Review\n\n(1 comment)"
        },
        {
            "timestamp": 1695307058,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1695742065,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1695771324,
            "reviewer": {
                "name": "Josh Lehan",
                "email": "krellan@google.com",
                "username": "Krellan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1697447409,
            "reviewer": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1697500374,
            "reviewer": {
                "name": "Josh Lehan",
                "email": "krellan@google.com",
                "username": "Krellan"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1697501571,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "7db62eb8acdaf76a1b0e30dfe23040e0238d0deb",
            "parents": [
                "a70b1f0e7e053a22e085a94dbe123bf42ce96d8f"
            ],
            "ref": "refs/changes/59/65559/1",
            "uploader": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "createdOn": 1690787138,
            "author": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/fan-reboot-control.service",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control_%.bbappend",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 56,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "abeada1a7d8a1108389a3c5e6fd4842fda96b0c9",
            "parents": [
                "943616a245490ae8e34fc579a9e791f5c4767dc2"
            ],
            "ref": "refs/changes/59/65559/2",
            "uploader": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "createdOn": 1690877450,
            "author": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/fan-reboot-control.service",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control_%.bbappend",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 56,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "2b9d3047e39d12651348d8a413695c7765fb16ef",
            "parents": [
                "6b903b70557fc708a5f5cbee9da2602bb42b072f"
            ],
            "ref": "refs/changes/59/65559/3",
            "uploader": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "createdOn": 1692655538,
            "author": {
                "name": "Patrick Rudolph",
                "email": "patrick.rudolph@9elements.com",
                "username": "PatrickRudolph"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "I am curious why this is being submitted to the broad OpenBMC community. This change seems like a local platform-specific change, that would only affect one vendor's platforms. Is it to be used as a reference or example?"
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/fan-reboot-control.service",
                    "line": 9,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "Does the sbp1 hardware not have a watchdog to automatically handle when fan service goes away?"
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/fan-reboot-control.service",
                    "line": 9,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "There is hw watchdog for sbp1"
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/fan-reboot-control.service",
                    "line": 9,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "Sorry, There is NO hw watchdog for sbp1"
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 2,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "No matter what the implementation of this ends up being, we shouldn\u2019t do wholesale replacements of service files.  You should be able to use service.d files to just extend the ExecStopPost aspect, right?"
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "Again, a hardware based watchdog would ramp up the fans in the case where pid-control has a bug/keeps crashing. This change seems to imply it does not have this watchdog."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Patrick Rudolph",
                        "email": "patrick.rudolph@9elements.com",
                        "username": "PatrickRudolph"
                    },
                    "message": "The max6639 PWM controllers have a temperature sensor and could ramp up the fan speed on critical threshold, but as far as I know those measure the inlet temperature right after the ruler drives. If they would measure the outlet temperature they could be used as watchdog.\nNeed clarification from IBM where the temperature sensors are located."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Why isn't this part of the previous service file?  It doesn't make much sense to span multiple services with the same content.  Makes it hard to traverse what is going on as a future developer."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Patrick Rudolph",
                        "email": "patrick.rudolph@9elements.com",
                        "username": "PatrickRudolph"
                    },
                    "message": "Clarified with IBM: The MAX6639 PWM controllers have no watchdog and are not meant to set fans to full speed when the attached temperature sensors gets hot."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "The previous service is only runs when the BMC is rebooted, where-as this service is the main fan controller started with the BMC. So if someone where to stop this service (or it were to fail), we'd be stuck with the fans in their last state until someone rebooted the BMC (without this change here).\nThis is following the design that meta-quanta/meta-olympus-nuvoton/ did in this area.\nLets see if the pid-control maintainer has any thoughts on this. It does seem like a useful feature to have the fans go high when the service fails or the BMC reboots. I'm curious if there's been any focus on getting that feature directly into pid-control."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "The IBM team seemed ok with not having the fans ramp. The hardware is designed to protect itself so unless we hear differently my preference would be to keep the fan-reboot-control.service in this commit and remove the override of the existing service in this file."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "Discussion in Discord: https://discord.com/channels/775381525260664832/775381525260664836/1153702896853078147\nJosh pointed out an existing issue which he added summary of the various cases and where they could be handled:\nhttps://github.com/openbmc/phosphor-pid-control/issues/34"
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Sounds like the phosphor-pid-control maintainer is open to putting some changes in the phosphor-pid-control.service to do what's being done here. Set the fans to a default when this service is stopped. That should handle the BMC reboot path as well because the service will be stopped as a part of the reboot.\n\nThe device tree aspect, setting fans to high when the kernel first comes up, seems like a much larger change outside of this commit."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "I agree. That would be a nice feature: https://github.com/openbmc/phosphor-pid-control/issues/34\n\nAs for setting the fans to a known speed when the service is cleanly stopped, that is nice, but there's also the (hopefully rare) situation of the service crashing. Ideally, the fans would be set to a known speed when the service is restarted after a crash, after a short delay for systemd to restart it, so that would cover this situation as well."
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "line": 10,
                    "reviewer": {
                        "name": "Patrick Rudolph",
                        "email": "patrick.rudolph@9elements.com",
                        "username": "PatrickRudolph"
                    },
                    "message": "Implemented the feature here:\nhttps://gerrit.openbmc.org/c/openbmc/phosphor-pid-control/+/67091/2\nhttps://gerrit.openbmc.org/c/openbmc/phosphor-pid-control/+/67090/2\n\nIt partly resolves issue#34. FailSafe PWM isn't set yet *before* the configuration has been processed.\n\nIt has the same effect as\n\"ExecStopPost=/bin/bash -c 'for i in /sys/class/hwmon/*/pwm1; do echo 92 > $i;\" when FailSafePercent is set to 34."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/fan-reboot-control.service",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control/phosphor-pid-control.service",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meta-ibm/meta-sbp1/recipes-phosphor/fans/phosphor-pid-control_%.bbappend",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 56,
            "sizeDeletions": 0
        }
    ]
}