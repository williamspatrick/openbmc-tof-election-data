{
    "project": "openbmc/openbmc",
    "branch": "master",
    "id": "I802f9d777537ff28f94945006b6582b15523e3a8",
    "number": 66895,
    "subject": "meta-ampere: mtmitchell: use standard gpio commands",
    "owner": {
        "name": "Thang Q. Nguyen",
        "email": "thang@os.amperecomputing.com",
        "username": "thangqn-ampere"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openbmc/+/66895",
    "hashtags": [],
    "createdOn": 1696474717,
    "lastUpdated": 1697272869,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1696474717,
            "reviewer": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1696474759,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1696474759,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1696474765,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/19927/"
        },
        {
            "timestamp": 1696475758,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/19927/ : SUCCESS"
        },
        {
            "timestamp": 1696475769,
            "reviewer": {
                "name": "Jenkins OpenBMC Google",
                "email": "haojenkinsg00gle@gmail.com",
                "username": "jenkins-openbmc-g00gle"
            },
            "message": "Patch Set 1:\n\nBuild Successful \n\nGoogle Internal CI : Google internal tests successfully started"
        },
        {
            "timestamp": 1696477065,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 1:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1696482537,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1696483073,
            "reviewer": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1696484797,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1696490671,
            "reviewer": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1696551846,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1696989946,
            "reviewer": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1696989983,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1696989983,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1696989989,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/20019/"
        },
        {
            "timestamp": 1696991659,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/20019/ : SUCCESS"
        },
        {
            "timestamp": 1696991669,
            "reviewer": {
                "name": "Jenkins OpenBMC Google",
                "email": "haojenkinsg00gle@gmail.com",
                "username": "jenkins-openbmc-g00gle"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nGoogle Internal CI : Google internal tests successfully started"
        },
        {
            "timestamp": 1696992975,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1697272863,
            "reviewer": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "message": "Patch Set 2: Code-Review+2"
        },
        {
            "timestamp": 1697272869,
            "reviewer": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "message": "Change has been successfully rebased and submitted as d9c8965dbc394b46ab2440ef423a5e8c2872f6ed"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "9167ed891877a2651117f123e49e279a6dacfa86",
            "parents": [
                "020979994f5e040941201ce369e3c7b9148c11cd"
            ],
            "ref": "refs/changes/95/66895/1",
            "uploader": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "createdOn": 1696474717,
            "author": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "line": 22,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "Just for the record, you are depending on behaviour that is not specified by gpioset:\n\n> Note: the state of a GPIO line controlled over the character device reverts to default\n> when the last process referencing the file descriptor representing the device file exits.\n> This means that it's wrong to run gpioset, have it exit and expect the line to continue\n> being driven high or low. It may happen if given pin is floating but it must be interpreted\n> as undefined behavior.\n\nhttps://git.kernel.org/pub/scm/libs/libgpiod/libgpiod.git/tree/tools/gpioset.c#n79"
                },
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "line": 22,
                    "reviewer": {
                        "name": "Thang Q. Nguyen",
                        "email": "thang@os.amperecomputing.com",
                        "username": "thangqn-ampere"
                    },
                    "message": "Thanks for your information.\nFrom my test, after setting the GPIO high via gpioset, check via /sys/class/gpio I can see the value remain. In what case do we have the value changed to default?\nAny suggestion to set GPIO using standard commands if not using gpioset?"
                },
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "line": 22,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "Right, what's going on is that the _current implementation_ of the Aspeed GPIO driver preserves the line state when you release the GPIO. The point I was trying to make above is it _doesn't have to_, and is within its rights to change that behaviour at any point in the future, by the words of the quote above. For instance, if we started caring about power management, we might want to set GPIOs being released to high-impedance. Further, other GPIO drivers may behave differently. The only thing that can be relied upon is that the line state beyond releasing the line (which occurs when the `gpioset` process terminates) is undefined.\n\nAnyway, it's kind of splitting hairs at this point. I just wanted to make sure you were aware of the trap that may appear in the future."
                },
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "line": 22,
                    "reviewer": {
                        "name": "Thang Q. Nguyen",
                        "email": "thang@os.amperecomputing.com",
                        "username": "thangqn-ampere"
                    },
                    "message": "I read https://www.thegoodpenguin.co.uk/blog/stop-using-sys-class-gpio-its-deprecated/ but I missed the note and subsequent sentence (Whilst we haven\u2019t observed this in practice (or verified it\u2019s true), the above note implies that the state of a GPIO line is undefined after you close your handle.).\nI will keep this for a while to see if any bad effect."
                },
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "line": 22,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "> Whilst we haven\u2019t observed this in practice \n\nRight, that's because of an implementation detail in the Aspeed GPIO driver when I upstreamed it. The GPIO chardev interface was in the process of being introduced at the time, and the clash in behaviour got overlooked.\n\n> or verified it\u2019s true\n\nThe text is written by the maintainers of libgpiod and the kernel GPIO subsystem, so I think that's fairly authoritative \ud83d\ude0a\n\nAnyway, you're probably fine to carry on with this script as it is now, but we will have to remember its existence in the future if we change the behaviour of the Aspeed GPIO driver."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -12
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-utils/ampere_power_util.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/ampere_platform_init.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -8
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/ampere_bmc_heartbeat.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/mtmitchell_platform_gpios_init.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-fault-monitor/ampere_fault_monitor.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -9
                }
            ],
            "sizeInsertions": 52,
            "sizeDeletions": 47
        },
        {
            "number": 2,
            "revision": "504c6331f7731316658bc494f37f80a4852bc16b",
            "parents": [
                "312d61307afdc47acbe9087534c69e55c7054fac"
            ],
            "ref": "refs/changes/95/66895/2",
            "uploader": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "createdOn": 1696989946,
            "author": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -12
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-utils/ampere_power_util.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/ampere_platform_init.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -8
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/ampere_bmc_heartbeat.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/mtmitchell_platform_gpios_init.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/gpio-lib.sh",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -2
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-fault-monitor/ampere_fault_monitor.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -9
                },
                {
                    "file": "meta-ampere/meta-jade/recipes-ampere/platform/ampere-utils/gpio-defs.sh",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 57,
            "sizeDeletions": 51
        },
        {
            "number": 3,
            "revision": "d9c8965dbc394b46ab2440ef423a5e8c2872f6ed",
            "parents": [
                "2013739591dc50e6d01836d0017e7e5a02225709"
            ],
            "ref": "refs/changes/95/66895/3",
            "uploader": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "createdOn": 1697272869,
            "author": {
                "name": "Thang Q. Nguyen",
                "email": "thang@os.amperecomputing.com",
                "username": "thangqn-ampere"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "meta-ampere/meta-common/recipes-ampere/platform/ampere-utils/ampere_spi_util.sh",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -12
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-utils/ampere_power_util.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/ampere_platform_init.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -8
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/ampere_bmc_heartbeat.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/mtmitchell_platform_gpios_init.sh",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": -6
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-platform-init/gpio-lib.sh",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -2
                },
                {
                    "file": "meta-ampere/meta-mitchell/recipes-ampere/platform/ampere-fault-monitor/ampere_fault_monitor.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -9
                },
                {
                    "file": "meta-ampere/meta-jade/recipes-ampere/platform/ampere-utils/gpio-defs.sh",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 57,
            "sizeDeletions": 51
        }
    ]
}