{
    "project": "openbmc/dbus-sensors",
    "branch": "master",
    "id": "I789838a31575b80d839bdb9812d23ad0d71505a9",
    "number": 67556,
    "subject": "Add debounce timer to intrusion sensor rescan",
    "owner": {
        "name": "Ian Woloschin",
        "email": "ian.woloschin@akamai.com",
        "username": "iwoloschin"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/dbus-sensors/+/67556",
    "hashtags": [],
    "createdOn": 1699282299,
    "lastUpdated": 1704321649,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1699282299,
            "reviewer": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1699282330,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1699282330,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1699282616,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/75827/ : SUCCESS"
        },
        {
            "timestamp": 1699296785,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1699297650,
            "reviewer": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1699299445,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1699299872,
            "reviewer": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1699310434,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1699315156,
            "reviewer": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1699323290,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1699356307,
            "reviewer": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "message": "Uploaded patch set 2: Commit message was updated.\n\nCopied Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1699356329,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1699356334,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1699356623,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/75915/ : SUCCESS"
        },
        {
            "timestamp": 1699488824,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1699516935,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1699516949,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1704314814,
            "reviewer": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1704321320,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 3: Commit message was updated.\n\nCopied Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR **changekind:NO_CODE_CHANGE** OR changekind:TRIVIAL_REBASE OR is:MIN\")\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR **changekind:NO_CODE_CHANGE**\")\n"
        },
        {
            "timestamp": 1704321327,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1704321335,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "message": "Change has been successfully rebased and submitted as 0df80a1defa16686bc9ac3f61c2cd87b6ab60219"
        },
        {
            "timestamp": 1704321379,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1704321649,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/77529/ : SUCCESS"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "ba1d609db98df6326b7685337733b05c56b81bf4",
            "parents": [
                "3ae1cb0979a3e76a2e1a95a36ea6dd919225c3e3"
            ],
            "ref": "refs/changes/56/67556/1",
            "uploader": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "createdOn": 1699282299,
            "author": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "I'd be curious to hear more on that...is there a bug we should be fixing there instead?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Ian Woloschin",
                        "email": "ian.woloschin@akamai.com",
                        "username": "iwoloschin"
                    },
                    "message": "Maybe? Is libgpiod even thread (context?) safe?\n\nI didn't look into it too much once I realized the issue was only occurring at system boot when there were a number of configuration changes each triggering a callback. I stole the timer idea here from Entity Manager, but then realized a lot of other dbus-sensor daemons have them as well. I think reducing the amount of work done for a quick succession of configuration changes is always going to be correct."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Hmm -- while I'm not deeply familiar with libgpiod and its internals, my rough understanding is that it's a fairly thin wrapper that just issues ioctl syscalls and doesn't have much in the way of internal state to maintain, so it's not the first thing I'd suspect of harboring race conditions.\n\nPerhaps relatedly, could you expand on the nature of the failures you've seen?  (I'm not sure exactly how to interpret \"sensors were failing\" absent some more detail.)"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Ian Woloschin",
                        "email": "ian.woloschin@akamai.com",
                        "username": "iwoloschin"
                    },
                    "message": "Yup, on a fresh BMC boot we were no longer finding a GPIO Sensor being enumerated:\n\n~# busctl tree xyz.openbmc_project.IntrusionSensor\n\u2514\u2500 /xyz\n  \u2514\u2500 /xyz/openbmc_project\n    \u2514\u2500 /xyz/openbmc_project/Chassis\n    \nLooking at gpioinfo I wouldn't even see anything bound to the CHASSIS_INTRUSION GPIO pin. Manually restarting the intrusion sensor daemon would result in the intrusion sensor being found no problem. This was because the createSensorsFromConfig is run once, without any competing callbacks from configuration changes.\n\nReducing the number of callbacks to one at a time appears to resolve the problem."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "How does that get us to a race in libgpiod though? Could this not be a concurrency issue with manipulating some other data structure internal to the intrusion sensor?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Ian Woloschin",
                        "email": "ian.woloschin@akamai.com",
                        "username": "iwoloschin"
                    },
                    "message": "I have to admit I'm not really sure, I may have jumped too quickly to a conclusion there. Something appears to be racing in the callback and this patch appears to fix that, though it might be more of a sweeping under the rug than fixing.\n\nStill, I think that having something like this is likely the correct approach, especially given that other sensor daemons take similar approaches."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@codeconstruct.com.au",
                        "username": "amboar"
                    },
                    "message": "Perhaps then it's worth dropping the argument about races in libgpiod and using the consistency argument instead?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Ian Woloschin",
                        "email": "ian.woloschin@akamai.com",
                        "username": "iwoloschin"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "src/IntrusionSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 29,
            "sizeDeletions": 3
        },
        {
            "number": 2,
            "revision": "77c1c4dec0625ae6ca66996f00b2366befdd61fb",
            "parents": [
                "3ae1cb0979a3e76a2e1a95a36ea6dd919225c3e3"
            ],
            "ref": "refs/changes/56/67556/2",
            "uploader": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "createdOn": 1699356307,
            "author": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "Code change looks OK, consistent with other daemons"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Chau Ly",
                        "email": "chaul@amperecomputing.com",
                        "username": "chaul-ampere"
                    },
                    "message": "Tested on Ampere's Mitchell platform."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ian Woloschin",
                        "email": "ian.woloschin@akamai.com",
                        "username": "iwoloschin"
                    },
                    "message": "I realized this is still hanging around. The commit message has been updated to resolve the comment thread."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "src/IntrusionSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 28,
            "sizeDeletions": 3
        },
        {
            "number": 3,
            "revision": "a0e6a9ecdf76e47828683ca5ecde324cdc281cd6",
            "parents": [
                "3ae1cb0979a3e76a2e1a95a36ea6dd919225c3e3"
            ],
            "ref": "refs/changes/56/67556/3",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "createdOn": 1704321320,
            "author": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "src/IntrusionSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 29,
            "sizeDeletions": 3
        },
        {
            "number": 4,
            "revision": "0df80a1defa16686bc9ac3f61c2cd87b6ab60219",
            "parents": [
                "15a39dfd553a3f454cedf4a2231e662b1ee46ecf"
            ],
            "ref": "refs/changes/56/67556/4",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@codeconstruct.com.au",
                "username": "amboar"
            },
            "createdOn": 1704321335,
            "author": {
                "name": "Ian Woloschin",
                "email": "ian.woloschin@akamai.com",
                "username": "iwoloschin"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "src/IntrusionSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 29,
            "sizeDeletions": 3
        }
    ]
}