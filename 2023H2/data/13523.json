{
    "project": "openbmc/meta-phosphor",
    "branch": "master",
    "topic": "certificates",
    "id": "I5663ab85e9da20141e9e2d318f93f2c68c41e38b",
    "number": 13523,
    "subject": "Exclude certificate file during systemd-tmpfiles cleanup",
    "owner": {
        "name": "Jayanth Othayoth",
        "email": "ojayanth@gmail.com",
        "username": "ojayanth"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/meta-phosphor/+/13523",
    "hashtags": [],
    "createdOn": 1538572889,
    "lastUpdated": 1697526180,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1538572889,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1538572903,
            "reviewer": {
                "name": "Jenkins",
                "email": "openbmc-ci-admin@ozlabs.org",
                "username": "jenkins-openbmc"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1538573013,
            "reviewer": {
                "name": "Jenkins",
                "email": "openbmc-ci-admin@ozlabs.org",
                "username": "jenkins-openbmc"
            },
            "message": "Patch Set 1:\n\nBuild Started https://openpower.xyz/job/openbmc-build-gerrit-trigger-meta/733/"
        },
        {
            "timestamp": 1538573075,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1538573091,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 1:\n\nhttps://gerrit.openbmc-project.xyz/#/c/openbmc/openbmc/+/13458/ tracks the initial review comments."
        },
        {
            "timestamp": 1538573221,
            "reviewer": {
                "name": "Deepak Kodihalli",
                "email": "deepak.kodihalli.83@gmail.com",
                "username": "dkodihal"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1538573773,
            "reviewer": {
                "name": "Jenkins",
                "email": "openbmc-ci-admin@ozlabs.org",
                "username": "jenkins-openbmc"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://openpower.xyz/job/openbmc-build-gerrit-trigger-meta/733/ : SUCCESS"
        },
        {
            "timestamp": 1538573785,
            "reviewer": {
                "name": "Jenkins",
                "email": "openbmc-ci-admin@ozlabs.org",
                "username": "jenkins-openbmc"
            },
            "message": "Patch Set 1:\n\nBuild Started \n\nReal hardware build started"
        },
        {
            "timestamp": 1538574844,
            "reviewer": {
                "name": "Jenkins",
                "email": "openbmc-ci-admin@ozlabs.org",
                "username": "jenkins-openbmc"
            },
            "message": "Patch Set 1:\n\nReal Hardware Build Successful"
        },
        {
            "timestamp": 1538617798,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Topic set to certificate"
        },
        {
            "timestamp": 1538617805,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Topic changed from certificate to certificates"
        },
        {
            "timestamp": 1538687361,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1: Code-Review-1\n\n(1 comment)\n\nI really don't like this approach, as we're abusing the definition of what /tmp is intended for."
        },
        {
            "timestamp": 1538705981,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1538728613,
            "reviewer": {
                "name": "Deepak Kodihalli",
                "email": "deepak.kodihalli.83@gmail.com",
                "username": "dkodihal"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1540320207,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n> (1 comment)\n\nTaking a step back for a second, I really don't understand what problem we're solving with this patchset.  Is there a bug that could be pointed to that has more detail.\n\nOne thing that could help is making the Tested By: field into a user facing operation.  A user of the system can't do the steps listed in the Tested By, so what exactly are we solving here?\n\nI suspect once this patchset has more detail on what we're solving (from the perspective of a user) I suspect that this patchset will make more sense."
        },
        {
            "timestamp": 1540320346,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1540322265,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1540322272,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 1: Code-Review-1"
        },
        {
            "timestamp": 1540389761,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1540389774,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 1: Code-Review-1"
        },
        {
            "timestamp": 1540390177,
            "reviewer": {
                "name": "Deepak Kodihalli",
                "email": "deepak.kodihalli.83@gmail.com",
                "username": "dkodihal"
            },
            "message": "Patch Set 1:\n\nThe certificate files were definitely being deleted, and we saw this on multiple systems. I don't know if it's a bug with tmpfiles itself."
        },
        {
            "timestamp": 1543026226,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n> The certificate files were definitely being deleted, and we saw\n > this on multiple systems. I don't know if it's a bug with tmpfiles\n > itself.\n\nIs this patchset still needed?"
        },
        {
            "timestamp": 1548768495,
            "reviewer": {
                "name": "MARRI DEVENDER RAO",
                "email": "devenrao@in.ibm.com",
                "username": "devenrao"
            },
            "message": "Removed reviewer MARRI DEVENDER RAO with the following votes:\n\n* Code-Review+1 by MARRI DEVENDER RAO <devenrao@in.ibm.com>\n"
        },
        {
            "timestamp": 1564781726,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Removed Code-Review-1 by Ed Tanous <ed.tanous@intel.com>\n"
        },
        {
            "timestamp": 1564781729,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Removed reviewer Ed Tanous."
        },
        {
            "timestamp": 1697526180,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Abandoned\n\nNo activity for long time"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "6b6551288094ba6ecd1c1dc5e5a14a195b4f8bbd",
            "parents": [
                "8f1d06b18710ccfb10b1a423991e9c617af6b6c6"
            ],
            "ref": "refs/changes/23/13523/1",
            "uploader": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "createdOn": 1538572889,
            "author": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@in.ibm.com",
                "username": ""
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 14,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "why not?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 21,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This isn't really valid as a Tested By given the context that we're fixing some errant behavior.  Users don't explicitly trigger systemd-tmpfiles-clean, nor do they verify that config files exist.  I think making this statement into something that a user could actually execute and verify would make it more clear what issue this patchset is resolving.\n\nIf there are timelines in it, some steps could be to move the BMC clock forward in time to trigger the garbage collection that causes the errant behavior, but as written, it's still really not clear what this is solving."
                },
                {
                    "file": "recipes-phosphor/certificate/phosphor-certificate-manager_git.bb",
                    "line": 33,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This is not what /tmp should be used for.  If the file needs to persist over a reboot (or first boot in this case) it needs to be put in a location intended for that.  Maybe /etc/certs/default?\n\nThe other thing to consider when putting certs in this way, is what happens when you need to change a default certificate?  this approach doesn't allow for replacement of defaults (which will be necessary as systems age and certificates expire)"
                },
                {
                    "file": "recipes-phosphor/certificate/phosphor-certificate-manager_git.bb",
                    "line": 33,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "systemd-tmpfiles already have rule to cleanup file is /tmp for every 10 days. This feature used to block the temporary certificate file during this window. Here temporary certificate files mean , during REST certificate upload process reset server saves the input file in to /tmp/cert_xxx_.pem and calls the d-bus interface to activate this certificate. phosphor-certificate-manager validates this certificate and copies this permanent location based on end point and REST server deletes this file from /tmp. this window is very small . But still need to consider this race condition during the /tmp cleanup. Currently certificate manager updates only valid certificates to nginx or LDAP. Also not maintaining any default certificate now. nginx.service and nslcd service alreay have capability to create self signed certificate during service restart incase no certificate is present the specified path."
                },
                {
                    "file": "recipes-phosphor/certificate/phosphor-certificate-manager_git.bb",
                    "line": 33,
                    "reviewer": {
                        "name": "Deepak Kodihalli",
                        "email": "deepak.kodihalli.83@gmail.com",
                        "username": "dkodihal"
                    },
                    "message": "The certificates in /tmp are only used for the duration of a d-bus call that copies the certificate file from /tmp to a well-known persistent location.\n\nDefault (generated self-signed certs) can be replaced via the certificate upload API."
                },
                {
                    "file": "recipes-phosphor/certificate/phosphor-certificate-manager_git.bb",
                    "line": 33,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "> /tmp are only used for the duration of a d-bus call \n\nthen why is this needed?  presumably that duration is short?  systemd won't delete the file unless it old...ish."
                },
                {
                    "file": "recipes-phosphor/certificate/phosphor-certificate-manager_git.bb",
                    "line": 33,
                    "reviewer": {
                        "name": "Jayanth Othayoth",
                        "email": "ojayanth@gmail.com",
                        "username": "ojayanth"
                    },
                    "message": "Good point Brad. My assumption is totally wrong for the \"age\" parameter.  am going to abandon this patch.\nI also confirmed tmpfiles rules, says , age is 10d.\n@deepak, we need to relook the problem reported in your system related missing certificate file during upload."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "recipes-phosphor/certificate/phosphor-certificate-manager/certs.conf",
                    "type": "ADDED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "recipes-phosphor/certificate/phosphor-certificate-manager_git.bb",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 42,
            "sizeDeletions": 0
        }
    ]
}