{
    "project": "openbmc/phosphor-fan-presence",
    "branch": "master",
    "id": "Ie616a9631a129401a3cdc000612a8e694d02ef7a",
    "number": 66608,
    "subject": "Small change to power state initial sequence",
    "owner": {
        "name": "Chau Ly",
        "email": "chaul@amperecomputing.com",
        "username": "chaul-ampere"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-fan-presence/+/66608",
    "hashtags": [],
    "createdOn": 1694690451,
    "lastUpdated": 1695176361,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1694690451,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1694690505,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1694690505,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1694690648,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1694690689,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1694690689,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1694690691,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/74137/ : ABORTED"
        },
        {
            "timestamp": 1694690787,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/74138/ : SUCCESS"
        },
        {
            "timestamp": 1694729866,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1694751870,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1694786887,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1695021436,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1695021477,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1695021477,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1695021581,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/74185/ : SUCCESS"
        },
        {
            "timestamp": 1695021588,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1695052330,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1695094913,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Uploaded patch set 4: Commit message was updated.\n\nCopied Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1695094961,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1695094961,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1695095065,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4:\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/74227/ : SUCCESS"
        },
        {
            "timestamp": 1695136532,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4: Code-Review+2"
        },
        {
            "timestamp": 1695176339,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1695176361,
            "reviewer": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "ae0ede182e6b66754057f15aee80f7d18c01f665",
            "parents": [
                "2e22b235adc9335716d4f31f209b8f5c787cb8ec"
            ],
            "ref": "refs/changes/08/66608/1",
            "uploader": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "createdOn": 1694690451,
            "author": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 26,
                    "deletions": 0
                },
                {
                    "file": "monitor/system.cpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "monitor/system.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -5
                },
                {
                    "file": "power_state.hpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 56,
            "sizeDeletions": 10
        },
        {
            "number": 2,
            "revision": "ad081d487acd3d81db5685070ac4ecc1fc9829a6",
            "parents": [
                "2e22b235adc9335716d4f31f209b8f5c787cb8ec"
            ],
            "ref": "refs/changes/08/66608/2",
            "uploader": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "createdOn": 1694690648,
            "author": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "monitor/system.cpp",
                    "line": 126,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "The only thing I can see here is in this function there is:\n\n        std::for_each(_powerOffRules.begin(), _powerOffRules.end(),\n                      [this](auto& rule) {\n            rule->check(PowerRuleState::atPgood, _fanHealth);\n        });\n        std::for_each(_powerOffRules.begin(), _powerOffRules.end(),\n                      [this](auto& rule) {\n            rule->check(PowerRuleState::runtime, _fanHealth);\n        });\n        \nand we have rules defined that use atPgood that are just supposed to run when power turns on, so I need to think some if it's OK if they also run after a BMC reboot when system is already up."
                },
                {
                    "file": "monitor/system.cpp",
                    "line": 126,
                    "reviewer": {
                        "name": "Chau Ly",
                        "email": "chaul@amperecomputing.com",
                        "username": "chaul-ampere"
                    },
                    "message": "Agree. How about the below part? Do you think the part should be called in the mentioned case to check if fan object paths are on Dbus? When BMC boots with host ON and no fan sensor is found, host should be turned off? (sorry for the urgly format).\n        \n        // If no fan has its sensors on D-Bus, then there is a problem\n        // with the fan controller.  Log an error and shut down.\n        if (std::all_of(_fans.begin(), _fans.end(), [](const auto& fan) {\n                return fan->numSensorsOnDBusAtPowerOn() == 0;\n            }))\n        {\n>    \n      #if DELAY_HOST_CONTROL > 0\n            sleep(DELAY_HOST_CONTROL);\n            std::for_each(_fans.begin(), _fans.end(),\n                          [powerStateOn](auto& fan) {\n                fan->powerStateChanged(powerStateOn);\n            });\n            if (std::all_of(_fans.begin(), _fans.end(), [](const auto& fan) {\n                    return fan->numSensorsOnDBusAtPowerOn() == 0;\n                }))\n            {\n                handleOfflineFanController();\n                return;\n            }\n>   \n     #else\n            handleOfflineFanController();\n            return;\n>   \n     #endif\n        }"
                },
                {
                    "file": "monitor/system.cpp",
                    "line": 126,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "In our case, we wouldn't want to power off a system that was already up and running fine before the reboot, however unlikely that is.\n\nThe change to power_state.hpp looks fine though, if you wanted to separate that one out into a different commit it could go in now."
                },
                {
                    "file": "monitor/system.cpp",
                    "line": 126,
                    "reviewer": {
                        "name": "Chau Ly",
                        "email": "chaul@amperecomputing.com",
                        "username": "chaul-ampere"
                    },
                    "message": "Agree also. I changed this patch to only modifying power_state.hpp."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 26,
                    "deletions": 0
                },
                {
                    "file": "monitor/system.cpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "power_state.hpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 45,
            "sizeDeletions": 4
        },
        {
            "number": 3,
            "revision": "a9ad03e672238be1e1521b88a388958ad8958a18",
            "parents": [
                "2e22b235adc9335716d4f31f209b8f5c787cb8ec"
            ],
            "ref": "refs/changes/08/66608/3",
            "uploader": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "createdOn": 1695021436,
            "author": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Can remove this now."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Chau Ly",
                        "email": "chaul@amperecomputing.com",
                        "username": "chaul-ampere"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "power_state.hpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 41,
            "sizeDeletions": 4
        },
        {
            "number": 4,
            "revision": "0cff4ea6fb82144258e0d825ba44e0a04cee7eb8",
            "parents": [
                "2e22b235adc9335716d4f31f209b8f5c787cb8ec"
            ],
            "ref": "refs/changes/08/66608/4",
            "uploader": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "createdOn": 1695094913,
            "author": {
                "name": "Chau Ly",
                "email": "chaul@amperecomputing.com",
                "username": "chaul-ampere"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "power_state.hpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -4
                }
            ],
            "sizeInsertions": 38,
            "sizeDeletions": 4
        }
    ]
}