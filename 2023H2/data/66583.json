{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "If3c142e63f053b60eea4efddbb3cc7240cd397b6",
    "number": 66583,
    "subject": "MR to review the proposal for URI based threading model to handle aggregate URIs",
    "owner": {
        "name": "rohitpai",
        "email": "rohitpai77@gmail.com",
        "username": "rohitpai"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/66583",
    "hashtags": [],
    "createdOn": 1694581987,
    "lastUpdated": 1694629620,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1694581987,
            "reviewer": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1694582101,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nUser not approved, see admin, no CI"
        },
        {
            "timestamp": 1694583675,
            "reviewer": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "message": "Uploaded patch set 2: New patch set was added with same tree, parent tree, and commit message as Patch Set 1."
        },
        {
            "timestamp": 1694583780,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nUser not approved, see admin, no CI"
        },
        {
            "timestamp": 1694583863,
            "reviewer": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1694583952,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nUser not approved, see admin, no CI"
        },
        {
            "timestamp": 1694612944,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1694626852,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1694629439,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1694629456,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1694629620,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "9ed09bdbdf8809a36f698ccc0e90da5ef80b82e1",
            "parents": [
                "e1bf8bb6a843a2a53d74d74f410b5fe053c2d222"
            ],
            "ref": "refs/changes/83/66583/1",
            "uploader": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "createdOn": 1694581987,
            "author": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "src/webserver_main.cpp",
                    "type": "MODIFIED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/dbus_singleton.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/dbus_singleton.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 43,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "2de0c105b53d4b2459a64146f85af6468c10d52d",
            "parents": [
                "e1bf8bb6a843a2a53d74d74f410b5fe053c2d222"
            ],
            "ref": "refs/changes/83/66583/2",
            "uploader": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "createdOn": 1694583675,
            "author": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "kind": "NO_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "src/webserver_main.cpp",
                    "type": "MODIFIED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/dbus_singleton.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/dbus_singleton.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 43,
            "sizeDeletions": 1
        },
        {
            "number": 3,
            "revision": "eef3d5fe5a536db6d318c5cd0b5f7ee52f7fccad",
            "parents": [
                "e1bf8bb6a843a2a53d74d74f410b5fe053c2d222"
            ],
            "ref": "refs/changes/83/66583/3",
            "uploader": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "createdOn": 1694583863,
            "author": {
                "name": "rohitpai",
                "email": "rohitpai77@gmail.com",
                "username": "rohitpai"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 7,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Please mark as WIP."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 8,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Please follow https://cbea.ms/git-commit/ \n\n    Separate subject from body with a blank line\n    Limit the subject line to 50 characters\n    Capitalize the subject line\n    Do not end the subject line with a period\n    Use the imperative mood in the subject line\n    Wrap the body at 72 characters\n    Use the body to explain what and why vs. how\n\nThanks!"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Please explain more in the commit message body. Why does bmcweb need this change? What does it do? How was it tested?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "A few things:\n\nPlease get added to your companies CLA so CI will run.  There are build failures in your code that leads me to believe you didn't run it through CI checks before pushing.  This wastes reviewers time to point out things that are easily caught by build configs.\n\nAs commented by others specifically, the code shows a lack of understanding of how multi-threading an application works in practice.  I see no locks, or other synchronization methods that would make the existing code threadsafe, which is likely why it's hitting problems.  While a lot of the bmcweb code is reentrant, a significant portion is not, and is relying on global state.  In addition, as patrick points out, sdbusplus is not in itself thread safe.  You will notice my patchset that I've linked before did WAAAAAAY more than what's done here:\nhttps://gerrit.openbmc.org/c/openbmc/bmcweb/+/63710 and might be a good starting point for you.\n\nI'd recommend doing some reading on:\nThe available synconization mechanisms in boost asio (including actually enabling them in ifdefs).\nHow to write threadsafe code, including an understanding of shared access patterns and mutex usage.\nThread sanitizer, which can easily catch quite a few of these failures."
                },
                {
                    "file": "redfish-core/lib/metric_report.hpp",
                    "line": 99,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "?  The code you're doing in a loop 5000 times isn't actually doing anything except constructing a very large json object (which, if that's your goal, there are more efficient ways to accomplish).\n\nLets focus on getting this code to something whos performance can be tested externally to the process.  Just pushing 5000 values to an array doesn't really prove the multi-threading capability."
                },
                {
                    "file": "redfish-core/lib/metric_report.hpp",
                    "line": 137,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "extra spaces"
                },
                {
                    "file": "src/dbus_singleton.cpp",
                    "line": 8,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "The dbus connection cannot be shared across threads. sd-bus has an underlying requirement that a connection is only accessed from a single thread. Even if you use locking you can end up with undefined results."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "src/webserver_main.cpp",
                    "type": "MODIFIED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/dbus_singleton.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/dbus_singleton.cpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/metric_report.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 81,
            "sizeDeletions": 1
        }
    ]
}