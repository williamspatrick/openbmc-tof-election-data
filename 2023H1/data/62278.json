{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I476361413fdb508c93aea88ca6142bc649562c56",
    "number": 62278,
    "subject": "redfish: ensure protocol state always returned",
    "owner": {
        "name": "Andrew Geissler",
        "email": "geissonator@yahoo.com",
        "username": "geissonator"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/62278",
    "hashtags": [],
    "createdOn": 1681155638,
    "lastUpdated": 1684531520,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1681155638,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1681155658,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681155658,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1681156820,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/63958/ : SUCCESS"
        },
        {
            "timestamp": 1683750634,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1683752210,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2: Patch Set 1 was rebased\n\nCopied Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1683752252,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1683752252,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1683752286,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/66123/ : FAILURE"
        },
        {
            "timestamp": 1683839291,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 3: Patch Set 2 was rebased.\n\nCopied Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1683839338,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1683839338,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1683839561,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/66272/ : FAILURE"
        },
        {
            "timestamp": 1683914698,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 4: Patch Set 3 was rebased\n\nCopied Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1683914745,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1683914745,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1683916099,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/66381/ : SUCCESS"
        },
        {
            "timestamp": 1684512222,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1684513401,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1684528726,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 4:\n\n(2 comments)"
        },
        {
            "timestamp": 1684531517,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(2 comments)"
        },
        {
            "timestamp": 1684531518,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4: Code-Review+2"
        },
        {
            "timestamp": 1684531520,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully rebased and submitted as 1ee2db7fc901dd14cabe2b57c453ddb6483ec285"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "3d84acca84ebcea9e829bc8535797aaa244cfec4",
            "parents": [
                "46bc67a5a2d5966d5f33f345469bc74cd7861ce2"
            ],
            "ref": "refs/changes/78/62278/1",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1681155638,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "efe9b002ddfcf4a393576e7ed181508370900958",
            "parents": [
                "97a34f4301e699fcad0c9960de229fa212ccfbbf"
            ],
            "ref": "refs/changes/78/62278/2",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1683752210,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "0c9acdad406fc467911718cda49b04829ee5fd42",
            "parents": [
                "dd069232bdb219771400b40689f95b26caf32175"
            ],
            "ref": "refs/changes/78/62278/3",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1683839291,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "35dc4666258b8bc9a511bf9db19f59e2bf72e1f8",
            "parents": [
                "581532345fc0e46eba1fbbdaadd66b2a176419cd"
            ],
            "ref": "refs/changes/78/62278/4",
            "uploader": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "createdOn": 1683914698,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 29,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I'm looking at the code, and I'm not seeing where it works the way you described:\n\nhttps://github.com/openbmc/bmcweb/blob/e6feae518c5a153af2dc64d3810fd029f0875366/redfish-core/lib/redfish_util.hpp#L194\n\nit looks like it loops over the protocols, and adds them to the list regardless of whether \"find\" was set or not, find just determined whether the protocol was enabled."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 29,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "The code I was looking at was https://gerrit.openbmc.org/c/openbmc/bmcweb/+/44438/19/redfish-core/lib/network_protocol.hpp#b191 (// If the service is not installed, that is not an error). We'd put a default in for these if the service wasn't found."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 29,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "ACK."
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "line": 180,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This wasn't my understanding of how that worked.  They should be in ListUnits, but disabled, right?\n\nMy problem here is that for systems that don't support ssh or IPMI, and don't have those services present, this changes the behavior such that now the user-facing tree looks like those services are supported."
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "line": 180,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "I did some quick tests on my witherspoon. The service-config manager appears to do a \"systemctl stop\" and a \"systemctl disable\" on the service and socket (using the systemd d-bus api). After the disable is done, a \"busctl --json=pretty call org.freedesktop.systemd1 /org/freedesktop/systemd1 org.freedesktop.systemd1.Manager ListUnits\" will not return the IPMI service or socket in it's data.\n\nFor the ListUnitFiles API it notes \"ListUnitFiles() returns an array of unit names plus their enablement status. Note that ListUnit() returns a list of units currently loaded into memory, while ListUnitFiles() returns a list of unit files that could be found on disk.\" So calling \"ListUnitFiles()\" may work but in both QEMU and on my witherspoon I get a \"Call failed: Connection timed out\" before it can return.\n\nI think addressing your concern here about people that don't have the feature installed at all would require a re-thinking of how this logic works. Maybe a more specific d-bus call like \"GetUnitFileState\" but then you'd need to know the ethX info. I'm not sure but I do think per my other comment that the default used to be that we would always return something."
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "line": 180,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> I did some quick tests on my witherspoon. The service-config manager appears to do a \"systemctl stop\" and a \"systemctl disable\" on the service and socket (using the systemd d-bus api). After the disable is done, a \"busctl --json=pretty call org.freedesktop.systemd1 /org/freedesktop/systemd1 org.freedesktop.systemd1.Manager ListUnits\" will not return the IPMI service or socket in it's data.\n\nThis is unexpected.  Thank you for running this test.\n\n> \n> For the ListUnitFiles API it notes \"ListUnitFiles() returns an array of unit names plus their enablement status. Note that ListUnit() returns a list of units currently loaded into memory, while ListUnitFiles() returns a list of unit files that could be found on disk.\" So calling \"ListUnitFiles()\" may work but in both QEMU and on my witherspoon I get a \"Call failed: Connection timed out\" before it can return.\n\nACK.\n\n> \n> I think addressing your concern here about people that don't have the feature installed at all would require a re-thinking of how this logic works. Maybe a more specific d-bus call like \"GetUnitFileState\" but then you'd need to know the ethX info. I'm not sure but I do think per my other comment that the default used to be that we would always return something.\n\nYep, agreed.  My thinking was based on an incorrect understanding of how ListUnits worked.  Thanks for looking into it."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "1ee2db7fc901dd14cabe2b57c453ddb6483ec285",
            "parents": [
                "81c4e3305281b2cfece8822f7c7114200ce4e12c"
            ],
            "ref": "refs/changes/78/62278/5",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1684531520,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/network_protocol.hpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 51,
            "sizeDeletions": 0
        }
    ]
}