{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I7ef6d7457f8203cf5ea3d07a59342583c05e1e7e",
    "number": 39409,
    "subject": "WIP: Allow intermediate writes",
    "owner": {
        "name": "Ed Tanous",
        "email": "ed@tanous.net",
        "username": "edtanous"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/39409",
    "hashtags": [],
    "createdOn": 1609919417,
    "lastUpdated": 1686261696,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1609919417,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1609919441,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1609919899,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/10543/ : FAILURE"
        },
        {
            "timestamp": 1609920017,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 2: Patch Set 1 was rebased."
        },
        {
            "timestamp": 1609920051,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1609920562,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/10546/ : FAILURE"
        },
        {
            "timestamp": 1612276267,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1612329831,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1612330796,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1612449616,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1612459036,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1612500307,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1615911254,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1615912693,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1618812255,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1618812948,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1618848451,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1618858874,
            "reviewer": {
                "name": "Ravi Teja",
                "email": "raviteja28031990@gmail.com",
                "username": "raviteja-b"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1686261696,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Abandoned\n\nNot clear this is still needed."
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "3eb72e7d3a3a2e8b792dd30f1c4ed1d11d054032",
            "parents": [
                "e84f3e230ac8dac832d9fbed051e795a02c44b26"
            ],
            "ref": "refs/changes/09/39409/1",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1609919417,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -27
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -9
                }
            ],
            "sizeInsertions": 69,
            "sizeDeletions": 36
        },
        {
            "number": 2,
            "revision": "981051eaaf62b581ff6878bb747baef87a0d3cf9",
            "parents": [
                "a32b1a3622736b0a254f7523ca857bb07e941675"
            ],
            "ref": "refs/changes/09/39409/2",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1609920017,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "we can use dynamic response body right?"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "don't we need to create another response structure for dynamic body type?\nbecoz existing response body is of string type"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Your patchset actually gave me the idea that if we had \"done\" callbacks, we wouldn't need to have the core take ownership of the string, which means we can use buffer body, and have flow control with it, which removes the need for dynamic body, like we do with websockets.  In fact, websockets could use a buffer interface too if we had callbacks when the write was done, which would fix the flow control issues there too."
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "i agree we can use buffer_body..\ninitially i have tried to use buffer_body type instead of dynamic body but we need to enable chunked encoding for buffer body type as per HTTP 1.1\nits additional overhead and complicated again.\nso i understand that we can achieve same with dynamic_body easily and i feel for our use-case dynamic-body is apt"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> i agree we can use buffer_body..\n> initially i have tried to use buffer_body type instead of dynamic body but we need to enable chunked encoding for buffer body type as per HTTP 1.1\n> its additional overhead and complicated again.\n> so i understand that we can achieve same with dynamic_body easily and i feel for our use-case dynamic-body is apt\n\nI didn't think buffer body required chunked encoding.  Http1.1 doesn't require chunked encoding unless I'm missing something.  Agreed that chunked encoding is more complexity than it's worth."
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "Ed,\n\nI have created  response class with http buffer_body type and buffer body type ignoring content length header even if i set and chunked encoding enabled by default with buffer_body type(could not disable).\n\n curl -k -H \"X-Auth-Token: $bmc_token\" -X GET -D dumpheader.txt http://${BMC_IP}/redfish/v1/Managers/bmc/LogServices/Dump/attachment/1 > bmcdump_1\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  4096    0  4096    0     0   141k      0 --:--:-- --:--:-- --:--:--  142k\n\ncurl: (56) Problem (2) in the Chunked-Encoded data\n\n\n-cat dumpheader.txt\nHTTP/1.1 200 OK\nContent-Type: application/octet-stream\nTransfer-Encoding: chunked"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Can you post the code you used somewhere?  I was under the impression that code had to call res.chunked(true) to enable chunking, and also call net::make_chunk.  I'm not sure what you did to get it, but I've used buffer body in the past for similar things."
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "sure Ed. I need to search for that code, not sure if i had backup.\ni remember enabling res.chunked(true) but did not use make_chunk, i think that's where we need to write more code to prepare chunk header and chunk data for each chunk right?\ni will try once again and will let you know.\nbut don't we have another way to achieve flow control with dynamic_buffer body.\nthat's exactly suits for data streaming right?"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "Ed\n\nI have used buffer_body with disabled chunked encoding instead of dynamic buffer body\nin my dump offload commit and could see dumps offloaded."
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "do you want to take a look that code? shall I push"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Feel free."
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 151,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "updated latest patch of this commit\nhttps://gerrit.openbmc-project.xyz/c/openbmc/bmcweb/+/38051\nthis patchset uses buffer body instead of dynamic buffer body \nplease have a look and let me know your views"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 159,
                    "reviewer": {
                        "name": "Ravi Teja",
                        "email": "raviteja28031990@gmail.com",
                        "username": "raviteja-b"
                    },
                    "message": "i did not understand why do we need to store headers ?\nheaders sent only once before writing data right?"
                },
                {
                    "file": "http/http_response.hpp",
                    "line": 159,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "We're converting the body to a different type here.  The first call to write will send the headers along with the first payload, so they need to be preserved.  Unfortunately, they're part of the body, and I wasn't able to get a fields reference type to work (it's not allowed).  and the way we organize this, we don't really know if the API in question is going to call write, until it does, so we can't send the headers ahead of time before the first call to write.\n\nHopefully that makes sense."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "http/http_connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 24,
                    "deletions": -26
                },
                {
                    "file": "http/http_response.hpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -9
                }
            ],
            "sizeInsertions": 68,
            "sizeDeletions": 35
        }
    ]
}