{
    "project": "openbmc/libpldm",
    "branch": "main",
    "topic": "msgbuf-conversion",
    "id": "I6916d28cdd1e27f180fb52725a836a365299ee9a",
    "number": 62409,
    "subject": "platform: pldm_msgbuf for decode_get_pdr_resp()",
    "owner": {
        "name": "Andrew Jeffery",
        "email": "andrew@aj.id.au",
        "username": "amboar"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/libpldm/+/62409",
    "hashtags": [],
    "createdOn": 1681308056,
    "lastUpdated": 1682053144,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1681308056,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1681308078,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681308079,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1681308257,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/64113/ : SUCCESS"
        },
        {
            "timestamp": 1681395311,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 2: New patch set was added with same tree, parent tree, and commit message as Patch Set 1.\n\nCopied Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1681395340,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681395340,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1681395891,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/64193/ : SUCCESS"
        },
        {
            "timestamp": 1681445401,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 3: Patch Set 2 was rebased.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1681445423,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681445423,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1681445614,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/64234/ : SUCCESS"
        },
        {
            "timestamp": 1681958334,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 4: Patch Set 3 was rebased.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1681958362,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681958362,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1681958888,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/64503/ : SUCCESS"
        },
        {
            "timestamp": 1681963147,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 4:\n\n(4 comments)"
        },
        {
            "timestamp": 1681973784,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 4:\n\n(4 comments)"
        },
        {
            "timestamp": 1681990859,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 4:\n\n(3 comments)"
        },
        {
            "timestamp": 1681993193,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 5.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1681993219,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681993220,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1681993522,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/64581/ : SUCCESS"
        },
        {
            "timestamp": 1682050874,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1682051306,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1682052134,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 5: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1682053044,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1682053144,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Change has been successfully rebased and submitted as 4e5e8a2159c190d4f3940656c060c65a28f83d86"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "0a091dae609e67d33a03d3fcdf5d553a84005ddd",
            "parents": [
                "c0c077c149f92eef69d61c61c671023b7ddc21b6"
            ],
            "ref": "refs/changes/09/62409/1",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1681308056,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/platform.c",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -26
                }
            ],
            "sizeInsertions": 31,
            "sizeDeletions": 27
        },
        {
            "number": 2,
            "revision": "321581b8af00ce76fbec7e84f81269358d5054fc",
            "parents": [
                "07cfb294bc12c22f16661bd41512d066d2615a72"
            ],
            "ref": "refs/changes/09/62409/2",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1681395311,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "NO_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/platform.c",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -26
                }
            ],
            "sizeInsertions": 31,
            "sizeDeletions": 27
        },
        {
            "number": 3,
            "revision": "9837552e49c3faeefccb09bcbb8b1c146f67b8da",
            "parents": [
                "063b9ef14c8332a19ec48a4148a6d69329b750a1"
            ],
            "ref": "refs/changes/09/62409/3",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1681445401,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "line": 354,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Why this had to change?"
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "line": 354,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "The test case is that we fail to decode a response that has a bad buffer state.\n\nI've changed the test slightly so we try to extract more data from the buffer than is valid (i.e. attempt a buffer overrun by sizing `retRecordData` to be one byte less than `respCnt`). The underlying message buffer is defined on line 355 as `responseMsg`, whose length is defined in terms of `recordDataLength`."
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "line": 354,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Ack"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/platform.c",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -26
                }
            ],
            "sizeInsertions": 31,
            "sizeDeletions": 27
        },
        {
            "number": 4,
            "revision": "16349914c7c2c68f79de436ea6c7821b9adfcd64",
            "parents": [
                "059371383a30510def662890be4278e7bad23242"
            ],
            "ref": "refs/changes/09/62409/4",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1681958334,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "src/platform.c",
                    "line": 518,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Is the check done here because this is beyond the PLDM_GET_PDR_MIN_RESP_BYTES init validation?\n\n#define PLDM_GET_PDR_MIN_RESP_BYTES 12 covers for resp_cnt as well."
                },
                {
                    "file": "src/platform.c",
                    "line": 518,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Good question. Because we dereference `resp_cnt` below, failing to test `rc` causes warnings about use of `resp_cnt` in a potentially uninitialised state. So the test keeps us honest. However, because the optimiser can eventually prove that the test is unnecessary it should be removed from the generated code (as it's guaranteed present by the buffer being at least PLDM_GET_PDR_MIN_RESP_BYTES).\n\nMaintaining this pattern of testing `rc` prior to dereferencing the extracted value keeps us safe when we go beyond the minimum message length where it's actually required."
                },
                {
                    "file": "src/platform.c",
                    "line": 518,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Ack"
                },
                {
                    "file": "src/platform.c",
                    "line": 525,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Should we check the rc here? If the buffer didn't have the *resp_cnt as expected?"
                },
                {
                    "file": "src/platform.c",
                    "line": 525,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "That's not necessary because we don't access any values from `record_data`, and `pldm_msgbuf_extract_array()` prevents overflow of the underlying buffer (i.e. when `resp_cnt` is too large)."
                },
                {
                    "file": "src/platform.c",
                    "line": 525,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Just want to confirm my understanding. \n\nIf `*resp_cnt=5`, but there is no data in `buf` matching that, then wouldn't it be better to check the rc here? since extracting the array will fail."
                },
                {
                    "file": "src/platform.c",
                    "line": 525,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "The value of `*resp_cnt` is extracted from the message itself (line 516). If the message is truncated such that it is shorter than what's required by `*resp_cnt`, then this call to `pldm_msgbuf_extract_array()` will cause `pldm_msgbuf_destroy()` below to return `PLDM_ERROR_INVALID_LENGTH`.\n\nIf the caller of `decode_get_pdr_resp()` receives the return value `PLDM_ERROR_INVALID_LENGTH` then they mustn't read through any of the pointers they provided as arguments, as it's not possible to determine which are valid and which are not. What they do know is that the message was truncated in some fashion and that they need to throw the whole operation out."
                },
                {
                    "file": "src/platform.c",
                    "line": 525,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Ack"
                },
                {
                    "file": "src/platform.c",
                    "line": 529,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Check rc here as well?"
                },
                {
                    "file": "src/platform.c",
                    "line": 529,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Not required as we don't dereference `transfer_crc`. Whether it was successfully extracted is captured by `return pldm_msgbuf_destroy(ctx);` below."
                },
                {
                    "file": "src/platform.c",
                    "line": 529,
                    "reviewer": {
                        "name": "Tom Joseph",
                        "email": "rushtotom@gmail.com",
                        "username": "tomjoseph83"
                    },
                    "message": "Ack"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/platform.c",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -26
                }
            ],
            "sizeInsertions": 31,
            "sizeDeletions": 27
        },
        {
            "number": 5,
            "revision": "abcff88398e6baee8bc867e240483820c8434edf",
            "parents": [
                "97642108b734f9f819776d96ed1f3fb09651c0c1"
            ],
            "ref": "refs/changes/09/62409/5",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1681993193,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 26,
                    "deletions": 0
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/platform.c",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -26
                }
            ],
            "sizeInsertions": 47,
            "sizeDeletions": 27
        },
        {
            "number": 6,
            "revision": "4e5e8a2159c190d4f3940656c060c65a28f83d86",
            "parents": [
                "5c651b80615bee3cc706c7f006ce2fa1865f3bbd"
            ],
            "ref": "refs/changes/09/62409/6",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1682053144,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 26,
                    "deletions": 0
                },
                {
                    "file": "tests/libpldm_platform_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/platform.c",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -26
                }
            ],
            "sizeInsertions": 47,
            "sizeDeletions": 27
        }
    ]
}