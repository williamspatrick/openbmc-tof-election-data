{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I5d6267332b7b97c11f638850108e671d0baa26fd",
    "number": 59723,
    "subject": "Removed checking cookie in mTLS authentication",
    "owner": {
        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
        "email": "boleslawx.ogonczyk-makowski@intel.com",
        "username": "bogonczx"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/59723",
    "hashtags": [],
    "createdOn": 1671101316,
    "lastUpdated": 1674148367,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1671101316,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1671101344,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1671101344,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1671103056,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/57838/ : SUCCESS"
        },
        {
            "timestamp": 1671139419,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1671183147,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1671562444,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1671634594,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Uploaded patch set 2: Commit message was updated."
        },
        {
            "timestamp": 1671634617,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1"
        },
        {
            "timestamp": 1671634624,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1671634624,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1671634666,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/58164/ : FAILURE"
        },
        {
            "timestamp": 1671635069,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Patch Set 3: Patch Set 2 was rebased"
        },
        {
            "timestamp": 1671635099,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1671635099,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1671636723,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/58165/ : SUCCESS"
        },
        {
            "timestamp": 1673288254,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(8 comments)"
        },
        {
            "timestamp": 1673352272,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Patch Set 3:\n\n(5 comments)"
        },
        {
            "timestamp": 1673352749,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1674139936,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Uploaded patch set 4: Commit message was updated.\n\nCopied Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1674139980,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1674139980,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1674140083,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1674140187,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/59403/ : FAILURE"
        },
        {
            "timestamp": 1674140251,
            "reviewer": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "message": "Patch Set 5: Patch Set 4 was rebased\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1674140292,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1674140292,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1674141094,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/59404/ : SUCCESS"
        },
        {
            "timestamp": 1674148349,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1674148367,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "fcbe7e0a484ef8d6b1a2360f2bcc466cc9708516",
            "parents": [
                "0fb5b5051bebfe1330627a02d8f7c83195f71ed3"
            ],
            "ref": "refs/changes/23/59723/1",
            "uploader": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "createdOn": 1671101316,
            "author": {
                "name": "kniczyji",
                "email": "karol.niczyj@intel.com",
                "username": "kniczyji"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Needs more context here.  Why is this change needed?  What result are you trying to achieve?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "It was our internal fix for a bug with these reproduction steps:\n\nCreate two users: read_only with read_only privilege and admin with administrator privilege\nGet X-Auth-Token for admin user by sending POST request to BMC:\n\ncurl -k -X POST -d '{\"UserName\": \"admin\", \"Password\": \"donotchange\"}' https://BMC_IP/redfish/v1/SessionService/Sessions -H \"Content-Type: application/json\" -D headers_file.txt\n\nX-Auth-Token is incorporated in headers_file.txt\nPrepare CA and user certificate for read_only user\nAdd CA certificate to BMC\nExecute following request to BMC:\n\ncurl -k --cert user.pem --key user_key.pem -H \"Connection: keep-alive\" -H \"Cookie: SESSION=admin_x-auth-token\" -A \"abc\" https://BMC_IP/redfish/v1/AccountService/Accounts/admin\n\nCurrent results:\nFor request from last step BMC response is success - 200 OK\nSuccessful response is possible due to adding cookie header (with valid admin user X-Auth-Token) and nonempty User-Agent header\nThis is unexpected behavior which should be fixed\n\nExpected results:\nMTLS authentication passes - it can be confirmed because session for read_only user is created.\nAccountService/Accounts/admin resource should not be accessible by user with read_only privileges, expected response here is 403 - Forbidden"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Please add more details to your commit message, not in a gerrit comment.  I will respond once details are added there."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Done"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "Done"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 11,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Which ones?  WHat are the tests doing?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 11,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "The tests check various authorization scenarios and situation described in my reply above wasn't passing one without this change."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 11,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Please update your commit message with which tests were run."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 11,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Done"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 11,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "include/authentication.hpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 25,
            "sizeDeletions": 16
        },
        {
            "number": 2,
            "revision": "43468e24ede2ca26719b6ba0252492133260ec06",
            "parents": [
                "0fb5b5051bebfe1330627a02d8f7c83195f71ed3"
            ],
            "ref": "refs/changes/23/59723/2",
            "uploader": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "createdOn": 1671634594,
            "author": {
                "name": "kniczyji",
                "email": "karol.niczyj@intel.com",
                "username": "kniczyji"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "include/authentication.hpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 52,
            "sizeDeletions": 16
        },
        {
            "number": 3,
            "revision": "97e010ce5b47cff7982be36d9a7958eaebee7945",
            "parents": [
                "6dcbb8675d5c5765c3e53354b8f3b339effecd44"
            ],
            "ref": "refs/changes/23/59723/3",
            "uploader": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "createdOn": 1671635069,
            "author": {
                "name": "kniczyji",
                "email": "karol.niczyj@intel.com",
                "username": "kniczyji"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "what does \"highest priority\" mean in this context.  It's not clear."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Per the developing guide, please word wrap 50/72."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "https://github.com/openbmc/bmcweb/blob/bb759e3aeaadfec9f3aac4485f253bcc8a523e4c/include/authentication.hpp#L275\n\nAccording to this part of code the priority of authentication is:\nmTLS\nXToken\nCookie\n\nwith next one only being used if previous one wasn't so having mTLS depend on a cookie is counter-intuitive and actually makes a cookie have a higher priority than mTLS"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "The only line that exceeds 72 characters seems to be \"Signed-off-by: Boleslaw Ogonczyk Makowski <boleslawx.ogonczyk-makowski@intel.com>\" - is this the one that I should wrap? Asking for clarification because I haven't seen anyone else have to wrap their signed-off-by line but then their names might not be as long as mine."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "Done"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 13,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Can you convey in your commit message why this is a problem.  If the user has access to multiple credentials, is there a problem if we use the highest one they posess?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 13,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "the problem is that we aren't using the highest, we are using the cookie which should have lower priority than mTLS"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 33,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I'm not following here.  You're using the admins session, isn't it expected that you get the admins privilege level?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 33,
                    "reviewer": {
                        "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                        "email": "boleslawx.ogonczyk-makowski@intel.com",
                        "username": "bogonczx"
                    },
                    "message": "mTLS has higher priority so I'd expect privilege level to come from the highest priority method that has been used - the fact that it came from a cookie makes cookies effectively act as having higher priority than mTLS which shouldn't be the case\n\nI've reversed the scenario to help show the problem better:\nI'm using a valid admin certificate for mTLS connection (https://github.com/openbmc/docs/blob/master/security/TLS-configuration.md) and then providing some dummy SESSION value in a cookie (-H \"Cookie: SESSION=123\")- I'm getting \"401 Unauthorized\" - which means cookies have higher priority than mTLS when they shouldn't."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 37,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "If anything we should be giving bad-request if we don't allow using two different forms of valid credentials."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Based on the code, this looks fine.  Get your commit message cleaned up per the developing guide, and we'll get this on."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "include/authentication.hpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 52,
            "sizeDeletions": 16
        },
        {
            "number": 4,
            "revision": "3bdef4730a0ac502e2d2d169fbe89618e98fe8e2",
            "parents": [
                "6dcbb8675d5c5765c3e53354b8f3b339effecd44"
            ],
            "ref": "refs/changes/23/59723/4",
            "uploader": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "createdOn": 1674139936,
            "author": {
                "name": "kniczyji",
                "email": "karol.niczyj@intel.com",
                "username": "kniczyji"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 32,
                    "deletions": 0
                },
                {
                    "file": "include/authentication.hpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 42,
            "sizeDeletions": 16
        },
        {
            "number": 5,
            "revision": "ade2fe78b9907e5fa9d96d615f7682dade19e8c8",
            "parents": [
                "2b73119c57d054d1a0d67b376ae5651fccfae5ba"
            ],
            "ref": "refs/changes/23/59723/5",
            "uploader": {
                "name": "Boles\u0142aw Ogo\u0144czyk M\u0105kowski",
                "email": "boleslawx.ogonczyk-makowski@intel.com",
                "username": "bogonczx"
            },
            "createdOn": 1674140251,
            "author": {
                "name": "kniczyji",
                "email": "karol.niczyj@intel.com",
                "username": "kniczyji"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 32,
                    "deletions": 0
                },
                {
                    "file": "include/authentication.hpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 42,
            "sizeDeletions": 16
        }
    ]
}