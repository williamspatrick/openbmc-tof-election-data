{
    "project": "openbmc/phosphor-host-ipmid",
    "branch": "master",
    "id": "Icab98137a0115e1c5a482cc97598f7dd66d26bfc",
    "number": 60159,
    "subject": "dbus-sdr: Look for ObjectManagers on /xyz/openbmc_project/vr",
    "owner": {
        "name": "Sui Chen",
        "email": "suichen6@gmail.com",
        "username": "quadpixels"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/60159",
    "hashtags": [],
    "createdOn": 1673347974,
    "lastUpdated": 1676515279,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1673347974,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1673348003,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1673348003,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1673348023,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/58851/ : FAILURE"
        },
        {
            "timestamp": 1673348792,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Uploaded patch set 2: New patch set was added with same tree, parent tree, and commit message as Patch Set 1.\n\nCopied Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1673348803,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1673348803,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1673348821,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/58855/ : FAILURE"
        },
        {
            "timestamp": 1673349234,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Patch Set 2:\n\nThis change is ready for review."
        },
        {
            "timestamp": 1673376524,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1673376530,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1673376569,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1673376570,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1673376813,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/58887/ : SUCCESS"
        },
        {
            "timestamp": 1673482148,
            "reviewer": {
                "name": "John Broadbent",
                "email": "jebr@google.com",
                "username": "jebr224"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1673565617,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1673569438,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Uploaded patch set 4.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1673569460,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1673569460,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1673569542,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1673569710,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/59006/ : SUCCESS"
        },
        {
            "timestamp": 1673999779,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1674590589,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1674847381,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1674847803,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1675210460,
            "reviewer": {
                "name": "Peter Lundgren",
                "email": "peterlundgren@google.com",
                "username": "peterlundgren"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1675279270,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1675987994,
            "reviewer": {
                "name": "John Broadbent",
                "email": "jebr@google.com",
                "username": "jebr224"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1676502741,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 4: Code-Review+2"
        },
        {
            "timestamp": 1676508537,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1676515279,
            "reviewer": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "message": "Change has been successfully rebased and submitted as c2cb1bc28a76cb7b1723add540b836667c5eedeb"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "a18965a30032de0195fb92f4d009333e08baab5d",
            "parents": [
                "eae8859cae6655ccc000c792a4b51cf8ac38b0c1"
            ],
            "ref": "refs/changes/59/60159/1",
            "uploader": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "createdOn": 1673347974,
            "author": {
                "name": "Sui Chen",
                "email": "suichen@google.com",
                "username": ""
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 30,
                    "deletions": 0
                },
                {
                    "file": "dbus-sdr/sensorcommands.cpp",
                    "type": "MODIFIED",
                    "insertions": 32,
                    "deletions": -14
                }
            ],
            "sizeInsertions": 62,
            "sizeDeletions": 14
        },
        {
            "number": 2,
            "revision": "5e1571249722d5f508db5d80a2dba694f4037ada",
            "parents": [
                "eae8859cae6655ccc000c792a4b51cf8ac38b0c1"
            ],
            "ref": "refs/changes/59/60159/2",
            "uploader": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "createdOn": 1673348792,
            "author": {
                "name": "Sui Chen",
                "email": "suichen@google.com",
                "username": ""
            },
            "kind": "NO_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 30,
                    "deletions": 0
                },
                {
                    "file": "dbus-sdr/sensorcommands.cpp",
                    "type": "MODIFIED",
                    "insertions": 32,
                    "deletions": -14
                }
            ],
            "sizeInsertions": 62,
            "sizeDeletions": 14
        },
        {
            "number": 3,
            "revision": "42ea182a2b6f4f3785450407c0885c445daf5fe1",
            "parents": [
                "eae8859cae6655ccc000c792a4b51cf8ac38b0c1"
            ],
            "ref": "refs/changes/59/60159/3",
            "uploader": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "createdOn": 1673376524,
            "author": {
                "name": "Sui Chen",
                "email": "suichen@google.com",
                "username": ""
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "John Broadbent",
                        "email": "jebr@google.com",
                        "username": "jebr224"
                    },
                    "message": "I like the idea"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Vernon Mauery",
                        "email": "vernon.mauery@linux.intel.com",
                        "username": "vmauery"
                    },
                    "message": "It seems like the fix should be to the vr-sensor code to put the ObjectManager at the standard location like all the other sensors."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Sui Chen",
                        "email": "suichen6@gmail.com",
                        "username": "quadpixels"
                    },
                    "message": "I think the problem is the VR Sensor daemon is already installing ObjectManager at `/xyz/openbmc_project/vr` (\"standard locations\"), but dbus-sdr does not look for ObjectManagers located there after 9a9ac0bcfc2df48873ca0f9725eb5255f7191d84, only `/xyz/openbmc_project/sensors`.\n\nSince SDRs can come from daemons implementing the ObjectManager on both /xyz/openbmc_project/vr and /xyz/openbmc_project/sensors, dbus-sdr needs to check both DBus paths."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Sui Chen",
                        "email": "suichen6@gmail.com",
                        "username": "quadpixels"
                    },
                    "message": "Let me try to explain why the fix is dbus-sdr a bit more clearly:\n\n1) First, two global variables are maintained:\n\n1.1) A global variable `sensorTree` is maintained and referenced throughout the daemon. Its type is a `map<string,map<string,vector<string>>>`. More specifically:\n\n```\nmap<string,              -> DBus object name, e.g. cpu_temp\n   map<string,           -> DBus service, e.g. HwMon1\n      vector<string>>>   -> List of DBus interfaces, e.g. Value\n```\n\nIt is populated and maintained by calling the ObjectMapper via `lbdUpdateSensorTree` . Note that calls to this function involve both regular sensors (can be seen from the presence of \"VoltageRegularMode\" in the argument to GetSubTree (https://github.com/openbmc/phosphor-host-ipmid/blob/4eca251085f83caec4957d3bea812d51c1a5d3b4/dbus-sdr/sdrutils.cpp#L103)).\n\n1.2) Another global variable `SensorCache` is derived from `sensorTree`.\n\nIts type is a `map<string,map<object_path,map<string,map<string,value>>>>`. More\nspecifically,\n\n```\nmap<string,            -> DBus connection, e.g. HwMon1\n   map<object_path,    -> Object path, e.g. cpu_temp\n       map<string,     -> Interface the object implements. e.g. \"xyz.openbmc_project.Sensor.Value\"\n          map<string,  -> Name of a property in the interface, e.g. \"Value\"\n              value>>>> -> Value of the property, e.g. 50 degrees C\n```\n\nNote that the entry in a `sensorTree` corresponds to the `a{oa{sa{sv}}}`\nDBus type, which is the return type of `GetManagedObjects`. In other words: `SensorCache` caches the values of all managed objects of the interesting daemons.\n\n2) The sensor readings are maintained by the following flow:\n\na) ipmid obtains the list of interesting DBus services and populates `sensorTree` with `GetSubTree`.\nb) ipmid keeps updating their cached values in `SensorCache` with the `getSensorMap` function calling `GetManagedObjects`.\n\nWith change\nhttps://github.com/openbmc/phosphor-host-ipmid/commit/9a9ac0bcfc2df48873ca0f9725eb5255f7191d84, a) above still works correctly, because a) specifically calls out `/xyz/openbmc_project/sensors` and `/xyz/openbmc_project/vr`, while b) stops working for VR because b) used to query the object manager located at and under `/` and now it's only `/xyz/openbmc_project/sensors`.\n\nThe VR daemon in question has always been installing an Object Manager at `/xyz/openbmc_project/vr`. It is because of dbus-sdr accidentally skipping this path during the call to `/xyz/openbmc_project/vr` during `getSensorMap` that the VR sensors disappear from the SDR list. So the fix should be in dbus-sdr not the VR daemon."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Vernon Mauery",
                        "email": "vernon.mauery@linux.intel.com",
                        "username": "vmauery"
                    },
                    "message": "I understand why the VR sensors are no longer showing up, I object to this change as the fix. I believe the change should be in the VR daemon code to match the standard OpenBMC sensor object manager location of /xyz/openbmc_project/sensors"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Sui Chen",
                        "email": "suichen6@gmail.com",
                        "username": "quadpixels"
                    },
                    "message": "The daemon implements xyz.openbmc_project.Control.VoltageRegulatorMode and no .Sensor.Value interfaces.\n\nWe recently updated https://github.com/openbmc/phosphor-dbus-interfaces/blob/master/yaml/xyz/openbmc_project/Control/VoltageRegulatorControl.interface.yaml#L9 and stated that any daemons implementing VoltageRegulatorMode should install the ObjectManager at /vr.\n\nDo you intend to modify the .yaml file too?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Peter Lundgren",
                        "email": "peterlundgren@google.com",
                        "username": "peterlundgren"
                    },
                    "message": "Vernon,\n\nDoes Sui's comment make sense or is there a different solution that you'd recommend?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Sui Chen",
                        "email": "suichen6@gmail.com",
                        "username": "quadpixels"
                    },
                    "message": "(Continuing the discussion with Vernon earlier)\n\nThe sensor code looks for not just sensor interfaces, but also the VoltageRegulatorMode interface: https://github.com/openbmc/phosphor-host-ipmid/blob/master/dbus-sdr/sdrutils.cpp#L103 . This code has been in use for about 2 years. I've CC'ed the original authors (Hao and Willy)."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Sui Chen",
                        "email": "suichen6@gmail.com",
                        "username": "quadpixels"
                    },
                    "message": "Thanks for the approval! I guess this issue can now be closed."
                },
                {
                    "file": "dbus-sdr/sensorcommands.cpp",
                    "line": 340,
                    "reviewer": {
                        "name": "John Broadbent",
                        "email": "jebr@google.com",
                        "username": "jebr224"
                    },
                    "message": "If there were sensor in both `/xyz/openbmc_project/sensors`, and in `/xyz/openbmc_project/vr` we would break, only having checked sensors?"
                },
                {
                    "file": "dbus-sdr/sensorcommands.cpp",
                    "line": 340,
                    "reviewer": {
                        "name": "Sui Chen",
                        "email": "suichen6@gmail.com",
                        "username": "quadpixels"
                    },
                    "message": "Yes this is a valid concern. Now merging the ObjectValueTree."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 30,
                    "deletions": 0
                },
                {
                    "file": "dbus-sdr/sensorcommands.cpp",
                    "type": "MODIFIED",
                    "insertions": 33,
                    "deletions": -14
                }
            ],
            "sizeInsertions": 63,
            "sizeDeletions": 14
        },
        {
            "number": 4,
            "revision": "3aa31990633c6c65fa885460a175bc7b60ce8d11",
            "parents": [
                "eae8859cae6655ccc000c792a4b51cf8ac38b0c1"
            ],
            "ref": "refs/changes/59/60159/4",
            "uploader": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "createdOn": 1673569438,
            "author": {
                "name": "Sui Chen",
                "email": "suichen@google.com",
                "username": ""
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Sui Chen",
                        "email": "suichen6@gmail.com",
                        "username": "quadpixels"
                    },
                    "message": "Friendly ping?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 30,
                    "deletions": 0
                },
                {
                    "file": "dbus-sdr/sensorcommands.cpp",
                    "type": "MODIFIED",
                    "insertions": 30,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 60,
            "sizeDeletions": 10
        },
        {
            "number": 5,
            "revision": "c2cb1bc28a76cb7b1723add540b836667c5eedeb",
            "parents": [
                "bd604760285e3def12c59e84f4d0b933827ab775"
            ],
            "ref": "refs/changes/59/60159/5",
            "uploader": {
                "name": "Sui Chen",
                "email": "suichen6@gmail.com",
                "username": "quadpixels"
            },
            "createdOn": 1676515279,
            "author": {
                "name": "Sui Chen",
                "email": "suichen@google.com",
                "username": ""
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 30,
                    "deletions": 0
                },
                {
                    "file": "dbus-sdr/sensorcommands.cpp",
                    "type": "MODIFIED",
                    "insertions": 30,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 60,
            "sizeDeletions": 10
        }
    ]
}