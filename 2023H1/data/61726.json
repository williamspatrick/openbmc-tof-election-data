{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "I3040c4ea52b2bebcb6e206bb50585c6a75538f0a",
    "number": 61726,
    "subject": "Aggregation: Prefix fix HttpHeaders property",
    "owner": {
        "name": "Carson",
        "email": "clabrado@google.com",
        "username": "carsonlab"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/61726",
    "hashtags": [],
    "createdOn": 1679089592,
    "lastUpdated": 1680018916,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1679089592,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1679089611,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1679089611,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1679090351,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1679090966,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/62892/ : FAILURE"
        },
        {
            "timestamp": 1679093278,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1679339950,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 2: Patch Set 1 was rebased.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1679339985,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1679339985,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1679341597,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/62952/ : SUCCESS"
        },
        {
            "timestamp": 1679414079,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(4 comments)"
        },
        {
            "timestamp": 1679959314,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1679959335,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1679959335,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1679960457,
            "reviewer": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "message": "Patch Set 3:\n\n(4 comments)"
        },
        {
            "timestamp": 1679960606,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/63195/ : SUCCESS"
        },
        {
            "timestamp": 1680018914,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1680018916,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully merged"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "fb57f264a25f8d14bc3291e05311508b63a4c855",
            "parents": [
                "c251fe8155c3eb82a418e9f3f64415f38f0a7a21"
            ],
            "ref": "refs/changes/26/61726/1",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1679089592,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 199,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "nit, for a split of two, you generally want to use find.\n\nAlso, I suspect you want to search on \":\", not \" \""
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 199,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "The entire targeted string is going to be \"Location: /redfish/v1/{something}\".  I also wanted to make sure the split gave me the URI by itself so that I could correctly parse it as a url."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 199,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "yep.  same advice applies.\n\nsize_t npos = strHeader->find(' ');\n\n\nAlthough looking at this again, this might be one of the few correct uses of starts_with.\nconstexpr std::string_view location = \"Location: \";\nif (boost::starts_with(*strHeader, location){\n   std::string header = strHeader.substr(location.size();\n   addPrefixToStringItme(header, prefix);\n   *strHeader = location + header;\n}"
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 199,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "Done"
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 227,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "The only place these show up is in TaskService, and we don't aggregate TaskService?"
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 227,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "At least from the schema, HttpHeaders appear under /redfish/v1/EventService/Subscriptions/{EventDestinationId}\n/redfish/v1/TaskService/Tasks/{TaskId}\n\nWhile we don't aggregate TaskService, we do aggregate Tasks"
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 227,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "hmmmmm.  I wonder if we should be aggregating tasks.  That ship has probably sailed though."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 227,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "I think we definitely want to aggregate tasks.  For instance, the LogService.CollectDiagnosticData Actions under LogServices spawn tasks.  If we don't aggregate tasks then we wouldn't be able to collect diagnostic dumps from satellite BMCs."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 228,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This needs to check the odata.type (or the URI, your choice) as well.  There are multiple HttpHeaders properties."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 228,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "In the schema I only see \"HttpHeaders\" being a property of EventDestination, Job, and Task.  If the current response is getting aggregated in the first place then we want to attempt to perform prefix fixing.\n\nIf you're instead referring to the individual HTTP headers contained by HttpHeaders then addPrefixToHeadersInResp() makes sure that the \"Location\" header is the only one we'd attempt to fix.  This is consistent with how addAggregatedHeaders() only attempts to fix the \"Location\" header."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 228,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "We shouldn't aggregate EventDestination headers for sure.  Job and task are debatable how an aggregator should handle them.\n\nI'd still like some level of type check here before we mess with the value."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 228,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "As it currently stands, all of the headers under the \"HttpHeaders\" property are going to be included as part of the response.  We're just talking about attempting to apply the aggregation prefix if there is a Location header and it is for a Redfish URI of an aggregated resource.\n\nThis makes it consistent with what we would already be returning in the actual Location header thanks to addAggregatedHeaders().  I'm not understanding why we need some sort of type check here.  I feel like we already performed that check at the start of the aggregation flow when it was decided whether or not to aggregate the request.  If we're processing an aggregated response then we should want to attempt prefix fixing on any Redfish URI."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 228,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "ACK."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "test/redfish-core/include/redfish_aggregator_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 33,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 42,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 96,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "3d2c5dc765acec1e40f81159da95744d19256a17",
            "parents": [
                "8b2521a5a3be479814beb316975bf3de0b4e378f"
            ],
            "ref": "refs/changes/26/61726/2",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1679339950,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 185,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "please log an error here."
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "line": 185,
                    "reviewer": {
                        "name": "Carson",
                        "email": "clabrado@google.com",
                        "username": "carsonlab"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "test/redfish-core/include/redfish_aggregator_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 33,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 42,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 96,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "b27e1cbefc2a12a838de209decb7e22b5ba1b2c0",
            "parents": [
                "0ed80c8ce93a38eca6951ffad5c3143a3a720053"
            ],
            "ref": "refs/changes/26/61726/3",
            "uploader": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "createdOn": 1679959314,
            "author": {
                "name": "Carson",
                "email": "clabrado@google.com",
                "username": "carsonlab"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "test/redfish-core/include/redfish_aggregator_test.cpp",
                    "type": "MODIFIED",
                    "insertions": 33,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/include/redfish_aggregator.hpp",
                    "type": "MODIFIED",
                    "insertions": 40,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 94,
            "sizeDeletions": 0
        }
    ]
}