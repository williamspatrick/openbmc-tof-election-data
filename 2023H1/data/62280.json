{
    "project": "openbmc/openbmc",
    "branch": "master",
    "id": "I57eda0302dc2b7ac1a9cb0bf11aa23d23d6e08ab",
    "number": 62280,
    "subject": "meta-google: install nft rules for traffic redirection",
    "owner": {
        "name": "Yuxiao Zhang",
        "email": "yuxiaozhang@google.com",
        "username": "zyxiaooo"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openbmc/+/62280",
    "hashtags": [],
    "createdOn": 1681171559,
    "lastUpdated": 1686938824,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1681171559,
            "reviewer": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1681171641,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681171641,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1681171648,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/16640/"
        },
        {
            "timestamp": 1681172774,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/16640/ : SUCCESS"
        },
        {
            "timestamp": 1681172786,
            "reviewer": {
                "name": "Jenkins OpenBMC Google",
                "email": "haojenkinsg00gle@gmail.com",
                "username": "jenkins-openbmc-g00gle"
            },
            "message": "Patch Set 1:\n\nBuild Successful \n\nGoogle Internal CI : Google internal tests successfully started"
        },
        {
            "timestamp": 1681174024,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 1:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1681325085,
            "reviewer": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1681325190,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681325190,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1681325198,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/16700/"
        },
        {
            "timestamp": 1681326263,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/16700/ : SUCCESS"
        },
        {
            "timestamp": 1681326275,
            "reviewer": {
                "name": "Jenkins OpenBMC Google",
                "email": "haojenkinsg00gle@gmail.com",
                "username": "jenkins-openbmc-g00gle"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nGoogle Internal CI : Google internal tests successfully started"
        },
        {
            "timestamp": 1683137537,
            "reviewer": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1683137572,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1683137573,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1683137578,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/17179/"
        },
        {
            "timestamp": 1683138570,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/17179/ : SUCCESS"
        },
        {
            "timestamp": 1683138582,
            "reviewer": {
                "name": "Jenkins OpenBMC Google",
                "email": "haojenkinsg00gle@gmail.com",
                "username": "jenkins-openbmc-g00gle"
            },
            "message": "Patch Set 3:\n\nBuild Successful \n\nGoogle Internal CI : Google internal tests successfully started"
        },
        {
            "timestamp": 1683139804,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 3:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1683353546,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1683576068,
            "reviewer": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1683681251,
            "reviewer": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1686938824,
            "reviewer": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "message": "Abandoned\n\nmerged as other CL, not needed"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "fdb593f6490fa83dea363d27e605d53a4711cfe6",
            "parents": [
                "2fce3b664a5bc15e3e5fb81e4f632eac96700742"
            ],
            "ref": "refs/changes/80/62280/1",
            "uploader": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "createdOn": 1681171559,
            "author": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-google/networking/files/50-gbmc-redirect.rules.in",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-google/networking/gbmc-bridge.bb",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-google/networking/gbmc-nft-redirect.bb",
                    "type": "ADDED",
                    "insertions": 51,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 81,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "096a9039e14ca8aaef7e1c2135ca14b69a789a73",
            "parents": [
                "1aedd5f751aef46920bdf6c96a11a052e8c0e81d"
            ],
            "ref": "refs/changes/80/62280/2",
            "uploader": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "createdOn": 1681325085,
            "author": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-google/networking/files/50-gbmc-redirect.rules.in",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-google/networking/gbmc-bridge.bb",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-google/networking/gbmc-nft-redirect.bb",
                    "type": "ADDED",
                    "insertions": 51,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 81,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "d1daa660d05ba975ca8792cce8a78dfe7b1b557f",
            "parents": [
                "7ee1a1362878ed57bcdc29ab19720941aad26d0b"
            ],
            "ref": "refs/changes/80/62280/3",
            "uploader": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "createdOn": 1683137537,
            "author": {
                "name": "Yuxiao Zhang",
                "email": "yuxiaozhang@google.com",
                "username": "zyxiaooo"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "I feel like it's too difficult to mentally map the inputs to the output rules and the input rules are hard to interpret without directly mapping them into the code as they are a mass of numbers with various separators\n`GBMC_REDIRECT_MAP = \"cn0@1024:80@30000,3959@40000 cn1@2048:80@30001,3959@40001\"`\n\nSince this will ultimately be standardized for all of our CN's, can we just make a static ruleset for 2 CNs (until we need more) and just ship it to all of them. We can require that cn interfaces always use the `cn<N>` format and it shouldn't be a problem to have unused interfaces."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Yuxiao Zhang",
                        "email": "yuxiaozhang@google.com",
                        "username": "zyxiaooo"
                    },
                    "message": "ok that makes sense as well. Are you saying install the static rules in openbmc or internally for every platform that needs them? Here is the generated rule set:\n```\ntable bridge filter {\n    chain gbmcbr_mark {\n        type filter hook prerouting priority -300; policy accept;\n        iifname == \"cn0\" mark set 1024 return\n        iifname == \"cn1\" mark set 2048 return\n\n    }\n}\ntable inet raw {\n    chain gbmcbr_nat_input {\n        type filter hook prerouting priority -300;\n        mark 1024 tcp dport 80 tcp dport set 30000 notrack\n        mark 1024 tcp dport 3959 tcp dport set 40000 notrack\n        mark 2048 tcp dport 80 tcp dport set 30001 notrack\n        mark 2048 tcp dport 3959 tcp dport set 40001 notrack\n\n    }\n    chain gbmcbr_nat_output {\n        type filter hook output priority -300;\n        tcp sport 30000 tcp sport set 80 notrack\n        tcp sport 40000 tcp sport set 3959 notrack\n        tcp sport 30001 tcp sport set 80 notrack\n        tcp sport 40001 tcp sport set 3959 notrack\n\n    }\n}\n```\nI am not sure if we want to put this to all the platforms. 1. Outgoing rules doesn't have interface and we want to avoid redirecting them on platforms other than athena (we have to make them matching certain egress interface name, etc.)\n2. This may add some performance overheads"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Yuxiao Zhang",
                        "email": "yuxiaozhang@google.com",
                        "username": "zyxiaooo"
                    },
                    "message": "I think it is not possible to mangle the port number on bridge stage.\nBut seems that all the ports are only used by new platforms, so maybe we don't need to specify the outgoing interface on the outgoing dir. The rule will be look like this\n```\ntable bridge filter {\n    chain gbmcbr_mark {\n        type filter hook prerouting priority -300; policy accept;\n        iifname == \"cn0\" mark set 1024 return\n        iifname == \"cn1\" mark set 2048 return\n\n    }\n}\ntable inet raw {\n    chain gbmcbr_nat_input {\n        type filter hook prerouting priority -300;\n        mark 1024 tcp dport 10166 tcp dport set 10167 notrack\n        mark 2048 tcp dport 10166 tcp dport set 10168 notrack\n    }\n    chain gbmcbr_nat_output {\n        type filter hook output priority -300;\n        tcp sport 10167 tcp sport set 10166 notrack\n        tcp sport 10168 tcp sport set 10166 notrack\n    }\n}\n```\nLet me know if this looks fine then I can just ship this file to the gbmc nftable recipe."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-google/networking/files/50-gbmc-redirect.rules.in",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "meta-google/recipes-phosphor/images/obmc-phosphor-image.bbappend",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "meta-google/recipes-google/networking/gbmc-nft-redirect.bb",
                    "type": "ADDED",
                    "insertions": 51,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 82,
            "sizeDeletions": 1
        }
    ]
}