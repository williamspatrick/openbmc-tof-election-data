{
    "project": "openbmc/host-error-monitor",
    "branch": "master",
    "id": "I2a249161ac7455ad75b824b85733d0bb8749a507",
    "number": 62450,
    "subject": "Check host power state explicitly instead of caching signals",
    "owner": {
        "name": "Zev Weiss",
        "email": "zev@bewilderbeest.net",
        "username": "zevweiss"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/host-error-monitor/+/62450",
    "hashtags": [],
    "createdOn": 1681346368,
    "lastUpdated": 1684958692,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1681346368,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1681346413,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681346413,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1681346428,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/64157/ : FAILURE"
        },
        {
            "timestamp": 1681346483,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1681346552,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1681346568,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681346568,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1681346589,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/64158/ : SUCCESS"
        },
        {
            "timestamp": 1681346701,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1681346728,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1681346728,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1681346750,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/64159/ : SUCCESS"
        },
        {
            "timestamp": 1682613414,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1682636486,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1682703682,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1682722889,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 4.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1682722928,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1682722928,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1682722928,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1682722945,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/65387/ : FAILURE"
        },
        {
            "timestamp": 1682726198,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 5.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1682726218,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1682726218,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1682726240,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/65388/ : SUCCESS"
        },
        {
            "timestamp": 1682958328,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1682974688,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 6.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1682974721,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1682974721,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: -Ok-To-Test"
        },
        {
            "timestamp": 1682974741,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/65470/ : FAILURE"
        },
        {
            "timestamp": 1682974788,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Uploaded patch set 7.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1682974816,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1682974816,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: -Ok-To-Test"
        },
        {
            "timestamp": 1682974835,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        },
        {
            "timestamp": 1682974843,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/65471/ : SUCCESS"
        },
        {
            "timestamp": 1683059631,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        },
        {
            "timestamp": 1684266186,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        },
        {
            "timestamp": 1684958301,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        },
        {
            "timestamp": 1684958692,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 7:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "374132d66b7fa37c320d29c84902e4a3293fdc56",
            "parents": [
                "ee00ccc0060cc1b575377743772b0bedabc83f08"
            ],
            "ref": "refs/changes/50/62450/1",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1681346368,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "As discussed a bit recently in #development on discord."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/host_error_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -28
                },
                {
                    "file": "include/error_monitors/base_gpio_poll_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -42
                }
            ],
            "sizeInsertions": 70,
            "sizeDeletions": 71
        },
        {
            "number": 2,
            "revision": "06797908b10128622a6e537fd29da4c300e868c9",
            "parents": [
                "ee00ccc0060cc1b575377743772b0bedabc83f08"
            ],
            "ref": "refs/changes/50/62450/2",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1681346552,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/host_error_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -29
                },
                {
                    "file": "include/error_monitors/base_gpio_poll_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -42
                }
            ],
            "sizeInsertions": 73,
            "sizeDeletions": 72
        },
        {
            "number": 3,
            "revision": "7fb003288b7ccd44b68bacb8d9186ef591a644aa",
            "parents": [
                "ee00ccc0060cc1b575377743772b0bedabc83f08"
            ],
            "ref": "refs/changes/50/62450/3",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1681346701,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Overall it's looking good.  The code is simpler and doesn't seem to be impacted by D-Bus performance in my testing.\n\nIn my testing, I ran into a strange D-Bus issue and a startup order issue.  But once we work through those, everything looks good on my system."
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "I'm running into an issue here if host-error-monitor starts before power-control.  I think what happens is it returns here without calling the callback below.\n\nThen in base_gpio_poll_monitor, since the callback isn't called, it doesn't execute either the `waitForEvent()` or `poll()` calls, which I think leaves the signal monitor in a dead state.\n\nI'm not sure the best way to handle it.  We could always call the callback with either a default or error value and handle it in the callback.  Or we could adjust in base_gpio_poll_monitor so that even if the callback doesn't run, the signal monitor keeps running.  What do you think?"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Ah, yeah...I guess I'd be inclined to pass along the \"unknown\" host-state value to the callback and let it decide what to do in cases where the state check fails.  The existing code seems to implicitly assume the host is off at startup (due to the `hostOff = true` initialization), and then after that I guess would just maintain its notion of the current state as whatever update signal it saw last if power-control crashes or something.  With this patch in its current form we no longer have that state-tracking to fall back on, so we could either just have each callback decide what assumption about the host's power state is most appropriate for it, or revive the global variable purely to serve as a fallback if the dbus query fails...thoughts?"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "I'm leaning towards no global variable and let each callback decide how to handle the response from the state check.  It seems to be the most flexible and as you said, will allow the most appropriate response from each callback."
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Done"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Hmm... I'm still seeing it hang if I start power-control after host-error-monitor, so that didn't fix it. \ud83d\ude15\n\nWithout power-control, it gets a `No route to host` error. Everything seems to be fine until that error, then host-error-monitor just hangs waiting for the next call to checkHostState().\n\nHowever, while it's hung there, I can read the host state using `busctl`. I wonder if it's something in sdbusplus that is trying to protect host-error-monitor by blocking D-Bus to the same host after getting the \"No route\" error.\n\nDo you see this issue if you start power-control after host-error-monitor? Or stop and start power-control while host-error-monitor is running?"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "I'm having trouble reproducing the problem you're seeing...if I stop power-control and then start host-error-monitor I don't see any  error messages, and I've got an ierr_monitor instance on a CATERR line, so there's definitely at least one polled monitor in the mix; if I then start power-control and power on the host, using the gpio-mockup driver to trigger the CATERR signal I see the expected response from host-error-monitor.  Just in case I'm missing something, could you provide a more detailed step-by-step description of exactly what you're doing to reproduce the problem?"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "For setup, I enable gpio-mockup in an Err2Monitor and add these debug prints:\n```\ndiff --git a/include/error_monitors/base_gpio_poll_monitor.hpp b/include/error_monitors/base_gpio_poll_monitor.hpp\nindex 6d6d7c8..b62e0ad 100644\n--- a/include/error_monitors/base_gpio_poll_monitor.hpp\n+++ b/include/error_monitors/base_gpio_poll_monitor.hpp\n@@ -25,7 +25,7 @@\n\n namespace host_error_monitor::base_gpio_poll_monitor\n {\n-static constexpr bool debug = false;\n+static constexpr bool debug = true;\n\n enum class AssertValue\n {\ndiff --git a/src/host_error_monitor.cpp b/src/host_error_monitor.cpp\nindex 29a0f0b..d01223d 100644\n--- a/src/host_error_monitor.cpp\n+++ b/src/host_error_monitor.cpp\n@@ -38,11 +38,13 @@ static void init()\n\n void checkHostState(std::function<void(std::optional<bool>)> callback)\n {\n+    std::cerr << \"JMB: In checkHostState\\n\";\n     // Get the current host state and pass it into the provided callback\n     conn->async_method_call(\n         [callback](boost::system::error_code ec,\n                    const std::variant<std::string>& property) {\n             std::optional<bool> status = std::nullopt;\n+            std::cerr << \"JMB: In checkHostState handler\\n\";\n             if (!ec)\n             {\n                 const std::string* state = std::get_if<std::string>(&property);\n@@ -55,6 +57,12 @@ void checkHostState(std::function<void(std::optional<bool>)> callback)\n                     status = *state !=\n                              \"xyz.openbmc_project.State.Host.HostState.Off\";\n                 }\n+                std::cerr << \"Host is \" << *state << \"\\n\";\n+            }\n+            else\n+            {\n+                std::cerr << \"JMB: Error getting host state: \" << ec.what()\n+                          << \"\\n\";\n             }\n\n             callback(status);\n```"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 46,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "On start-up, the ERR2 mockup is asserted, so the monitor is polling:\n```\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: Polling gpio-mockup-A-2\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: Flushing gpio-mockup-A-2 events\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: In checkHostState\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: In checkHostState handler\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: Host is xyz.openbmc_project.State.Host.HostState.Running\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 19:43:56 bmc-maca4bf018cdac8 host-error-monitor[305]: gpio-mockup-A-2 asserted\n```\n\nI stop power-control with `systemctl stop xyz.openbmc_project.Chassis.Control.Power@0` and get this:\n```\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: Polling gpio-mockup-A-2\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: Flushing gpio-mockup-A-2 events\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: In checkHostState\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: In checkHostState handler\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: Error getting host state: No route to host [generic:113]\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: gpio-mockup-A-2 not asserted\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 19:44:17 bmc-maca4bf018cdac8 host-error-monitor[305]: Wait for gpio-mockup-A-2\n```\n\nThis looks correct so far and puts the ERR2 monitor back into wait mode after it fails to find the current host state.\n\nI then start power-control again with `systemctl start xyz.openbmc_project.Chassis.Control.Power@0` and get this:\n```\nMay 24 19:45:47 bmc-maca4bf018cdac8 host-error-monitor[305]: Polling gpio-mockup-A-2\nMay 24 19:45:47 bmc-maca4bf018cdac8 host-error-monitor[305]: Flushing gpio-mockup-A-2 events\nMay 24 19:45:47 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: In checkHostState\n```\n\nIt correctly starts polling again, but when it tries to get the host state from D-Bus, it just hangs there.\n\nIf I stop power-control again, I get\n```\nroot@bmc-maca4bf018cdac8:~# May 24 20:03:22 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: In checkHostState handler\nMay 24 20:03:22 bmc-maca4bf018cdac8 host-error-monitor[305]: JMB: Error getting host state: Connection timed out [generic:110]\nMay 24 20:03:22 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 20:03:22 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 20:03:22 bmc-maca4bf018cdac8 host-error-monitor[305]: gpio-mockup-A-2 not asserted\nMay 24 20:03:22 bmc-maca4bf018cdac8 host-error-monitor[305]: Checking gpio-mockup-A-2 state\nMay 24 20:03:22 bmc-maca4bf018cdac8 host-error-monitor[305]: Wait for gpio-mockup-A-2\n```\n\nWhere it finally returns to the handler with a connection timeout."
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 117,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "I am running into an issue here on my system where when a signal monitor that inherits base_gpio_poll_monitor is started, it tries to check the host state, but seems to hang waiting for D-Bus.\n\nI made the following change in a test build that seems to resolve the issue and mimics the current behavior where the signal monitors are initialized after io.run() starts:\n\n```\n-    // Initialize the signal monitors\n-    host_error_monitor::init();\n+    boost::asio::post(host_error_monitor::io, []() {\n+        // Initialize the signal monitors\n+        host_error_monitor::init();\n+    });\n```"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 117,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Ah, okay -- I'll incorporate that tweak into the next version of the patch, thanks."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/host_error_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -30
                },
                {
                    "file": "include/error_monitors/base_gpio_poll_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": -42
                }
            ],
            "sizeInsertions": 74,
            "sizeDeletions": 73
        },
        {
            "number": 4,
            "revision": "f9bb2188b1588a5f9a02caa799778d09e6e35e37",
            "parents": [
                "03ed41b37b9feba12d8dcf42f5580557b9e0f13f"
            ],
            "ref": "refs/changes/50/62450/4",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1682722889,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/host_error_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "type": "MODIFIED",
                    "insertions": 28,
                    "deletions": -42
                },
                {
                    "file": "include/error_monitors/base_gpio_poll_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -42
                }
            ],
            "sizeInsertions": 92,
            "sizeDeletions": 85
        },
        {
            "number": 5,
            "revision": "cd6c0b4b9f2baca4c289778c3458d25598c9aff4",
            "parents": [
                "03ed41b37b9feba12d8dcf42f5580557b9e0f13f"
            ],
            "ref": "refs/changes/50/62450/5",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1682726198,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 52,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "This will still exit without calling the callback and leave the monitor in a dead state.  Should we call the callback in this case, too?"
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "line": 52,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Ah yeah, missed this other `return`...now fixed, thanks."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/host_error_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": -42
                },
                {
                    "file": "include/error_monitors/base_gpio_poll_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -42
                }
            ],
            "sizeInsertions": 93,
            "sizeDeletions": 85
        },
        {
            "number": 6,
            "revision": "b669b442d415c899e00e60c9e8f377f98a2e1957",
            "parents": [
                "03ed41b37b9feba12d8dcf42f5580557b9e0f13f"
            ],
            "ref": "refs/changes/50/62450/6",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1682974688,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/host_error_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "type": "MODIFIED",
                    "insertions": 30,
                    "deletions": -42
                },
                {
                    "file": "include/error_monitors/base_gpio_poll_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -42
                }
            ],
            "sizeInsertions": 94,
            "sizeDeletions": 85
        },
        {
            "number": 7,
            "revision": "a8b4bfe0055dde166e84c0b36dd667b368d22afc",
            "parents": [
                "03ed41b37b9feba12d8dcf42f5580557b9e0f13f"
            ],
            "ref": "refs/changes/50/62450/7",
            "uploader": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "createdOn": 1682974788,
            "author": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 24,
                    "deletions": 0
                },
                {
                    "file": "include/host_error_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "src/host_error_monitor.cpp",
                    "type": "MODIFIED",
                    "insertions": 31,
                    "deletions": -42
                },
                {
                    "file": "include/error_monitors/base_gpio_poll_monitor.hpp",
                    "type": "MODIFIED",
                    "insertions": 38,
                    "deletions": -42
                }
            ],
            "sizeInsertions": 95,
            "sizeDeletions": 85
        }
    ]
}