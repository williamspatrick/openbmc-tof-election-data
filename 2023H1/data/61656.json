{
    "project": "openbmc/smbios-mdr",
    "branch": "master",
    "id": "I58b514c9e845d64770fa6f946493222a011a2018",
    "number": 61656,
    "subject": "Add dbus match rule to detect motherboard object creation",
    "owner": {
        "name": "Nikhil Namjoshi",
        "email": "nikhilnamjoshi@google.com",
        "username": "namjoshiniks"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/smbios-mdr/+/61656",
    "hashtags": [],
    "createdOn": 1678837373,
    "lastUpdated": 1679356699,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1678837373,
            "reviewer": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1678837401,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1678837401,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1678837479,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/62666/ : SUCCESS"
        },
        {
            "timestamp": 1678849086,
            "reviewer": {
                "name": "Brandon Kim",
                "email": "brandonkim@google.com",
                "username": "brandonkimbk"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1678849313,
            "reviewer": {
                "name": "Brandon Kim",
                "email": "brandonkim@google.com",
                "username": "brandonkimbk"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1678901179,
            "reviewer": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Code-Review+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1678901230,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1678901230,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1678901317,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/62719/ : SUCCESS"
        },
        {
            "timestamp": 1678904855,
            "reviewer": {
                "name": "Brandon Kim",
                "email": "brandonkim@google.com",
                "username": "brandonkimbk"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1678909995,
            "reviewer": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1678910005,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1678910005,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1678910079,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/62731/ : SUCCESS"
        },
        {
            "timestamp": 1678910081,
            "reviewer": {
                "name": "Brandon Kim",
                "email": "brandonkim@google.com",
                "username": "brandonkimbk"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1678910215,
            "reviewer": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1679243024,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1679243116,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1679328841,
            "reviewer": {
                "name": "Brandon Kim",
                "email": "brandonkim@google.com",
                "username": "brandonkimbk"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1679356693,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1679356699,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Change has been successfully rebased and submitted as dd1811c9f7fc40f88b91d944eee4770d7c2f57cf"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "b4e629f4b0ef655ceb947aa9c342c0b995d0ea86",
            "parents": [
                "6d8d8d63c46bcfbf0427504ada524dfaeec91f54"
            ],
            "ref": "refs/changes/56/61656/1",
            "uploader": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "createdOn": 1678837373,
            "author": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/mdrv2.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Brandon Kim",
                        "email": "brandonkim@google.com",
                        "username": "brandonkimbk"
                    },
                    "message": "I think you mentioned in our offline discussion - but you've tried adding the key \"interface\" and use \"systemInterface\" in the matcher itself?\n\nhttps://dbus.freedesktop.org/doc/dbus-specification.html (in section \"Match Rules\")"
                },
                {
                    "file": "src/mdrv2.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Nikhil Namjoshi",
                        "email": "nikhilnamjoshi@google.com",
                        "username": "namjoshiniks"
                    },
                    "message": "I did and tried several different variations of rules.. The interface rule is to match the messages sent over or to a particular interface. It does not match the interface in the message body..\n\nI looked at all the signals/method calls that are made when Entity manager starts up.. None of those have messages that go to interface=xyz.openbmc_project.Inventory.Item.System. This is expected I believe because this interface has no members under it (ref #1), so we won't see any message sent to it.\n\nIf we want to avoid the triggering of the callbacks repeatedly, the only way seems to be to hardcode the motherboardPath in the rule, but this solution won't be upstream-able.\n\nSo the only way is to wait for the InterfacesAdded signal and look at the message body to find if our System interface is being updated. This is similar to what is already being done as shown in ref #2.\n\nJust an FYI, that the matcher will be set only when we hit the error scenarios (motherboard Path is not found on first attempt)\n\nref:\n1) https://github1s.com/openbmc/phosphor-dbus-interfaces/blob/HEAD/yaml/xyz/openbmc_project/Inventory/Item/System.interface.yaml 2) https://github1s.com/openbmc/smbios-mdr/blob/master/src/cpuinfo_utils.cpp#L236"
                },
                {
                    "file": "src/mdrv2.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "@Brandon are you OK with the rational here?"
                },
                {
                    "file": "src/mdrv2.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Brandon Kim",
                        "email": "brandonkim@google.com",
                        "username": "brandonkimbk"
                    },
                    "message": "Yes, thanks for checking Zhikui - yes this makes sense. Let me close this comment."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 119,
                    "deletions": 0
                },
                {
                    "file": "src/mdrv2.cpp",
                    "type": "MODIFIED",
                    "insertions": 31,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 150,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "a6f93079ed4d109e86fe877c8f4abfa41cb2697d",
            "parents": [
                "6d8d8d63c46bcfbf0427504ada524dfaeec91f54"
            ],
            "ref": "refs/changes/56/61656/2",
            "uploader": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "createdOn": 1678901179,
            "author": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/mdrv2.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Brandon Kim",
                        "email": "brandonkim@google.com",
                        "username": "brandonkimbk"
                    },
                    "message": "I think we should also try to use the match_t + sdbusplus::bus::match::rules:: instead of the strings way of constructing the matcher"
                },
                {
                    "file": "src/mdrv2.cpp",
                    "line": 421,
                    "reviewer": {
                        "name": "Nikhil Namjoshi",
                        "email": "nikhilnamjoshi@google.com",
                        "username": "namjoshiniks"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 119,
                    "deletions": 0
                },
                {
                    "file": "src/mdrv2.cpp",
                    "type": "MODIFIED",
                    "insertions": 26,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 145,
            "sizeDeletions": 1
        },
        {
            "number": 3,
            "revision": "5d317afd523f8cb7fabd1444f0321bab93080252",
            "parents": [
                "6d8d8d63c46bcfbf0427504ada524dfaeec91f54"
            ],
            "ref": "refs/changes/56/61656/3",
            "uploader": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "createdOn": 1678909995,
            "author": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 119,
                    "deletions": 0
                },
                {
                    "file": "src/mdrv2.cpp",
                    "type": "MODIFIED",
                    "insertions": 27,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 146,
            "sizeDeletions": 1
        },
        {
            "number": 4,
            "revision": "dd1811c9f7fc40f88b91d944eee4770d7c2f57cf",
            "parents": [
                "1cf66fee9aaa6e5021dc4199893fad1e65625443"
            ],
            "ref": "refs/changes/56/61656/4",
            "uploader": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "createdOn": 1679356699,
            "author": {
                "name": "Nikhil Namjoshi",
                "email": "nikhilnamjoshi@google.com",
                "username": "namjoshiniks"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 119,
                    "deletions": 0
                },
                {
                    "file": "src/mdrv2.cpp",
                    "type": "MODIFIED",
                    "insertions": 27,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 146,
            "sizeDeletions": 1
        }
    ]
}