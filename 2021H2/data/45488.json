{
    "project": "openbmc/webui-vue",
    "branch": "master",
    "id": "I62778badbc2f7e674f5b0f702d82ef856b43662b",
    "number": 45488,
    "subject": "Modify WebSocketPlugin debounce callbacks",
    "owner": {
        "name": "John Liu",
        "email": "John_Liu@quantatw.com",
        "username": "johnlliiuu"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/webui-vue/+/45488",
    "commitMessage": "Modify WebSocketPlugin debounce callbacks\n\n- Add dispatchWebSocketData in GlobalStore to separate different debounce callbacks of interfaces\n\nSigned-off-by: John Liu <John_Liu@quantatw.com>\nChange-Id: I62778badbc2f7e674f5b0f702d82ef856b43662b\n",
    "createdOn": 1627894035,
    "lastUpdated": 1634719357,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1627894035,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1627894047,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nUser not approved, see admin, no CI"
        },
        {
            "timestamp": 1627894587,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 1:\n\nHi, I recovered the debounce for ws.onmessage function and added a test. Please help to review. Thanks."
        },
        {
            "timestamp": 1627897522,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1627897563,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nUser not approved, see admin, no CI"
        },
        {
            "timestamp": 1627901655,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1627908868,
            "reviewer": {
                "name": "Derick Montague",
                "email": "derick.montague@ibm.com",
                "username": "derick-montague"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1627915916,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1627967498,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1627984148,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1628054988,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1628064369,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1628064779,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1628069985,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1628070000,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nUser not approved, see admin, no CI"
        },
        {
            "timestamp": 1628070104,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1628070489,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1628070658,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 3:\n\nHi Lei,\nI uploaded Patchset 3 and you can download it to verify. Thanks."
        },
        {
            "timestamp": 1629905695,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nHi John, Thanks for the commit. \nCan you get on your company's CI approval list? \n\nSo you don't get \"User not approved, see admin, no CI\""
        },
        {
            "timestamp": 1629905773,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/25035/ : SUCCESS"
        },
        {
            "timestamp": 1630359350,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 3:\n\nI do not see you on Quanta's latest CLA. This CLA was uploaded May 24, 2021"
        },
        {
            "timestamp": 1634547771,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1634713887,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1634716205,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1634719357,
            "reviewer": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "622a9ca7c0fd79a160acfb08058b05af15c21116",
            "parents": [
                "7e2ba5432d067101e4c2931b388b4b6f07979dba"
            ],
            "ref": "refs/changes/88/45488/1",
            "uploader": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "createdOn": 1627894035,
            "author": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "package-lock.json",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": -24
                },
                {
                    "file": "package.json",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "src/mock/server/WebSocketServer.js",
                    "type": "ADDED",
                    "insertions": 44,
                    "deletions": 0
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "src/store/plugins/WebSocketPlugin.js",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": -13
                },
                {
                    "file": "tests/unit/AppHeader.spec.js",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 124,
            "sizeDeletions": 38
        },
        {
            "number": 2,
            "revision": "b3ae2ece9c741a0f1ac9d237db2c8cb10f4df7bf",
            "parents": [
                "7e2ba5432d067101e4c2931b388b4b6f07979dba"
            ],
            "ref": "refs/changes/88/45488/2",
            "uploader": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "createdOn": 1627897522,
            "author": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "When there are multiple events coming from BMC, is this piece of code capable of catching all the events?\nAs my understanding (which I am not very sure), this looks only separating the callbacks of different types, but it still may miss events."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Derick Montague",
                        "email": "derick.montague@ibm.com",
                        "username": "derick-montague"
                    },
                    "message": "If there is concern and we are still looking to handle performance, is there value discussing throttling opposed to debouncing? I think it is potentially possible to miss events with either."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "John Liu",
                        "email": "John_Liu@quantatw.com",
                        "username": "johnlliiuu"
                    },
                    "message": "Added { maxWait: (number) } option after the DEBOUNCE_INTERVAL may solve Lei's problem. maxWait: The maximum time func is allowed to be delayed before it's invoked."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "I am not sure why the performance here is a concern:\n* Typically BMC is not generating events frequently\n* When something happens (e.g. the host is power on/off), there could be multiple events coming  together in a short time, this is why the debounce here could cause the webui to miss events.\n* Even if the BMC really generates a lot of events, the webui usually could handle all of them since its performance is usually better than the BMC chip."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "John Liu",
                        "email": "John_Liu@quantatw.com",
                        "username": "johnlliiuu"
                    },
                    "message": "Hi Lei,\nMy understanding is every event will be received by websocket, debounce only filter the the same path of subscription, but it will setServerStatus by the last event since we have set the debounce argument trailing to true. So miss events in the duration of delay won't affect the status result."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "> event will be received by websocket, debounce only filter the the same path of subscription\n\nI do not think so, previously before cad5bb9, I could confirm that the debounce causes the event loss and thus it makes the power status inconsistent."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "John Liu",
                        "email": "John_Liu@quantatw.com",
                        "username": "johnlliiuu"
                    },
                    "message": "You are right. Before cad5bb9, all events mixed in the same debounce function will lost some event data. This is why I separate the original debounce function to different debounce functions."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "With this change, although the Host and Logging events are separated, if BMC generates multiple Host events, the webui still misses the events, is it?"
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "John Liu",
                        "email": "John_Liu@quantatw.com",
                        "username": "johnlliiuu"
                    },
                    "message": "Hi Lei,\nIf you have 10 logging events and 1 host status event received by the websocket within 2.5 seconds, both logging events and host status will be processed with this change, debunce function will let the host status and logging event do only one time not 10 times of the logging event related action."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "But if the BMC generates 2 or more host status event within 2.5 seconds, only 1 event is handled by the WebUI, and it could cause the host status inconsistent.\n\nWhy do we really care the debounce anyway? The browser should be able to handle every event generated by BMC, is it?"
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "@John Liu could you kindly reply to the above question?"
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "John Liu",
                        "email": "John_Liu@quantatw.com",
                        "username": "johnlliiuu"
                    },
                    "message": "Yes, debounce will record the last event within 2.5 seconds. If you operate power within 2.5 seconds, the header of server status icon will not be changed. But it doesn't matter because inconsistent in the short time interval can be ignored. I have a scenario to monitor sensor reading (bmcweb -Drest=enabled), it will populate very large data to browser via websocket. So debounce function is necessary to me."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "> But it doesn't matter because inconsistent in the short time interval can be ignored.\n\nThe problem is, it is not inconsistent in the short time interval, but it becomes inconsistent as long as there is no new power related events.\nSo we should really remove the debounce here.\n\n> I have a scenario to monitor sensor reading (bmcweb -Drest=enabled), it will populate very large data to browser via websocket.\n\nOn g220a we enable `-Drest=enabled` as well, what \"large data\" do you refer?"
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 34,
                    "reviewer": {
                        "name": "John Liu",
                        "email": "John_Liu@quantatw.com",
                        "username": "johnlliiuu"
                    },
                    "message": "> The problem is, it is not inconsistent in the short time interval, but it becomes inconsistent as long as there is no new power related events.\n> So we should really remove the debounce here.\nSeems that your debounce function not working properly. I can always get the LAST event so that in my environment is consistent.\n> On g220a we enable `-Drest=enabled` as well, what \"large data\" do you refer?\nI subscribed xyz.openbmc_project.Sensor.Value interface to draw charts on the Overview page."
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "line": 112,
                    "reviewer": {
                        "name": "John Liu",
                        "email": "John_Liu@quantatw.com",
                        "username": "johnlliiuu"
                    },
                    "message": "Check property not null is required."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "package-lock.json",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -3
                },
                {
                    "file": "package.json",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "src/mock/server/WebSocketServer.js",
                    "type": "ADDED",
                    "insertions": 44,
                    "deletions": 0
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "src/store/plugins/WebSocketPlugin.js",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -11
                },
                {
                    "file": "tests/unit/AppHeader.spec.js",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 99,
            "sizeDeletions": 15
        },
        {
            "number": 3,
            "revision": "104ce6375bfb76294eebac6b64551491b3f2240b",
            "parents": [
                "7e2ba5432d067101e4c2931b388b4b6f07979dba"
            ],
            "ref": "refs/changes/88/45488/3",
            "uploader": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "createdOn": 1628069985,
            "author": {
                "name": "John Liu",
                "email": "John_Liu@quantatw.com",
                "username": "johnlliiuu"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "package-lock.json",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -3
                },
                {
                    "file": "package.json",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "src/mock/server/WebSocketServer.js",
                    "type": "ADDED",
                    "insertions": 44,
                    "deletions": 0
                },
                {
                    "file": "src/store/modules/GlobalStore.js",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "src/store/plugins/WebSocketPlugin.js",
                    "type": "MODIFIED",
                    "insertions": 4,
                    "deletions": -11
                },
                {
                    "file": "tests/unit/AppHeader.spec.js",
                    "type": "MODIFIED",
                    "insertions": 20,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 15
        }
    ]
}