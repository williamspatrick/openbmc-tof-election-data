{
    "project": "openbmc/phosphor-power",
    "branch": "master",
    "id": "Ia9a6bbb58b5e439623d3931426cb91cb8948da7a",
    "number": 46176,
    "subject": "pseq: Add power control dbus server interface",
    "owner": {
        "name": "Jim Wright",
        "email": "jlwright@us.ibm.com",
        "username": "wrightjl1"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/46176",
    "commitMessage": "pseq: Add power control dbus server interface\n\nAdd the PowerInterface class which provides a server interface for the\n\"org.openbmc.control.Power\" dbus service.\n\nUpdate meson.build file to support.\n\nThe \"org.openbmc.control.Power\" interface is currently used by the\nChassis component to control power on and off as well as by a number of\nother OBMC applications which use the pgood property and associated\nsignals to determine the power state of the system.  Some desire to\nmove to a \"xyz.openbmc_project.control.Power\" interface has been\nexpressed.  The following is a proposed plan to accomplish this:\n1. Create a compatible \"org.openbmc.control.Power\" application (this\n   commit).\n2. Add \"xyz...\" interface to this application (future commit).\n3. Begin transition of existing applications to new interface (future\n   commits).\n\nSigned-off-by: Jim Wright <jlwright@us.ibm.com>\nChange-Id: Ia9a6bbb58b5e439623d3931426cb91cb8948da7a\n",
    "createdOn": 1629909052,
    "lastUpdated": 1630514869,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1629909052,
            "reviewer": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1629909068,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1629909512,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/25040/ : SUCCESS"
        },
        {
            "timestamp": 1629933353,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 1:\n\n(5 comments)"
        },
        {
            "timestamp": 1630003816,
            "reviewer": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1630003830,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1630004269,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/25165/ : SUCCESS"
        },
        {
            "timestamp": 1630007146,
            "reviewer": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "message": "Patch Set 2:\n\n(5 comments)"
        },
        {
            "timestamp": 1630007735,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(2 comments)"
        },
        {
            "timestamp": 1630007813,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1630071058,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1630072112,
            "reviewer": {
                "name": "Mike Capps",
                "email": "mikepcapps@gmail.com",
                "username": "mikecgithub"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1630076175,
            "reviewer": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1630076190,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1630076666,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/25223/ : SUCCESS"
        },
        {
            "timestamp": 1630076929,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1630077209,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1630077215,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1630077220,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Change has been successfully rebased and submitted as 1992083a94b09bcdd59f806722519af0e124143f by Shawn McCarney"
        },
        {
            "timestamp": 1630077278,
            "reviewer": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "message": "Patch Set 4:\n\n(2 comments)"
        },
        {
            "timestamp": 1630514869,
            "reviewer": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "f0263444df98646941b6ee32bf4b53dccc1d5185",
            "parents": [
                "5d4a9c78acf0d019b8dd083ac2aad4e0af241481"
            ],
            "ref": "refs/changes/76/46176/1",
            "uploader": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "createdOn": 1629909052,
            "author": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I think the org.openbmc namespace is old.  Would it make sense to move to xyz.openbmc_project.control.Power, or is that too much change across the BMC apps?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "Good question, Matt Spinler and I have also discussed.  In addition to the Chassis component usage to control power on and off, there are a number of OBMC applications using the pgood property and associated signals to know the power state of the system.\n\nI propose the following plan:\n1. Create a compatible \"org.openbmc.control.Power\" application (this commit).\n2. Add \"xyz...\" interface to this application (future commit).\n3. Begin transition of existing applications to new interface (future commits)."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "That seems reasonable.\n\nI was not trying to manufacture unnecessary work.  I just thought for a new, standard app we'd want to use a standard D-Bus interface if possible."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Jim, maybe you could update the commit message with your with your comment here that explains your plans for how/why this is used."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "Done"
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I am not an sd-bus expert by any means, but I noticed a difference here vs. phosphor-regulators/src/interfaces/manager_interface.cpp\n\nIn the callback methods there, it has the following sequence:\n  auto m = sdbusplus::message::message(msg);\n  auto reply = m.new_method_return();\n  reply.method_return();\n\nHere it looks like you are appending the response to the request message rather than the reply?  It could be a difference between calling a method vs. getting a property though."
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "I think it's the difference between a method and property.  I can't seem to find the example I based this code from though."
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "FWIW, here's an example, but in systemd not sdbusplus: https://github.com/openbmc/obmc-console/blob/master/console-server.c#L360"
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "line": 116,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Nit: typo"
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "line": 116,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "Done"
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "line": 16,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Where is this interface defined?  I didn't see it in phosphor-dbus-interfaces."
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "line": 16,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "https://github.com/openbmc/skeleton/blob/master/libopenbmc_intf/openbmc_intf.xml#L112\n\nI suspect this interface predates phosphor-dbus-interfaces.\n\nIn case it helps, here is the busctl tree and introspect from the skeleton application:\nroot@rainier:~# busctl tree org.openbmc.control.Power\n|-----/org\n  |-----/org/openbmc\n    |-----/org/openbmc/control\n      |-----/org/openbmc/control/power0\nroot@rainier:~# busctl introspect org.openbmc.control.Power /org/openbmc/control/power0\nNAME                                TYPE      SIGNATURE RESULT/VALUE FLAGS\norg.freedesktop.DBus.Introspectable interface -         -            -\n.Introspect                         method    -         s            -\norg.freedesktop.DBus.Peer           interface -         -            -\n.GetMachineId                       method    -         s            -\n.Ping                               method    -         -            -\norg.freedesktop.DBus.Properties     interface -         -            -\n.Get                                method    ss        v            -\n.GetAll                             method    s         a{sv}        -\n.Set                                method    ssv       -            -\n.PropertiesChanged                  signal    sa{sv}as  -            -\norg.openbmc.Control                 interface -         -            -\n.init                               method    -         -            -\n.heatbeat                           property  i         0            emits-change\n.poll_interval                      property  i         3000         emits-change writable\n.Heartbeat                          signal    s         -            -\n.Started                            signal    -         -            -\norg.openbmc.control.Power           interface -         -            -\n.getPowerState                      method    -         i            -\n.setPowerState                      method    i         -            -\n.pgood                              property  i         0            emits-change\n.pgood_timeout                      property  i         10           emits-change writable\n.state                              property  i         0            emits-change\n.PowerGood                          signal    -         -            -\n.PowerLost                          signal    -         -            -"
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "line": 79,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I take it the interface doesn't define an enum?  That would be nice so we know what the various values mean."
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "line": 79,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "Correct, for compatibility I need to use int.  Power off is 0.  Power on is 1.  Other values are not valid."
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "line": 79,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Maybe we could at least at your description above should be added to the doxygen for getState() and setState()?\n\nAlthough maybe it is defined in YAML already somewhere."
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "line": 79,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Wow that didn't make any sense.  One more try:\n\nMaybe your description above should be added to the doxygen for getState() and setState()?"
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "line": 79,
                    "reviewer": {
                        "name": "Jim Wright",
                        "email": "jlwright@us.ibm.com",
                        "username": "wrightjl1"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "type": "ADDED",
                    "insertions": 292,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "type": "ADDED",
                    "insertions": 141,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 434,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "7031a6825fc3e72a9843a5b9c2b5e7a7d5b215aa",
            "parents": [
                "d8b8cb15bf3e3f5e7e50e2421e702d8b46852d0f"
            ],
            "ref": "refs/changes/76/46176/2",
            "uploader": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "createdOn": 1630003816,
            "author": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "type": "ADDED",
                    "insertions": 292,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "type": "ADDED",
                    "insertions": 141,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 434,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "5013bc5c2c3858f831fe87aba6ee50ed8de246e6",
            "parents": [
                "d8b8cb15bf3e3f5e7e50e2421e702d8b46852d0f"
            ],
            "ref": "refs/changes/76/46176/3",
            "uploader": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "createdOn": 1630076175,
            "author": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 27,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "type": "ADDED",
                    "insertions": 292,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "type": "ADDED",
                    "insertions": 142,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 435,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "1992083a94b09bcdd59f806722519af0e124143f",
            "parents": [
                "fa23f7d1016d388cf531d186046b16efee4465a1"
            ],
            "ref": "refs/changes/76/46176/4",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1630077220,
            "author": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 27,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.cpp",
                    "type": "ADDED",
                    "insertions": 292,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-sequencer/src/power_interface.hpp",
                    "type": "ADDED",
                    "insertions": 142,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 435,
            "sizeDeletions": 0
        }
    ]
}