{
    "project": "openbmc/phosphor-power",
    "branch": "master",
    "id": "Ic8c3b567c8265e90bce420f98ac6f1e131ff713b",
    "number": 45518,
    "subject": "psu-ng: Read and validate input voltage",
    "owner": {
        "name": "Adriana Kobylak",
        "email": "anoo@linux.ibm.com",
        "username": "anoo1"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/45518",
    "commitMessage": "psu-ng: Read and validate input voltage\n\nRead the input voltage reported by pmbus for each PSU. Determine the\nactual voltage based on predefined thresholds. Then validate the actual\nvoltage is supported for the PSU model.\n\nTested:\nVerified in Rainier 2U that the 2 present PSUs had a pmbus\nvoltage value of 208000 mV, which is then translated to a 220V PSU, and\nthat value is validated against the supported configuration.\nVerified the additional data strings by printing them with debug\nstatements:\nAug 05 18:50:15 p10bmc phosphor-psu-monitor[3615]: ACTUAL_VOLTAGE: 208.000000\nAug 05 18:50:15 p10bmc phosphor-psu-monitor[3615]: CALLOUT_INVENTORY_PATH:\n/xyz/openbmc_project/inventory/system/chassis/motherboard/powersupply0\nAug 05 18:50:15 p10bmc phosphor-psu-monitor[3615]: EXPECTED_VOLTAGE: 220\n\nChange-Id: Ic8c3b567c8265e90bce420f98ac6f1e131ff713b\nSigned-off-by: Adriana Kobylak <anoo@us.ibm.com>\n",
    "createdOn": 1627936839,
    "lastUpdated": 1629400154,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1627936839,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1627936853,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627937281,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/23585/ : SUCCESS"
        },
        {
            "timestamp": 1627953654,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@inspur.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1627992178,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 1: Code-Review-1\n\n(2 comments)"
        },
        {
            "timestamp": 1628105118,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1628105140,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1628105534,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(3 comments)"
        },
        {
            "timestamp": 1628105573,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/23810/ : SUCCESS"
        },
        {
            "timestamp": 1628114132,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1628192186,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1628192217,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1628192266,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1628192692,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/23915/ : SUCCESS"
        },
        {
            "timestamp": 1628212271,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@inspur.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1628256156,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1628287979,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1628294135,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1628539165,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1628539192,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1628539407,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4:\n\n(3 comments)"
        },
        {
            "timestamp": 1628539624,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/24080/ : SUCCESS"
        },
        {
            "timestamp": 1628610808,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 4: Code-Review+1\n\nLooks good."
        },
        {
            "timestamp": 1628722521,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4: Code-Review+1\n\nWe used to call out the first thing that might be wrong, but it in my view that is just as valid as the last thing that went wrong, so ... looks good to me."
        },
        {
            "timestamp": 1629395058,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1629400149,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 4: Code-Review+2"
        },
        {
            "timestamp": 1629400154,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Change has been successfully rebased and submitted as 4175ffb76eac53d94de7c2c6397cb03ce5ea0e99 by Shawn McCarney"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "81403b99590898d18b4302e27b15ffef3332f057",
            "parents": [
                "10eb00f68e444f3d7f4f23217820aff5e850bd46"
            ],
            "ref": "refs/changes/18/45518/1",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1627936839,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 572,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@inspur.com",
                        "username": "lxwinspur"
                    },
                    "message": "Nit: Could you use `std::from_chars` instead of `std::stoi`?\n\n```\n#include <charconv>\n\nint PowerSupply::getInputVoltage(std::string inputVoltageStr)\n{\n    if (!present)\n    {\n        return 0;\n    }\n\n    int inputVol = 0;\n    auto inputVoltageStr = pmbusIntf->readString(phosphor::pmbus::READ_VIN,\n                                                 phosphor::pmbus::Type::Hwmon);\n    std::from_chars(inputVoltageStr.c_str(),\n                    inputVoltageStr.c_str() + inputVoltageStr.length(),\n                    inputVol);\n\n    return inputVol;\n}\n```"
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 572,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Looking at std::from_chars, seems like it doesn't handle any characters other than 0, so a string of \"0x33\" would be converted to 0, versus std::stoi would convert it to 51. I see that some pmbus values are hex strings, such as status0:\n\n$ cat /sys/kernel/debug/pmbus/hwmon12/status0\n0x0841\n\nMy concern would be that in1_input would change to be a hex string, and then the validate function would break. So maybe std::stoi is more future-proof in this case?"
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 572,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@inspur.com",
                        "username": "lxwinspur"
                    },
                    "message": "> Looking at std::from_chars, seems like it doesn't handle any characters other than 0, so a string of \"0x33\" would be converted to 0, versus std::stoi would convert it to 51. I see that some pmbus values are hex strings, such as status0:\n\n\nI did a test:\n```\nstd::string str = \"0x33\";\nstd::cerr << \"str value = \" << std::stoi(str) << std::endl;\n```\n\nThe printed result is 0, and this result value is the same as `std::from_chars`.\nSorry, Maybe I missing something?"
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 572,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "std::stoi has other arguments that say which base the value is in, or if it should be autodetected."
                },
                {
                    "file": "phosphor-power-supply/power_supply.hpp",
                    "line": 240,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Should this function return the actual voltage instead of having the validate function call two separate functions, one to get the pmbus reading and one to convert it to actual voltage?"
                },
                {
                    "file": "phosphor-power-supply/power_supply.hpp",
                    "line": 240,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. It retuns the actual voltage now."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 494,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "This check is not needed. Some power supplies can run at either 110V or 220V, that's the reason the supported configuration schema has an array of supported voltages for each PSU model."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 494,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Removed."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "type": "MODIFIED",
                    "insertions": 21,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.hpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 45,
                    "deletions": 0
                },
                {
                    "file": "pmbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 106,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "6c16a17766c56874756ab29c601aafeeb35a881e",
            "parents": [
                "10eb00f68e444f3d7f4f23217820aff5e850bd46"
            ],
            "ref": "refs/changes/18/45518/2",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1628105118,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 528,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "I don't know how useful it would be, but you could also store the actual voltage reading in the additionalData, like 113.5 or whatever, if you returned it from getInputVoltage along with the 'enum' reading."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 528,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Yeah that's a good idea. It'd look like this now:\nAug 05 18:50:15 p10bmc phosphor-psu-monitor[3615]: ACTUAL_VOLTAGE: 208.000000"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "type": "MODIFIED",
                    "insertions": 39,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.hpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": 0
                },
                {
                    "file": "pmbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 99,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "3228d5ac0e6d4084de734091896481ae2947000e",
            "parents": [
                "10eb00f68e444f3d7f4f23217820aff5e850bd46"
            ],
            "ref": "refs/changes/18/45518/3",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1628192186,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 583,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "If std::stod() fails due to an invalid string value, it will throw one of two std exceptions.  Would we want to catch them here too?  If so, maybe change catch parameter to 'const std::exception&)"
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 583,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Yeah good point, changed to \"const std::exception&\" and added a log msg to help debug."
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 589,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Nit: If you initialize the output parameters to these values at the top of the function, then you don't need an else clause.  Would make this method a little shorter and easier to read."
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "line": 589,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. Indeed it would, added the initialized parameters at the top."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 499,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "If the PSU count or input voltage is wrong, this loop stores info in additionalData and then continues to the next configuration.\n\nCan two configurations exist that both initially match but then fail the count or voltage test?  \n\nIf so, additionalData will have a mixture of data from both failed configs.\n\nFor example, if the first config has the wrong count and the second config has the wrong voltage, additionalData will contain keys/values from both configs.  Or if both configs have the wrong voltage, EXPECTED_VOLTAGE will have a list with values from both configs.\n\nMaybe this can't happen or is what you want to occur in that situation.  If so, please ignore."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 499,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Done. That scenario could be possible, I can see how it'd be confusing. Changed it so that on each mismatched configuration we clear the additional data of a previous mismatch, so that we only have the data from the last mismatch instead of a combination of multiple ones."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "type": "MODIFIED",
                    "insertions": 42,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 37,
                    "deletions": 0
                },
                {
                    "file": "pmbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 106,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "d3f67681f06ff72ef00092bbcc0f06a3673b7b6b",
            "parents": [
                "10eb00f68e444f3d7f4f23217820aff5e850bd46"
            ],
            "ref": "refs/changes/18/45518/4",
            "uploader": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "createdOn": 1628539165,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "type": "MODIFIED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 46,
                    "deletions": -3
                },
                {
                    "file": "pmbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 113,
            "sizeDeletions": 3
        },
        {
            "number": 5,
            "revision": "4175ffb76eac53d94de7c2c6397cb03ce5ea0e99",
            "parents": [
                "4dc9a30029916f21f12e8433ee82e35858247f86"
            ],
            "ref": "refs/changes/18/45518/5",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1629400154,
            "author": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.cpp",
                    "type": "MODIFIED",
                    "insertions": 40,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/power_supply.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 46,
                    "deletions": -3
                },
                {
                    "file": "pmbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 113,
            "sizeDeletions": 3
        }
    ]
}