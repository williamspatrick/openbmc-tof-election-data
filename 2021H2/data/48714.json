{
    "project": "openbmc/phosphor-fan-presence",
    "branch": "master",
    "id": "I8ff281d49ac780e8ff38f3e8ed02ab95395f1fd3",
    "number": 48714,
    "subject": "control: Create parameter trigger",
    "owner": {
        "name": "Matt Spinler",
        "email": "spinler@us.ibm.com",
        "username": "spinler"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-fan-presence/+/48714",
    "commitMessage": "control: Create parameter trigger\n\nCreate a new event trigger that will run actions when a parameter is\neither added, removed, or changed.\n\nWhen the trigger is enabled it is added to the Manager class since that\nis where parameters are stored, and then the Manager watches for\nparameter changes and runs actions as needed.\n\nThe JSON config would look like:\n{\n    \"class\": \"parameter\",\n    \"parameter\": \"pcie_floor_index\"\n}\n\nSigned-off-by: Matt Spinler <spinler@us.ibm.com>\nChange-Id: I8ff281d49ac780e8ff38f3e8ed02ab95395f1fd3\n",
    "createdOn": 1636474862,
    "lastUpdated": 1638384626,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1636474862,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1636474877,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1636474977,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/29962/ : SUCCESS"
        },
        {
            "timestamp": 1636584071,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Uploaded patch set 2: Patch Set 1 was rebased."
        },
        {
            "timestamp": 1636584086,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1636584192,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/30101/ : SUCCESS"
        },
        {
            "timestamp": 1637249584,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1637332364,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1638203295,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1638220007,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1638220023,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1638220104,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/30867/ : FAILURE"
        },
        {
            "timestamp": 1638220170,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1638220187,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1638220295,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/30877/ : SUCCESS"
        },
        {
            "timestamp": 1638305750,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 4:\n\n(2 comments)"
        },
        {
            "timestamp": 1638314737,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1638375660,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1638375660,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1638375677,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1638375790,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/30989/ : SUCCESS"
        },
        {
            "timestamp": 1638376731,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1638384626,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Change has been successfully merged by Matt Spinler"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "1e1bc1e85f96dc8635f858212b625450cc368a9f",
            "parents": [
                "f0723ee3f9c1412e5b9b9f479f383165142cda66"
            ],
            "ref": "refs/changes/14/48714/1",
            "uploader": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "createdOn": 1636474862,
            "author": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 23,
                    "deletions": 0
                },
                {
                    "file": "control/Makefile.am",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 31,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 44,
                    "deletions": -1
                },
                {
                    "file": "control/json/triggers/parameter.cpp",
                    "type": "ADDED",
                    "insertions": 49,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/parameter.hpp",
                    "type": "ADDED",
                    "insertions": 41,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/trigger.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 169,
            "sizeDeletions": 2
        },
        {
            "number": 2,
            "revision": "8194c5731ed5bce90432efbe5ff05f076e305681",
            "parents": [
                "c024d780229822fe4eb5a948b4e5d76a8e28f3f9"
            ],
            "ref": "refs/changes/14/48714/2",
            "uploader": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "createdOn": 1636584071,
            "author": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 19,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "To match how signals are configured, might as well just make this be \"parameter\"."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 19,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Done"
                },
                {
                    "file": "control/json/manager.cpp",
                    "line": 727,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "With ParamTriggerData type the same as SignalActions, this could change to something like:\n\n```\n    auto it = _parameterTriggers.find(name);\n    if (it != _parameterTriggers.end())\n    {\n        // Taken from signal.cpp::triggerSignal()'s returned lambda\n        std::for_each(actions.begin(), actions.end(),\n                      [&it->second = actions](auto& action) {\n                          actions.emplace_back(std::ref(action));\n                      });\n    }\n    else\n    {\n        ParamTriggerData triggerActions;\n        std::for_each(actions.begin(), actions.end(),\n                      [&triggerActions](auto& action) {\n                          triggerActions.emplace_back(std::ref(action));\n                      });\n        _parameterTriggers[name] = std::move(triggerActions);\n    }\n```"
                },
                {
                    "file": "control/json/manager.cpp",
                    "line": 727,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Ack"
                },
                {
                    "file": "control/json/manager.hpp",
                    "line": 119,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "May want to consider simplifying this similar to the change I did for signals -> https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-fan-presence/+/48858\n\nstd::vector<std::reference_wrapper<std::unique_ptr<ActionBase>>>;\n\nIn fact, may be able to reuse SignalActions from that change directly? maybe then we should have this \"parameter\" trigger be of `signal` class?"
                },
                {
                    "file": "control/json/manager.hpp",
                    "line": 119,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "Lets not have this be of `signal` class, but would be good to have this updated to use the updated SignalActions and maybe change that to be \"TriggerActions\" used by both signal and parameter triggers."
                },
                {
                    "file": "control/json/manager.hpp",
                    "line": 119,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "If I were to do that, then I'd have to write code in addParameterTrigger or in the calling lambda to convert the incoming vector of unique_ptrs into a vector of references. You'd still like that to be done so it can use that type?"
                },
                {
                    "file": "control/json/manager.hpp",
                    "line": 119,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "It seems it'd be better to flatten to a single vector of the actions instead of a vector-of-vector and there shouldnt be much to adjust in addParameterTrigger to do this? I've added a comment there on what can be done.\n\nEssentially the list of actions per trigger shouldnt be too long really, I'm just looking for the best structure to keep the actions organized in if there were to be more than one event configured to run different actions when the same member signal, etc.. is used to trigger them."
                },
                {
                    "file": "control/json/manager.hpp",
                    "line": 119,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 23,
                    "deletions": 0
                },
                {
                    "file": "control/Makefile.am",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 31,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 44,
                    "deletions": -1
                },
                {
                    "file": "control/json/triggers/parameter.cpp",
                    "type": "ADDED",
                    "insertions": 49,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/parameter.hpp",
                    "type": "ADDED",
                    "insertions": 41,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/trigger.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 169,
            "sizeDeletions": 2
        },
        {
            "number": 3,
            "revision": "53541c1afaf8d01eff735019aa4a58aace9deb41",
            "parents": [
                "1a19eadd2a5c86e3482400ffb3eef4108077cbe8"
            ],
            "ref": "refs/changes/14/48714/3",
            "uploader": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "createdOn": 1638220007,
            "author": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 23,
                    "deletions": 0
                },
                {
                    "file": "control/Makefile.am",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 31,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 44,
                    "deletions": -1
                },
                {
                    "file": "control/json/triggers/parameter.cpp",
                    "type": "ADDED",
                    "insertions": 49,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/parameter.hpp",
                    "type": "ADDED",
                    "insertions": 41,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/trigger.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 169,
            "sizeDeletions": 2
        },
        {
            "number": 4,
            "revision": "51dd3b802f4457166aacf5cafa2a00e48af66deb",
            "parents": [
                "1a19eadd2a5c86e3482400ffb3eef4108077cbe8"
            ],
            "ref": "refs/changes/14/48714/4",
            "uploader": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "createdOn": 1638220170,
            "author": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 23,
                    "deletions": 0
                },
                {
                    "file": "control/Makefile.am",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 31,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 44,
                    "deletions": -1
                },
                {
                    "file": "control/json/triggers/parameter.cpp",
                    "type": "ADDED",
                    "insertions": 48,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/parameter.hpp",
                    "type": "ADDED",
                    "insertions": 41,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/trigger.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 168,
            "sizeDeletions": 2
        },
        {
            "number": 5,
            "revision": "d0ba86a3a5deb0157bddee5cbc254ad248615e9c",
            "parents": [
                "31ba23c1911e3e594c1ca14d36cba7d12c6eca1c"
            ],
            "ref": "refs/changes/14/48714/5",
            "uploader": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "createdOn": 1638375660,
            "author": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 23,
                    "deletions": 0
                },
                {
                    "file": "control/Makefile.am",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "control/json/manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": -1
                },
                {
                    "file": "control/json/manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 47,
                    "deletions": -4
                },
                {
                    "file": "control/json/triggers/parameter.cpp",
                    "type": "ADDED",
                    "insertions": 48,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/parameter.hpp",
                    "type": "ADDED",
                    "insertions": 41,
                    "deletions": 0
                },
                {
                    "file": "control/json/triggers/signal.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -10
                },
                {
                    "file": "control/json/triggers/signal.hpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": -8
                },
                {
                    "file": "control/json/triggers/trigger.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 192,
            "sizeDeletions": 24
        }
    ]
}