{
    "project": "openbmc/openbmc",
    "branch": "master",
    "id": "I2d8b4f4eaf8ff6df092893760aaae9db2ce3917b",
    "number": 44477,
    "subject": "mmc-init: Add factory reset based on rwreset",
    "owner": {
        "name": "Isaac Kurth",
        "email": "isaac.kurth@ibm.com",
        "username": "IsaacPK"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/openbmc/+/44477",
    "commitMessage": "mmc-init: Add factory reset based on rwreset\n\nTo enable factory resets, the mmc-init.sh script checks on reboot if\nthe environment variable rwreset is set to \"true\". If it is, the rw\nparts of the file system that users may have modified are reformatted\nto remove all user changes and rwreset is set to \"false\".\n\nTested: Add a file to /var and use fw_setenv to set rwreset to true.\nReboot the machine and verify that the added file is gone and rwreset\nis set to false.\n\nSigned-off-by: Isaac Kurth <isaac.kurth@ibm.com>\nChange-Id: I2d8b4f4eaf8ff6df092893760aaae9db2ce3917b\n",
    "createdOn": 1624645117,
    "lastUpdated": 1626877298,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1624645117,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1624645161,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1624645170,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/4952/"
        },
        {
            "timestamp": 1624645663,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/4952/ : SUCCESS"
        },
        {
            "timestamp": 1624646958,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 1:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1624895667,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1624900992,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1624924807,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1624995632,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1625017275,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1625018849,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1625084378,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1625084422,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1625084429,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/5064/"
        },
        {
            "timestamp": 1625084439,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1625084903,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/5064/ : SUCCESS"
        },
        {
            "timestamp": 1625086211,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 2:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1625086305,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2:\n\n(1 comment)\n\nEventually this initrd will read the gpio being proposed with https://gerrit.openbmc-project.xyz/c/openbmc/docs/+/44557 in order to decide if a factory reset will be done .. Are you planning on adding that functionality in this commit or a follow-up commit?"
        },
        {
            "timestamp": 1625087488,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1625087569,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 2:\n\n> Patch Set 2:\n> \n> (1 comment)\n> \n> Eventually this initrd will read the gpio being proposed with https://gerrit.openbmc-project.xyz/c/openbmc/docs/+/44557 in order to decide if a factory reset will be done .. Are you planning on adding that functionality in this commit or a follow-up commit?\n\nI was thinking a follow-up commit so that one commit doesn't have have too much stuff going on."
        },
        {
            "timestamp": 1625606519,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1625606580,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1625606588,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/5133/"
        },
        {
            "timestamp": 1625607053,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/5133/ : SUCCESS"
        },
        {
            "timestamp": 1625608272,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 3:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1625660237,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1625676860,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1625745214,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1625778597,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1625778642,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1625778648,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/5203/"
        },
        {
            "timestamp": 1625779027,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1625779120,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/5203/ : SUCCESS"
        },
        {
            "timestamp": 1625780440,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 4:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1625781812,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4: Code-Review+1\n\nFeel free to ping me on Discord in ~5 days if no one else has given additional feedback."
        },
        {
            "timestamp": 1626201336,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 4: Code-Review+1"
        },
        {
            "timestamp": 1626208670,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 4:\n\n(3 comments)\n\n> > Eventually this initrd will read the gpio being proposed with https://gerrit.openbmc-project.xyz/c/openbmc/docs/+/44557 in order to decide if a factory reset will be done .. Are you planning on adding that functionality in this commit or a follow-up commit?\n> \n> I was thinking a follow-up commit so that one commit doesn't have have too much stuff \n\nI'm ok as long as this one just clears the variable so we don't end up reseting when we add that and don't have to add additional logic."
        },
        {
            "timestamp": 1626300035,
            "reviewer": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "message": "Patch Set 4:\n\n> Patch Set 4:\n> \n> (3 comments)\n> \n> > > Eventually this initrd will read the gpio being proposed with https://gerrit.openbmc-project.xyz/c/openbmc/docs/+/44557 in order to decide if a factory reset will be done .. Are you planning on adding that functionality in this commit or a follow-up commit?\n> > \n> > I was thinking a follow-up commit so that one commit doesn't have have too much stuff \n> \n> I'm ok as long as this one just clears the variable so we don't end up reseting when we add that and don't have to add additional logic.\n\nYup, the code I want to submit just clears the rwreset variable, so we shouldn't see rwreset with an unexpected value.\n\n> Ideally we would patch the upstream fwutils, but I don't know how long this has been considered legacy to know if it would be accepted.\n\nI don't really know enough about the upstream fwutils to comment on this."
        },
        {
            "timestamp": 1626697467,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 4: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1626877294,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4: Code-Review+2"
        },
        {
            "timestamp": 1626877298,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Change has been successfully rebased and submitted as 315698e53dfa383697599803d074b981946b0bfd by Patrick Williams"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "aa1c0e4e1ece1bbf06a9b7d520d147c9318153f7",
            "parents": [
                "f8fadb810cefd61f17e52db3104b8d779f2a2bcd"
            ],
            "ref": "refs/changes/77/44477/1",
            "uploader": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "createdOn": 1624645117,
            "author": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "line": 11,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Can you check how much space is added to the initramfs by these additions?\n\nWhile we aren't constrained on space, the compressed initrd has to be cryptographically checksummed every boot in addition to increasing the size of the image loaded into memory.\n\n(The alternative would be to rearrange the script to address /var after other mounts)."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "line": 11,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "I'm not sure how to check the size of initramfs, could you or someone else show me how?"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "line": 11,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "Okay, we figured out what files to look at for the size. \n\nFormat:\n\n<filename>\n<size in bytes before changes> -> <size in bytes after changes>\nDifference: <number of bytes>\nPercent change: <percentage>\n\nfitImage-obmc-phosphor-initramfs-p10bmc-p10bmc\n6,761,732 -> 6,801,452\nDifference: 39,720\nPercent change: 0.59%\n\nobmc-phosphor-initramfs-p10bmc.cpio.xz\n2,732,624 -> 2,774,836\nDifference: 42,212\nPercent change: 1.54%"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 52,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "What is the default lock directory?  Should we change it?  Should it be /run/lock ?"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 52,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "If I use fw_printenv with nothing specified with the --lock parameter it fails with this message: \"Error opening lock file /var/lock/fw_printenv.lock\" The failure is because there's no /var/lock directory. Running the command with --lock /run/lock would fail for the same reason.\n\nIt would be possible to use the default directory /var/lock if we first create /var/lock. /var is accessible at this point. Or it would be possible to use /run/lock if we create the lock directory in /run. Or it would be possible to just use /var.\n\nMy inclination is to leave it unchanged so we can avoid the extra step of creating a directory. Unless there's some benefit to using /var/lock or /run/lock that I'm not aware of."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 52,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "> Unless there's some benefit to using /var/lock or /run/lock that I'm not aware of.\n\nFollowing standard file system placement.  See `man hier | grep lock -A1`.\n\nSee also https://en.wikipedia.org/wiki/Principle_of_least_astonishment"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 52,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "That makes sense. I can add 'mkdir /var/lock' so people aren't surprised by seeing a lock file in /run. Originally I didn't realize I could use /var in the middle of booting but it seems like I can."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 52,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "Done"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 54,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Need to remove \"--lock /run\" from here as well. Should we just clear (remove) the rwreset variable with \"fw_setenv rwreset\" instead of setting it to false? The rwreset variable doesn't exist in the default environment."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 54,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "Agree, I'll remove the extra --lock run and just clear rwreset instead of setting it to false."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 54,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "the lock directory has moved to /run/lock and /var/lock is a symlink when we get running.\nhttps://github.com/systemd/systemd/blob/bedc15706e213a806b18824d1bcb66d381fa2a06/tmpfiles.d/legacy.conf#L14"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 9,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "6c393fd62e706d9e3243d69443b953a63a7cdb5b",
            "parents": [
                "f8fadb810cefd61f17e52db3104b8d779f2a2bcd"
            ],
            "ref": "refs/changes/77/44477/2",
            "uploader": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "createdOn": 1625084378,
            "author": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 10,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "bd71df1b52cc0b3a6d170d651b5c0f040a622bb0",
            "parents": [
                "f8fadb810cefd61f17e52db3104b8d779f2a2bcd"
            ],
            "ref": "refs/changes/77/44477/3",
            "uploader": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "createdOn": 1625606519,
            "author": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 56,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Probably should swap the order here, right?\n\nDo we need to catch any failures from 'mkfs.ext4'?  Why or why not?"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 56,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "Honestly, I'm not sure because I haven't worked with mkfs.ext4 / mke2fs much before. I'll ask around and see what people think. The folks I would normally consult with about this are on vacation right now. And my thoughts on the ordering of those lines depends on what we can expect in terms of errors / failures."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 56,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Normally I like all scripts to be 'set -e', but I think because of how this is called in the boot sequence that ends up being a bad idea (as it results in a kernel panic, I suspect).\n\nIt appears, based on line 47, that this script tends to catch failures and then escape to an emergency shell on error to let the user (at a console??) attempt to fix things up.  I don't know how this is useful in production though because the console is usually disabled.\n\nUnless you get feedback otherwise from Milton, my suggestion would be to arrange the code like this:\n\n  echo \"Factory Reset requested.\"\n  if ! mkfs.ext4 -F \"${rwfsdev}\"; then\n      echo \"Reformat for Factory Reset failed.\"\n      /bin/sh\n  fi\n  fw_setenv rwreset\n\nThis way:\n1. we are catching failures from mkfs.ext4 and not blindly continuing on.\n2. we do not reset the u-boot flag, and will try again on next reboot, unless there really is a user at the console who [hopefully] did some kind of recovery."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 56,
                    "reviewer": {
                        "name": "Isaac Kurth",
                        "email": "isaac.kurth@ibm.com",
                        "username": "IsaacPK"
                    },
                    "message": "I agree with Patrick's ideas here and put the in the next patchset. The one difference is that instead of ending the failure clause with fi, I end it with else, so that resetting rwreset and printing a statement that we succeeded can only happen if the reformatting went correctly."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 56,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "@Patrick, \nThe script has to allow multiple valid informational return codes from fsck and would need significant changes to run with -e.   \nSee https://gerrit.openbmc-project.xyz/c/openbmc/openbmc/+/42094 for more discussion"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 10,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "f448cc05556336ecabb71ea08abb172ef0df5f76",
            "parents": [
                "f8fadb810cefd61f17e52db3104b8d779f2a2bcd"
            ],
            "ref": "refs/changes/77/44477/4",
            "uploader": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "createdOn": 1625778597,
            "author": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 52,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "ranther than creating a directory in var that we are going to overmount, can we just makedir /run/lock and use it ?\n\nUpdate: found discussion in prior thread about \"just using default\" var/lock.\n\nIdeally we would patch the upstream fwutils, but I don't know how long this has been considered legacy to know if it would be accepted."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 52,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "We can do this in a follow up"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 14,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "315698e53dfa383697599803d074b981946b0bfd",
            "parents": [
                "e11f5e254ccae62d15a1ad5e1b7ff03feb71a515"
            ],
            "ref": "refs/changes/77/44477/5",
            "uploader": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "createdOn": 1626877298,
            "author": {
                "name": "Isaac Kurth",
                "email": "isaac.kurth@ibm.com",
                "username": "IsaacPK"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init.bb",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 14,
            "sizeDeletions": 0
        }
    ]
}