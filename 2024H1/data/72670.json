{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "id": "Ide90abdbc4c6e88215049783b88d9e91902c554d",
    "number": 72670,
    "subject": "Fix coredump when restart service if created subscriptions",
    "owner": {
        "name": "wenlitao",
        "email": "w_litao@linux.alibaba.com",
        "username": "w-litao"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/bmcweb/+/72670",
    "hashtags": [],
    "createdOn": 1720754843,
    "lastUpdated": 1721108550,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1720754843,
            "reviewer": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1720754873,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1720754873,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1720756220,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1720756445,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/87827/ : SUCCESS"
        },
        {
            "timestamp": 1720800236,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1721007907,
            "reviewer": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1721008078,
            "reviewer": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1721010478,
            "reviewer": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1721010513,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1721010513,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1721010558,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1721011929,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/87930/ : SUCCESS"
        },
        {
            "timestamp": 1721012559,
            "reviewer": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1721091525,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1721108450,
            "reviewer": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1721108547,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1721108548,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2: Code-Review+2"
        },
        {
            "timestamp": 1721108550,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Change has been successfully rebased and submitted as fbfb788061e52ceac6156d9e24434e46aa1211d2"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "722d99dc952186a67d28e8acfa75246c8a0711c8",
            "parents": [
                "ac1e1246464e28fe4313ba936a6b8f64ec65bb12"
            ],
            "ref": "refs/changes/70/72670/1",
            "uploader": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "createdOn": 1720754843,
            "author": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I\u2019m not understanding what the crash is.  yes, this is making a copy of a shared ptr instead of a reference.  why is that a problem?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "wenlitao",
                        "email": "w_litao@linux.alibaba.com",
                        "username": "w-litao"
                    },
                    "message": "I used gdb to debug this problem, but didn't get a clear answer, then I found the problem here through the code. Some info may help:\n\ncrash log:\nJul 27 16:57:48 sn123456 systemd[1]: Stopping bmcweb server...\nJul 27 16:57:50 sn123456 systemd[1]: bmcweb.service: Main process exited, code=dumped, status=11/SEGV\nJul 27 16:57:50sn123456 systemd[1]: bmcweb.service: Failed with result 'core-dump'.\nJul 27 16:57:50 sn123456 systemd[1]: Stopped bmcweb server.\n\ngdb debug:\n(gdb) signal SIGTERM\nContinuing with signal SIGTERM.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0073621c in boost::system::error_code::operator=<boost::asio::error::basic_errors>(boost::asio::error::basic_errors) [clone .isra.0] (this=this@entry=0x66647339, val=val@entry=boost::asio::error::operation_aborted)\n    at /usr/include/boost/system/detail/error_code.hpp:207\n207     /usr/include/boost/system/detail/error_code.hpp: No such file or directory.\n(gdb) bt\n#0  0x0073621c in boost::system::error_code::operator=<boost::asio::error::basic_errors>(boost::asio::error::basic_errors) [clone .isra.0] (this=this@entry=0x66647339, val=val@entry=boost::asio::error::operation_aborted)\n    at /usr/include/boost/system/detail/error_code.hpp:207\n#1  0x00682a34 in boost::asio::detail::epoll_reactor::deregister_descriptor (this=0x146e4c8, descriptor=<optimized out>, \n    descriptor_data=@0x1470610: 0x146de78, closing=<optimized out>)\n    at /usr/include/boost/asio/detail/impl/epoll_reactor.ipp:411\n#2  0x00659538 in boost::asio::detail::reactive_descriptor_service::release (impl=..., this=<optimized out>)\n    at /usr/include/boost/asio/detail/impl/reactive_descriptor_service.ipp:164\n#3  boost::asio::posix::basic_descriptor<boost::asio::any_io_executor>::release (this=0x1470604)\n    at /usr/include/boost/asio/posix/basic_descriptor.hpp:381\n#4  sdbusplus::asio::connection::~connection (this=<optimized out>, this=<optimized out>)\n    at /usr/include/sdbusplus/asio/connection.hpp:72\n#5  std::destroy_at<sdbusplus::asio::connection> (__location=0x14705ec) at /usr/include/c++/12.2.0/bits/stl_construct.h:88\n#6  std::_Destroy<sdbusplus::asio::connection> (__pointer=0x14705ec) at /usr/include/c++/12.2.0/bits/stl_construct.h:149\n#7  std::allocator_traits<std::allocator<void> >::destroy<sdbusplus::asio::connection> (__p=0x14705ec)\n    at /usr/include/c++/12.2.0/bits/alloc_traits.h:648\n#8  std::_Sp_counted_ptr_inplace<sdbusplus::asio::connection, std::allocator<void>, (__gnu_cxx::_Lock_policy)2>::_M_dispose (\n    this=0x14705e0) at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:613\n#9  0x00447060 in std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release_last_use (this=0x14705e0)\n    at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:361\n#10 std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release (this=0x14705e0)\n    at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:361\n#11 0x005277f8 in std::__shared_count<(__gnu_cxx::_Lock_policy)2>::~__shared_count (this=<optimized out>, \n    this=<optimized out>) at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:1071\n#12 0x00447060 in std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release_last_use (this=0x147b308)\n    at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:361\n#13 std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release (this=0x147b308)\n    at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:361\n#14 0x005277f8 in std::__shared_count<(__gnu_cxx::_Lock_policy)2>::~__shared_count (this=<optimized out>, \n    this=<optimized out>) at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:1071\n#15 0x00527a00 in std::__shared_ptr<sdbusplus::asio::dbus_interface, (__gnu_cxx::_Lock_policy)2>::~__shared_ptr (\n--Type <RET> for more, q to quit, c to continue without paging--c\n    this=<optimized out>, this=<optimized out>) at /usr/include/c++/12.2.0/bits/shared_ptr_base.h:1524\n#16 std::shared_ptr<sdbusplus::asio::dbus_interface>::~shared_ptr (this=<optimized out>, this=<optimized out>) at /usr/include/c++/12.2.0/bits/shared_ptr.h:175\n#17 0x7674f330 in ?? () from target:/lib/libc.so.6\nBacktrace stopped: previous frame identical to this frame (corrupt stack?)"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "how do you reproduce it?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "wenlitao",
                        "email": "w_litao@linux.alibaba.com",
                        "username": "w-litao"
                    },
                    "message": "Go through the following steps:\n1. Use redfish to create multiple subscriptions (it seems that the more subscriptions, the higher the probability of crash)\ncurl -k -u user:passwd -X POST https://192.168.252.132/redfish/v1/EventService/Subscriptions/ -d '\n{\n\"Context\": \"CustomText\",\n\"Destination\": \"https://30.221.33.11:5678\",\n\"Protocol\": \"Redfish\",\n\"EventFormatType\": \"Event\",\n\"DeliveryRetryPolicy\": \"RetryForever\",\n\"ResourceTypes\": [\n\"Task\"\n],\n\"HttpHeaders\": [\n{\n\"Authentication\": \"Splunk 49ce1-sdfoijf-wegsdfe-qwessddasd\"\n}\n]\n}'\n2. Restart bmcweb\nsystemctl restart bmcweb.service"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "```\n#0  0x00704150 in boost::asio::detail::epoll_reactor::deregister_descriptor (this=0x0, descriptor=8,\n    descriptor_data=@0x81dd08: 0xc223a8, closing=false) at /usr/include/boost/asio/detail/impl/epoll_reactor.ipp:403\n403\t/usr/include/boost/asio/detail/impl/epoll_reactor.ipp: No such file or directory.\n(gdb)\n(gdb) where\n#0  0x00704150 in boost::asio::detail::epoll_reactor::deregister_descriptor (this=0x0, descriptor=8,\n    descriptor_data=@0x81dd08: 0xc223a8, closing=false) at /usr/include/boost/asio/detail/impl/epoll_reactor.ipp:403\n#1  0x0076b16c in boost::asio::detail::reactive_descriptor_service::destroy (impl=..., this=0xbfa440)\n    at /usr/include/boost/asio/detail/impl/reactive_descriptor_service.ipp:94\n#2  boost::asio::detail::io_object_impl<boost::asio::detail::reactive_descriptor_service, boost::asio::any_io_executor>::~io_object_impl() [clone .isra.0] (this=<optimized out>, this=<optimized out>) at /usr/include/boost/asio/detail/io_object_impl.hpp:95\n#3  0x005e431c in boost::asio::posix::basic_descriptor<boost::asio::any_io_executor>::~basic_descriptor (this=<optimized out>,\n    this=<optimized out>) at /usr/include/boost/asio/posix/basic_descriptor.hpp:718\n#4  boost::asio::posix::basic_stream_descriptor<boost::asio::any_io_executor>::~basic_stream_descriptor (this=<optimized out>,\n    this=<optimized out>) at /usr/include/boost/asio/posix/basic_stream_descriptor.hpp:49\n#5  std::_Optional_payload_base<boost::asio::posix::basic_stream_descriptor<boost::asio::any_io_executor> >::_M_destroy (\n    this=0x81dcfc <_ZN7redfishL11inotifyConnE.lto_priv.0>) at /usr/include/c++/13.2.0/optional:287\n#6  std::_Optional_payload_base<boost::asio::posix::basic_stream_descriptor<boost::asio::any_io_executor> >::_M_reset (\n    this=0x81dcfc <_ZN7redfishL11inotifyConnE.lto_priv.0>) at /usr/include/c++/13.2.0/optional:318\n#7  std::_Optional_payload<boost::asio::posix::basic_stream_descriptor<boost::asio::any_io_executor>, false, false, false>::~_Optional_payload (this=<optimized out>, this=<optimized out>) at /usr/include/c++/13.2.0/optional:439\n#8  std::_Optional_base<boost::asio::posix::basic_stream_descriptor<boost::asio::any_io_executor>, false, false>::~_Optional_base (this=<optimized out>, this=<optimized out>) at /usr/include/c++/13.2.0/optional:510\n#9  std::optional<boost::asio::posix::basic_stream_descriptor<boost::asio::any_io_executor> >::~optional (\n    this=<optimized out>, this=<optimized out>) at /usr/include/c++/13.2.0/optional:705\n#10 0x7663aa30 in __run_exit_handlers (status=12556632, listp=0x7663aa30 <__run_exit_handlers+476>,\n    run_list_atexit=run_list_atexit@entry=true, run_dtors=run_dtors@entry=true) at exit.c:108\n#11 0x7663abec in __GI_exit (status=<optimized out>) at exit.c:138\n#12 0x76623434 in __libc_start_call_main (main=0x76623434 <__libc_start_call_main+112>, main@entry=0x38, argc=1987448408,\n    argc@entry=1987453688, argv=0x5024d0 <main(int, char**)>, argv@entry=0x7e8c8e14)\n    at /usr/src/debug/glibc/2.39+git/sysdeps/nptl/libc_start_call_main.h:74\n#13 0x7662351c in __libc_start_main_impl (main=0x38, argc=1987453688, argv=0x7e8c8e14, init=<optimized out>, fini=0x0,\n    rtld_fini=0x76f08998 <_dl_fini>, stack_end=0x7e8c8e14) at libc-start.c:360\n#14 0x00503bec in _start () at ../sysdeps/arm/start.S:105\n```\n\nThis is the result I get when I look at the coredump.\n\nWe should do your fix as well (please get it rewritten to just be the change to the reference), but I believe this is the underlying problem.\n\nhttps://gerrit.openbmc.org/c/openbmc/bmcweb/+/72784\n\nIf you could test that, I'd appreciate it."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "wenlitao",
                        "email": "w_litao@linux.alibaba.com",
                        "username": "w-litao"
                    },
                    "message": "I have rewritten it as a reference, and I tested the combination of these two patches dozens of times, and no more crash was found."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Done"
                },
                {
                    "file": "include/persistent_data.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "could we instead just make this a reference?  Keeping the variable name is more descriptive."
                },
                {
                    "file": "include/persistent_data.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "wenlitao",
                        "email": "w_litao@linux.alibaba.com",
                        "username": "w-litao"
                    },
                    "message": "Yes, it works, I modified it to:\nconst UserSubscription& subValue = *it.second;\nTested 500 times and the problem did not appear."
                },
                {
                    "file": "include/persistent_data.hpp",
                    "line": 266,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "include/persistent_data.hpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -14
                }
            ],
            "sizeInsertions": 35,
            "sizeDeletions": 14
        },
        {
            "number": 2,
            "revision": "9d4177825c14d940063f60130ed27ba6e6ea4d7f",
            "parents": [
                "ac1e1246464e28fe4313ba936a6b8f64ec65bb12"
            ],
            "ref": "refs/changes/70/72670/2",
            "uploader": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "createdOn": 1721010478,
            "author": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "include/persistent_data.hpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -14
                }
            ],
            "sizeInsertions": 36,
            "sizeDeletions": 14
        },
        {
            "number": 3,
            "revision": "fbfb788061e52ceac6156d9e24434e46aa1211d2",
            "parents": [
                "67b159036d12c8db99255714fdf3d230cd4f2e70"
            ],
            "ref": "refs/changes/70/72670/3",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1721108550,
            "author": {
                "name": "wenlitao",
                "email": "w_litao@linux.alibaba.com",
                "username": "w-litao"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "include/persistent_data.hpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -14
                }
            ],
            "sizeInsertions": 36,
            "sizeDeletions": 14
        }
    ]
}