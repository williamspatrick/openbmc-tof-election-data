{
    "project": "openbmc/sdbusplus",
    "branch": "master",
    "id": "I8559e078edee2ac1dbefef838c9317956d3d011a",
    "number": 68959,
    "subject": "WIP: Add asio match expression",
    "owner": {
        "name": "Ed Tanous",
        "email": "ed@tanous.net",
        "username": "edtanous"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/sdbusplus/+/68959",
    "hashtags": [],
    "createdOn": 1705712728,
    "lastUpdated": 1705876689,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1705712728,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1705712749,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1705712749,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1705712834,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 2: Patch Set 1 was rebased."
        },
        {
            "timestamp": 1705712854,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1705712854,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1705712856,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/78238/ : ABORTED"
        },
        {
            "timestamp": 1705713271,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/78240/ : SUCCESS"
        },
        {
            "timestamp": 1705718037,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1705869148,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3: Commit message was updated.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1705869187,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1705869187,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1705869339,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1705869360,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/78245/ : FAILURE"
        },
        {
            "timestamp": 1705870244,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 4: Commit message was updated.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1705870253,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1705870253,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: -Ok-To-Test"
        },
        {
            "timestamp": 1705870426,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/78246/ : FAILURE"
        },
        {
            "timestamp": 1705876272,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 5: Commit message was updated.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1705876294,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1705876294,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: -Ok-To-Test"
        },
        {
            "timestamp": 1705876689,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/78247/ : SUCCESS"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "02592227537aefc486f15727d7fa4830535e6843",
            "parents": [
                "2534123b3444d0a2ca47a28fbbc22d9be08a4fc7"
            ],
            "ref": "refs/changes/59/68959/1",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1705712728,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "type": "ADDED",
                    "insertions": 90,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "test/bus/match_async.cpp",
                    "type": "ADDED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 173,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "88c8736d14718937ae2642a84b4f9573d90cd0ce",
            "parents": [
                "5828bccf3e0e50c15ce0ddd29d55551f08d55f2f"
            ],
            "ref": "refs/changes/59/68959/2",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1705712834,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "line": 54,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I'm not sure how it is useful to use the same callback for install as event.\n\nTypically you want to:\n1. install a match\n2. check for the presence / absence of an object and do something about it\n\nYou really can't do #2 until you know #1 is done, otherwise you're likely to miss the event you really wanted to see.  If I can't explicitly stop #2, then I might be late at installing the match and early at observing the state (or vice versa) and assume the wrong state forever.\n\nThis is the same problem I was trying to convey to LeiYU in his attempt at this."
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "line": 54,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> I'm not sure how it is useful to use the same callback for install as event.\n\nIt's an asio convention to return a single callback for a single \"async\" request.  Admittedly, I haven't done that properly here, so I'm not surprised that it looks confusing.\n\nThe main intent was twofold.  First, to prevent installing a \"do nothing\" callback on the install handler.  If you have a single callback, you MUST handle the failure case.  With dual callbacks, it's easy enough to throw install failures to a lambda of ```[](){};``` and do nothing about them.\nSecond, having a single callback invoked as part of the constructor makes the diff from the match_t object API smaller, and able to be an automated regex-like change to clients.\n\nI'm not convinced either of these are good enough reasons to have a mediocre API, but that's also why I had this patch in reserve for the last year and hadn't published it patch until Lei brought up the issue.\n\nMy intent was to make this look more like the signal_set API, queuing responses, and returning operation_aborted on destruction of the main object, like all the other ASIO APIs do.\nhttps://www.boost.org/doc/libs/1_84_0/doc/html/boost_asio/reference/signal_set.html\n\nI'm not sure if that's a good idea either because queuing internally in the object is a pain and adds complexity.\n\nTL; DR, I need to play around with things more, and I haven't had the time.\n\n>  > Typically you want to:\n> 1. install a match\n> 2. check for the presence / absence of an object and do something about it\n> \n> You really can't do #2 until you know #1 is done, otherwise you're likely to miss the event you really wanted to see.  If I can't explicitly stop #2, then I might be late at installing the match and early at observing the state (or vice versa) and assume the wrong state forever.\n> \n> This is the same problem I was trying to convey to LeiYU in his attempt at this.\n\nI'm not sure I understand what \"explicitly stop #2\" means?  I've seen two flows for match expressions.\n1. Order doesn't matter (or the author didn't care about possible races), we just want to be informed if X thing changes.  On install failure, we want to crash or log an error.\n\n2. Set up a match, verify it's installed, then query the value of a property.  You now have a cache of that property's current value, and will be informed on changes.  On install failure, generally you want to destroy the match object, and return a value to the user that their operation failed."
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "line": 76,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Is there a real rationale on why we need to install the match async?  It seems like both of you are working around a real bug elsewhere.  There is no reason that sd-bus, the library, can't have both sync and async calls in the same thread."
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "line": 76,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "You are absolutely right, sd-bus can have blocking and async calls on the same thread (and that works today).  The problem is what happens to everything else that's on the same reactor.\n\n(I initially typed a reply here, then just added it to the commit message, read the new commit message first before continuing).\n\nThe same thing would happen in reverse if we called a blocking HTTP operation (read_some instead of async_read_some), all DBus operations would get blocked, until the HTTP operation in asio completed.\n\nShort of putting each connection type (DBus, http, timers) on its own thread, I can't think of a way to fix this aside from making sure that calls done from async callbacks are also async (and I'm assuming that's why sd-bus added the method).  Ideally if we get rid of the public sdbusplus::bus_t inheritance in the future, prior to doing blocking calls on an asio connection, we could check for io_context::stopped(), to ensure that the blocking call isn't being done from within an async callback that would block the reactor.  That would result in a runtime error instead of a compile time error, but at least both paths would be supported, and if you blocked all events, at least you would get an error, instead of YOUR code working fine, while breaking other things.  This patch, or something resembling it would still be the first step to that.\n\nI've rambled enough.  Hopefully it makes sense."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "type": "ADDED",
                    "insertions": 90,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "test/bus/match_async.cpp",
                    "type": "ADDED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 173,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "41d095ebf3e5e859121c0151e483cb13c64e6056",
            "parents": [
                "5828bccf3e0e50c15ce0ddd29d55551f08d55f2f"
            ],
            "ref": "refs/changes/59/68959/3",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1705869148,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "type": "ADDED",
                    "insertions": 90,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "test/bus/match_async.cpp",
                    "type": "ADDED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 183,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "42df07e811896f3ad0be0deec53f32d1f6767fff",
            "parents": [
                "5828bccf3e0e50c15ce0ddd29d55551f08d55f2f"
            ],
            "ref": "refs/changes/59/68959/4",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1705870244,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "type": "ADDED",
                    "insertions": 90,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "test/bus/match_async.cpp",
                    "type": "ADDED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 182,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "440b467da9eb3e860e9943afe9da1553e9e8d0f3",
            "parents": [
                "5828bccf3e0e50c15ce0ddd29d55551f08d55f2f"
            ],
            "ref": "refs/changes/59/68959/5",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1705876272,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/connection.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/asio/match.hpp",
                    "type": "ADDED",
                    "insertions": 90,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "test/bus/match_async.cpp",
                    "type": "ADDED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 182,
            "sizeDeletions": 0
        }
    ]
}