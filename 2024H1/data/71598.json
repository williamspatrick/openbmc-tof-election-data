{
    "project": "openbmc/phosphor-logging",
    "branch": "master",
    "id": "I71cf045bf06f1c55fa3bb81a85f7f92fc0f950fe",
    "number": 71598,
    "subject": "RFC: Add new api report_metadata to post metadata to dbus",
    "owner": {
        "name": "Jian Zhang",
        "email": "zhangjian3032@gmail.com",
        "username": "zhangjian3032"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-logging/+/71598",
    "hashtags": [],
    "createdOn": 1716477516,
    "lastUpdated": 1717122686,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1716477516,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1716477568,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1716477568,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1716477665,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/84815/ : FAILURE"
        },
        {
            "timestamp": 1716477992,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1716478295,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1716478332,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1716478332,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1716478426,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/84816/ : FAILURE"
        },
        {
            "timestamp": 1716518245,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Uploaded patch set 3: Commit message was updated.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1716518270,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1716518270,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1716518363,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/84833/ : FAILURE"
        },
        {
            "timestamp": 1716519134,
            "reviewer": {
                "name": "Lei YU",
                "email": "mine260309@gmail.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1716530114,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1716965630,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1717019984,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1717122686,
            "reviewer": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "577248445cdcb88ea13533cdcec98e1bf403ae4e",
            "parents": [
                "e8026679f89642e3336b8c5e495f6ab694988e7a"
            ],
            "ref": "refs/changes/98/71598/1",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1716477516,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "please ignore the CI issue, need update the dbus-interfaces...\njust for rfc, maybe we have other fix"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 54,
                    "deletions": 0
                },
                {
                    "file": "log_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "log_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "yaml/xyz/openbmc_project/Logging/Internal/Manager.interface.yaml",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "lib/include/phosphor-logging/elog.hpp",
                    "type": "MODIFIED",
                    "insertions": 64,
                    "deletions": 0
                },
                {
                    "file": "lib/elog.cpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "tools/phosphor-logging/templates/elog-gen-template.mako.hpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 199,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "b19f233ca636724f25532f108c5c8f436695c4e1",
            "parents": [
                "e8026679f89642e3336b8c5e495f6ab694988e7a"
            ],
            "ref": "refs/changes/98/71598/2",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1716478295,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 54,
                    "deletions": 0
                },
                {
                    "file": "log_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "log_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "yaml/xyz/openbmc_project/Logging/Internal/Manager.interface.yaml",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "lib/include/phosphor-logging/elog.hpp",
                    "type": "MODIFIED",
                    "insertions": 64,
                    "deletions": 0
                },
                {
                    "file": "lib/elog.cpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "tools/phosphor-logging/templates/elog-gen-template.mako.hpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 198,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "422dd7f8fd094b3a00c189033280832c1eba4d1b",
            "parents": [
                "e8026679f89642e3336b8c5e495f6ab694988e7a"
            ],
            "ref": "refs/changes/98/71598/3",
            "uploader": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "createdOn": 1716518245,
            "author": {
                "name": "Jian Zhang",
                "email": "zhangjian3032@gmail.com",
                "username": "zhangjian3032"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Have you seen https://gerrit.openbmc.org/c/openbmc/docs/+/71489 that also proposes removing the journal from event logs?  Maybe that never comes to fruition, or maybe it takes a very long time, but if nothing else is there anything in that doc that could help here?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "Sorry, I haven't noticed it yet, I\u2018ll look into it."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 43,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "So no changes needed at the call sites, right?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 43,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "If we accept directly overriding the original function (instead of using a new API report_metadata), no modifications are needed at the call sites. The current changes have undergone extensive stress testing, and no log loss has been observed."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 47,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "mine260309@gmail.com",
                        "username": "mine260309"
                    },
                    "message": "This approach can mitigate issues by creating the log entry directly with metadata as the parameters of the call, instead of consuming the sd-journal."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 47,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "yup, currently the log chain is:\n1, log generate app -> journald'\n2, log generate app -> (dbus-call) logging\n3, logging notify(dbus) systemd sent signal to journald\n4, journald write file to local storage\n5, logging wait journald write done (we expect it, but in reality it is not.)\n6, get metadata...\n\nthe chain is too long, there are often difficult to diagnose and reproduce."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "Hi, Friendly ping"
                },
                {
                    "file": "lib/elog.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "I kinda liked how the other versions would automatically add _PID to the additional data by pulling it from the journal.  I there a way to still get that here?"
                },
                {
                    "file": "lib/elog.cpp",
                    "line": 56,
                    "reviewer": {
                        "name": "Jian Zhang",
                        "email": "zhangjian3032@gmail.com",
                        "username": "zhangjian3032"
                    },
                    "message": "all right, we could."
                },
                {
                    "file": "lib/include/phosphor-logging/elog.hpp",
                    "line": 115,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "mine260309@gmail.com",
                        "username": "mine260309"
                    },
                    "message": "Possibly `const &`"
                },
                {
                    "file": "tools/phosphor-logging/templates/elog-gen-template.mako.hpp",
                    "line": 79,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "mine260309@gmail.com",
                        "username": "mine260309"
                    },
                    "message": "Need to check `if (n < 0)` to handle the error case."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 54,
                    "deletions": 0
                },
                {
                    "file": "log_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "log_manager.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": 0
                },
                {
                    "file": "yaml/xyz/openbmc_project/Logging/Internal/Manager.interface.yaml",
                    "type": "MODIFIED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "lib/include/phosphor-logging/elog.hpp",
                    "type": "MODIFIED",
                    "insertions": 64,
                    "deletions": 0
                },
                {
                    "file": "lib/elog.cpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "tools/phosphor-logging/templates/elog-gen-template.mako.hpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 198,
            "sizeDeletions": 0
        }
    ]
}