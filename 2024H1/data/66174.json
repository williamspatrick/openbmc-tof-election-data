{
    "project": "openbmc/x86-power-control",
    "branch": "master",
    "id": "Ic5c486cb93dd60fc21f1214a6e7ee803de960cf4",
    "number": 66174,
    "subject": "config option: power button uses hw powercontrol",
    "owner": {
        "name": "Alexander",
        "email": "alexander.hansen@9elements.com",
        "username": "pointbazaar"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/x86-power-control/+/66174",
    "hashtags": [],
    "createdOn": 1692622915,
    "lastUpdated": 1704798934,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1692622915,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1692622947,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1692622947,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1692622971,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/73234/ : FAILURE"
        },
        {
            "timestamp": 1692623136,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1692623152,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1692623152,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1692623174,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/73235/ : FAILURE"
        },
        {
            "timestamp": 1692623277,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Uploaded patch set 3.\n\nOutdated Votes:\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1692623312,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1692623312,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: -Ok-To-Test"
        },
        {
            "timestamp": 1692623370,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/73236/ : SUCCESS"
        },
        {
            "timestamp": 1692748706,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1692779255,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 3: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1692836853,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1692878294,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Patch Set 3: -Code-Review\n\n(2 comments)"
        },
        {
            "timestamp": 1704798934,
            "reviewer": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "message": "Abandoned\n\nstale"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "cdf8c4b2d76427dff572f1007e1a3b5ffb541139",
            "parents": [
                "2ae5308d69f1bac6b82f6918780fefb0f869aad5"
            ],
            "ref": "refs/changes/74/66174/1",
            "uploader": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "createdOn": 1692622915,
            "author": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "README.md",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 52,
            "sizeDeletions": 2
        },
        {
            "number": 2,
            "revision": "abe28a00706ede5a6a880a77acf2d00c4ddf21e4",
            "parents": [
                "2ae5308d69f1bac6b82f6918780fefb0f869aad5"
            ],
            "ref": "refs/changes/74/66174/2",
            "uploader": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "createdOn": 1692623136,
            "author": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "README.md",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 56,
            "sizeDeletions": 2
        },
        {
            "number": 3,
            "revision": "1de004caa17c95757d77af6b0e195e3cae897f23",
            "parents": [
                "2ae5308d69f1bac6b82f6918780fefb0f869aad5"
            ],
            "ref": "refs/changes/74/66174/3",
            "uploader": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "createdOn": 1692623277,
            "author": {
                "name": "Alexander",
                "email": "alexander.hansen@9elements.com",
                "username": "pointbazaar"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "I'm a bit confused about the hardware arrangement this is intended to handle.  On all the systems I'm using x86-power-control on the power button is only connected to a BMC GPIO and isn't wired directly to anything else, so it's up to the BMC to handle it in software (or via an ast2500 GPIO passthrough configuration, but that's sort of tangential), and the existing code works fine.  What's different about the Tyan hardware that necessitates altering the logic in this daemon?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "if i understand the code correctly, \ndifferent events happen and then getPowerStateHandler(...)\nreturns the event handler for that power state to handle it.\n\n'powerStateOn(...)' is such a handler.\nInside that handler, if event is Event::powerButtonPressed\nit was the case that following code would be run:\n\nsetPowerState(PowerState::gracefulTransitionToOff);\ngracefulPowerOffTimerStart();\n\nwhich changes the power state (has no effect on any gpios or power control hw)\nand starts a timer (has no effect on any gpios or power control hw).\n\nNow the powerStateGracefulTransitionToOff\ncan receive Event::psPowerOKDeAssert event \nwhich can cancel that timer and transition to PowerState::off.\n\nIn my opinion, to explain the diff to the power control happening in case of dbus \nEvent::powerOffRequest, the \nassertGPIOForMs(powerOutConfig, TimerMap[\"ForceOffPulseMs\"])\nfrom forcePowerOff function has to happen in hardware.\n\nIf it were just a gpio without connection to power control logic, where is the power control happening? Which function is then causing the powerok gpio to change state? And why would the logic in that case be any different than a power on/off request from dbus?\n\nOn the specific Tyan S5549 Chassis that this patch is for, x86-power-control registers the button press but the expected change in powerok gpio does not happen without this patch.\n\nOn another Tyan S8030 the x86-power-control works without issue. In both cases the button press is registered."
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Oh, sorry -- I had forgotten that my systems are in fact also dependent on the Aspeed GPIO passthrough feature for this, so it's not actually as tangential as I'd thought.  Might that be an option for the S5549?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "yes, it might be. I can try it out, maybe this patch is not needed after all.\nDo you have any other examples than aspeed-bmc-inspur-nf5280m6.dts which can be shared? \n\nWhen applying it's configuration, it did not have the same effect as this patch. Maybe some mistake on my part. Some devicetree snippet would already help."
                },
                {
                    "file": "src/power_control.cpp",
                    "line": 1730,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Do we really want a single power button press to proceed directly to a forceful power cut?  I think on most systems it's treated more like `gracefulPowerOffRequest`, and to trigger a hard power-cut you press and hold the button for something like 6 seconds or so."
                },
                {
                    "file": "src/power_control.cpp",
                    "line": 1730,
                    "reviewer": {
                        "name": "Alexander",
                        "email": "alexander.hansen@9elements.com",
                        "username": "pointbazaar"
                    },
                    "message": "Making it configurable would be nice. I would have to look to see if the implementation supports detecting button presses of configurable length."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "README.md",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 56,
            "sizeDeletions": 2
        }
    ]
}