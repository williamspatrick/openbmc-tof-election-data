{
    "project": "openbmc/openbmc",
    "branch": "master",
    "id": "I833066c3575348de3ea45861dfb55a65d7082b0e",
    "number": 67429,
    "subject": "TEMP: Linux: Use tmpfs as default filesystem for initrd",
    "owner": {
        "name": "Stefan Berger",
        "email": "stefanb@linux.ibm.com",
        "username": "stefanberger"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/openbmc/+/67429",
    "hashtags": [],
    "createdOn": 1698361031,
    "lastUpdated": 1708020080,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1698361031,
            "reviewer": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1698361348,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1698361348,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1698366222,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/20399/"
        },
        {
            "timestamp": 1698366870,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/20399/ : FAILURE"
        },
        {
            "timestamp": 1698418769,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "mdmii@outlook.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1: Code-Review-1\n\n(1 comment)"
        },
        {
            "timestamp": 1698418825,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "mdmii@outlook.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1698422247,
            "reviewer": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1698547399,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "mdmii@outlook.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1698623570,
            "reviewer": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1698700388,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "mdmii@outlook.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1698761293,
            "reviewer": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1698848968,
            "reviewer": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1698857398,
            "reviewer": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Code-Review-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE OR changekind:TRIVIAL_REBASE OR is:MIN\")\n* Verified-1 (copy condition: \"changekind:NO_CHANGE OR changekind:NO_CODE_CHANGE\")\n"
        },
        {
            "timestamp": 1698857662,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1698857662,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1698862709,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/20471/"
        },
        {
            "timestamp": 1698864173,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/20471/ : FAILURE"
        },
        {
            "timestamp": 1708020080,
            "reviewer": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "message": "Abandoned\n\nWas a temporary patch while it was not in Linux"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "2ec023dc039c66363104d6896a92d742ffab8d74",
            "parents": [
                "bd1412dde945624f67d575910c8967b799d588a4"
            ],
            "ref": "refs/changes/29/67429/1",
            "uploader": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "createdOn": 1698361031,
            "author": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "mdmii@outlook.com",
                        "username": "mdmillerii"
                    },
                    "message": "no. `rootfsnames` is the filesystem for the mounted root not the Initramfs.\n\nwe can argue using kernel parameter names by userspace for the same scope is reasonable and user friendly but using them differently is not.\n\nconsider adding init for rd.fstype building on the namespace of rd.init (and the convention that rd. is for initramfs options).\n\n\nalso will need change log for motivation and context."
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "mdmii@outlook.com",
                        "username": "mdmillerii"
                    },
                    "message": "https://groups.google.com/g/linux.kernel/c/KI74_xL2SHM"
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Stefan Berger",
                        "email": "stefanb@linux.ibm.com",
                        "username": "stefanberger"
                    },
                    "message": "root_fs_names is set by the rootfstype= command line option. Why would the filesystem for the mounted root, that is typically on a disk, have anything to do with tmpfs set by rootfstype=tmpfs ?\n\nCommit 6e19eded3684dc184181093af3bff2ff440f5b53 describes the changes there as:\n\n```\n    initmpfs: use initramfs if rootfstype= or root= specified\n\n    Command line option rootfstype=ramfs to obtain old initramfs behavior, and\n    use ramfs instead of tmpfs for stub when root= defined (for cosmetic\n    reasons).\n``` \n    \nIt also appends the following lines to the existing text:\n\n```\nWhat is rootfs?\n---------------\n\nrootfs is a special instance of ramfs (or tmpfs, if that's enabled), which is\nalways present in 2.6 systems.  You can't unmount rootfs for approximately the\nsame reason you can't kill the init process; rather than having special code\nto check for and handle an empty list, it's smaller and simpler for the kernel\nto just make sure certain lists can't become empty.\n\nMost systems just mount another filesystem over rootfs and ignore it.  The\namount of space an empty instance of ramfs takes up is tiny.\n\n+If CONFIG_TMPFS is enabled, rootfs will use tmpfs instead of ramfs by\n+default.  To force ramfs, add \"rootfstype=ramfs\" to the kernel command\n+line.\n+\n```\n\nThe sentence is not matching the changes introduced there. Instead the text should have said:\n\n```\nIf CONFIG_TMPFS is enabled, rootfs will use tmpfs instead of ramfs by\ndefault unless root= is given.  To force ramfs, add \"rootfstype=ramfs\" to the kernel command line but also avoid the root= parameter.\n```\n\nI think my patch above fixes this patch and the original description (with the preceding '+') is then correct."
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "mdmii@outlook.com",
                        "username": "mdmillerii"
                    },
                    "message": "(1) Your patch does not implement the statement either.  Looking further, the logic was added as two patches in series:\n\n  https://github.com/openbmc/linux/commit/16203a7a9422315bc929461503e3a046459ea5ff\n  https://github.com/openbmc/linux/commit/6e19eded3684dc184181093af3bff2ff440f5b53\n\nThe first patch always used TMPFS if compiled.   The second added conditions, and the changelog is inconsistent with the comment text.  I have not researched the lkml archives for possibly relevant discussions, however the changelog does mention cosmetic reasons. \n\n>initmpfs: use initramfs if rootfstype= or root= specified\n\n> Command line option rootfstype=ramfs to obtain old initramfs behavior, and\nuse ramfs instead of tmpfs for stub when root= defined (for cosmetic\nreasons).\n\nThe title talks about use initramfs but probably should have said \"use ramfs for rootfs\".  The patches were merged in September 2013 before the late 2014 discussion on ima needing the xattr support of tmpfs.\n\n(2) The definition of the parameter is \"Set root filesystem type\".   It is not \"set rootfs file system type\".   (The definition dates to before git before this tmpfs addition).\n\nhttps://github.com/openbmc/linux/blob/fc8d4fdba5bd2b9b1cea2aa8a731531943c45aa7/Documentation/admin-guide/kernel-parameters.txt#L5522\n\n(3) In light of (2), we look at the source for other uses of the parameter and find it is interpreted as a list of filesystems to try when mounting the root filesystem \n\nhttps://github.com/openbmc/linux/blob/fc8d4fdba5bd2b9b1cea2aa8a731531943c45aa7/init/do_mounts.c#L169\n\nhttps://github.com/openbmc/linux/blob/fc8d4fdba5bd2b9b1cea2aa8a731531943c45aa7/init/do_mounts.c#L327\n\nAnd we see that there are several special cases when parsing root=\n\nhttps://github.com/openbmc/linux/blob/fc8d4fdba5bd2b9b1cea2aa8a731531943c45aa7/init/do_mounts.c#L399\n\nHistory lesson:  Before initramfs, there was (and still is) initial ram disk, which loaded a block ram device with an image (either from bootloader supplied content or by reading another device such as multiple floppies) and looked for a file called /linuxrc.  When found it would execute as a process not pid 1, and before exiting it was expected to set a sysctl with the intended root device block number.  Alternatively the ram disk could be the main root filesystem with root=/dev/ram (an alias for /dev/ram0).  So bootloaders were setting root=/dev/ram when specifying content for the bootloader before initramfs started usurping the content of the initrd data block supplied the bootloader.  I presume reusing the interface was deemed to be easier for the ecosystem than adding a new interface to all bootloaders.\n\n(4) I misremembered, the actual parameter is rdinit=, not rd.init= , therefore the rd.fstype is not a good suggestion.  I have not yet considered naming further.\n\nhttps://github.com/openbmc/linux/blob/fc8d4fdba5bd2b9b1cea2aa8a731531943c45aa7/Documentation/admin-guide/kernel-parameters.txt#L5323"
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Stefan Berger",
                        "email": "stefanb@linux.ibm.com",
                        "username": "stefanberger"
                    },
                    "message": "Regarding your point (2): This is so confusing since Rob Landley added the additional text to the rootfs documentation section and from this perspective rootfstype=ramfs clearly wants to allow users to restore the old behavior of rootfs using ramfs instead of tmpfs.\n\nAlso, the code that I modified is in this neighborhood clearly concerned about rootfs:\n\n```\nstatic bool is_tmpfs;\nstatic int rootfs_init_fs_context(struct fs_context *fc)\n{\n\tif (IS_ENABLED(CONFIG_TMPFS) && is_tmpfs)\n\t\treturn shmem_init_fs_context(fc);\n\n\treturn ramfs_init_fs_context(fc);\n}\n\nstruct file_system_type rootfs_fs_type = {\n\t.name\t\t= \"rootfs\",\n\t.init_fs_context = rootfs_init_fs_context,\n\t.kill_sb\t= kill_litter_super,\n};\n\nvoid __init init_rootfs(void)\n{\n\tif (IS_ENABLED(CONFIG_TMPFS) && !saved_root_name[0] &&\n\t\t(!root_fs_names || strstr(root_fs_names, \"tmpfs\")))\n\t\tis_tmpfs = true;\n}\n```\n\nI think it's a bug that rootfs cannot be tmpfs if 'root=' is specified on the command line and therefore saved_root_name[0] != '\\0'. What does the one have to do with the other?"
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "mdmii@outlook.com",
                        "username": "mdmillerii"
                    },
                    "message": "as I said I believe the logic in the second patch likey migrated from use tmpfs unless `ramfs` specified to only use `tmpfs` if ..., and the ramifications were not fully considered.   but someone will need to research that.\n\ntoday in some setups initfs of any kind is optional (meaning root can be mounted by initramfs or the inbuilt kernel root mount), so we should try to preserve them.   if one were to actually add tmpfs or ramfs to roitfstype= then it would be mounted before the real block device root\nhttps://github.com/openbmc/linux/blob/fc8d4fdba5bd2b9b1cea2aa8a731531943c45aa7/init/do_mounts.c#L375"
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Stefan Berger",
                        "email": "stefanb@linux.ibm.com",
                        "username": "stefanberger"
                    },
                    "message": "I will post the patch as an RFC to lkml and then we can go from there. I am sure others can weigh in as well. Another option to achieve tmpfs for rootfs and tested for below the existing if statement would be easy to introduce but can then also be ambiguous with the existing test `strstr(root_fs_names, \"tmpfs\")` that already sets tmpfs."
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "line": 20,
                    "reviewer": {
                        "name": "Stefan Berger",
                        "email": "stefanb@linux.ibm.com",
                        "username": "stefanberger"
                    },
                    "message": "I hope Rob's patch is going to make it now: https://lkml.org/lkml/2023/11/1/333\n\nI will use it now in this series but now have to again change the boot command lines and append initfstype=tmpfs."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed.inc",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/0001-init-Default-to-tmpfs-even-if-root-is-given.patch",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 40,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "291b1671cb37149dd38ff1eb16257595328c3491",
            "parents": [
                "b87dcbda5eec9c26646fad87d311f798089de597"
            ],
            "ref": "refs/changes/29/67429/2",
            "uploader": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "createdOn": 1698857398,
            "author": {
                "name": "Stefan Berger",
                "email": "stefanb@linux.ibm.com",
                "username": "stefanberger"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed.inc",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "meta-aspeed/recipes-kernel/linux/linux-aspeed/ima/fix_rootfstype=tmpfs.patch",
                    "type": "ADDED",
                    "insertions": 47,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 62,
            "sizeDeletions": 0
        }
    ]
}