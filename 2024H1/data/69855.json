{
    "project": "openbmc/obmc-ikvm",
    "branch": "master",
    "id": "I4620fb98bcdaff0e0cbfd0d87e94dbbe3284a80d",
    "number": 69855,
    "subject": "fix(input): refactor hid gadget create/destroy",
    "owner": {
        "name": "Brad Bishop",
        "email": "bradleyb@fuzziesquirrel.com",
        "username": "bradbishop"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/obmc-ikvm/+/69855",
    "hashtags": [],
    "createdOn": 1709667783,
    "lastUpdated": 1711001561,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1709667783,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1709667811,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1709667811,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1709667850,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/80194/ : SUCCESS"
        },
        {
            "timestamp": 1709804778,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 1:\n\n(8 comments)"
        },
        {
            "timestamp": 1709815656,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 1:\n\n(7 comments)"
        },
        {
            "timestamp": 1709842125,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1710344408,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Uploaded patch set 2.\n\nOutdated Votes:\n* Verified+1 (copy condition: \"changekind:NO_CHANGE\")\n"
        },
        {
            "timestamp": 1710344422,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1710344422,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: -Ok-To-Test"
        },
        {
            "timestamp": 1710344451,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/80669/ : SUCCESS"
        },
        {
            "timestamp": 1710344777,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 2:\n\n(4 comments)"
        },
        {
            "timestamp": 1710874782,
            "reviewer": {
                "name": "Zev Weiss",
                "email": "zev@bewilderbeest.net",
                "username": "zevweiss"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "f0b4529ec2daedd4d8d26b955b2673af11ec106c",
            "parents": [
                "63cef2a26af47b077abc7ccc0abf662ca52fe924"
            ],
            "ref": "refs/changes/55/69855/1",
            "uploader": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "createdOn": 1709667783,
            "author": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 32,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Neat -- has this been tested on non-aspeed hardware by any chance?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 32,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "no"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Alright -- a handful of relatively minor/superficial things, though one more structural uncertainty..."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 19,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Aside from the four declared in the corresponding header file, all the other functions in this file could/should be static I think?"
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 19,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "sure, will do."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 19,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "Done"
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 48,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "While I suppose it'd technically be a teeny tiny bit less efficient, I think it might be nice to define this in terms of `writeRawSysfsAttribute()` instead of duplicating most of it (and this shouldn't be a hot enough path that constructing a `std::string` or whatever to have a span to pass to the inner function makes any real difference).\n\nOr actually I suppose if all the sysfs files we're dealing with here are implemented properly on the kernel side it should be fine to leave off the trailing `\\n`, so it wouldn't even need to do that (though I guess you'd need a `strlen()` to determine the length of the span)."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 48,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "will do."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 48,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "turns out both const char* and std::string are implicitly convertible to std::span<const char> so just the one function is needed!"
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 105,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Bit of a yoda conditional, could we flip the operands around here instead?"
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 105,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "sure"
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 105,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "Done"
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 177,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "While we're at it reformatting this for the language switch, how about we deduplicate the comment & code and write the bytes as hex integer literals rather than quoted chars?  (`0x01` seems simpler to read/write than `'\\x01'`, especially if it's all just raw binary with no text.)  So something like:\n \n```\n// Binary HID keyboard descriptor\nstd::array<char, 63> kbdDesc{\n  0x05, 0x01, // USAGE_PAGE (Generic Desktop)\n  0x09, 0x06, // USAGE (Keyboard)\n  0xa1, 0x01, // Collection (Application)\n  // ...etc...\n};\n```\n\nThat way if we ever have to tweak it it's much easier to do it in one place instead of two that could drift out of sync undetected."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 177,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "sure thing."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 177,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "> While we're at it reformatting this for the language switch, how about we deduplicate the comment & code\n\nI did this.\n\n> and write the bytes as hex integer literals\n\nWhen I tried to do this, some of the bytes no longer fit in a (signed) char.  Should I change the array type to unsigned char?  That would then require casts back to signed char when using ofstream::write...given that is it still worth using integer literals?"
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 177,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Ah, that's unfortunate, but yeah, I see the problem...\n\nAnd yes, I guess unsigned char would be slightly more appropriate for arbitrary binary data -- perhaps a reasonably clean solution would be to have a `writeSysfsAttribute()` that takes one signedness and a tiny wrapper overload that takes the other signedness and just does a trivial conversion before calling the inner one?  (And to be pedantic maybe specify `unsigned char` and `signed char` explicitly on both, since which one a plain `char` is is technically implementation-defined.)\n\nOr if that ends up being more complicated for some reason it wouldn't be the end of the world to just stick with the character literals as it is now."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 226,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "And similarly here of course."
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "line": 226,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "\ud83d\udc4d"
                },
                {
                    "file": "ikvm_input.cpp",
                    "line": 55,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Hmm, does this cause any problems with multiple simultaneously-connected clients, like the second one booting the first one or effectively demoting it to view-only (by killing its keyboard/mouse) or something?"
                },
                {
                    "file": "ikvm_input.cpp",
                    "line": 55,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "I'm new to this app so I could be wrong but I don't think so - the Input::connect/disconnect methods are only called when the connected RFB client count transitions from 0->1 and 1->0."
                },
                {
                    "file": "ikvm_input.cpp",
                    "line": 55,
                    "reviewer": {
                        "name": "Zev Weiss",
                        "email": "zev@bewilderbeest.net",
                        "username": "zevweiss"
                    },
                    "message": "Ah, yes, that appears to be the case -- nevermind then, looks like it should be fine as is."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "ikvm_gadget.hpp",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "ikvm_input.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -35
                },
                {
                    "file": "ikvm_input.hpp",
                    "type": "MODIFIED",
                    "insertions": 0,
                    "deletions": -6
                },
                {
                    "file": "start-ipkvm.service",
                    "type": "MODIFIED",
                    "insertions": 0,
                    "deletions": -1
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -6
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "type": "ADDED",
                    "insertions": 266,
                    "deletions": 0
                },
                {
                    "file": "create_usbhid.sh",
                    "type": "DELETED",
                    "insertions": 0,
                    "deletions": -162
                }
            ],
            "sizeInsertions": 326,
            "sizeDeletions": 210
        },
        {
            "number": 2,
            "revision": "18327619977ca01551d64bc48bd504c9f3792f8b",
            "parents": [
                "63cef2a26af47b077abc7ccc0abf662ca52fe924"
            ],
            "ref": "refs/changes/55/69855/2",
            "uploader": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "createdOn": 1710344408,
            "author": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 35,
                    "deletions": 0
                },
                {
                    "file": "ikvm_gadget.hpp",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "ikvm_input.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -35
                },
                {
                    "file": "ikvm_input.hpp",
                    "type": "MODIFIED",
                    "insertions": 0,
                    "deletions": -6
                },
                {
                    "file": "start-ipkvm.service",
                    "type": "MODIFIED",
                    "insertions": 0,
                    "deletions": -1
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -6
                },
                {
                    "file": "ikvm_gadget.cpp",
                    "type": "ADDED",
                    "insertions": 241,
                    "deletions": 0
                },
                {
                    "file": "create_usbhid.sh",
                    "type": "DELETED",
                    "insertions": 0,
                    "deletions": -162
                }
            ],
            "sizeInsertions": 302,
            "sizeDeletions": 210
        }
    ]
}