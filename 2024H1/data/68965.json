{
    "project": "openbmc/phosphor-objmgr",
    "branch": "master",
    "id": "I0ea71f3e00d6ddc045a55f90e7d89d2f1785cc9c",
    "number": 68965,
    "subject": "libmapper: Filter out the ObjectMapper service",
    "owner": {
        "name": "George Liu",
        "email": "liuxiwei@ieisystem.com",
        "username": "lxwinspur"
    },
    "url": "https://gerrit.openbmc.org/c/openbmc/phosphor-objmgr/+/68965",
    "hashtags": [],
    "createdOn": 1705905971,
    "lastUpdated": 1714007201,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1705905971,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1705906025,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1705906025,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: -Ok-To-Test"
        },
        {
            "timestamp": 1705906303,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/78261/ : SUCCESS"
        },
        {
            "timestamp": 1705940552,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1705948853,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1705970465,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706125656,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706145132,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706193371,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706198396,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706199305,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 1: -Code-Review\n\n(1 comment)"
        },
        {
            "timestamp": 1706229238,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706278336,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706487907,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706532468,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706575142,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1706591383,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1713859035,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1713881775,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1714007201,
            "reviewer": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "05bda1d0c993bf0e70925933184639dc3bdcb1bc",
            "parents": [
                "ec87407cc1d69cbd11d9235a069a80efccf53e02"
            ],
            "ref": "refs/changes/65/68965/1",
            "uploader": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "createdOn": 1705905971,
            "author": {
                "name": "George Liu",
                "email": "liuxiwei@ieisystem.com",
                "username": "lxwinspur"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "@Patrick @Matt\nAny comments on this one?\nIs there any plan to merge this commit?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Since you fixed phosphor-host-ipmid  I don't think this is needed?"
                },
                {
                    "file": "/PATCHSET_LEVEL",
                    "line": 0,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "I still think it's two problems.\nThis patch is mainly to fix the problem of filtering out `xyz.openbmc_project.ObjectMapper` when calling mapper ger-service."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "This is kind of silly to do it on the client library side, when nobody really uses this client library, isn't it?\n\nOr ... is it only useful to do on the client library?\n\nIt seems like we should do this filtering on the server side.  Unless, it is useful to get in some cases but not others?"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "Thanks Patrick.\nI don't think filtering on the client side is reasonable for two reasons:\n* For the server, we can obtain the service through dbus path and interfaces. For the client, maybe we want to know which service the current path belongs to (at least IEI uses this command very frequently downstream).\n* If possible, I think it is reasonable to return all services. As for why I didn\u2019t do this, it\u2019s because I didn\u2019t want to break the original logic.\n\nIn any case, it is very unreasonable to use this command to return xyz.openbmc_project.ObjectMapper."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I don't know how to interpret your response here.  Are you planning to change this code or you think it is right?\n\n> In any case, it is very unreasonable to use this command to return xyz.openbmc_project.ObjectMapper.\n\nIt does this due to associations, right?  I agree it's probably not what is interesting in most cases, but part of this is just due to extra filtering being done by this `mapper_get_service` function.  Probably better to avoid using that?"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "> I don't know how to interpret your response here.  Are you planning to change this code or you think it is right?\n\n1. Without breaking the original logic, I think it is correct to filter out `xyz.openbmc_project.ObjectMapper`.\n2. Otherwise we could return all service names, but this would require refactoring everywhere `mapper_get_service` is used.\n\nI prefer the first way and would like to hear your suggestions."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "If associations had been invented when this get-service API was created, I suspect either a) it would have done the same change as in this commit, or b) it would have been shot down as a bad idea since assuming a path has one service is wrong."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "It looks like the only use of this function in the whole codebase is in phosphor-host-ipmid.  Should we just fix it there to use the mapper calls directly?\n\nI guess I don't really care one way or the other if this change goes in.  It just seemed odd to do filtering on the client side when we're in the mapper library.  You'd think that if it was important for mapper there would be server-side work for it."
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Trying a few of the sensors on my system, it looks like it's just alphabetical.  VirtualSensor comes after ObjectMapper, so it returns ObjectMapper.  But ObjectMapper comes after ADCSensor, so for that one I do get ADCSensor.\n\nThose paths in the mapper don't actually have any interfaces on them, it's just that it's a subpath of an association path that does.\n\nSo maybe then yea it would be better to change the server to not return objects that only have the 3 default freedesktop interfaces?"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "So can we have the client return all service names instead of just the first one, and then do some minor refactoring in phosphor-host-ipmid?\n@Patrick @Matt"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "Why can't that code just call GetObject instead?"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "> Why can't that code just call GetObject instead?\n\nBecause I don't know what the original design intention was? I don't want to break the existing logic, I just want to get the correct service name through the object path"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I'm not especially satisfied with that response.  It isn't like the code we're talking about is especially complex and you seem to already understand the \"fix\".\n\nThe only call to this code is in sensorhandler.cpp as just a trivial redirection:\n```\nint get_bus_for_path(const char* path, char** busname)\n{\n    return mapper_get_service(bus, path, busname);\n}\n```\n\nThe interesting code is where this is called from, which is in `find_openbmc_path`:\n\n    rc = get_bus_for_path(info.sensorPath.c_str(), &busname);\n\nThere is a full path to a sensor that they're looking for an object at that path.  Isn't this exactly what GetObject is for?"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "I see.\nI just want to clarify that for us this should be two questions:\n1. `get_bus_for_path` should not call the mapper_get_service method directly but should call the GetObject method\n2. `mapper get-service` is just a tool, we should let it return all existing service names right?\n\nIf we can agree here, I will fix both issues above \ud83d\ude0a"
                },
                {
                    "file": "libmapper/mapper.c",
                    "line": 647,
                    "reviewer": {
                        "name": "George Liu",
                        "email": "liuxiwei@ieisystem.com",
                        "username": "lxwinspur"
                    },
                    "message": "> 1. get_bus_for_path should not call the mapper_get_service method directly but should call the GetObject method\n\nFixed: https://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/69082"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 25,
                    "deletions": 0
                },
                {
                    "file": "libmapper/mapper.c",
                    "type": "MODIFIED",
                    "insertions": 27,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 52,
            "sizeDeletions": 10
        }
    ]
}