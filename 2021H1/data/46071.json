{
    "project": "openbmc/phosphor-power",
    "branch": "master",
    "id": "Iccd56d842e808dcd5c192d5cc2dc1947fbdb03f6",
    "number": 46071,
    "subject": "psu-ng: Do not create duplicate power supplies",
    "owner": {
        "name": "B. J. Wyman",
        "email": "bjwyman@gmail.com",
        "username": "bjwyman"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/46071",
    "commitMessage": "psu-ng: Do not create duplicate power supplies\n\nWhen the entity-manager is restarted, the interfaces watched for the\npower supply data will get re-added. If the data on the added interfaces\nmatches an already existing power supply, skip creating the power supply\nobject.\n\nChange-Id: Iccd56d842e808dcd5c192d5cc2dc1947fbdb03f6\nSigned-off-by: Brandon Wyman <bjwyman@gmail.com>\n",
    "createdOn": 1629415540,
    "lastUpdated": 1630527539,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1629415540,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1629415555,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1629415605,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/24686/ : FAILURE"
        },
        {
            "timestamp": 1629491181,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 2: Patch Set 1 was rebased."
        },
        {
            "timestamp": 1629491203,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1629491693,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/24764/ : SUCCESS"
        },
        {
            "timestamp": 1629492194,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 2:\n\nThis change is ready for review."
        },
        {
            "timestamp": 1629758784,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 3: Patch Set 2 was rebased."
        },
        {
            "timestamp": 1629758799,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1629758850,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/24846/ : FAILURE"
        },
        {
            "timestamp": 1629898565,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1629919900,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 4: Patch Set 3 was rebased."
        },
        {
            "timestamp": 1629919913,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1629920014,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1629920345,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/25049/ : SUCCESS"
        },
        {
            "timestamp": 1629926916,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1629990151,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 4:\n\n(4 comments)"
        },
        {
            "timestamp": 1630015688,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1630015875,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4:\n\n(2 comments)"
        },
        {
            "timestamp": 1630016011,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 4:\n\nI suppose pointing out an example from a restart in the simulator doesn't add much to the conversation if I still need to make some changes:\nAug 26 21:47:36 p10bmc systemd[1]: Stopping Entity Manager...\nAug 26 21:47:36 p10bmc systemd[1]: xyz.openbmc_project.EntityManager.service: Deactivated successfully.\nAug 26 21:47:36 p10bmc systemd[1]: Stopped Entity Manager.\nAug 26 21:47:36 p10bmc systemd[1]: Starting Entity Manager...\nAug 26 21:47:36 p10bmc systemd[1]: Started Entity Manager.\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc entity-manager[1346]: Inventory Added\nAug 26 21:47:42 p10bmc phosphor-psu-monitor[402]: InterfacesAdded for: xyz.openbmc_project.Configuration.IBMCFFPSConnector\nAug 26 21:47:42 p10bmc phosphor-psu-monitor[402]: InterfacesAdded for: xyz.openbmc_project.Configuration.IBMCFFPSConnector\nAug 26 21:47:42 p10bmc phosphor-psu-monitor[402]: InterfacesAdded for: xyz.openbmc_project.Configuration.IBMCFFPSConnector\nAug 26 21:47:42 p10bmc phosphor-psu-monitor[402]: InterfacesAdded for: xyz.openbmc_project.Configuration.IBMCFFPSConnector\nroot@p10bmc:~#"
        },
        {
            "timestamp": 1630456122,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1630456134,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1630456298,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 5:\n\n(4 comments)"
        },
        {
            "timestamp": 1630456612,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/25398/ : SUCCESS"
        },
        {
            "timestamp": 1630527174,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 5: Code-Review+1"
        },
        {
            "timestamp": 1630527336,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 5: Code-Review+1"
        },
        {
            "timestamp": 1630527465,
            "reviewer": {
                "name": "Jim Wright",
                "email": "jlwright@us.ibm.com",
                "username": "wrightjl1"
            },
            "message": "Patch Set 5: Code-Review+1"
        },
        {
            "timestamp": 1630527536,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1630527539,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Change has been successfully rebased and submitted as ecbecbc8ef1429ad1776918d6450f6eaa099e38a by Shawn McCarney"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "2ff471c21b0b3ed42fd9a899c9679999a1683cd2",
            "parents": [
                "19abb20fbcccbcfee09bf9fd0e24de91db3d7d09"
            ],
            "ref": "refs/changes/71/46071/1",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1629415540,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 50,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 50,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "1bba38717384e640eed72af9ec52f71d281f7f6c",
            "parents": [
                "a1c6aed0919562305b11d85305ed99b080c34b7e"
            ],
            "ref": "refs/changes/71/46071/2",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1629491181,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 50,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 50,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "70f95dfd5b707eec44c84d4a0d9357adc4eebdf1",
            "parents": [
                "e429acd891b835d97bc43531a01953fc7d9f41a0"
            ],
            "ref": "refs/changes/71/46071/3",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1629758784,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "This all seems a bit of overkill to me :)  It would imply the previous presence or I2C properties were wrong, which would have been a code bug that someone is trying to fix by just restarting entity-manager instead of fixing it in the driver."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "That is one possible reason. The intent here was to avoid creating additional power supply objects that match the ones we already created earlier. The entity-manager restart generates the interfacesAdded signal, quite possibly with no changes."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "what I meant that was the properties you are checking here are properties of the hardware and there should be no reason for them to change in between entity-manager restarts.  So personally I think just checking for a duplicate inventory path is good enough."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Well, I guess I sort of see that. The presence line likely isn't going to change. The address I suppose could maybe change, but not practically in most systems.\n\nI suppose even that would be a bit hacky... the device tree would need changing if you also needed to change the entity-manager configuration."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Snip. Inventory match only, comments on why GPIO and I2C match/check not needed."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 50,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 50,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "517fdc984d60711e36c9ebc9481c415dc290ed74",
            "parents": [
                "d8b8cb15bf3e3f5e7e50e2421e702d8b46852d0f"
            ],
            "ref": "refs/changes/71/46071/4",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1629919900,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 146,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "If you decided to keep all of the comparisons vs. just the inventory path (re: Matt's comment), it might be a good idea to refactor this into a separate method like exists().  getPSUProperties() is getting long."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 146,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "I think I might lean towards the inventory match, and remove the rest of the matching... quite a bit of work to get that all matching up right, and then not really practical to have/need. \ud83d\ude1e"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 146,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Dropped the extra comparisons."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "I might be just misunderstanding, but it doesn't seem like the \"i2c-A/A-00BB\" in the comment matches the regular expression.  Also, given that address starts with 'A' and bus starts with 'B', you might want to swap what the letters represent.  I kept getting confused which parts of the path had the address vs. bus."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Oh! I had to fix that, there is no hyphen in there..."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 167,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Dropped i2cMatch."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 180,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "FYI ... this will throw an exception if it cannot perform the conversion.  Same with the one on line 183.  Not sure if you wanted to catch that and handle it?"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 180,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Dropped i2cMatch."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 181,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Why is this needed (just curious)?  If it is bus 3, is the number 103 in the path?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 50,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 50,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "e2df6f39f769429cc2be5ebff4c7e8b1553c8da1",
            "parents": [
                "5dab5d3d8fdf8d2198743077fe22c3b45c48eb32"
            ],
            "ref": "refs/changes/71/46071/5",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1630456122,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 17,
            "sizeDeletions": 0
        },
        {
            "number": 6,
            "revision": "ecbecbc8ef1429ad1776918d6450f6eaa099e38a",
            "parents": [
                "22318a32ca829277472af835777de8a822b94804"
            ],
            "ref": "refs/changes/71/46071/6",
            "uploader": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "createdOn": 1630527539,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 17,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 17,
            "sizeDeletions": 0
        }
    ]
}