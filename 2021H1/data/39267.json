{
    "project": "openbmc/openbmc-build-scripts",
    "branch": "master",
    "id": "Ifd480dc7d4003ec21251d6077caf33baf3b622ef",
    "number": 39267,
    "subject": "unit-test: Set git proxy in docker",
    "owner": {
        "name": "Lei YU",
        "email": "yulei.sh@bytedance.com",
        "username": "mine260309"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/openbmc-build-scripts/+/39267",
    "commitMessage": "unit-test: Set git proxy in docker\n\nSome repos will download externalprojects via git, and it could be\nslow in some network environment.\n\nSet git proxy in $HOME/.gitconfig in the docker container so that git\ncould use the proxy to speedup the download.\n\nTested: Verify it's faster to run repo-ci on dbus-sensors that downloads\n        nlohmann-json project via git. Without this change, it's very\n        slow and eventually fails due to timeout.\n\nSigned-off-by: Lei YU <yulei.sh@bytedance.com>\nChange-Id: Ifd480dc7d4003ec21251d6077caf33baf3b622ef\n",
    "createdOn": 1609221113,
    "lastUpdated": 1610457291,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1609221113,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1609221127,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1609221133,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/76/"
        },
        {
            "timestamp": 1609221149,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/76/ : SUCCESS"
        },
        {
            "timestamp": 1609277768,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1609294469,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1609294776,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 2: Commit message was updated."
        },
        {
            "timestamp": 1609296693,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1609317109,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1609862175,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1609952206,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1609986744,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1609986754,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1609986761,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1609986768,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/77/"
        },
        {
            "timestamp": 1609986781,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/77/ : SUCCESS"
        },
        {
            "timestamp": 1610027175,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1610029284,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1610029289,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Change has been successfully merged by Andrew Geissler"
        },
        {
            "timestamp": 1610030793,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\nShould support be added for https_proxy also?"
        },
        {
            "timestamp": 1610071931,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n> Patch Set 3:\n> \n> Should support be added for https_proxy also?\n\nAll the scripts in this repo use \"http_proxy\" as the \"input\" environment for proxy, and some set both \"http_proxy\" and \"https_proxy\" with the same http proxy.\n\nWith above, we do not need to check https_proxy."
        },
        {
            "timestamp": 1610404358,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1610416733,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1610457291,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "196341cfe0950091bb4fbc9a61341db45c045b40",
            "parents": [
                "5b4a1e8be11dd7e8f6239a4a382d8f8ddb95b3e6"
            ],
            "ref": "refs/changes/67/39267/1",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1609221113,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "Is there a difference here? or are these all just \"external projects via git\" to the repo downloading them?"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "I mention `subprojects` for meson and `externalprojects` for cmake.\nBut I did only test this case for dbus-sensors which is a cmake project.\n\nWill reword."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "Something else seems to be wrong with dbus-sensors downloading nlohmann-json via git during ci when nlohmann-json is already included in the docker image."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "That is the intended behavior for the cmake repos, that it sets `YOCTO` OFF by default and runs repo CI by downloading and compiling all the dependencies as externalprojects."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "I'm not referring to doing a machine image build using Yocto. If dbus-sensors is using the `openbmc-build-scripts` to run repo-ci, then why is it explicitly downloading nlohmann-json when this script would already have that installed within the docker container? That's a question outside the scope of this change (however it's causing the need for this change) since many other repos do not explicitly download/install nlohmann-json for their repo-ci."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "When bmcweb was using cmake, I did send a patch to make \"YOCTO\" default so that repo-ci could use the docker image's environment to run the build and test. It was rejected.\nSo I assume that is really intended behavior for such repos.\nSee https://gerrit.openbmc-project.xyz/c/openbmc/bmcweb/+/27409"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 16,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "That's fine, it's inefficient for these repos in docker CI to download these dependencies twice since they may already present in the docker image. For example, it doesn't look like dbus-sensors checks for nlohmann json prior to downloading it into the repo directory."
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 517,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "Wouldn't it be better to have this set for the base set of openbmc projects included above in the case they include any external projects via git or any other ones for that matter?"
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 517,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "The above steps runs at docker build stage, where the proxy settings are from the \"--build-arg\".\n\nThis ${PROXY_CMD} is intended to set the proxy in the docker image, so when the container runs, e.g. repo CI runs, it uses the proxy."
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 517,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "Right, I'm asking why it was added to the end of the docker image build instead of being done earlier so that the repos that are always included in the docker image build get the possible benefit of the proxy if they download any external projects via git."
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 517,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "> if they download any external projects via git.\n\nAs explained above, the docker build step does not use the environment of the container, it uses the below `--build-arg` instead.\n\nBesides, you could see that the ${HOME} is created at the \"Final configuration for the workspace\", so the proxy settings are here after ${HOME} is created.\n\nLast, by putting it at the last step makes it could re-use previously downloaded docker images (cached), so it's faster if you already have built the docker image."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 9,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "3f6c3575bd57a70eebabbe355447ef6cac540360",
            "parents": [
                "5b4a1e8be11dd7e8f6239a4a382d8f8ddb95b3e6"
            ],
            "ref": "refs/changes/67/39267/2",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1609294776,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 24,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Should document this option in the \"Script Variables\" section at top."
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 24,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 9,
            "sizeDeletions": 1
        },
        {
            "number": 3,
            "revision": "b850977aaf474d6f57cb7e1e133f35b48295d963",
            "parents": [
                "5b4a1e8be11dd7e8f6239a4a382d8f8ddb95b3e6"
            ],
            "ref": "refs/changes/67/39267/3",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1609986744,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 529,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "There is support for 'https_proxy' here but now not in the .gitconfig changes you made.  I think this is problematic and you should have a `[https]` section in the .gitconfig also."
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 529,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "In .gitconfig, there is only `http.proxy`, but not `https.proxy`.\nhttps://git-scm.com/docs/git-config#Documentation/git-config.txt-httpproxy\n\n> http.proxy\n> Override the HTTP proxy, normally configured using the http_proxy, https_proxy, and all_proxy environment variables"
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "line": 529,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Huh.  For some reason in my .gitconfig at work I have both of them.  I guess that is what I get for blindly copying something out of a wiki. ;)"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "build-unit-test-docker.sh",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 11,
            "sizeDeletions": 1
        }
    ]
}