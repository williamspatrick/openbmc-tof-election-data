{
    "project": "openbmc/openbmc",
    "branch": "master",
    "topic": "bootchart",
    "id": "I8fd4366ecff3d1f26541eb36534d4c288186cd1c",
    "number": 43997,
    "subject": "meta-phosphor: mmc-init: Honour init= on the kernel commandline",
    "owner": {
        "name": "Andrew Jeffery",
        "email": "andrew@aj.id.au",
        "username": "amboar"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/openbmc/+/43997",
    "commitMessage": "meta-phosphor: mmc-init: Honour init= on the kernel commandline\n\nThis makes it easier to measure boot performance with systemd-bootchart,\nfor example:\n\n    bootargs=console=ttyS4,115200n8 init=/lib/systemd/systemd-bootchart\n\nChange-Id: I8fd4366ecff3d1f26541eb36534d4c288186cd1c\nSigned-off-by: Andrew Jeffery <andrew@aj.id.au>\n",
    "createdOn": 1623396887,
    "lastUpdated": 1623823030,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1623396887,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1623396924,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1623396933,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1623396939,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/ci-openbmc/4598/"
        },
        {
            "timestamp": 1623399347,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-openbmc/4598/ : SUCCESS"
        },
        {
            "timestamp": 1623400652,
            "reviewer": {
                "name": "Jenkins OpenBMC IBM",
                "email": "geissonator+jenkinsibm@gmail.com",
                "username": "jenkins-openbmc-ibm"
            },
            "message": "Patch Set 1:\n\nBuild Successful \n\nIBM Hardware CI : witherspoon hardware tests passed"
        },
        {
            "timestamp": 1623702308,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623704840,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623780884,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1623784702,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1: Code-Review+1\n\n(2 comments)"
        },
        {
            "timestamp": 1623787575,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1623797733,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623797824,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2: Commit message was updated."
        },
        {
            "timestamp": 1623797864,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623797970,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623798974,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623800200,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2: Code-Review-1\n\n(1 comment)"
        },
        {
            "timestamp": 1623800852,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623805046,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623813006,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623813314,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Abandoned"
        },
        {
            "timestamp": 1623819174,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623823030,
            "reviewer": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "52a524e980a538f54b2ad105803a8d06bcf6577f",
            "parents": [
                "2bb4f12fba0d1faa1184a9d787b32cdfdbbd8992"
            ],
            "ref": "refs/changes/97/43997/1",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1623396887,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Could you add an example of a /proc/cmdline that would enable systemd-bootchart? it seems you're expecting the cmdline to start with init= and be set to something like: \"init=something plus maybe more\" and the script would parse it to \"something plus maybe more\""
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "Maybe it's worth commenting on the code rather than the commit message given the question about the implementation? It sounds like you think there's a constraint on the position of init= on the command line? There's no such constraint, appending init= work fine, but I suspect there may be some confusion about shell quoting.\n\nHaving said that, I'll add this as an example:\n\n console=ttyS4,115200n8 init=/lib/systems/systemd-bootchart"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Hopefully with a path that exists (systems -> systemd ?)"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "> Hopefully with a path that exists (systems -> systemd ?)\n\nYes, that was a typo thanks to autocorrect on my phone."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Its a bit simplistic in that the kernel honors double quotes when parsing (but can't pass them through).  \n\nI think its ok.\n\nWe could do a similar change in obmc-phosphor-initfs (already have the init=/sbin/init) but most of the option parsing there is boolean grep.\n\nubi with the mount script in rootfs as pre-init would need further configuration."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "> Its a bit simplistic in that the kernel honors double quotes when parsing (but can't pass them through).\n\nI'm not sure what you mean here? As a simple test:\n\n $ echo 'init=\"foo bar baz\"' | for arg in \"$(cat /proc/cmdline)\"; do\n     case \"$arg\" in\n         init=*)\n             init=\"${arg##init=}\";\n             ;;\n     esac;\n done;\n echo \"$init\"\n \"foo bar baz\"\n $"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": ">  $ echo 'init=\"foo bar baz\"' | for arg in \"$(cat /proc/cmdline)\"; do\n\nUgh, copy/paste fail, that was meant to be\n\n  $ echo 'init=\"foo bar baz\"' | for arg in \"$(cat)\"; do"
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "I'm asserting the kernel parses that as init=foo bar baz.  But your code will give init=\"foo\n\nBut I don't think it will be a problem in practice.\n\n\nAlso some.junk=\"abc init=def\" will also misbehave."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "... aaand that doesn't actually work. Here's a pretend command line used as the data source:\n\n 2 08:42:05 andrew@mistburn:~$ cat /tmp/cmdline \n console=ttyS4,115200n8 init=\"foo bar baz\"\n 2 08:42:05 andrew@mistburn:~$\n\nTake 2, quoting the shell substitution:\n\n 2 08:42:03 andrew@mistburn:~$ init=\"\"; for arg in \"$(cat /tmp/cmdline)\"; do case \"$arg\" in init=*) init=\"${arg##init=}\"; ;; esac; done; echo $init\n \n 2 08:42:05 andrew@mistburn:~$\n\nvs unquoted substitution:\n\n 2 08:50:26 andrew@mistburn:~$ init=\"\"; for arg in $(cat /tmp/cmdline); do case \"$arg\" in init=*) init=\"${arg##init=}\"; ;; esac; done; echo $init\n \"foo\n 2 08:52:05 andrew@mistburn:~$ \n\nDodging the substitution appears to work, but this is likely a function of how the loop arguments are parsed:\n\n 2 08:52:41 andrew@mistburn:~$ init=\"\"; for arg in console=ttyS4,115200n8 init=\"foo bar baz\"; do case \"$arg\" in init=*) init=\"${arg##init=}\"; ;; esac; done; echo $init\n foo bar baz\n 2 08:59:24 andrew@mistburn:~$\n\nGiven the substitution is quoted below, I don't understand how the system booted and produced results using systemd-bootchart. I'm lost."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "So the code was slightly modified from here: https://stackoverflow.com/a/15027935. I modified it to remove the `set -- $(cat /proc/cmdline)` by just directly substituting it for \"$@\". However, testing the code as it was:\n\n 2 09:12:03 andrew@mistburn:~$ set -- $(cat /tmp/cmdline)\n 2 09:12:14 andrew@mistburn:~$ for x in \"$@\"; do\n >  echo $x;\n > done\n console=ttyS4,115200n8\n init=\"foo\n bar\n baz\"\n 2 09:12:25 andrew@mistburn:~$\n\nSo Milton is right, it's a bit hamstrung, but there's also a bug in that I should drop the quotes around the shell substitution. Still don't yet understand how it did what I expected."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Maybe you had only init=, or had it first.   \nOr added the quotes around the cat later.\n\n\nI'd have to look if the desktop initrd creaters (forgetting, on phone) handle the quoting."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "It seems that if you've got systemd-bootchart installed in the image it is started, it doesn't matter whether you've set init= on the kernel commandline:\n\n root@p10bmc:~# cat /proc/cmdline \n console=ttyS4,115200n8 root=/dev/ram rw rootwait root=PARTLABEL=rofs-a\n root@p10bmc:~# ls /run/log\n bootchart-19700101-0000.svg  bootchart-20210616-0303.svg  journal\n root@p10bmc:~#\n\nMaybe we just abandon this change."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Looking at \nhttps://github.com/openbmc/openbmc/blob/master/poky/meta/recipes-devtools/systemd-bootchart/systemd-bootchart_234.bb\n\nit doesn't have any of the magic ALTERNATIVES documented in\nhttps://github.com/openbmc/openbmc/blob/912a10d13cdb41080f7215532c68e463b633e2e2/meta-phosphor/recipes-phosphor/preinit-mounts/preinit-mounts.bb#L18\nto install itself as /sbin/init like\nhttps://github.com/openbmc/openbmc/blob/912a10d13cdb41080f7215532c68e463b633e2e2/meta-phosphor/recipes-phosphor/preinit-mounts/preinit-mounts.bb#L18\n\nbut instead relies on \nhttps://github.com/systemd/systemd-bootchart/blob/master/units/systemd-bootchart.service.in\n\nto run as a normal systemv compatible unit using the -r relative flag to hide the late start.\n\nIf that's sufficent ok, but it seems like we are missing early information that would otherwise be captured.\n\nActually I checked this out because I wanted to know what the overhead of running this and if I should reconsider adding to the base p10bmc image.  A cputime stats on exit for itself might be useful :-)."
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "line": 61,
                    "reviewer": {
                        "name": "Andrew Jeffery",
                        "email": "andrew@aj.id.au",
                        "username": "amboar"
                    },
                    "message": "In this case I was wanting information on the relative startup of mctp-demux-daemon and pldmd. But yeah, if we were serious about it, we should enable use of init=. We can do that when we need it though, and this discussion can serve as a warning to others about the dangers of shell scripting \ud83d\ude04"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 12,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "55a6a3f560fafe13d751d54645acc19fb867ee19",
            "parents": [
                "2bb4f12fba0d1faa1184a9d787b32cdfdbbd8992"
            ],
            "ref": "refs/changes/97/43997/2",
            "uploader": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "createdOn": 1623797824,
            "author": {
                "name": "Andrew Jeffery",
                "email": "andrew@aj.id.au",
                "username": "amboar"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "meta-phosphor/recipes-phosphor/initrdscripts/phosphor-mmc-init/mmc-init.sh",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 12,
            "sizeDeletions": 1
        }
    ]
}