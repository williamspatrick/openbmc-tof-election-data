{
    "project": "openbmc/docs",
    "branch": "master",
    "topic": "power-recovery",
    "id": "I7173f44e3a605ef317a2165595a43cf8906d7f87",
    "number": 48015,
    "subject": "power-recovery: handling of brownout conditions",
    "owner": {
        "name": "Andrew Geissler",
        "email": "geissonator@yahoo.com",
        "username": "geissonator"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/docs/+/48015",
    "commitMessage": "power-recovery: handling of brownout conditions\n\nA brownout condition is when a system has enough power for the BMC but\nnot the rest of the hardware in the chassis. This design update\naddresses how the BMC firmware will handle this scenario.\n\nChange-Id: I7173f44e3a605ef317a2165595a43cf8906d7f87\nSigned-off-by: Andrew Geissler <geissonator@yahoo.com>\n",
    "createdOn": 1634763673,
    "lastUpdated": 1638809925,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1634763673,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1634840670,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1635198465,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1635198465,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1635262711,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 2:\n\n(1 comment)\n\nLooks good, just 1 comment"
        },
        {
            "timestamp": 1635364437,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1635364437,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1635370774,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1635432099,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Topic set to power-recovery"
        },
        {
            "timestamp": 1635437762,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1635798242,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 4: Patch Set 3 was rebased."
        },
        {
            "timestamp": 1636046548,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 4:\n\n(3 comments)"
        },
        {
            "timestamp": 1636145362,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1636145362,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 5:\n\n(3 comments)"
        },
        {
            "timestamp": 1636408072,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1636492621,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 6."
        },
        {
            "timestamp": 1636492621,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 6:\n\n(2 comments)"
        },
        {
            "timestamp": 1636993339,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 6:\n\n(2 comments)"
        },
        {
            "timestamp": 1637268705,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Uploaded patch set 7."
        },
        {
            "timestamp": 1637268705,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 7:\n\n(2 comments)"
        },
        {
            "timestamp": 1637272034,
            "reviewer": {
                "name": "Derek Howard",
                "email": "derekh@us.ibm.com",
                "username": "derekhoward55"
            },
            "message": "Patch Set 7: Code-Review+1\n\n(1 comment)"
        },
        {
            "timestamp": 1637273844,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 7: Code-Review+1"
        },
        {
            "timestamp": 1638809916,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 7: Verified+1 Code-Review+2"
        },
        {
            "timestamp": 1638809925,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Change has been successfully rebased and submitted as e67c779ec815d204ae7d9f07da3f533f6aab8364 by Patrick Williams"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "1d528054abd487d25a7c2313778dc2c47369cb1f",
            "parents": [
                "b2948755f5c7e51cca327ed9801d07c93893920f"
            ],
            "ref": "refs/changes/15/48015/1",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1634763673,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 32,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "I don't think we want to associate/equate the existence of a UPS with a brownout condition.  Although it is true from a BMC perspective in both cases the BMC can continue to run, brownout&blackout are terms used in the industry to describe the type of power line disturbance.  Ie, a brownout or a blackout can happen with or without a UPS attached.\n\nEg, without a UPS attached, when a brownout happens, the chassis power is lost but the BMC (on standby power) can continue to run, as stated above.  However, if a UPS is attached, whether the PLD is a brownout or a blackout, in both cases the chassis power is maintained, and the system should eventually turn itself off in an orderly fashion before the UPS drains and the system crashes.\n\nSo really those are 3 separate scenarios (blackout, brownout, power loss with UPS attached) for which we want to utilize the automated power-on recovery feature (aka auto-power restart).  Hopefully that makes sense, let me know if not, thanks."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 32,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "ok makes sense, let me focus on just the brownout scenario in this commit and add a small change in a separate commit about UPS's."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 69,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 69,
            "sizeDeletions": 5
        },
        {
            "number": 2,
            "revision": "424caf6b31fae81095c9cdfbc0eddafa007ca118",
            "parents": [
                "b2948755f5c7e51cca327ed9801d07c93893920f"
            ],
            "ref": "refs/changes/15/48015/2",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1635198465,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 139,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "The phosphor-psu-monitor app in the phosphor-power repo is already continuously monitoring the ps status to detect the brownout, would log an error in this scenario, would detect when the brownout condition ends, etc.  Or is there a reason a new app would need to be created?"
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 139,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Great, just me not knowing it existed, I'll add that."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 64,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 64,
            "sizeDeletions": 5
        },
        {
            "number": 3,
            "revision": "d12751402759fd47ae3844edfa7e52ef823780d3",
            "parents": [
                "73e5bbe4abebd9fd3e20593eb07393384849b9eb"
            ],
            "ref": "refs/changes/15/48015/3",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1635364437,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 147,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "I'm struggling a bit with this one. If we put it under the xyz.openbmc_project.State.Chassis interface, then we'd have to have the phosphor-state-manager chassis application host this. So we'd have it hosted by state-manager but controlled by phosphor-psu-monitor? It feels like it fits well here but it seems weird that some other app will be setting the property. Should we host this under a separate interface? xyz.openbmc_project.Status.Chassis maybe? Or should we just say state-manager hosts it and leaves Undefined and it's up to psu-monitor to set?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 64,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 64,
            "sizeDeletions": 5
        },
        {
            "number": 4,
            "revision": "435fa9b88c33c71a41ee6d04bb8d61510bfbc3c6",
            "parents": [
                "55f12ee1390bfeea9abb3a80fe7fc0aff56a0b0a"
            ],
            "ref": "refs/changes/15/48015/4",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1635798242,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 151,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I don't understand what is being proposed here.\n\nThere is already an xyz.openbmc_project.State.Chassis interface.  Isn't that interface hosted by phosphor-state-manager?  Why would you host a new instance of it, with a new property, just for that one property?\n\nHopefully you're not suggesting that psu-monitor will be *writing* that property, hosted currently by the phosphor-state-manager, reflecting its current view of the state?"
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 151,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, this was definitely an open question. Derek and I talked a bit offline and I think in the end, the best design is for the existing xyz.openbmc_project.State.Chassis under/xyz/openbmc_project/state/chassisX to host a new PowerStatus property. When it's read by someone, the code will query all power status interfaces associated with that chassis and return state based on that."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 158,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Can you elaborate how this is related to PLDM?  (I don't actually know much about it so it could be that the terms are just ones I'm not familiar with.)  The reference to it seems to have come out of no where."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 158,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, maybe too much implementation detail here. Basically, on IBM systems, when we know a brownout is coming (i.e. a UPS is about to run out of power or something), we notify the host firmware. The host firmware provides an option to it's users to indicate if they want the system to auto power on when the brown out completes. This text was trying to capture that design point. I think I'll just make it more generic and indicate that there is a one-time feature users can utilize if they wish a special one-time behavior when the brownout completes."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 167,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Do you have ideas on what this would look like for a system where there are multiple host instances managed on individual sub-chassis elements?  It is fairly common to service them by hot-removing them, which may appear like a \"Brownout\".\n\nI'm not positive as to what indicates \"Good\" based on the design, but it seems possible that the power state is \"Off\" but likely \"Good\", as in, we now believe that power has been re-established in a way that the sub-chassis will successfully power on, but that we haven't actively turned it back on yet.  It probably isn't always a good idea automatically to turn back on all your voltage regulators outside of the normal power sequence, is it?"
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 167,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "> Do you have ideas on what this would look like for a system where there are multiple host instances managed on individual sub-chassis elements? \n\nAlthough not fully implemented, everything in state-manager is instance based, including the software which runs the automated power on logic. We mostly just support a single chassis and host instance. But, say we did have two chassis, we'd then have two chassis-state manager instances, both hosting the xyz.openbmc_project.State.Chassis interface. They would only be looking for power status for their associated chassis. You talk about \"sub-chassis elements\" but I'm not sure what that is? For each pgood power domain, we'd have a single chassis instance. If a VRM goes out, the whole domain is out and any host code running on that chassis.\n\n>  It probably isn't always a good idea automatically to turn back on all your voltage regulators outside of the normal power sequence, is it?\n\nWe only turn things back on when the brownout completes if the user has a auto power on policy set that wants us to power back on."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 64,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 64,
            "sizeDeletions": 5
        },
        {
            "number": 5,
            "revision": "14f5ad57031c33380f46a759f26c9beda5066fa5",
            "parents": [
                "6c5fb75fe20a8293967bab95fb080ea22c776410"
            ],
            "ref": "refs/changes/15/48015/5",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1636145362,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 107,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "A nuance here. If the user requests a power on, we'll try it. If still in a brownout then errors will be logged and power on will fail. The only thing firmware needs to do is not run the APR logic when a brownout condition is active."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 150,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "To follow naming conventions in that interface, this should be \"CurrentPowerStatus\"."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 150,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 78,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 78,
            "sizeDeletions": 5
        },
        {
            "number": 6,
            "revision": "2a8fbed8c1a709d4db7b57c3c7c89bfd05c3e338",
            "parents": [
                "6c5fb75fe20a8293967bab95fb080ea22c776410"
            ],
            "ref": "refs/changes/15/48015/6",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1636492621,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 177,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "I assume this 'PowerStatus' here is the \"interface to be defined in a later update\"?"
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 177,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, let me make this a bit more vague until we get it defined within phosphor-power."
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 184,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "Are these now 'CurrentPowerStatus'?"
                },
                {
                    "file": "designs/power-recovery.md",
                    "line": 184,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Yeah, this is a bit unclear. Let me try and clean it up a bit."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 77,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 77,
            "sizeDeletions": 5
        },
        {
            "number": 7,
            "revision": "64e18508d84a2bc65de163de0e0becf07da86a8e",
            "parents": [
                "d6db4a532e97ac3b96846a3a2deee5446c4f5bf8"
            ],
            "ref": "refs/changes/15/48015/7",
            "uploader": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "createdOn": 1637268705,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "designs/power-recovery.md",
                    "line": 185,
                    "reviewer": {
                        "name": "Derek Howard",
                        "email": "derekh@us.ibm.com",
                        "username": "derekhoward55"
                    },
                    "message": "Looks good, just a question on if the phosphor-power app should start the state-manager service directly, or if the state-manager service will automatically be started via monitoring the DBus interface changing (or if thats a detail TBD)."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 78,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 78,
            "sizeDeletions": 5
        },
        {
            "number": 8,
            "revision": "e67c779ec815d204ae7d9f07da3f533f6aab8364",
            "parents": [
                "f3d60e3d1ec71069a1fd1d793ebc967192e4e07d"
            ],
            "ref": "refs/changes/15/48015/8",
            "uploader": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "createdOn": 1638809925,
            "author": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "designs/power-recovery.md",
                    "type": "MODIFIED",
                    "insertions": 78,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 78,
            "sizeDeletions": 5
        }
    ]
}