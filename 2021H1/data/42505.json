{
    "project": "openbmc/sdbusplus",
    "branch": "master",
    "id": "I32bc0fdf89c44cc6bab1c4622b143d6e06098659",
    "number": 42505,
    "subject": "message: Add call_async method",
    "owner": {
        "name": "William A. Kennington III",
        "email": "wak@google.com",
        "username": "wak-google"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/sdbusplus/+/42505",
    "commitMessage": "message: Add call_async method\n\nThis makes it possible to perform an async method call that is agnostic\nto the event loop running the sd_bus state machine.\n\nChange-Id: I32bc0fdf89c44cc6bab1c4622b143d6e06098659\nSigned-off-by: William A. Kennington III <wak@google.com>\n",
    "createdOn": 1618994940,
    "lastUpdated": 1620309411,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1618994940,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1618994955,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1618995064,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1618995075,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1618995078,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/15878/ : ABORTED"
        },
        {
            "timestamp": 1618995716,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/15879/ : SUCCESS"
        },
        {
            "timestamp": 1619006429,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1619017453,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1619170637,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1619798062,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1620252677,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1620252700,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620252760,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1620253060,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/16748/ : FAILURE"
        },
        {
            "timestamp": 1620253375,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1620253386,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620253674,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/16749/ : FAILURE"
        },
        {
            "timestamp": 1620254752,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1620254764,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620255467,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/16753/ : SUCCESS"
        },
        {
            "timestamp": 1620268167,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5: Code-Review+2\n\n(1 comment)"
        },
        {
            "timestamp": 1620268416,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1620309411,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Change has been successfully merged by Patrick Williams"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "9b527882f58f8488fbc4aa0b822db337f16fa39c",
            "parents": [
                "533218b426ce2b393248591c234e2bb734fd0c43"
            ],
            "ref": "refs/changes/05/42505/1",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1618994940,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "type": "MODIFIED",
                    "insertions": 84,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                },
                {
                    "file": "test/message/call.cpp",
                    "type": "ADDED",
                    "insertions": 103,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 227,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "ea4b07c6d1af1755758bf844b2628f05cb7e0d62",
            "parents": [
                "533218b426ce2b393248591c234e2bb734fd0c43"
            ],
            "ref": "refs/changes/05/42505/2",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1618995064,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 483,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "What is the rationale for catching this error and turning it, effectively, into a silent issue rather than letting the top-level exception handler deal with it and/or asserting/crashing?\n\nThis seems to be the only time we do this kind of behavior from what I can tell.  We should document the rationale at least (if we keep doing it)."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 483,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I was thinking about this commit a little more and I wonder if we need to create a promise type, which will eventually also be used for co-routines, rather than returning a simple bus::slot for async calls.  The promise would hold the return value and any exception which came from the underlying async call and when you try to get the return value it would rethrow (or the exception could be obtained from it via query).\n\nI'm not suggesting that this needs to be done right now, but we should probably keep that in mind before we have too many users of this async function."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 483,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "The rationale is similar to the event driven callback code too. I found that triggering an abort in those cases was almost always less desirable than ignoring the error, because most callbacks would end up just wrapping everything in a `try catch` block to prevent spurious aborts. In the cases it would abort, the program would end up hard to debug and failing for cases where it could limp along and still be serviceable. If you needed to do something special on error, you would have your own cleanup logic anyway. I would hope that most code is using sensible RAII, so any used resources could be cleaned up in the process.\n\nWRT to future based async. A long time ago I wrote a future / promise type intended to replace the builtin ones that use locks / atomics. It would allow the event loop to wake up the future callback and allow the user to get from it with similar semantics to std::future.\nhttps://gerrit.openbmc-project.xyz/c/openbmc/stdplus/+/22336\n\nAt the time the intended use case was for an sd_bus_call_async function\nhttps://gerrit.openbmc-project.xyz/c/openbmc/sdbusplus/+/21351\n\nBut with the coroutines features in c++20 I would need to revist how this was implemented as it doesn't really make sense with that model. I still think it would be nice to have a call_async function that more closely matches how sd_bus_call_async works under the covers for users not interested in asio / coroutines."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 483,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "> I found that triggering an abort in those cases was almost always less desirable than ignoring the error, because most callbacks would end up just wrapping everything in a `try catch` block to prevent spurious aborts. In the cases it would abort, the program would end up hard to debug and failing for cases where it could limp along and still be serviceable.\n\nI don't like any silent catching and dropping of an error.  Even in this case where we're printing something to the console (maybe that ends up in the journal), nobody will look at it.  So we could go a LONG time with unseen issues before anybody deals with them.\n\nIf you print the exception, print a message, and abort, you should have everything someone needs to debug it.\n\nIf someone decides to wrap the whole call in a try-catch and drop it in their own code, that is on them.  Maybe they feel like that is a good way to deal with it.  We shouldn't make those decisions for other developers in library code though.\n\n> WRT to future based async....\n\nOk.  I'm planning on working on coroutine support in the near future.  We can revisit this once I have something working there.  I don't think it would be high impact to migrate people to a promise return in the future if we go that route."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 483,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "We can start out terminating and see how it goes. It's easier to switch to more permissive behavior later if we want."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 484,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Why fprintf?  This is C++ code."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 484,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "If you prefer iostreams we could do that, purely personal preference."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 484,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I'm mostly indifferent.  We don't have other cases of this already in the code either way.  All 'cout' calls are in test cases or examples.  There are no [f]printf calls.\n\nThe only potential problem is that buffering can be implemented differently between C++ and C io.  We could end up with a message out the console sooner, due to use of fprintf, than the application itself due to their use of cout/cerr."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 484,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Since we are terminating now, it would make sense to print something rather than nothing even if it gets interleaved it could help debug. I left it as printf but I don't mind switching it."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 484,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "std::terminate spews the normal untaught exception blurb, so this is good enough to me.  I don\u2019t think we need extra printing."
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "line": 484,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "I realized that, I already fixed it in P5"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "type": "MODIFIED",
                    "insertions": 84,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "test/message/call.cpp",
                    "type": "ADDED",
                    "insertions": 103,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 226,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "02fe814e351822776f53081918e5f5d3c8434b05",
            "parents": [
                "fcff67636ac3bdf58d52606eb1519c5cfbd1a4ef"
            ],
            "ref": "refs/changes/05/42505/3",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620252677,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "type": "MODIFIED",
                    "insertions": 87,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "test/message/call.cpp",
                    "type": "ADDED",
                    "insertions": 99,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 225,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "f5abef6af97a68814ff115ce84fa95f5d1afcd60",
            "parents": [
                "fcff67636ac3bdf58d52606eb1519c5cfbd1a4ef"
            ],
            "ref": "refs/changes/05/42505/4",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620253375,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "type": "MODIFIED",
                    "insertions": 87,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "test/message/call.cpp",
                    "type": "ADDED",
                    "insertions": 98,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 224,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "472b702298660dc5469424b3bf0e6921c8b4061b",
            "parents": [
                "fcff67636ac3bdf58d52606eb1519c5cfbd1a4ef"
            ],
            "ref": "refs/changes/05/42505/5",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620254752,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message.hpp",
                    "type": "MODIFIED",
                    "insertions": 84,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/sdbus.hpp",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/test/sdbus_mock.hpp",
                    "type": "MODIFIED",
                    "insertions": 9,
                    "deletions": 0
                },
                {
                    "file": "test/meson.build",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": 0
                },
                {
                    "file": "test/message/call.cpp",
                    "type": "ADDED",
                    "insertions": 102,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 225,
            "sizeDeletions": 0
        }
    ]
}