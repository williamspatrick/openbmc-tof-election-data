{
    "project": "openbmc/sdbusplus",
    "branch": "master",
    "id": "Ia6c2f4fb19984f549c6bac2d67d0b5d610022038",
    "number": 42946,
    "subject": "native_types: Reduce append allocation",
    "owner": {
        "name": "William A. Kennington III",
        "email": "wak@google.com",
        "username": "wak-google"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/sdbusplus/+/42946",
    "commitMessage": "native_types: Reduce append allocation\n\nThis builds the string from left to right, instead of dealing with\nstring inserts, optimizing for allocations. Uses our own hex encoder\ninstead of relying on systemd libraries. This maintains explicit\ncompatability with the systemd encoding scheme.\n\nChange-Id: Ia6c2f4fb19984f549c6bac2d67d0b5d610022038\nSigned-off-by: William A. Kennington III <wak@google.com>\n",
    "createdOn": 1620262659,
    "lastUpdated": 1620918314,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1620262659,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1620262695,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620262875,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 2: Commit message was updated."
        },
        {
            "timestamp": 1620263037,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1620263053,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620263056,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/16760/ : ABORTED"
        },
        {
            "timestamp": 1620263744,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/16762/ : SUCCESS"
        },
        {
            "timestamp": 1620266600,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 3:\n\n(2 comments)\n\nI've added Ed to this one and the \"Don't escape all strings\".  At one point he was thinking he would escape all strings, I thought, but I know we brought up the 'openbmc_project' issue before in Discord."
        },
        {
            "timestamp": 1620268239,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1620268371,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1620268398,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620269069,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/16766/ : SUCCESS"
        },
        {
            "timestamp": 1620315689,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4: Code-Review+1\n\n(1 comment)\n\nLGTM"
        },
        {
            "timestamp": 1620331624,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Uploaded patch set 5: Patch Set 4 was rebased."
        },
        {
            "timestamp": 1620331636,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620332335,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/16825/ : SUCCESS"
        },
        {
            "timestamp": 1620918298,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1620918314,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Change has been successfully rebased and submitted as 285f78b142c83b849aff792c00eea5c5650ba17f by Patrick Williams"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "993eab58aba2d3754cd88bf2b7ab42b3532bdb64",
            "parents": [
                "5289b4be438d0869f70818cdbe18225d53d555ff"
            ],
            "ref": "refs/changes/46/42946/1",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620262659,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 14,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -12
                },
                {
                    "file": "src/message/native_types.cpp",
                    "type": "MODIFIED",
                    "insertions": 85,
                    "deletions": -48
                },
                {
                    "file": "test/message/types.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 100,
            "sizeDeletions": 62
        },
        {
            "number": 2,
            "revision": "6b3443b8f231ad9bf839b4adb57263e39b71b57a",
            "parents": [
                "5289b4be438d0869f70818cdbe18225d53d555ff"
            ],
            "ref": "refs/changes/46/42946/2",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620262875,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -12
                },
                {
                    "file": "src/message/native_types.cpp",
                    "type": "MODIFIED",
                    "insertions": 85,
                    "deletions": -48
                },
                {
                    "file": "test/message/types.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 100,
            "sizeDeletions": 62
        },
        {
            "number": 3,
            "revision": "de26818f89eac3abce023786e16d3ddb4c2b45f1",
            "parents": [
                "5289b4be438d0869f70818cdbe18225d53d555ff"
            ],
            "ref": "refs/changes/46/42946/3",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620263037,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "line": 148,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "I don't know the constructor of string_view.  Does removing the 'const char*' parameter here push extra construction work onto the caller?  This might diminish some of the optimization you did to move the functions into the library.  A small tail-recursive variant in the library that converts from const char* -> string_view might be a little better."
                },
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "line": 148,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "It pushes the work of doing strlen() onto a `const char *` caller, but if you pass an std::string it just takes the already stored ptr + str. Google internally generally thinks this is very efficient since it's just a ptr + size tuple that you are passing and prefers passing by copy as the indirection is slower.\n\nThe first thing the function does is look at the length of the passed in argument, so you don't gain anything by holding off on performing the strlen."
                },
                {
                    "file": "src/message/native_types.cpp",
                    "line": 35,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Can we just use 'isalnum'?"
                },
                {
                    "file": "src/message/native_types.cpp",
                    "line": 35,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Ah yeah, of course this exists."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -12
                },
                {
                    "file": "src/message/native_types.cpp",
                    "type": "MODIFIED",
                    "insertions": 85,
                    "deletions": -51
                },
                {
                    "file": "test/message/types.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 100,
            "sizeDeletions": 65
        },
        {
            "number": 4,
            "revision": "5134eb015f71f1a98c918c329f3bd3da78e1f98d",
            "parents": [
                "5289b4be438d0869f70818cdbe18225d53d555ff"
            ],
            "ref": "refs/changes/46/42946/4",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620268371,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/message/native_types.cpp",
                    "line": 32,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "For what it's worth... this is neat, I didn't know you could initialize constexpr arrays like this."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -12
                },
                {
                    "file": "src/message/native_types.cpp",
                    "type": "MODIFIED",
                    "insertions": 86,
                    "deletions": -51
                },
                {
                    "file": "test/message/types.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 65
        },
        {
            "number": 5,
            "revision": "986088d3d4195134515f23218956275c045d26dd",
            "parents": [
                "e39b3dcb91f14e109b203150a6bd23ad798d07f9"
            ],
            "ref": "refs/changes/46/42946/5",
            "uploader": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "createdOn": 1620331624,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -12
                },
                {
                    "file": "src/message/native_types.cpp",
                    "type": "MODIFIED",
                    "insertions": 86,
                    "deletions": -51
                },
                {
                    "file": "test/message/types.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 65
        },
        {
            "number": 6,
            "revision": "285f78b142c83b849aff792c00eea5c5650ba17f",
            "parents": [
                "673ad2347f283d2ac2e8344c770deb7156640150"
            ],
            "ref": "refs/changes/46/42946/6",
            "uploader": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "createdOn": 1620918314,
            "author": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "include/sdbusplus/message/native_types.hpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -12
                },
                {
                    "file": "src/message/native_types.cpp",
                    "type": "MODIFIED",
                    "insertions": 86,
                    "deletions": -51
                },
                {
                    "file": "test/message/types.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 101,
            "sizeDeletions": 65
        }
    ]
}