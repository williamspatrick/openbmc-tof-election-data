{
    "project": "openbmc/openbmc-build-scripts",
    "branch": "master",
    "id": "I130766a822710bf634eca3677e22c9d484defa00",
    "number": 42252,
    "subject": "unit-test: meson: check meson version for C++20",
    "owner": {
        "name": "Patrick Williams",
        "email": "patrick@stwcx.xyz",
        "username": "williamspatrick"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/openbmc-build-scripts/+/42252",
    "commitMessage": "unit-test: meson: check meson version for C++20\n\nIf a package requests C++20 support, only Meson >=0.57 recognizes\nthe 'cpp_std=c++20' option but doesn't warn about this.  Add code\nin our test path to ensure that if a package has requested C++20\nit also requests Meson >=0.57.  This helps prevent a cryptic\nmessage if someone compiles one of our packages on a distro with\nan older version of Meson.\n\nTested: Ran script against sdbusplus with various settings of\nmeson_version and cpp_std.\n\nSigned-off-by: Patrick Williams <patrick@stwcx.xyz>\nChange-Id: I130766a822710bf634eca3677e22c9d484defa00\n",
    "createdOn": 1618429717,
    "lastUpdated": 1618869417,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1618429717,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1618429732,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1618429737,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/268/"
        },
        {
            "timestamp": 1618430598,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/268/ : SUCCESS"
        },
        {
            "timestamp": 1618433947,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618434075,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618434337,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618434773,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618435112,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618436045,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618593441,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1618593456,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1618593461,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/269/"
        },
        {
            "timestamp": 1618593487,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1618594108,
            "reviewer": {
                "name": "Matthew Barth",
                "email": "msbarth@linux.ibm.com",
                "username": "msbarth"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1618594476,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/269/ : SUCCESS"
        },
        {
            "timestamp": 1618869389,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 2: Code-Review+2"
        },
        {
            "timestamp": 1618869417,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Change has been successfully merged by Andrew Geissler"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "37e511353cf476385cfff8f30a79d260e4fc2d4e",
            "parents": [
                "17c69eda1542e82c537268ad2a4ce84caf569938"
            ],
            "ref": "refs/changes/52/42252/1",
            "uploader": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "createdOn": 1618429717,
            "author": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "scripts/unit-test.py",
                    "line": 1030,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "`meson_version` appears to be optionally defined in a meson.build file, so a project that doesnt have it defined, but is using >=0.57 while running this would fail with the exception, correct?"
                },
                {
                    "file": "scripts/unit-test.py",
                    "line": 1030,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "Looks like the `meson-info/meson-info.json` file that generated after doing \"meson build\" contains the meson version, but in this format for example:\n\n\"meson_version\": {\"full\": \"0.55.1\", \"major\": 0, \"minor\": 55, \"patch\": 1}"
                },
                {
                    "file": "scripts/unit-test.py",
                    "line": 1030,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "> so a project that doesnt have it defined, but is using >=0.57 while running this would fail with the exception, correct?\n\nCorrect.  If someone specifies C++20 and they *don't* specify at least Meson 0.57 in their meson.build, I want it to fail.  It doesn't matter what version of meson we happen to be running during the test.\n\nC++20 will always work for us because we're running a new enough meson.  But, a user downloading one of these repositories and attempting to compile it with their native distro will get a cryptic error about meson not recognizing the C++20 option.  It is far better to simply halt them for running an older version of Meson and let meson tell them it is too old."
                },
                {
                    "file": "scripts/unit-test.py",
                    "line": 1030,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "Right, but if a repo's meson.build file *does not* provide a \"meson_version\", wont we get this failure still since this if would succeed with meson_version = None?\n\nIf that's the case, maybe the exception should note that \"meson_version\" needs to be given in the meson.build file."
                },
                {
                    "file": "scripts/unit-test.py",
                    "line": 1030,
                    "reviewer": {
                        "name": "Matthew Barth",
                        "email": "msbarth@linux.ibm.com",
                        "username": "msbarth"
                    },
                    "message": "For example, phosphor-power currently has:\n```\nproject(\n    'phosphor-power',\n    'cpp',\n    default_options: [\n        'warning_level=3',\n        'werror=true',\n        'cpp_std=c++17',\n        'prefix=/usr'\n    ],\n    license: 'Apache-2.0',\n    version: '1.0',\n)\n```\nand could update to using c++20 without adding \"meson_version\":\n```\nproject(\n    'phosphor-power',\n    'cpp',\n    default_options: [\n        'warning_level=3',\n        'werror=true',\n        'cpp_std=c++20',\n        'prefix=/usr'\n    ],\n    license: 'Apache-2.0',\n    version: '1.0',\n)\n```\nThen wouldnt we see phosphor-power fail CI since its using c++20 now, but didnt explicitly add \"meson_version\" to its meson.build file and our CI has meson >=0.57?"
                },
                {
                    "file": "scripts/unit-test.py",
                    "line": 1030,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "If a repository does not set meson_version in the project, then the meson_version here is None.  'if not meson_version' will run the if condition, which raises the exception and it fails.  Thus, any project that specifies C++20 and either abstains from specifying a meson_version OR specifies an old meson_version will fail CI (and block merge until the specification is added)."
                },
                {
                    "file": "scripts/unit-test.py",
                    "line": 1030,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Updated Exception message to be clearer how to fix the reported issue."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "scripts/unit-test.py",
                    "type": "MODIFIED",
                    "insertions": 29,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 29,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "95095f17d02f8c6d3622f5573b32fed3f4f68f61",
            "parents": [
                "17c69eda1542e82c537268ad2a4ce84caf569938"
            ],
            "ref": "refs/changes/52/42252/2",
            "uploader": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "createdOn": 1618593441,
            "author": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "scripts/unit-test.py",
                    "type": "MODIFIED",
                    "insertions": 32,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 32,
            "sizeDeletions": 0
        }
    ]
}