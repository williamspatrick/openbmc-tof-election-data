{
    "project": "openbmc/phosphor-misc",
    "branch": "master",
    "id": "I4a944d62d3bbb7e57d1beab90e435663d3ff1e1f",
    "number": 42280,
    "subject": "usb-ctrl: Add support to set BMC and Host's mac address",
    "owner": {
        "name": "Lei YU",
        "email": "yulei.sh@bytedance.com",
        "username": "mine260309"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-misc/+/42280",
    "commitMessage": "usb-ctrl: Add support to set BMC and Host's mac address\n\nBy default it uses the random MAC address when usb ecm is enabled.\nInspired from usb-network.sh in meta-quanta, it is possible to specify\nthe MAC address.\n\nAdd optional arguments to set the MAC address when ecm is enabled, so\nthat the BMC and Host side's MAC addresses are known.\n\nTested: Verify the MAC addresses could be specified by below command:\n\n            usb-ctrl ecm usbeth0 on <bmc-addr host-addr>\n\nSigned-off-by: Lei YU <yulei.sh@bytedance.com>\nSigned-off-by: Milton Miller <miltonm@us.ibm.com>\nChange-Id: I4a944d62d3bbb7e57d1beab90e435663d3ff1e1f\n",
    "createdOn": 1618482724,
    "lastUpdated": 1620387357,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1618482724,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1618482737,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1618482907,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/15495/ : SUCCESS"
        },
        {
            "timestamp": 1618810168,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1:\n\n(2 comments)\n\nPlease make optional."
        },
        {
            "timestamp": 1618810940,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618811609,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618827239,
            "reviewer": {
                "name": "Igor Kononenko",
                "email": "i.kononenko@yadro.com",
                "username": "ikmsk10"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618989173,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1618989853,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1618989864,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1618989952,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1618990023,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/15865/ : SUCCESS"
        },
        {
            "timestamp": 1619006511,
            "reviewer": {
                "name": "Igor Kononenko",
                "email": "i.kononenko@yadro.com",
                "username": "ikmsk10"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1619492558,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1619492568,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(2 comments)"
        },
        {
            "timestamp": 1619492594,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1619492703,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/16231/ : SUCCESS"
        },
        {
            "timestamp": 1619513040,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1619513051,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1619513074,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/16264/ : SUCCESS"
        },
        {
            "timestamp": 1619513244,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 4:\n\n(8 comments)\n\nThere was enough here I pushed my suggestions."
        },
        {
            "timestamp": 1619514317,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 4:\n\n(3 comments)\n\nLei I just pushed this to speed implementation of my suggestions and not to take it over.\n\nPlease test and continue this series.\n\nThanks."
        },
        {
            "timestamp": 1619517333,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1619667561,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1619667574,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1619667597,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/16361/ : SUCCESS"
        },
        {
            "timestamp": 1620358349,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 5: Code-Review+1\n\nTested on g220a system and it works fine."
        },
        {
            "timestamp": 1620363874,
            "reviewer": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "message": "Patch Set 5: Code-Review+1\n\nThanks was waiting on test results."
        },
        {
            "timestamp": 1620370512,
            "reviewer": {
                "name": "Igor Kononenko",
                "email": "i.kononenko@yadro.com",
                "username": "ikmsk10"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1620387357,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Change has been successfully merged by Lei YU"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "d5b0c0b701e4ff95ca365840cec54c73a33e0d9a",
            "parents": [
                "6f46c4e974faf7ccc5525cfb4b6912ecc2635308"
            ],
            "ref": "refs/changes/80/42280/1",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1618482724,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 146,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "This syntax sets opt4 to usb-ro if $4 is unset or empty string."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 146,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Yup, but I do not want to break the previous logic.\nSo if user sets bmc's mac address but does not set host's mac address, the opt4 here becomes usb-ro, and it will fail on line 175.\nI intend to accept this behavior, unless there is a better solution."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 146,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Hmm surprised we don't have set -e in this script."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 146,
                    "reviewer": {
                        "name": "Igor Kononenko",
                        "email": "i.kononenko@yadro.com",
                        "username": "ikmsk10"
                    },
                    "message": "You might want to declare separate functions, e.g. init_mass_storage and init_ecm, which will define the own logic. The first two passed args might be stripped and pass through into that functions.\nThis will allow making more proper of configuring the default values which is dependent on usb-type."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 146,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "> Hmm surprised we don't have set -e in this script.\n\nI think it may be on purpose, with -e any failure will make the script to quit, then the status could be in the middle of the init/de-init, it may cause the script failure on following calls.\n\n> You might want to declare separate functions\n\nYup, separated functions make sense."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 146,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Another thought, if we use separate functions, it will contain duplicated code.\nI am not really good at bash programming, so adding an extra \"if\" to initialize $opt4 to keep the previous logic."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 146,
                    "reviewer": {
                        "name": "Igor Kononenko",
                        "email": "i.kononenko@yadro.com",
                        "username": "ikmsk10"
                    },
                    "message": "I'm very disliked that the usb_insert args might be ambiguous. I would prefer to do refactor this function.\nBut IMHO, this works for another change. \nI would like to have accepted these modifications if anyone else no has any objections."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 174,
                    "reviewer": {
                        "name": "Igor Kononenko",
                        "email": "i.kononenko@yadro.com",
                        "username": "ikmsk10"
                    },
                    "message": "I would prefer to include double-quotes for the passed ${opt3} and ${opt4}."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 174,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 175,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Which makes this nonsense or error EINVAL"
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 175,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Already discussed in the above comment."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 15,
            "sizeDeletions": 11
        },
        {
            "number": 2,
            "revision": "c43b8a50ee8f7674b06d5d245b2665780821976c",
            "parents": [
                "6f46c4e974faf7ccc5525cfb4b6912ecc2635308"
            ],
            "ref": "refs/changes/80/42280/2",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1618989853,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 18,
            "sizeDeletions": 11
        },
        {
            "number": 3,
            "revision": "a3da79749c1834004955aa8dfe8992ba3594d62a",
            "parents": [
                "6f46c4e974faf7ccc5525cfb4b6912ecc2635308"
            ],
            "ref": "refs/changes/80/42280/3",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1619492558,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 42,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "We should double quote the args here"
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 136,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "the optional mac address\nor \noptionally the mac address"
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 138,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "This became a long line, but I see that \"mass storage\" was repeated the second could be eliminated without loss of clarity IMO.   Or see alternative below."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 139,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "then 'usb-ro' is used by default\n(yes I know it was unchanged text, just a nit / cleanup while here)"
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 140,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "similar to dev_addr.\n\nAs an alternative, would it be more clear to list the type and then $3 and $4\n\nFor Mass Storage,\n  $3: file\n  $4: optional interface_type (usb|usb-ro|hdd|cdrom) defaults to usb-ro\nFor ecm,\n  $3: optional device MAC address\n  $4: optional host MAC address"
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 149,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Thinking a bit about this, $3 is not optional for usb storage.  \nAn alternative grouping is to create additional variables that are interface specific.\nand since it is only assignment we don't have to qualify by the interface type.\n\n\nlocal file = \"$3\"\nlocal interface_type = \"${4:-usb-ro}\"\nlocal dev_addr = \"$3\"\nlocal host_addr = \"$4\""
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 176,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Why should we need to specify both if we only care about one?\ninstead of && here nest an if for each line.   \nOr just write them unconditionally, we will get -EINVAL and a random MAC generated (I checked).\n\nThe variable names would change with my suggestion above."
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 176,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "The referenced behaviour is here:\n\nhttps://github.com/openbmc/linux/blob/d538d632fb2046278ff3457994d64d43ee2901c7/drivers/usb/gadget/function/u_ether.c#L692"
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "line": 214,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Our conventionabove is to put variables in <angle-brackets>\nchanging both to be optional but still positionable (see changeset 4)"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": -11
                }
            ],
            "sizeInsertions": 18,
            "sizeDeletions": 11
        },
        {
            "number": 4,
            "revision": "646ec1b882abb6d7a5005f47a3c504cea068bd61",
            "parents": [
                "6f46c4e974faf7ccc5525cfb4b6912ecc2635308"
            ],
            "ref": "refs/changes/80/42280/4",
            "uploader": {
                "name": "Milton D. Miller II",
                "email": "miltonm@us.ibm.com",
                "username": "mdmillerii"
            },
            "createdOn": 1619513040,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "The commit message should stand on its own.\n\nAdd support to set the ecm network Host MAC Address"
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 12,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "I did not test this."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 15,
                    "reviewer": {
                        "name": "Milton D. Miller II",
                        "email": "miltonm@us.ibm.com",
                        "username": "mdmillerii"
                    },
                    "message": "Ooops missed the trailing >\n\n@andrewg this seems to have missed the SOB checker"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 16,
                    "deletions": 0
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "type": "MODIFIED",
                    "insertions": 16,
                    "deletions": -10
                }
            ],
            "sizeInsertions": 16,
            "sizeDeletions": 10
        },
        {
            "number": 5,
            "revision": "cf69740eebf68b76cc5f0509a9b34204dd8bf0a1",
            "parents": [
                "75d4734fb8bc390d97106544af8f2ffd2d9bf02c"
            ],
            "ref": "refs/changes/80/42280/5",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1619667561,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 22,
                    "deletions": 0
                },
                {
                    "file": "usb-ctrl/usb-ctrl",
                    "type": "MODIFIED",
                    "insertions": 18,
                    "deletions": -7
                }
            ],
            "sizeInsertions": 18,
            "sizeDeletions": 7
        }
    ]
}