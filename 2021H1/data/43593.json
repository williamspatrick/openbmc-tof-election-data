{
    "project": "openbmc/openbmc-build-scripts",
    "branch": "master",
    "id": "Ibbe6b291468664d40f8ca53df942ff1f3e3656d8",
    "number": 43593,
    "subject": "unit-test-docker: add nanopb package and dependencies",
    "owner": {
        "name": "Zhenfei Tai",
        "email": "ztai@google.com",
        "username": "ztai-goog"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/openbmc-build-scripts/+/43593",
    "commitMessage": "unit-test-docker: add nanopb package and dependencies\n\nAdd nanopb and its dependencies to the docker image so that recipes\ndepend on nanopb can run unit test correctly.\n\nSigned-off-by: Zhenfei Tai <ztai@google.com>\nChange-Id: Ibbe6b291468664d40f8ca53df942ff1f3e3656d8\n",
    "createdOn": 1622136638,
    "lastUpdated": 1622819482,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1622136638,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1622136653,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1622136663,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/300/"
        },
        {
            "timestamp": 1622138493,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/300/ : SUCCESS"
        },
        {
            "timestamp": 1622143780,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1622145448,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1622145463,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1622145469,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/301/"
        },
        {
            "timestamp": 1622145585,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 2: Code-Review+1"
        },
        {
            "timestamp": 1622145647,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1622146474,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1622146488,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1622146490,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/301/ : ABORTED"
        },
        {
            "timestamp": 1622146500,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/302/"
        },
        {
            "timestamp": 1622146955,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/302/ : SUCCESS"
        },
        {
            "timestamp": 1622147269,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1622160518,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1622181920,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1622181976,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1622181986,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/303/"
        },
        {
            "timestamp": 1622183245,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/303/ : SUCCESS"
        },
        {
            "timestamp": 1622185339,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1622185458,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1622188958,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1622188976,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1622188982,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5:\n\nBuild Started https://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/304/"
        },
        {
            "timestamp": 1622189018,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1622190787,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/CI-MISC/job/ci-openbmc-build-scripts/304/ : SUCCESS"
        },
        {
            "timestamp": 1622559795,
            "reviewer": {
                "name": "Andrew Geissler",
                "email": "geissonator@yahoo.com",
                "username": "geissonator"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1622570085,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Uploaded patch set 6: Commit message was updated."
        },
        {
            "timestamp": 1622570124,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1622598927,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1622601816,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1622617781,
            "reviewer": {
                "name": "William A. Kennington III",
                "email": "wak@google.com",
                "username": "wak-google"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1622691189,
            "reviewer": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1622819482,
            "reviewer": {
                "name": "Patrick Williams",
                "email": "patrick@stwcx.xyz",
                "username": "williamspatrick"
            },
            "message": "Patch Set 6:\n\n(2 comments)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "89f251f3665f3c32ee256dedd2d7b67129030102",
            "parents": [
                "b84d59dc1ffa681f40eea1243d41b44d2d9c347e"
            ],
            "ref": "refs/changes/93/43593/1",
            "uploader": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "createdOn": 1622136638,
            "author": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 285,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Use the 0.4.5 tag directly here."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 13,
            "sizeDeletions": 1
        },
        {
            "number": 2,
            "revision": "afb54e738f01ba67d045b6f2dd6f76440689d477",
            "parents": [
                "b84d59dc1ffa681f40eea1243d41b44d2d9c347e"
            ],
            "ref": "refs/changes/93/43593/2",
            "uploader": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "createdOn": 1622145448,
            "author": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "nit: None of the config_flags are needed as these are common for cmake builds."
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "Zhenfei Tai",
                        "email": "ztai@google.com",
                        "username": "ztai-goog"
                    },
                    "message": "Updated. Removed the shared and static lib option as `cmake_flags` already covers them.\n\nI'm a little unsure about the install_prefix, which is set to /usr/local. However I don't see the LD_LIBRARY_PATH set to include the path.\n\nIn my docker testing, meson couldn't find the nanopb lib when it's installed in /usr/local.\n`meson.get_compiler('c').find_library('libprotobuf-nanopb')`\n\nAdmittedly there's a `dir` argument in find_library() but I'm not sure if that's the best solution."
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "/usr/local should be fine, your build should be looking at the 'nanopb-config' dependency for the correct linking and include paths."
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "Zhenfei Tai",
                        "email": "ztai@google.com",
                        "username": "ztai-goog"
                    },
                    "message": "It seems it has to be /usr/local; otherwise the lib won't be copied into the final image from package specific one.\n\nIn addition, nanopb installs the python modules into /usr/local/lib/python3/dist-packages (https://github.com/nanopb/nanopb/blob/master/CMakeLists.txt#L42), which needs to be copied into /usr/local/lib/python3.9/dist-packages in order to run the generator properly.\n\nCode depends on nanopb needs to specify `dirs` in meson build in order to find the nanopb library."
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "Zhenfei Tai",
                        "email": "ztai@google.com",
                        "username": "ztai-goog"
                    },
                    "message": "On a second thought, using a symlink is sufficient."
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Ehh, if this behavior is going to require changes for users of nanopb to be able to locate the library, we should just set the install prefix to /usr here. That's what bitbake will do anyway.\n\nI was hoping the installed cmake definitions would work with meson's cmake dependency support and we wouldn't have to change either, but I guess not."
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "Zhenfei Tai",
                        "email": "ztai@google.com",
                        "username": "ztai-goog"
                    },
                    "message": "There's logic here that copies from /usr/local of each package docker into final docker image. https://github.com/openbmc/openbmc-build-scripts/blob/master/scripts/build-unit-test-docker#L509\n\nOne solution is to make `prefix` a Package property so that we can make it specific for nanopb. What do you think?"
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "William A. Kennington III",
                        "email": "wak@google.com",
                        "username": "wak-google"
                    },
                    "message": "Oh yeah, some backstory on that. Copying from /usr is slow / difficult because most of the contents of the container live in that folder. If we had to copy /usr, we would be repeatedly copying most of the same files over and over. By installing each unique thing to /usr/local and copying them in at the end, copying is relatively fast and efficient since nothing is in /usr/local by default and all the operations are copying unique sets of files.\n\nI wonder if there is something we could do to at least provide symlinks... The most straightfoward fix would be to contribute a proper pkgconfig to nanopb."
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 287,
                    "reviewer": {
                        "name": "Zhenfei Tai",
                        "email": "ztai@google.com",
                        "username": "ztai-goog"
                    },
                    "message": "The symlink is for the python module. Is it configurable by pkgconfig?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 13,
            "sizeDeletions": 1
        },
        {
            "number": 3,
            "revision": "b02d50792f559e00211b0b9ed0614e489b617bc1",
            "parents": [
                "b84d59dc1ffa681f40eea1243d41b44d2d9c347e"
            ],
            "ref": "refs/changes/93/43593/3",
            "uploader": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "createdOn": 1622146474,
            "author": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 11,
            "sizeDeletions": 1
        },
        {
            "number": 4,
            "revision": "ff5a9be94d00327cc5e4ae3a9f71bc964d841266",
            "parents": [
                "b84d59dc1ffa681f40eea1243d41b44d2d9c347e"
            ],
            "ref": "refs/changes/93/43593/4",
            "uploader": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "createdOn": 1622181920,
            "author": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 717,
                    "reviewer": {
                        "name": "Zhenfei Tai",
                        "email": "ztai@google.com",
                        "username": "ztai-goog"
                    },
                    "message": "The directory doesn't exist in the image, not sure if it's doing anything useful."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 11,
            "sizeDeletions": 1
        },
        {
            "number": 5,
            "revision": "092d800ddb37cb41c121282e63216a75f9cebc49",
            "parents": [
                "b84d59dc1ffa681f40eea1243d41b44d2d9c347e"
            ],
            "ref": "refs/changes/93/43593/5",
            "uploader": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "createdOn": 1622188958,
            "author": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 8,
                    "reviewer": {
                        "name": "Andrew Geissler",
                        "email": "geissonator@yahoo.com",
                        "username": "geissonator"
                    },
                    "message": "Please include a brief \"why\" this is needed in the commit msg."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 8,
                    "reviewer": {
                        "name": "Zhenfei Tai",
                        "email": "ztai@google.com",
                        "username": "ztai-goog"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 11,
            "sizeDeletions": 1
        },
        {
            "number": 6,
            "revision": "3602d7b801e5071618d90afd306d1b8829e9553f",
            "parents": [
                "b84d59dc1ffa681f40eea1243d41b44d2d9c347e"
            ],
            "ref": "refs/changes/93/43593/6",
            "uploader": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "createdOn": 1622570085,
            "author": {
                "name": "Zhenfei Tai",
                "email": "ztai@google.com",
                "username": "ztai-goog"
            },
            "kind": "NO_CODE_CHANGE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 9,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Who is planning to use protobuf?  Can those few repositories just use a cmake/meson submodule to pick it up in CI testing?"
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "line": 288,
                    "reviewer": {
                        "name": "Patrick Williams",
                        "email": "patrick@stwcx.xyz",
                        "username": "williamspatrick"
                    },
                    "message": "Do we have an issue to nanopb to get this fixed?  Please add a #TODO.  We really shouldn't have to know to fix this up every time the underlying distro upgrades the python version and we have no way to detect it when making a change to this repository, do we?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "scripts/build-unit-test-docker",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 11,
            "sizeDeletions": 1
        }
    ]
}