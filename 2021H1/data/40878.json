{
    "project": "openbmc/telemetry",
    "branch": "master",
    "id": "I1e950c096e36d2150a94c459e794bbac7303100d",
    "number": 40878,
    "subject": "async changes to support 40749",
    "owner": {
        "name": "Ed Tanous",
        "email": "ed@tanous.net",
        "username": "edtanous"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/telemetry/+/40878",
    "commitMessage": "async changes to support 40749\n\nhttps://gerrit.openbmc-project.xyz/c/openbmc/sdbusplus/+/40749\n\nIs currently proposing changing these APIs to use C++ asio style\ncallbacks instead of the javascript callbacks.  This was the only usage\nof these callbacks that I found, so this patchset is to move to the new\ntype.\n\nRequires 40749 to be merged before this will build.\n\nSigned-off-by: Ed Tanous <edtanous@google.com>\nSigned-off-by: Krzysztof Grobelny <krzysztof.grobelny@intel.com>\nChange-Id: I1e950c096e36d2150a94c459e794bbac7303100d\n",
    "createdOn": 1614118146,
    "lastUpdated": 1614934392,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1614118146,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1614118160,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1614118178,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/12926/ : FAILURE"
        },
        {
            "timestamp": 1614160467,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1614163645,
            "reviewer": {
                "name": "Jozef Wludzik",
                "email": "jozef.wludzik@intel.com",
                "username": "jwludzik"
            },
            "message": "Patch Set 1:\n\nFix for CI is merged -> https://gerrit.openbmc-project.xyz/c/openbmc/telemetry/+/40825\nStyle issue that is reported by jenkins is resolved.\nPlease, rebase your change"
        },
        {
            "timestamp": 1614184582,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2: Patch Set 1 was rebased"
        },
        {
            "timestamp": 1614184600,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1614184636,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/12985/ : FAILURE"
        },
        {
            "timestamp": 1614184914,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1614184984,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n> Patch Set 1:\n> \n> Fix for CI is merged -> https://gerrit.openbmc-project.xyz/c/openbmc/telemetry/+/40825\n> Style issue that is reported by jenkins is resolved.\n> Please, rebase your change\n\nPatch has been rebased, but this requires the patch mentioned in the commit message to be merged at the same time for it to build."
        },
        {
            "timestamp": 1614266523,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1614267508,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1614928175,
            "reviewer": {
                "name": "Adrian Ambro\u017cewicz",
                "email": "adrian.ambrozewicz@linux.intel.com",
                "username": "aambroze"
            },
            "message": "Patch Set 3: Patch Set 2 was rebased"
        },
        {
            "timestamp": 1614928189,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1614928720,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/13386/ : FAILURE"
        },
        {
            "timestamp": 1614929952,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Patch Set 3:\n\n@Ed, Look like your patches doesn't include fixes in unit tests"
        },
        {
            "timestamp": 1614933451,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1614933465,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1614933786,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1614933811,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1614933813,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/13399/ : ABORTED"
        },
        {
            "timestamp": 1614934366,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/13400/ : SUCCESS"
        },
        {
            "timestamp": 1614934377,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Patch Set 5: Code-Review+2"
        },
        {
            "timestamp": 1614934392,
            "reviewer": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "message": "Change has been successfully merged by Krzysztof Grobelny"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "baec7c78df370f5679924d268e39b46e2c70c64e",
            "parents": [
                "9f14591205aa47cf3e99c44cc8a0469cb87ed8da"
            ],
            "ref": "refs/changes/78/40878/1",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1614118146,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "src/sensor.cpp",
                    "line": 45,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This portion of the capture is duplicated between the error case and the \"good\" case."
                },
                {
                    "file": "src/sensor.cpp",
                    "line": 40,
                    "reviewer": {
                        "name": "Krzysztof Grobelny",
                        "email": "krzysztof.grobelny@intel.com",
                        "username": "krzysztof-i"
                    },
                    "message": "What are the benefits of it? You are just moving code from library to user code. You will have to add this if condition in every future usage of getProperty"
                },
                {
                    "file": "src/sensor.cpp",
                    "line": 40,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> What are the benefits of it? \n\nI've outlined the benefits in the crosslinked patch in the commit message.  This handles more cases, and is in line with std::networking.\n\n> You are just moving code from library to user code. You will have to add this if condition in every future usage of getProperty\n\nI'm not following what you mean about moving to user code.  This whole file is user code unless I'm mistaken, and I've simply modified how error conditions are registered.\n\nThe difference between having to add a conditional versus having to construct a whole new lambda is negligible, and as you can see from this patch, seems to lead to less code, as the lambda captures aren't duplicated  between the two handlers.  This means that the complex objects aren't constructed twice, which should be good overall.  These benefits are called out in the commit message in sdbusplus."
                },
                {
                    "file": "src/sensor.cpp",
                    "line": 40,
                    "reviewer": {
                        "name": "Krzysztof Grobelny",
                        "email": "krzysztof.grobelny@intel.com",
                        "username": "krzysztof-i"
                    },
                    "message": "I agree that it prevents something moveable only to be passed to both handlers, that is valid point and this proposition seems like good approach to address it. Thanks for explanation.\n\nThere is one part that I disagree, current version (with separate callbacks) doesn't duplicate logic. For some cases like this one, it is not important which error code was it, so once errorHandler is called no additional check is needed (I saw many cases like this in bmcweb). Version with one callback will have to rapeat if (ec) in every invocation even for something trivial like this. I am not sure what you meant by less code (lines? characters? binary size?) but for sure in version with two callback common logic was already in getProperty and didn't have to be repeated in every invocation of getProperty. Duplicating capture list is inconvenient and inefficient, but duplicating logic means adding more complexity to your code.\n\nAnyway it has to wait for sdbusplus patch to be merged. I raised my concerns there, once change in sdbusplus is accepted this one will get +2."
                },
                {
                    "file": "src/sensor.cpp",
                    "line": 40,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "> I agree that it prevents something moveable only to be passed to both handlers, that is valid point and this proposition seems like good approach to address it. Thanks for explanation.\n> \n> There is one part that I disagree, current version (with separate callbacks) doesn't duplicate logic.\n\nFair point, I should've said that it duplicates the captures, which isn't strictly \"logic\" so, you're right here.\n\n> For some cases like this one, it is not important which error code was it, so once errorHandler is called no additional check is needed (I saw many cases like this in bmcweb).\n\nIt should be noted, this is an antipattern in bmcweb now.  As a general rule, there is info in the error message that generally results in status code changes to the response.  We're slowly going through and fixing them.\n\n> Version with one callback will have to rapeat if (ec) in every invocation even for something trivial like this. I am not sure what you meant by less code (lines? characters? binary size?)\n\nAt least for the sdbusplus examples, the binary size is identical, because the optimizer seems to optimize the exact same.  In this case, I mean less characters;  If you look at the old code, there's repeated lambda captures.  That's the code that's \"duplicate\"\n\n> but for sure in version with two callback common logic was already in getProperty and didn't have to be repeated in every invocation of getProperty. Duplicating capture list is inconvenient and inefficient, but duplicating logic means adding more complexity to your code.\n> \n> Anyway it has to wait for sdbusplus patch to be merged. I raised my concerns there, once change in sdbusplus is accepted this one will get +2.\n\n\nCool.  Thanks for your review."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "src/sensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -8
                }
            ],
            "sizeInsertions": 10,
            "sizeDeletions": 8
        },
        {
            "number": 2,
            "revision": "3cf062db2d2b0128ced2af57936322d28896e2ef",
            "parents": [
                "92cfff44d5790b7e59930e8a6acf15751a3cd891"
            ],
            "ref": "refs/changes/78/40878/2",
            "uploader": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "createdOn": 1614184582,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "src/sensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -8
                }
            ],
            "sizeInsertions": 10,
            "sizeDeletions": 8
        },
        {
            "number": 3,
            "revision": "0e80f4d498bb2cf4fa289603b59037734e1cf5ab",
            "parents": [
                "753e4b3c843dd5d1068949c4106a6389f0e0ffbc"
            ],
            "ref": "refs/changes/78/40878/3",
            "uploader": {
                "name": "Adrian Ambro\u017cewicz",
                "email": "adrian.ambrozewicz@linux.intel.com",
                "username": "aambroze"
            },
            "createdOn": 1614928175,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "src/sensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -8
                }
            ],
            "sizeInsertions": 10,
            "sizeDeletions": 8
        },
        {
            "number": 4,
            "revision": "ad3e7886f9b63358335b4f15654007e9c2cc75b6",
            "parents": [
                "753e4b3c843dd5d1068949c4106a6389f0e0ffbc"
            ],
            "ref": "refs/changes/78/40878/4",
            "uploader": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "createdOn": 1614933451,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "src/sensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -8
                },
                {
                    "file": "tests/src/test_report.cpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": -11
                },
                {
                    "file": "tests/src/test_report_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -7
                },
                {
                    "file": "tests/src/test_trigger.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -6
                }
            ],
            "sizeInsertions": 48,
            "sizeDeletions": 32
        },
        {
            "number": 5,
            "revision": "0e7ae5dbf1c07c19f11166acc812907e4ccd01ec",
            "parents": [
                "753e4b3c843dd5d1068949c4106a6389f0e0ffbc"
            ],
            "ref": "refs/changes/78/40878/5",
            "uploader": {
                "name": "Krzysztof Grobelny",
                "email": "krzysztof.grobelny@intel.com",
                "username": "krzysztof-i"
            },
            "createdOn": 1614933786,
            "author": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 20,
                    "deletions": 0
                },
                {
                    "file": "src/sensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 10,
                    "deletions": -8
                },
                {
                    "file": "tests/src/test_report.cpp",
                    "type": "MODIFIED",
                    "insertions": 16,
                    "deletions": -12
                },
                {
                    "file": "tests/src/test_report_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -7
                },
                {
                    "file": "tests/src/test_trigger.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -6
                }
            ],
            "sizeInsertions": 49,
            "sizeDeletions": 33
        }
    ]
}