{
    "project": "openbmc/phosphor-bmc-code-mgmt",
    "branch": "master",
    "id": "I18e76238821f48a3b322594bb359fcb37f28f397",
    "number": 43221,
    "subject": "bios: Delete uploaded DBus object after update",
    "owner": {
        "name": "Lei YU",
        "email": "yulei.sh@bytedance.com",
        "username": "mine260309"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-bmc-code-mgmt/+/43221",
    "commitMessage": "bios: Delete uploaded DBus object after update\n\nWhen the BIOS code update is completed, delete the uploaded DBus object\nso that only the \"bios_active\" object remains.\nOtherwise it leaves the uploaded DBus object that does not reflect a\nreal thing.\n\nTested: Verify only bios_active remains and the uploaded BIOS object is\n        deleted from DBus, and it is possible to upload and update the\n        same BIOS tarball for multieple times.\n\nSigned-off-by: Lei YU <yulei.sh@bytedance.com>\nChange-Id: I18e76238821f48a3b322594bb359fcb37f28f397\n",
    "createdOn": 1620977786,
    "lastUpdated": 1628078426,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1620977786,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1620977800,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1620977859,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/17264/ : SUCCESS"
        },
        {
            "timestamp": 1621627511,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1622797822,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1622833225,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623136938,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1626177127,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1626177157,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1626177240,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1626177241,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/21887/ : SUCCESS"
        },
        {
            "timestamp": 1626589772,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n@Adriana @Gunnar please help to check this change that is re-written with asio operations."
        },
        {
            "timestamp": 1626726138,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 2: Code-Review+1\n\n(1 comment)\n\nDid a code update on ibm's rainier for sanity check."
        },
        {
            "timestamp": 1626759062,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 2:\n\n@Gunnar @Ratan could you kindly help to review this patch?"
        },
        {
            "timestamp": 1626889831,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 2:\n\n(2 comments)"
        },
        {
            "timestamp": 1627062034,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1627275134,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1627275145,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627275235,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/22735/ : SUCCESS"
        },
        {
            "timestamp": 1627275422,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1627501480,
            "reviewer": {
                "name": "Adriana Kobylak",
                "email": "anoo@linux.ibm.com",
                "username": "anoo1"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1627538354,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3:\n\nWaiting for Gunnar's +1"
        },
        {
            "timestamp": 1627543611,
            "reviewer": {
                "name": "Jayanth Othayoth",
                "email": "ojayanth@gmail.com",
                "username": "ojayanth"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1627984995,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1628078426,
            "reviewer": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "message": "Change has been successfully rebased and submitted as 258681896603d2af084e8f6bf86bc33423ed7153 by Lei YU"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "bdd042e176a1ea1a2122f58670d7fad436b00841",
            "parents": [
                "e53a7bcaa29bcfe8ab417c95e897ddc0b8a78e1b"
            ],
            "ref": "refs/changes/21/43221/1",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1620977786,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "activation.cpp",
                    "line": 440,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "An idea is to add a match for property change in createBIOSObject() in the item updater, then set the Activation property for bios_active to Invalid at the beginning of the bios update, then here set bios_active to Active, and the property change callback would then go through all bios versions and delete the ones that are note bios_active."
                },
                {
                    "file": "activation.cpp",
                    "line": 440,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Sorry for the late reply, I did not have the time to test the match signal.\nJust a quick question, will the match work if the signal is sent from its own process?"
                },
                {
                    "file": "activation.cpp",
                    "line": 440,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "I would think it'd work because the process would call dbus to change a property which would trigger a dbus PropertyChanged signal, and the watch would be triggered by any dbus signal that fits the match, even if that same process is the one that made the dbus call to update the property. But I guess we should try it."
                },
                {
                    "file": "activation.cpp",
                    "line": 440,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Will try it once I have time.\nFor now let's hold it."
                },
                {
                    "file": "activation.cpp",
                    "line": 440,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "The \"match\" way is a bit complicated, and the case here really just needs an async call to erase the uploaded BIOS object.\nSo the code is updated to use boost asio to post a lambda to erase the object, which is more clear than the timer callback way."
                },
                {
                    "file": "activation.cpp",
                    "line": 440,
                    "reviewer": {
                        "name": "Adriana Kobylak",
                        "email": "anoo@linux.ibm.com",
                        "username": "anoo1"
                    },
                    "message": "Thanks for trying the match even if it didn't work :) . At least this asio way is much clearer than the original proposal."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": 0
                },
                {
                    "file": "item_updater.cpp",
                    "type": "MODIFIED",
                    "insertions": 28,
                    "deletions": 0
                },
                {
                    "file": "item_updater.hpp",
                    "type": "MODIFIED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "item_updater_main.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -3
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 62,
            "sizeDeletions": 4
        },
        {
            "number": 2,
            "revision": "e8641d1ddad018dbb6d2d90539e4429b48c54c1f",
            "parents": [
                "16aa28a057a3d8036ea5a0e963ebb731c3a6ab43"
            ],
            "ref": "refs/changes/21/43221/2",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1626177127,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "activation.cpp",
                    "line": 8,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Can the include just be  #include <boost/asio/io_context.hpp> ?"
                },
                {
                    "file": "activation.cpp",
                    "line": 8,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                },
                {
                    "file": "item_updater_main.cpp",
                    "line": 12,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Isn't this deprecated ?\nhttps://github.com/openbmc/bmcweb/commit/fb4fd5d43bc621e84add3499911a6f2a08694f8b"
                },
                {
                    "file": "item_updater_main.cpp",
                    "line": 12,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "Done"
                },
                {
                    "file": "meson.build",
                    "line": 18,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "Why do we want this?\nInstead maybe \n'-DBOOST_ASIO_NO_DEPRECATED', ?"
                },
                {
                    "file": "meson.build",
                    "line": 18,
                    "reviewer": {
                        "name": "Lei YU",
                        "email": "yulei.sh@bytedance.com",
                        "username": "mine260309"
                    },
                    "message": "It's copied from other repos, e.g. dbus-sensors.\nChanged to BOOST_ASIO_NO_DEPRECATED and it builds fine."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                },
                {
                    "file": "item_updater_main.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -6
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 30,
            "sizeDeletions": 6
        },
        {
            "number": 3,
            "revision": "9bd1c51033b1e9d3e7298194d2f48ec2088e1ade",
            "parents": [
                "16aa28a057a3d8036ea5a0e963ebb731c3a6ab43"
            ],
            "ref": "refs/changes/21/43221/3",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1627275134,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                },
                {
                    "file": "item_updater_main.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -6
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 30,
            "sizeDeletions": 6
        },
        {
            "number": 4,
            "revision": "258681896603d2af084e8f6bf86bc33423ed7153",
            "parents": [
                "7eebeaac3630bb0ccbb293b916c06509b15524ee"
            ],
            "ref": "refs/changes/21/43221/4",
            "uploader": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "createdOn": 1628078426,
            "author": {
                "name": "Lei YU",
                "email": "yulei.sh@bytedance.com",
                "username": "mine260309"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "activation.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                },
                {
                    "file": "item_updater_main.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": -6
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 30,
            "sizeDeletions": 6
        }
    ]
}