{
    "project": "openbmc/phosphor-power",
    "branch": "master",
    "id": "Ibd5a4f8cf8de8fc19933963ddc1ffbb53396970f",
    "number": 44451,
    "subject": "psu-ng: Change PSU D-Bus interface to configurable",
    "owner": {
        "name": "B. J. Wyman",
        "email": "bjwyman@gmail.com",
        "username": "bjwyman"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/44451",
    "commitMessage": "psu-ng: Change PSU D-Bus interface to configurable\n\nMake the name for the D-Bus power supply interface a configurable build\noption set by meson, stored in the config.h file.\n\nSigned-off-by: Brandon Wyman <bjwyman@gmail.com>\nChange-Id: Ibd5a4f8cf8de8fc19933963ddc1ffbb53396970f\n",
    "createdOn": 1624571275,
    "lastUpdated": 1631052792,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1624571275,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1624571291,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1624571712,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/20660/ : SUCCESS"
        },
        {
            "timestamp": 1624572789,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 1:\n\nThis change is ready for review."
        },
        {
            "timestamp": 1624572833,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 1:\n\nI started going down a path of another example, thinking Inspur, but I do not have a system or QEMU/simulator to test such a thing on."
        },
        {
            "timestamp": 1624906470,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1624959740,
            "reviewer": {
                "name": "Chanh Nguyen",
                "email": "chanh@os.amperecomputing.com",
                "username": "chnguyen-ampere"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1625182034,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1625182096,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 1:\n\nBrad, is there something you can think of that might make this a little better at being more generic?"
        },
        {
            "timestamp": 1625182896,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1625576527,
            "reviewer": {
                "name": "Brad Bishop",
                "email": "bradleyb@fuzziesquirrel.com",
                "username": "bradbishop"
            },
            "message": "Patch Set 1:\n\n(2 comments)"
        },
        {
            "timestamp": 1625775476,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 1:\n\n(1 comment)\n\nThe meson changes seem very similar (identical?) to the ones in https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/44456\n\nWere you planning on merging both of these reviews?\n\nAlso, are you planning on taking Brad's suggestion?  If so, I assume more changes are coming."
        },
        {
            "timestamp": 1625783298,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1625783340,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 1:\n\n> Patch Set 1:\n> \n> (1 comment)\n> \n> The meson changes seem very similar (identical?) to the ones in https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/44456\n> \n> Were you planning on merging both of these reviews?\n> \n> Also, are you planning on taking Brad's suggestion?  If so, I assume more changes are coming.\n\nThe change in 44456 depends on the one underneath it, thus the reason it is separate from this change."
        },
        {
            "timestamp": 1625783932,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1625783943,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1625784197,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 2:\n\nSquashed into https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/44450"
        },
        {
            "timestamp": 1625784393,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/21660/ : SUCCESS"
        },
        {
            "timestamp": 1625786516,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1625786927,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1625786994,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1625787009,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1625787018,
            "reviewer": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1625787458,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/21663/ : SUCCESS"
        },
        {
            "timestamp": 1625787634,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1626106357,
            "reviewer": {
                "name": "Chanh Nguyen",
                "email": "chanh@os.amperecomputing.com",
                "username": "chnguyen-ampere"
            },
            "message": "Patch Set 3:\n\n(1 comment)"
        },
        {
            "timestamp": 1627312948,
            "reviewer": {
                "name": "Shawn McCarney",
                "email": "shawnmm@us.ibm.com",
                "username": "smccarney"
            },
            "message": "Removed reviewer John Meyer."
        },
        {
            "timestamp": 1631052792,
            "reviewer": {
                "name": "Bruce Mitchell",
                "email": "bruce.mitchell@linux.vnet.ibm.com",
                "username": "BMC-Bruce"
            },
            "message": "Patch Set 3: Code-Review+1"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "591ce9489fc43ac87e4911b9454a3e37566e5130",
            "parents": [
                "8bf1b5a8788a2b0b9c18f34d5429c44b2cde0183"
            ],
            "ref": "refs/changes/51/44451/1",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1624571275,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "meson.build",
                    "line": 80,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "The advantage of this approach is that the generic PSU type could map to multiple config file variables.  The disadvantage is that if someone has a non-IBM PSU, they need to modify this file to add support for it.\n\nAn alternative approach would be a power_supply_interface build option that is set directly to the D-Bus interface name.  For example, -Dpower_supply_interface=xyz.openbmc_project.Acme.PSU.  Then no changes are required to this file for non-IBM PSUs; it would just be a recipe change.  However, I'm not sure if you want an option that granular.\n\nIs changing the interface name inside EntityManager to something generic not possible/practical?  That might avoid the need for this build option.\n\nNote that if someone does specify a different D-Bus interface, the interface will need to provide the same property names for the current C++ code to work."
                },
                {
                    "file": "meson.build",
                    "line": 80,
                    "reviewer": {
                        "name": "Chanh Nguyen",
                        "email": "chanh@os.amperecomputing.com",
                        "username": "chnguyen-ampere"
                    },
                    "message": "Agree Shawn,\n\nI'm using the non-IBM PSUs, and I must change the meson.build for my supply_interface. Why we set the interface name directly from build option? Or any other better solution."
                },
                {
                    "file": "meson.build",
                    "line": 80,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "I was kind of thinking ahead here.\n\nI originally had this change and https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/44456 in the same commit, but then split it into two commits as the other one depends on the changes to use libgpiod.\n\nI was thinking we could get both the interface name and the device driver name based on a passed in power supply type variable."
                },
                {
                    "file": "meson.build",
                    "line": 80,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "> An alternative approach would be\n\nI have another alternative to consider - simply support any number of PSU specific interfaces without any build time configuration.  This lets you support systems with different power supplies.\n\n> Is changing the interface name inside EntityManager to something generic not possible/practical?\n\nI think if IBMCFFPSConnector is already being used for non IBMCFFPS PSUs, the schema itself is already \"generic\" - from a functional point of view the name is not really all that important.  It could just stay as it is.\n\n> I was thinking we could get both the interface name and the device driver name based on a passed in power supply type variable.\n\nYou could maintain a mapping between interface names and device driver names in a header file.  This is what entity-manager does:\n\nhttps://github.com/openbmc/entity-manager/blob/master/include/devices.hpp\n\nAgain, this approach lets you support multiple power supply types at the same time and requires no build time configuration.  win-win."
                },
                {
                    "file": "meson.build",
                    "line": 80,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "> > An alternative approach would be\n> \n> I have another alternative to consider - simply support any number of PSU specific interfaces without any build time configuration.  This lets you support systems with different power supplies.\n> \nHow would one \"support any number of PSU specific interfaces\"?\n\n> > Is changing the interface name inside EntityManager to something generic not possible/practical?\n> \n> I think if IBMCFFPSConnector is already being used for non IBMCFFPS PSUs, the schema itself is already \"generic\" - from a functional point of view the name is not really all that important.  It could just stay as it is.\n> \n\nWhy would I need to support any number of PSU specific interfaces, if we do not need specific interfaces, due to IBMCFFPSConnector already being generic enough, despite the name?\n\nI do not see evidence of anyone else using IBMCFFPSConnector, at least not in the current code I just fetched from github.ibm.com/openbmc/entity-manager.\n\n> > I was thinking we could get both the interface name and the device driver name based on a passed in power supply type variable.\n> \n> You could maintain a mapping between interface names and device driver names in a header file.  This is what entity-manager does:\n> \n> https://github.com/openbmc/entity-manager/blob/master/include/devices.hpp\n> \n> Again, this approach lets you support multiple power supply types at the same time and requires no build time configuration.  win-win.\n\nIf IBMCFFPSConnector is generic enough, how does one do a mapping from the generic interface to the device driver to use for the power supply?"
                },
                {
                    "file": "meson.build",
                    "line": 99,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Shawn, this ends up being SUPPLY_INTERFACE in config.h, which kind of sort of ... eliminates the PSInterface coding standards violation... I think."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 16,
                    "reviewer": {
                        "name": "Chanh Nguyen",
                        "email": "chanh@os.amperecomputing.com",
                        "username": "chnguyen-ampere"
                    },
                    "message": "Hi,\n\nWith the \"I2CBus\" and \"I2CAddress\", Must we configure the property name like that in https://github.com/openbmc/entity-manager/tree/master/configurations ?"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 16,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Yes.\n\nSo, for the IBM systems, the power supply information is coming from:\nhttps://github.com/openbmc/entity-manager/blob/master/configurations/Nisqually.json\nand \nhttps://github.com/openbmc/entity-manager/blob/master/configurations/Bellavista.json\n\nThose depend on the schema:\nhttps://github.com/openbmc/entity-manager/blob/master/schemas/IBM.json\n\nIt now looks even more apparently that something could maybe be a bit more generic for these as well."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 16,
                    "reviewer": {
                        "name": "Brad Bishop",
                        "email": "bradleyb@fuzziesquirrel.com",
                        "username": "bradbishop"
                    },
                    "message": "> It now looks even more apparently that something could maybe be a bit more generic for these as well.\n\nIf the schema works and is being used for someone besides IBM it is already general purpose - it doesn't matter what the name is or what file it is in."
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 16,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Chanh,\n\nHow are you currently using this application to monitor your non-IBM PSUs?\n\nDo you use a different D-Bus interface?  A different driver?  Both?"
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "line": 16,
                    "reviewer": {
                        "name": "Chanh Nguyen",
                        "email": "chanh@os.amperecomputing.com",
                        "username": "chnguyen-ampere"
                    },
                    "message": "Shawn,\n\nCurrently, I'm using the phosphor-power-supply app to monitor my PSU. It's The CSU2000AP (https://www.artesyn.com/power-supplies/websheet/628/csu2000ap-series)\n\nI'm using the pmbus driver (https://github.com/openbmc/linux/blob/dev-5.10/Documentation/hwmon/pmbus.rst). The supply_interface is \"xyz.openbmc_project.Configuration.pmbus\" and the supply_driver is \"pmbus\"\n\nFinally, What's approach for non-ibm psus? I wouldn't like to change the meson.build for my supply_interface and supply_driver. I will comment in the https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-power/+/44456\n\nThanks,\nChanh"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "meson_options.txt",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": -6
                }
            ],
            "sizeInsertions": 24,
            "sizeDeletions": 6
        },
        {
            "number": 2,
            "revision": "1924582baa3be5744318b1b28713815024464312",
            "parents": [
                "681b2a36e646b07c26fbdd2bae8f0ee1c4f3f930"
            ],
            "ref": "refs/changes/51/44451/2",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1625783932,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "phosphor-power-supply/README.md",
                    "line": 13,
                    "reviewer": {
                        "name": "Shawn McCarney",
                        "email": "shawnmm@us.ibm.com",
                        "username": "smccarney"
                    },
                    "message": "Should this be 'SUPPLY_INTERFACE'?"
                },
                {
                    "file": "phosphor-power-supply/README.md",
                    "line": 13,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Oops! I even pointed it out earlier. :-/"
                },
                {
                    "file": "phosphor-power-supply/README.md",
                    "line": 13,
                    "reviewer": {
                        "name": "B. J. Wyman",
                        "email": "bjwyman@gmail.com",
                        "username": "bjwyman"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "meson_options.txt",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/README.md",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": -6
                }
            ],
            "sizeInsertions": 23,
            "sizeDeletions": 7
        },
        {
            "number": 3,
            "revision": "774e3383cb757435272361d7af10cc14f0c498a5",
            "parents": [
                "681b2a36e646b07c26fbdd2bae8f0ee1c4f3f930"
            ],
            "ref": "refs/changes/51/44451/3",
            "uploader": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "createdOn": 1625786994,
            "author": {
                "name": "B. J. Wyman",
                "email": "bjwyman@gmail.com",
                "username": "bjwyman"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "meson.build",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                },
                {
                    "file": "meson_options.txt",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                },
                {
                    "file": "phosphor-power-supply/README.md",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                },
                {
                    "file": "phosphor-power-supply/psu_manager.cpp",
                    "type": "MODIFIED",
                    "insertions": 6,
                    "deletions": -6
                }
            ],
            "sizeInsertions": 23,
            "sizeDeletions": 7
        }
    ]
}