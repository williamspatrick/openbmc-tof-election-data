{
    "project": "openbmc/x86-power-control",
    "branch": "master",
    "id": "I5d6fa74dca60bd97e038373db6050d3dc4696431",
    "number": 45317,
    "subject": "Trigger SIO_PWR_GOOD if on before daemon starts",
    "owner": {
        "name": "Jean-Marie Verdun",
        "email": "jean-marie.verdun@hpe.com",
        "username": "vejmarie"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/x86-power-control/+/45317",
    "commitMessage": "Trigger SIO_PWR_GOOD if on before daemon starts\n\nOn some systems SIO_POWER_GOOD could be asserted before daemon\nstarts, which is not triggering an assert event and lead\nthe daemon to wait for even for such events to appear breaking\nthe UI and power control feature\n\nTest: Enhance startup. Validated on HPE ProLiant DL360 Gen10\n\nSigned-off-by: Jean-Marie Verdun <jean-marie.verdun@hpe.com>\nChange-Id: I5d6fa74dca60bd97e038373db6050d3dc4696431\n",
    "createdOn": 1627425236,
    "lastUpdated": 1629929622,
    "open": false,
    "status": "ABANDONED",
    "comments": [
        {
            "timestamp": 1627425236,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1627425255,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627425597,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/23024/ : FAILURE"
        },
        {
            "timestamp": 1627433895,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 2: Published edit on patch set 1."
        },
        {
            "timestamp": 1627433915,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627433969,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/23027/ : FAILURE"
        },
        {
            "timestamp": 1627434457,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 3: Published edit on patch set 2."
        },
        {
            "timestamp": 1627434470,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627434905,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/23029/ : SUCCESS"
        },
        {
            "timestamp": 1627440515,
            "reviewer": {
                "name": "Bruce Mitchell",
                "email": "bruce.mitchell@linux.vnet.ibm.com",
                "username": "BMC-Bruce"
            },
            "message": "Patch Set 3:\n\nThe Subject line is way longer than 50 characters.\nhttps://chris.beams.io/posts/git-commit/#limit-50"
        },
        {
            "timestamp": 1627446775,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 4: Commit message was updated."
        },
        {
            "timestamp": 1627446881,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 5: Commit message was updated."
        },
        {
            "timestamp": 1627483603,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 6: Published edit on patch set 5."
        },
        {
            "timestamp": 1627483630,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627483707,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/23091/ : SUCCESS"
        },
        {
            "timestamp": 1627542524,
            "reviewer": {
                "email": "rashmi.r.v@linux.intel.com",
                "username": "Rashmi-RV"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1627542594,
            "reviewer": {
                "email": "rashmi.r.v@linux.intel.com",
                "username": "Rashmi-RV"
            },
            "message": "Patch Set 6:\n\n(1 comment)"
        },
        {
            "timestamp": 1627574071,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 7: Published edit on patch set 6."
        },
        {
            "timestamp": 1627574086,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627574135,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 7: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/23218/ : FAILURE"
        },
        {
            "timestamp": 1627574266,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8: Published edit on patch set 7."
        },
        {
            "timestamp": 1627574281,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627574361,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 8: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/23221/ : SUCCESS"
        },
        {
            "timestamp": 1627683119,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 8:\n\nCan you please provide more detail on the issue you see that is prompting this change?\n\nThe powerState is already initialized starting on line 3351.  It is initialized based on the state of psPowerOK.  Are you seeing that the power state is not correctly initialized based on the state of psPowerOK?"
        },
        {
            "timestamp": 1627700921,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8:\n\n(2 comments)\n\n> Patch Set 8:\n> \n> Can you please provide more detail on the issue you see that is prompting this change?\n> \n> The powerState is already initialized starting on line 3351.  It is initialized based on the state of psPowerOK.  Are you seeing that the power state is not correctly initialized based on the state of psPowerOK?\n\nIn the case of SIO mode, the code is looking for psPowerOK and sioPowerGood. psPowerOK is not good enough by itself as initialized. \n\nRoughly if psPowerOK is good, the systems is declared as On but the code is waiting for sioPowerGood to be triggered.\n\nThe issue is that on ProLiant, if the host power policy is set to on, sioPowerGood is set to high before the BMC is started, and doesn't trigger any assert event leading the code to wait for ever for such event. So that is why I added that initial test and trigger the event by hand when gpios are initialized."
        },
        {
            "timestamp": 1628026678,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 8:\n\n(2 comments)\n\n> Patch Set 8:\n> \n> (2 comments)\n> \n> > Patch Set 8:\n> > \n> > Can you please provide more detail on the issue you see that is prompting this change?\n> > \n> > The powerState is already initialized starting on line 3351.  It is initialized based on the state of psPowerOK.  Are you seeing that the power state is not correctly initialized based on the state of psPowerOK?\n> \n> In the case of SIO mode, the code is looking for psPowerOK and sioPowerGood. psPowerOK is not good enough by itself as initialized. \n> \nSo far, this has been treated as a corner case.  We can consider adding extra logic here to handle both signals, but we would need to understand all the error cases and how to handle them.\n\n> Roughly if psPowerOK is good, the systems is declared as On but the code is waiting for sioPowerGood to be triggered.\n> \n> The issue is that on ProLiant, if the host power policy is set to on, sioPowerGood is set to high before the BMC is started, and doesn't trigger any assert event leading the code to wait for ever for such event. So that is why I added that initial test and trigger the event by hand when gpios are initialized.\n\nCan you show where you are getting stuck waiting forever?  I added a couple comments to the code where the state is initialized to \"on\" when psPowerOk is asserted.  Then, since it is in the \"on\" state, the sioPowerGoodAssert event that you trigger is not handled and takes no action.\n\nIs your system in a different state after initialization?"
        },
        {
            "timestamp": 1628517401,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8:\n\n> Patch Set 8:\n> \n> (2 comments)\n> \n> > Patch Set 8:\n> > \n> > (2 comments)\n> > \n> > > Patch Set 8:\n> > > \n> > > Can you please provide more detail on the issue you see that is prompting this change?\n> > > \n> > > The powerState is already initialized starting on line 3351.  It is initialized based on the state of psPowerOK.  Are you seeing that the power state is not correctly initialized based on the state of psPowerOK?\n> > \n> > In the case of SIO mode, the code is looking for psPowerOK and sioPowerGood. psPowerOK is not good enough by itself as initialized. \n> > \n> So far, this has been treated as a corner case.  We can consider adding extra logic here to handle both signals, but we would need to understand all the error cases and how to handle them.\n> \n> > Roughly if psPowerOK is good, the systems is declared as On but the code is waiting for sioPowerGood to be triggered.\n> > \n> > The issue is that on ProLiant, if the host power policy is set to on, sioPowerGood is set to high before the BMC is started, and doesn't trigger any assert event leading the code to wait for ever for such event. So that is why I added that initial test and trigger the event by hand when gpios are initialized.\n> \n> Can you show where you are getting stuck waiting forever?  I added a couple comments to the code where the state is initialized to \"on\" when psPowerOk is asserted.  Then, since it is in the \"on\" state, the sioPowerGoodAssert event that you trigger is not handled and takes no action.\n> \n> Is your system in a different state after initialization?\n\nSorry I was out for vacations\n\nThis is the system state without patch. It is waiting for ever to get SIO power good triggered\n\nJul 20 23:12:15 dl360poc systemd[1]: Starting Intel Power Control...\nJul 20 23:12:17 dl360poc power-control[228]: Start Chassis power control service...\nJul 20 23:12:18 dl360poc power-control[228]: Failed to find the ID_BUTTON line\nJul 20 23:12:18 dl360poc power-control[228]: NMI_OUT set to 0\nJul 20 23:12:18 dl360poc power-control[228]: POWER_OUT set to 0\nJul 20 23:12:18 dl360poc power-control[228]: RESET_OUT set to 0\nJul 20 23:12:18 dl360poc power-control[228]:  NMI Source Property Monitor\nJul 20 23:12:18 dl360poc power-control[228]: Host0: Moving to \"Off\" state\nJul 20 23:12:18 dl360poc power-control[228]: Initializing power state. RestartCause set to xyz.openbmc_project.State.Host.RestartCause.Unknown\nJul 20 23:12:27 dl360poc systemd[1]: Started Intel Power Control.\nJul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: powerStateOff: power supply power OK assert event received\nJul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: Host0: Moving to \"Wait for SIO Power Good\" state"
        },
        {
            "timestamp": 1628539924,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 8:\n\n> Patch Set 8:\n> \n> > Patch Set 8:\n> > \n> > (2 comments)\n> > \n> > > Patch Set 8:\n> > > \n> > > (2 comments)\n> > > \n> > > > Patch Set 8:\n> > > > \n> > > > Can you please provide more detail on the issue you see that is prompting this change?\n> > > > \n> > > > The powerState is already initialized starting on line 3351.  It is initialized based on the state of psPowerOK.  Are you seeing that the power state is not correctly initialized based on the state of psPowerOK?\n> > > \n> > > In the case of SIO mode, the code is looking for psPowerOK and sioPowerGood. psPowerOK is not good enough by itself as initialized. \n> > > \n> > So far, this has been treated as a corner case.  We can consider adding extra logic here to handle both signals, but we would need to understand all the error cases and how to handle them.\n> > \n> > > Roughly if psPowerOK is good, the systems is declared as On but the code is waiting for sioPowerGood to be triggered.\n> > > \n> > > The issue is that on ProLiant, if the host power policy is set to on, sioPowerGood is set to high before the BMC is started, and doesn't trigger any assert event leading the code to wait for ever for such event. So that is why I added that initial test and trigger the event by hand when gpios are initialized.\n> > \n> > Can you show where you are getting stuck waiting forever?  I added a couple comments to the code where the state is initialized to \"on\" when psPowerOk is asserted.  Then, since it is in the \"on\" state, the sioPowerGoodAssert event that you trigger is not handled and takes no action.\n> > \n> > Is your system in a different state after initialization?\n> \n> Sorry I was out for vacations\n> \n> This is the system state without patch. It is waiting for ever to get SIO power good triggered\n> \n> Jul 20 23:12:15 dl360poc systemd[1]: Starting Intel Power Control...\n> Jul 20 23:12:17 dl360poc power-control[228]: Start Chassis power control service...\n> Jul 20 23:12:18 dl360poc power-control[228]: Failed to find the ID_BUTTON line\n> Jul 20 23:12:18 dl360poc power-control[228]: NMI_OUT set to 0\n> Jul 20 23:12:18 dl360poc power-control[228]: POWER_OUT set to 0\n> Jul 20 23:12:18 dl360poc power-control[228]: RESET_OUT set to 0\n> Jul 20 23:12:18 dl360poc power-control[228]:  NMI Source Property Monitor\n> Jul 20 23:12:18 dl360poc power-control[228]: Host0: Moving to \"Off\" state\nHere it looks like your system initialized to the \"Off\" state, so psPowerOk wasn't asserted on start-up.\n\n> Jul 20 23:12:18 dl360poc power-control[228]: Initializing power state. RestartCause set to xyz.openbmc_project.State.Host.RestartCause.Unknown\n> Jul 20 23:12:27 dl360poc systemd[1]: Started Intel Power Control.\n> Jul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: powerStateOff: power supply power OK assert event received\nHere while in the \"Off\" state, you get the power supply power OK assert event that starts the power-on flow and moves to the \"waitForSIOPowerGood\" state to wait for the power good signal to assert\n\n> Jul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: Host0: Moving to \"Wait for SIO Power Good\" state\n\nSo, the error you see is that it sits here forever?\n\nSo far, the flow looks correct and it looks like the state machine is not moving forward because the power good GPIO is not getting asserted to power-control.  Have you confirmed that your power good GPIO is asserting in hardware here after psPowerOk?\n\nAs a side note, it looks like in the case where psPowerOk asserts from the \"Off\" state, we are missing starting the watchdog timer.  I think we should add that, so you don't get stuck in the \"waitForSIOPowerGood\" state like this.  I will look into making that change."
        },
        {
            "timestamp": 1628559956,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8:\n\n> Here while in the \"Off\" state, you get the power supply power OK assert event that starts the power-on flow and moves to the \"waitForSIOPowerGood\" state to wait for the power good signal to assert\n> \n> > Jul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: Host0: Moving to \"Wait for SIO Power Good\" state\n> \n> So, the error you see is that it sits here forever?\n\n>> Yes\n\n\n> \n> So far, the flow looks correct and it looks like the state machine is not moving forward because the power good GPIO is not getting asserted to power-control.  Have you confirmed that your power good GPIO is asserting in hardware here after psPowerOk?\n> \n\n>> Yes\n\n> As a side note, it looks like in the case where psPowerOk asserts from the \"Off\" state, we are missing starting the watchdog timer.  I think we should add that, so you don't get stuck in the \"waitForSIOPowerGood\" state like this.  I will look into making that change.\n\n>> that might be another way to address the issue. What I have proposed is to manually check if the SIOPowerGood was pre-initialized (preAsserted) at code startup and if that is the case issuing the Asserted event manually, which I think is probably better than a watchdog which might still conclude it is not asserted. Roughly the code is currently assuming that the default value is not asserted during OpenBMC boots, which might not be the case on ProLiant machine."
        },
        {
            "timestamp": 1628627315,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 8:\n\n> Patch Set 8:\n> \n> > Here while in the \"Off\" state, you get the power supply power OK assert event that starts the power-on flow and moves to the \"waitForSIOPowerGood\" state to wait for the power good signal to assert\n> > \n> > > Jul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: Host0: Moving to \"Wait for SIO Power Good\" state\n> > \n> > So, the error you see is that it sits here forever?\n> \n> >> Yes\n> \n> \n> > \n> > So far, the flow looks correct and it looks like the state machine is not moving forward because the power good GPIO is not getting asserted to power-control.  Have you confirmed that your power good GPIO is asserting in hardware here after psPowerOk?\n> > \n> \n> >> Yes\nIf the power good GPIO is asserting in hardware after psPowerOk, then you should have gotten the event just like you got the event for psPowerOk.\n\n> \n> > As a side note, it looks like in the case where psPowerOk asserts from the \"Off\" state, we are missing starting the watchdog timer.  I think we should add that, so you don't get stuck in the \"waitForSIOPowerGood\" state like this.  I will look into making that change.\n> \n> >> that might be another way to address the issue. What I have proposed is to manually check if the SIOPowerGood was pre-initialized (preAsserted) at code startup and if that is the case issuing the Asserted event manually, which I think is probably better than a watchdog which might still conclude it is not asserted. Roughly the code is currently assuming that the default value is not asserted during OpenBMC boots, which might not be the case on ProLiant machine.\n\nSorry for the confusion, this was a side thought and is not directly related to your issue.\n\nYou shouldn't need to manually check for SIOPowerGood as you should have gotten that event automatically after the psPowerOk event.\n\nDo you see new SIOPowerGood events getting handled after initialization?"
        },
        {
            "timestamp": 1628720041,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8:\n\n> You shouldn't need to manually check for SIOPowerGood as you should have gotten that event automatically after the psPowerOk event.\n\nThat doesn't seems to be the case.\n\n> \n> Do you see new SIOPowerGood events getting handled after initialization?\n\nNo\n\nBut with my fix\n\nJul 27 17:47:24 dl360poc systemd[1]: Starting Intel Power Control...\nJul 27 17:47:26 dl360poc power-control[227]: Start Chassis power control service...\nJul 27 17:47:27 dl360poc power-control[227]: vejmarie: Debugging initial psPowerOKLine 0\nJul 27 17:47:27 dl360poc power-control[227]: vejmarie: Debugging initial SIOPowerGood\nJul 27 17:47:27 dl360poc power-control[227]: vejmarie: Debugging initial SIOPowerGood 1\nJul 27 17:47:27 dl360poc power-control[227]: Failed to find the ID_BUTTON line\nJul 27 17:47:27 dl360poc power-control[227]: NMI_OUT set to 0\nJul 27 17:47:27 dl360poc power-control[227]: POWER_OUT set to 0\nJul 27 17:47:27 dl360poc power-control[227]: RESET_OUT set to 0\nJul 27 17:47:27 dl360poc power-control[227]:  NMI Source Property Monitor\nJul 27 17:47:27 dl360poc power-control[227]: Host0: Moving to \"Off\" state\nJul 27 17:47:28 dl360poc power-control[227]: Initializing power state. RestartCause set to xyz.openbmc_project.State.Host.RestartCause.Unknown\nJul 27 17:47:36 dl360poc systemd[1]: Started Intel Power Control.\nJul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: powerStateOff: power supply power OK assert event received\nJul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: Host0: Moving to \"On\" state\nJul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: POH timer started\nJul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: Host system DC power is on\n\nAnd with the original code\n\nJul 20 23:12:15 dl360poc systemd[1]: Starting Intel Power Control...\nJul 20 23:12:17 dl360poc power-control[228]: Start Chassis power control service...\nJul 20 23:12:18 dl360poc power-control[228]: Failed to find the ID_BUTTON line\nJul 20 23:12:18 dl360poc power-control[228]: NMI_OUT set to 0\nJul 20 23:12:18 dl360poc power-control[228]: POWER_OUT set to 0\nJul 20 23:12:18 dl360poc power-control[228]: RESET_OUT set to 0\nJul 20 23:12:18 dl360poc power-control[228]:  NMI Source Property Monitor\nJul 20 23:12:18 dl360poc power-control[228]: Host0: Moving to \"Off\" state\nJul 20 23:12:18 dl360poc power-control[228]: Initializing power state. RestartCause set to xyz.openbmc_project.State.Host.RestartCause.Unknown\nJul 20 23:12:27 dl360poc systemd[1]: Started Intel Power Control.\nJul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: powerStateOff: power supply power OK assert event received\nJul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: Host0: Moving to \"Wait for SIO Power Good\" state"
        },
        {
            "timestamp": 1628797064,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 8:\n\n> Patch Set 8:\n> \n> > You shouldn't need to manually check for SIOPowerGood as you should have gotten that event automatically after the psPowerOk event.\n> \n> That doesn't seems to be the case.\n> \n> > \n> > Do you see new SIOPowerGood events getting handled after initialization?\n> \n> No\nI think this is the root-cause of the failure.  If you don't see SIOPowerGood events in power-control, then even if you initialize it correctly, future events will be missed.\nI'd start with 'gpioinfo' to find the line number for \"SIO_POWER_GOOD\", then use 'gpiomon' to check the to check if you are getting any events when the GPIO toggles.  That will help narrow down if it's an issue in power-control or through libgpiod.\n\n> \n> But with my fix\n> \n> Jul 27 17:47:24 dl360poc systemd[1]: Starting Intel Power Control...\n> Jul 27 17:47:26 dl360poc power-control[227]: Start Chassis power control service...\n> Jul 27 17:47:27 dl360poc power-control[227]: vejmarie: Debugging initial psPowerOKLine 0\n> Jul 27 17:47:27 dl360poc power-control[227]: vejmarie: Debugging initial SIOPowerGood\n> Jul 27 17:47:27 dl360poc power-control[227]: vejmarie: Debugging initial SIOPowerGood 1\n> Jul 27 17:47:27 dl360poc power-control[227]: Failed to find the ID_BUTTON line\n> Jul 27 17:47:27 dl360poc power-control[227]: NMI_OUT set to 0\n> Jul 27 17:47:27 dl360poc power-control[227]: POWER_OUT set to 0\n> Jul 27 17:47:27 dl360poc power-control[227]: RESET_OUT set to 0\n> Jul 27 17:47:27 dl360poc power-control[227]:  NMI Source Property Monitor\n> Jul 27 17:47:27 dl360poc power-control[227]: Host0: Moving to \"Off\" state\n> Jul 27 17:47:28 dl360poc power-control[227]: Initializing power state. RestartCause set to xyz.openbmc_project.State.Host.RestartCause.Unknown\n> Jul 27 17:47:36 dl360poc systemd[1]: Started Intel Power Control.\n> Jul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: powerStateOff: power supply power OK assert event received\n> Jul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: Host0: Moving to \"On\" state\nThis doesn't look right.  This shows the state move from Off directly to On when psPowerOk asserts.  I don't see your special handling or sioPowerGood event to move it to On.\n\n> Jul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: POH timer started\n> Jul 27 17:49:20 dl360poc-9440c941b11a power-control[227]: Host system DC power is on\n> \n> And with the original code\n> \n> Jul 20 23:12:15 dl360poc systemd[1]: Starting Intel Power Control...\n> Jul 20 23:12:17 dl360poc power-control[228]: Start Chassis power control service...\n> Jul 20 23:12:18 dl360poc power-control[228]: Failed to find the ID_BUTTON line\n> Jul 20 23:12:18 dl360poc power-control[228]: NMI_OUT set to 0\n> Jul 20 23:12:18 dl360poc power-control[228]: POWER_OUT set to 0\n> Jul 20 23:12:18 dl360poc power-control[228]: RESET_OUT set to 0\n> Jul 20 23:12:18 dl360poc power-control[228]:  NMI Source Property Monitor\n> Jul 20 23:12:18 dl360poc power-control[228]: Host0: Moving to \"Off\" state\n> Jul 20 23:12:18 dl360poc power-control[228]: Initializing power state. RestartCause set to xyz.openbmc_project.State.Host.RestartCause.Unknown\n> Jul 20 23:12:27 dl360poc systemd[1]: Started Intel Power Control.\n> Jul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: powerStateOff: power supply power OK assert event received\n> Jul 20 23:14:00 dl360poc-9440c941b11a power-control[228]: Host0: Moving to \"Wait for SIO Power Good\" state"
        },
        {
            "timestamp": 1628876201,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8:\n\n> Patch Set 8:\n> \n> > Patch Set 8:\n> > \n> > > You shouldn't need to manually check for SIOPowerGood as you should have gotten that event automatically after the psPowerOk event.\n> > \n> > That doesn't seems to be the case.\n> > \n> > > \n> > > Do you see new SIOPowerGood events getting handled after initialization?\n> > \n> > No\n> I think this is the root-cause of the failure.  If you don't see SIOPowerGood events in power-control, then even if you initialize it correctly, future events will be missed.\n> I'd start with 'gpioinfo' to find the line number for \"SIO_POWER_GOOD\", then use 'gpiomon' to check the to check if you are getting any events when the GPIO toggles.  That will help narrow down if it's an issue in power-control or through libgpiod.\n> \n\nI will check that, but from what I can see is that the toggling is working as expected later on and I can control the power state without any further issues."
        },
        {
            "timestamp": 1629761806,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8:\n\nok, my initial journalctl output with not containing all the logging info. I recompiled with the proposed fix\n\nroot@dl360poc-9440c941b11a:~# systemctl status xyz.openbmc_project.Chassis.Control.Power.service\n* xyz.openbmc_project.Chassis.Control.Power.service - Intel Power Control\n     Loaded: loaded (/lib/systemd/system/xyz.openbmc_project.Chassis.Control.Power.service; enabled; vendor preset: enabled)\n     Active: active (running) since Mon 2021-08-23 23:29:00 UTC; 3min 16s ago\n   Main PID: 220 (power-control)\n     CGroup: /system.slice/xyz.openbmc_project.Chassis.Control.Power.service\n             `-220 /usr/bin/power-control\n\nAug 23 23:28:52 dl360poc power-control[220]: RESET_OUT set to 0\nAug 23 23:28:52 dl360poc power-control[220]:  NMI Source Property Monitor\nAug 23 23:28:52 dl360poc power-control[220]: Host0: Moving to \"Off\" state\nAug 23 23:28:53 dl360poc power-control[220]: powerStateOff: SIO power good assert event received\nAug 23 23:28:53 dl360poc power-control[220]: Host0: Moving to \"On\" state\nAug 23 23:28:53 dl360poc power-control[220]: SIO Power Good asserted during initialization as associated GPIO is HIGH\nAug 23 23:28:53 dl360poc power-control[220]: Initializing power state. POH timer started\nAug 23 23:29:00 dl360poc systemd[1]: Started Intel Power Control.\nAug 23 23:30:48 dl360poc-9440c941b11a power-control[220]: powerStateOn: power supply power OK assert event received\nAug 23 23:30:48 dl360poc-9440c941b11a power-control[220]: No action taken.\nroot@dl360poc-9440c941b11a:~# \n\nYou can see the SIO power good event is triggered. Without that fix, it will not work on ProLiant"
        },
        {
            "timestamp": 1629816948,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 8:\n\n> Patch Set 8:\n> \n> ok, my initial journalctl output with not containing all the logging info. I recompiled with the proposed fix\n> \n> root@dl360poc-9440c941b11a:~# systemctl status xyz.openbmc_project.Chassis.Control.Power.service\n> * xyz.openbmc_project.Chassis.Control.Power.service - Intel Power Control\n>      Loaded: loaded (/lib/systemd/system/xyz.openbmc_project.Chassis.Control.Power.service; enabled; vendor preset: enabled)\n>      Active: active (running) since Mon 2021-08-23 23:29:00 UTC; 3min 16s ago\n>    Main PID: 220 (power-control)\n>      CGroup: /system.slice/xyz.openbmc_project.Chassis.Control.Power.service\n>              `-220 /usr/bin/power-control\n> \n> Aug 23 23:28:52 dl360poc power-control[220]: RESET_OUT set to 0\n> Aug 23 23:28:52 dl360poc power-control[220]:  NMI Source Property Monitor\n> Aug 23 23:28:52 dl360poc power-control[220]: Host0: Moving to \"Off\" state\n> Aug 23 23:28:53 dl360poc power-control[220]: powerStateOff: SIO power good assert event received\n> Aug 23 23:28:53 dl360poc power-control[220]: Host0: Moving to \"On\" state\n> Aug 23 23:28:53 dl360poc power-control[220]: SIO Power Good asserted during initialization as associated GPIO is HIGH\n> Aug 23 23:28:53 dl360poc power-control[220]: Initializing power state. POH timer started\n> Aug 23 23:29:00 dl360poc systemd[1]: Started Intel Power Control.\n> Aug 23 23:30:48 dl360poc-9440c941b11a power-control[220]: powerStateOn: power supply power OK assert event received\n> Aug 23 23:30:48 dl360poc-9440c941b11a power-control[220]: No action taken.\n> root@dl360poc-9440c941b11a:~# \n> \n> You can see the SIO power good event is triggered. Without that fix, it will not work on ProLiant\n\nSo, does that mean that your SIO power good is asserted before power supply power OK?"
        },
        {
            "timestamp": 1629827530,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Patch Set 8:\n\n> Patch Set 8:\n> \n> > Patch Set 8:\n> > \n> > ok, my initial journalctl output with not containing all the logging info. I recompiled with the proposed fix\n> > \n> > root@dl360poc-9440c941b11a:~# systemctl status xyz.openbmc_project.Chassis.Control.Power.service\n> > * xyz.openbmc_project.Chassis.Control.Power.service - Intel Power Control\n> >      Loaded: loaded (/lib/systemd/system/xyz.openbmc_project.Chassis.Control.Power.service; enabled; vendor preset: enabled)\n> >      Active: active (running) since Mon 2021-08-23 23:29:00 UTC; 3min 16s ago\n> >    Main PID: 220 (power-control)\n> >      CGroup: /system.slice/xyz.openbmc_project.Chassis.Control.Power.service\n> >              `-220 /usr/bin/power-control\n> > \n> > Aug 23 23:28:52 dl360poc power-control[220]: RESET_OUT set to 0\n> > Aug 23 23:28:52 dl360poc power-control[220]:  NMI Source Property Monitor\n> > Aug 23 23:28:52 dl360poc power-control[220]: Host0: Moving to \"Off\" state\n> > Aug 23 23:28:53 dl360poc power-control[220]: powerStateOff: SIO power good assert event received\n> > Aug 23 23:28:53 dl360poc power-control[220]: Host0: Moving to \"On\" state\n> > Aug 23 23:28:53 dl360poc power-control[220]: SIO Power Good asserted during initialization as associated GPIO is HIGH\n> > Aug 23 23:28:53 dl360poc power-control[220]: Initializing power state. POH timer started\n> > Aug 23 23:29:00 dl360poc systemd[1]: Started Intel Power Control.\n> > Aug 23 23:30:48 dl360poc-9440c941b11a power-control[220]: powerStateOn: power supply power OK assert event received\n> > Aug 23 23:30:48 dl360poc-9440c941b11a power-control[220]: No action taken.\n> > root@dl360poc-9440c941b11a:~# \n> > \n> > You can see the SIO power good event is triggered. Without that fix, it will not work on ProLiant\n> \n> So, does that mean that your SIO power good is asserted before power supply power OK?\n\nIt could happens when we are restoring power if the mandate is to be on. Our BMC is holding the host from running up to the time we didn't had ensure that the ROM is ready to be delivered to the PCH and has been validated. We assert (in fact it is soon ok) the power supply ok later into the boot process while sio power is ok. roughly both signals where up in the right sequencing but one of them is caught by our cpld/boot logic to wait that the system ends up in the right state. the current code logic is assuming a sequencing which is not right on proliant. the proliant sequencing might be wrong but this is the way it is currently and it definitely need to enforce the triggering of the sio signal during power up otherwise, if the restore power policy is on it will fail."
        },
        {
            "timestamp": 1629830315,
            "reviewer": {
                "name": "Jason Bills",
                "email": "jason.m.bills@linux.intel.com",
                "username": "jmbills"
            },
            "message": "Patch Set 8:\n\n(1 comment)"
        },
        {
            "timestamp": 1629929622,
            "reviewer": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "message": "Abandoned\n\nCode based changed too much. Need to restart the work"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "f22d08aa4a2a2e44fe7a5625ed815093ccdc6be3",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/1",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627425236,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 5,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "af3eaf3bfd454e1cc1ff3f41978954ad82f154d6",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/2",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627433895,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 5,
            "sizeDeletions": 0
        },
        {
            "number": 3,
            "revision": "a513bff7cab5f5ed13139ec23508b0970134a0b8",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/3",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627434457,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 13,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 5,
            "sizeDeletions": 0
        },
        {
            "number": 4,
            "revision": "a709a68b416742d737be73cc6a02fccd47db2fa1",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/4",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627446775,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 5,
            "sizeDeletions": 0
        },
        {
            "number": 5,
            "revision": "162d421e88e9dc38fe833c15225c92b375c798b2",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/5",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627446881,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "NO_CODE_CHANGE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 5,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 5,
            "sizeDeletions": 0
        },
        {
            "number": 6,
            "revision": "07c69ec348a09c3dfecacef57243e76cc98b3907",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/6",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627483603,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 13,
                    "reviewer": {
                        "email": "rashmi.r.v@linux.intel.com",
                        "username": "Rashmi-RV"
                    },
                    "message": "Please include 'Tested' field."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 13,
                    "reviewer": {
                        "name": "Jean-Marie Verdun",
                        "email": "jean-marie.verdun@hpe.com",
                        "username": "vejmarie"
                    },
                    "message": "Done"
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "line": 3938,
                    "reviewer": {
                        "email": "rashmi.r.v@linux.intel.com",
                        "username": "Rashmi-RV"
                    },
                    "message": "Can we also have phosphor logging under else condition?"
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "line": 3938,
                    "reviewer": {
                        "name": "Jean-Marie Verdun",
                        "email": "jean-marie.verdun@hpe.com",
                        "username": "vejmarie"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 15,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 8,
            "sizeDeletions": 0
        },
        {
            "number": 7,
            "revision": "e095b1c017dddcdb60373d89291cc65d38e8926c",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/7",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627574071,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 11,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 11,
            "sizeDeletions": 0
        },
        {
            "number": 8,
            "revision": "74c233a252f7662fdf63d22def61a763bc2a6355",
            "parents": [
                "2a26943210a7b26525638bb9dacfd2868c7cdad7"
            ],
            "ref": "refs/changes/17/45317/8",
            "uploader": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "createdOn": 1627574266,
            "author": {
                "name": "Jean-Marie Verdun",
                "email": "jean-marie.verdun@hpe.com",
                "username": "vejmarie"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "line": 1716,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "There is no handler for Event::sioPowerGoodAssert in the \"On\" state, so the event you trigger below would just hit the default case and take no action."
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "line": 3359,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Power state should be set to 'on' here if psPowerOk is asserted."
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "line": 3360,
                    "reviewer": {
                        "name": "Jason Bills",
                        "email": "jason.m.bills@linux.intel.com",
                        "username": "jmbills"
                    },
                    "message": "Could the check for SIO power good be added here?\nif (sioEnabled == true)\n    {\n        if (sioPowerGoodLine.get_value() > 1)\n        {\n            powerState = PowerState::on;\n        }\n    }\n\nThen if either signal is asserted during init, the powerState will be initialized to on."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 17,
                    "deletions": 0
                },
                {
                    "file": "power-control-x86/src/power_control.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 12,
            "sizeDeletions": 0
        }
    ]
}