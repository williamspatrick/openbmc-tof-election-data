{
    "project": "openbmc/phosphor-logging",
    "branch": "master",
    "id": "Ia98086c47d6083d8a104c1c28efc94c8b30a47ef",
    "number": 45124,
    "subject": "PEL: Fix to remove files from archive folder",
    "owner": {
        "email": "sumit_kumar@in.ibm.com",
        "username": "sumitk56"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-logging/+/45124",
    "commitMessage": "PEL: Fix to remove files from archive folder\n\nArchive folder contains the PEL logs (corresponding to deleted event\nlogs) that are deleted first, if the repo logs size exceeds the warning\nsize. Variable _archiveSize is used to keep track of size of archive\nfolder. After all logs in archive folder are deleted the _ardchiveSize\nwasn't reset to zero as a result it would keep entering this function\ntrying to delete the logs again under archive folder.\nThe fix here is to reset the _archiveSize and also use robust remove\nAPI for deletion instead of system command.\n\nSigned-off-by: Sumit Kumar <sumit_kumar@in.ibm.com>\nChange-Id: Ia98086c47d6083d8a104c1c28efc94c8b30a47ef\n",
    "createdOn": 1626880754,
    "lastUpdated": 1627309839,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1626880754,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1626880785,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1626881485,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/22474/ : SUCCESS"
        },
        {
            "timestamp": 1626882381,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 1:\n\n(3 comments)"
        },
        {
            "timestamp": 1626884110,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1626884130,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1626884400,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1626884420,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1626884423,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/22477/ : ABORTED"
        },
        {
            "timestamp": 1626885126,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/22478/ : SUCCESS"
        },
        {
            "timestamp": 1626893791,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1626949943,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Patch Set 3:\n\n(3 comments)"
        },
        {
            "timestamp": 1626950699,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Uploaded patch set 4."
        },
        {
            "timestamp": 1626950714,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1626951420,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/22547/ : SUCCESS"
        },
        {
            "timestamp": 1626967026,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4:\n\n(2 comments)"
        },
        {
            "timestamp": 1626967974,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 4:\n\n(1 comment)"
        },
        {
            "timestamp": 1626972082,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Patch Set 4:\n\n(3 comments)"
        },
        {
            "timestamp": 1626976034,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1626976048,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1626976744,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/22601/ : SUCCESS"
        },
        {
            "timestamp": 1627048646,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1627049236,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1627049922,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 5:\n\n(1 comment)"
        },
        {
            "timestamp": 1627052946,
            "reviewer": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "message": "Uploaded patch set 6."
        },
        {
            "timestamp": 1627052958,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1627053664,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 6: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/22697/ : SUCCESS"
        },
        {
            "timestamp": 1627309835,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Patch Set 6: Code-Review+2"
        },
        {
            "timestamp": 1627309839,
            "reviewer": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "message": "Change has been successfully rebased and submitted as c296692bdd3bb2da7f275ab2a6bddaec732d217f by Matt Spinler"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "307964e2d2b758b53ccccfe5d93f31d1240de657",
            "parents": [
                "593a4c665dce98b8bca181fc7ce60d6a32eabfe1"
            ],
            "ref": "refs/changes/24/45124/1",
            "uploader": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "createdOn": 1626880754,
            "author": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 542,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "You should be able to just use _archivePath here."
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 544,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "remove_all will remove a directory tree. I think you can just use remove() to remove a file.  Also, it will throw if the delete under the covers fails.  While unlikely, I'd feel a little better if you used the version that doesn't throw:\n\nstd::error_code ec;\nfs::remove(entry.path(), ec);"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 545,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "and as we discussed, need to set archive size back to 0"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "type": "MODIFIED",
                    "insertions": 3,
                    "deletions": -5
                }
            ],
            "sizeInsertions": 3,
            "sizeDeletions": 5
        },
        {
            "number": 2,
            "revision": "7bd5f1a459f5c28ed1286b3d9ceaf5210e74a7d3",
            "parents": [
                "593a4c665dce98b8bca181fc7ce60d6a32eabfe1"
            ],
            "ref": "refs/changes/24/45124/2",
            "uploader": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "createdOn": 1626884110,
            "author": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "type": "MODIFIED",
                    "insertions": 12,
                    "deletions": -6
                },
                {
                    "file": "extensions/openpower-pels/repository.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 13,
            "sizeDeletions": 7
        },
        {
            "number": 3,
            "revision": "7d9cdad6b0260e4e8c0aa21d4639efc860068ee3",
            "parents": [
                "593a4c665dce98b8bca181fc7ce60d6a32eabfe1"
            ],
            "ref": "refs/changes/24/45124/3",
            "uploader": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "createdOn": 1626884400,
            "author": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 547,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "I'm pretty sure the error code will be zero if there are no errors?"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 547,
                    "reviewer": {
                        "email": "sumit_kumar@in.ibm.com",
                        "username": "sumitk56"
                    },
                    "message": "It returns true if successful else false.\nhttps://en.cppreference.com/w/cpp/filesystem/remove"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 553,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "should probably keep going."
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 553,
                    "reviewer": {
                        "email": "sumit_kumar@in.ibm.com",
                        "username": "sumitk56"
                    },
                    "message": "Based on your next comment will remove it."
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 557,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "I wouldn't worry about this part. I'd expect we'll always be able to delete files, but for whatever reason if we can't (maybe someone made read only file in there?) I just don't want it to throw an exception and crash."
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 557,
                    "reviewer": {
                        "email": "sumit_kumar@in.ibm.com",
                        "username": "sumitk56"
                    },
                    "message": "yeah ok"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "type": "MODIFIED",
                    "insertions": 19,
                    "deletions": -6
                },
                {
                    "file": "extensions/openpower-pels/repository.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 20,
            "sizeDeletions": 7
        },
        {
            "number": 4,
            "revision": "f26dd77d552d9532ebb076dc39c79a514c0e7941",
            "parents": [
                "593a4c665dce98b8bca181fc7ce60d6a32eabfe1"
            ],
            "ref": "refs/changes/24/45124/4",
            "uploader": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "createdOn": 1626950699,
            "author": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 8,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "can you describe what the fix is here?  I tend to avoid 1 line commit messages."
                },
                {
                    "file": "/COMMIT_MSG",
                    "line": 8,
                    "reviewer": {
                        "email": "sumit_kumar@in.ibm.com",
                        "username": "sumitk56"
                    },
                    "message": "Will do"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 546,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "the documentation on operator bool says:\nChecks if the error value is valid, i.e. non-zero. \n\ndoesn't that mean that if it's true then there is an error?"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 546,
                    "reviewer": {
                        "email": "sumit_kumar@in.ibm.com",
                        "username": "sumitk56"
                    },
                    "message": "Yeah with std::error_code that's correct.\nI do like to change it to check for return value:\nbool remove( const std::filesystem::path& p, std::error_code& ec )"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 546,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "We don't need to make it complicated, all I really want is to not throw an exception if for some reason fs::remove were to fail.  As far as I'm concerned, you can remove the if (ec) check completely."
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 546,
                    "reviewer": {
                        "email": "sumit_kumar@in.ibm.com",
                        "username": "sumitk56"
                    },
                    "message": "I have updated patch-set 5 with following change. What do you think?\nresult = fs::remove(dirEntry.path());\nif (!result)\n{....}\n\n\nAlso as you suggested to not throw exception, can we change log<level::ERR> to log<level>::INFO with above code change??"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 546,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "I wrote the following test program:\n\n    std::ofstream file {\"test.txt\"};\n    file.close();\n\n    std::error_code ec;\n    std::filesystem::remove(\"test.txt\", ec);\n    if (!ec)\n    {\n        printf(\"delete failed?\\n\");\n    }\n    else\n    {\n        printf(\"ec is true\\n\");\n    }\n\nand when it runs, it successfully deletes test.txt and prints:\n$ ./a.out\ndelete failed?\n\nwhich still implies that !ec is a good thing, not a bad thing"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 550,
                    "reviewer": {
                        "name": "Matt Spinler",
                        "email": "spinler@us.ibm.com",
                        "username": "spinler"
                    },
                    "message": "since you're putting something in the journal, you may as well put in what file it couldn't delete:\n\nlog<level::ERR>(\"Could not delete a file in PEL archive\",\n                entry(\"FILENAME=%s\", entry.path().c_str()));"
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "line": 550,
                    "reviewer": {
                        "email": "sumit_kumar@in.ibm.com",
                        "username": "sumitk56"
                    },
                    "message": "Ok"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -6
                },
                {
                    "file": "extensions/openpower-pels/repository.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 14,
            "sizeDeletions": 7
        },
        {
            "number": 5,
            "revision": "42d2a6f8d95b9494ea5059fce25b57f90707a1eb",
            "parents": [
                "593a4c665dce98b8bca181fc7ce60d6a32eabfe1"
            ],
            "ref": "refs/changes/24/45124/5",
            "uploader": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "createdOn": 1626976034,
            "author": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -6
                },
                {
                    "file": "extensions/openpower-pels/repository.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 15,
            "sizeDeletions": 7
        },
        {
            "number": 6,
            "revision": "046bb041cbf10ed2ff1e2ed06eefbb71ea11ef49",
            "parents": [
                "593a4c665dce98b8bca181fc7ce60d6a32eabfe1"
            ],
            "ref": "refs/changes/24/45124/6",
            "uploader": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "createdOn": 1627052946,
            "author": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -6
                },
                {
                    "file": "extensions/openpower-pels/repository.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 15,
            "sizeDeletions": 7
        },
        {
            "number": 7,
            "revision": "c296692bdd3bb2da7f275ab2a6bddaec732d217f",
            "parents": [
                "e053884811eea3f165ce465b3942e192b8a36cbc"
            ],
            "ref": "refs/changes/24/45124/7",
            "uploader": {
                "name": "Matt Spinler",
                "email": "spinler@us.ibm.com",
                "username": "spinler"
            },
            "createdOn": 1627309839,
            "author": {
                "email": "sumit_kumar@in.ibm.com",
                "username": "sumitk56"
            },
            "kind": "TRIVIAL_REBASE",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 19,
                    "deletions": 0
                },
                {
                    "file": "extensions/openpower-pels/repository.cpp",
                    "type": "MODIFIED",
                    "insertions": 14,
                    "deletions": -6
                },
                {
                    "file": "extensions/openpower-pels/repository.hpp",
                    "type": "MODIFIED",
                    "insertions": 1,
                    "deletions": -1
                }
            ],
            "sizeInsertions": 15,
            "sizeDeletions": 7
        }
    ]
}