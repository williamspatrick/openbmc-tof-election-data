{
    "project": "openbmc/bmcweb",
    "branch": "master",
    "topic": "wip",
    "id": "Id4396e6f66b1493af6d6a5b9441eaf22a9400b4b",
    "number": 48318,
    "subject": "Validate Enter/ExitUtilizationPercent parameters",
    "owner": {
        "name": "Chris Cain",
        "email": "cjcain@us.ibm.com",
        "username": "cjcain"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/bmcweb/+/48318",
    "commitMessage": "Validate Enter/ExitUtilizationPercent parameters\n\nEnter Util must be <= Exit Util\n\nChange-Id: Id4396e6f66b1493af6d6a5b9441eaf22a9400b4b\nSigned-off-by: Chris Cain <cjcain@us.ibm.com>\n",
    "createdOn": 1635286596,
    "lastUpdated": 1635393097,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1635286596,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1635286611,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1635286612,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1635286916,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1635287017,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/29105/ : FAILURE"
        },
        {
            "timestamp": 1635300508,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(1 comment)\n\nThis change is ready for review."
        },
        {
            "timestamp": 1635340002,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Set Work In Progress"
        },
        {
            "timestamp": 1635341196,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1635356914,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 1:\n\n(3 comments)\n\nFYI, every time you put this as \"Work in progress\" it hides it from everyone except gerrit admins.  If that was your goal, feel free to leave it, but I suspect your goal in pushing it was to get help, so I'm going to add a wip topic to this so that others can see and comment to help you out."
        },
        {
            "timestamp": 1635356917,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Topic set to wip"
        },
        {
            "timestamp": 1635362085,
            "reviewer": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1635393097,
            "reviewer": {
                "name": "Gunnar Mills",
                "email": "gmills@us.ibm.com",
                "username": "gtmills"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "dc65384c6151021384d20f44ee9ad3ae8dce91ca",
            "parents": [
                "34cf59dfe4c03fb19857c7368a51a9330a190e3e"
            ],
            "ref": "refs/changes/18/48318/1",
            "uploader": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "createdOn": 1635286596,
            "author": {
                "name": "Chris Cain",
                "email": "cjcain@us.ibm.com",
                "username": "cjcain"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Gunnar Mills",
                        "email": "gmills@us.ibm.com",
                        "username": "gtmills"
                    },
                    "message": "I know it is wip, please have a proper commit msg and tested tag before you remove the wip. :)"
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "line": 2725,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Init your variables, although these look declared in the wrong spot."
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "line": 2737,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "same as below."
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "line": 2802,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "Currently having issue with the assignment on line 2798.  Logic seems correct to me, but when I trace the two values, exitUtil (captured variable) is different from what was read by the Get.\n\nTrace:\nOct 26 21:25:14 ever6bmc bmcweb[11926]:  CJC: Validating Enter <= Exit Utilization\nOct 26 21:25:14 ever6bmc bmcweb[11926]:  USER set EnterUtilizationPercent: 30\nOct 26 21:25:14 ever6bmc bmcweb[11926]:  BAD: EnterUtilizationPercent (30) > ExitUtilizationPercent (0)\nOct 26 21:25:14 ever6bmc bmcweb[11926]:  GET returned ExitUtilizationPercent: 0 and 12   <======= SHOULD BE SAME"
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "line": 2802,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "exitUtil is going out of scope, so it's pointing at garbage memory by the time you read it in the callback.  Change line 2778 to \n\n[aResp, exitUtil]\n\n(ie, remove the & from exitUtil) and i'll bet your error will go away."
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "line": 2802,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "The & is to pass it by reference to the lambda function.  If I don't have that, it does not compile:\n| ../../../../../../workspace/sources/bmcweb/redfish-core/include/../lib/systems.hpp:2798:38: error: assignment of read-only variable 'exitUtil'\n|  2798 |                             exitUtil = *u;\n|       |                             ~~~~~~~~~^~~~"
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "line": 2802,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "Right, because it's const int that context.  If you want it non-const, declare your lambda as mutable, but I still don't think it's going to do what I think you want.  You're trying to share some state between two different async routines without having proper ownership between them, so I doubt it's going to do what you expect, although it will avoid possible seg faults."
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "line": 2802,
                    "reviewer": {
                        "name": "Chris Cain",
                        "email": "cjcain@us.ibm.com",
                        "username": "cjcain"
                    },
                    "message": "I had some confusion on how the async requests execute and now I understand what is happening.  I am still not quite sure how to most efficiently code this validation.\n\nThe user could specify one or both of enter/exit utilization.  If they are not specifying one, it needs to read the current value of that property so it can compare.  If the Get is async, how do I wait for the result of the GET before doing the comparison?"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 12,
                    "deletions": 0
                },
                {
                    "file": "redfish-core/lib/systems.hpp",
                    "type": "MODIFIED",
                    "insertions": 109,
                    "deletions": -2
                }
            ],
            "sizeInsertions": 109,
            "sizeDeletions": 2
        }
    ]
}