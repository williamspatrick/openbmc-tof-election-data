{
    "project": "openbmc/phosphor-net-ipmid",
    "branch": "master",
    "id": "I112bbc3404ffcf90ab5358d2309672473662647a",
    "number": 43988,
    "subject": "Require a valid session state prior to executing commands",
    "owner": {
        "name": "Vernon Mauery",
        "email": "vernon.mauery@linux.intel.com",
        "username": "vmauery"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/phosphor-net-ipmid/+/43988",
    "commitMessage": "Require a valid session state prior to executing commands\n\nThe execution of commands should work fine for pre-session commands\nand for session commands that have the session in a valid state\n(not inactive or tearDownInProgress). This prevents a session from\ngetting used after the close session command.\n\nTested: send a command after the session has been closed or re-use an\n        old session ID. The BMC should ignore the request.\n\nChange-Id: I112bbc3404ffcf90ab5358d2309672473662647a\nSigned-off-by: Vernon Mauery <vernon.mauery@linux.intel.com>\n",
    "createdOn": 1623364737,
    "lastUpdated": 1624902339,
    "open": false,
    "status": "MERGED",
    "comments": [
        {
            "timestamp": 1623364737,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1623364751,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Set private"
        },
        {
            "timestamp": 1623387017,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 1: Code-Review+1"
        },
        {
            "timestamp": 1623401289,
            "reviewer": {
                "name": "Anton D. Kachalov",
                "email": "rnouse@google.com",
                "username": "ya-mouse"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623422321,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623425409,
            "reviewer": {
                "name": "Anton D. Kachalov",
                "email": "rnouse@google.com",
                "username": "ya-mouse"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623427950,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623428332,
            "reviewer": {
                "name": "Anton D. Kachalov",
                "email": "rnouse@google.com",
                "username": "ya-mouse"
            },
            "message": "Patch Set 1:\n\n(1 comment)"
        },
        {
            "timestamp": 1623429341,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1623496616,
            "reviewer": {
                "name": "Anton D. Kachalov",
                "email": "rnouse@google.com",
                "username": "ya-mouse"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623496769,
            "reviewer": {
                "name": "Anton D. Kachalov",
                "email": "rnouse@google.com",
                "username": "ya-mouse"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623526081,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 2:\n\n(1 comment)"
        },
        {
            "timestamp": 1623527076,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1623536942,
            "reviewer": {
                "name": "Anton D. Kachalov",
                "email": "rnouse@google.com",
                "username": "ya-mouse"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1623684753,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 3: Ok-To-Test+1"
        },
        {
            "timestamp": 1623732734,
            "reviewer": {
                "name": "Suryakanth Sekar",
                "email": "suryakanth.sekar@linux.intel.com",
                "username": "htnakayrus"
            },
            "message": "Patch Set 3: Code-Review+1"
        },
        {
            "timestamp": 1623756304,
            "reviewer": {
                "name": "Tom Joseph",
                "email": "rushtotom@gmail.com",
                "username": "tomjoseph83"
            },
            "message": "Patch Set 3: Code-Review+2"
        },
        {
            "timestamp": 1623781811,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Removed Ok-To-Test+1 by Vernon Mauery <vernon.mauery@linux.intel.com>\n"
        },
        {
            "timestamp": 1623781818,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 3: Ok-To-Test+1"
        },
        {
            "timestamp": 1623781913,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Removed Ok-To-Test+1 by Vernon Mauery <vernon.mauery@linux.intel.com>\n"
        },
        {
            "timestamp": 1623781921,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Patch Set 3: Ok-To-Test+1"
        },
        {
            "timestamp": 1623782159,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/19790/ : SUCCESS"
        },
        {
            "timestamp": 1623969147,
            "reviewer": {
                "name": "Joseph Reynolds",
                "email": "joseph-reynolds@charter.net",
                "username": "joseph-reynolds"
            },
            "message": "Patch Set 3:\n\nSeems okay to me, but I am not familiar with the code."
        },
        {
            "timestamp": 1624902339,
            "reviewer": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "message": "Change has been successfully merged by Vernon Mauery"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "c7fccbcbfb186bdd2703fd54e0f22ff711bea632",
            "parents": [
                "3dd5cddd8b7d0116062a0c20e36074e6f5faa18f"
            ],
            "ref": "refs/changes/88/43988/1",
            "uploader": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "createdOn": 1623364737,
            "author": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "message_handler.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "Anton D. Kachalov",
                        "email": "rnouse@google.com",
                        "username": "ya-mouse"
                    },
                    "message": "Non-IPMI commands within a session in wrong state will still reach the D-Bus.\nLet's move the check above into the Table::executeCommand() handler."
                },
                {
                    "file": "message_handler.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "Vernon Mauery",
                        "email": "vernon.mauery@linux.intel.com",
                        "username": "vmauery"
                    },
                    "message": "I am not sure why this branch exists... It is used to execute non-IPMI commands? Maybe we should just delete this part.\n\nTom? Do you know what is going on here?\n\nAlso, I am responding to this before coffee, so reader beware."
                },
                {
                    "file": "message_handler.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "Anton D. Kachalov",
                        "email": "rnouse@google.com",
                        "username": "ya-mouse"
                    },
                    "message": "There are a number of payload types like:\nOPEN_SESSION_{REQ,RESP}, RAKP{1-4}, SOL."
                },
                {
                    "file": "message_handler.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "Vernon Mauery",
                        "email": "vernon.mauery@linux.intel.com",
                        "username": "vmauery"
                    },
                    "message": "Right. I will move this to the Table::executeCommand() function. But to be clear, I don't think non-IPMI messages will get to d-bus. The non-IPMI functions all get handled locally."
                },
                {
                    "file": "message_handler.cpp",
                    "line": 154,
                    "reviewer": {
                        "name": "Anton D. Kachalov",
                        "email": "rnouse@google.com",
                        "username": "ya-mouse"
                    },
                    "message": "May be I'm wrong. The following code executes any unknown command passed to Table::executeCommand regardless of it's type:\n\nhttps://github.com/openbmc/phosphor-net-ipmid/blob/master/command_table.cpp#L73\n\nFor instance, SOL commands are registered from sol_module.cpp and are known in the Table list."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "message_handler.cpp",
                    "type": "MODIFIED",
                    "insertions": 8,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 8,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "c127838777381653c305722bb7a3ccd89a7e23a3",
            "parents": [
                "3dd5cddd8b7d0116062a0c20e36074e6f5faa18f"
            ],
            "ref": "refs/changes/88/43988/2",
            "uploader": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "createdOn": 1623429341,
            "author": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "command_table.cpp",
                    "line": 72,
                    "reviewer": {
                        "name": "Anton D. Kachalov",
                        "email": "rnouse@google.com",
                        "username": "ya-mouse"
                    },
                    "message": "Shouldn't we just check for session::State::active?\n\n>  if (handler->sessionID != session::sessionZero &&\n>      state != session::State::active)\n\nWe also have setupInProgress state. Such packets (IPMI v2.0) shouldn't reach this line (because EVP_DecryptInit_ex should fail with empty \"k2\"), but let's be more clear which states we are accepting/rejecting."
                },
                {
                    "file": "command_table.cpp",
                    "line": 72,
                    "reviewer": {
                        "name": "Anton D. Kachalov",
                        "email": "rnouse@google.com",
                        "username": "ya-mouse"
                    },
                    "message": "Btw, we already check for session::sessionZero above."
                },
                {
                    "file": "command_table.cpp",
                    "line": 72,
                    "reviewer": {
                        "name": "Vernon Mauery",
                        "email": "vernon.mauery@linux.intel.com",
                        "username": "vmauery"
                    },
                    "message": "Yeah, you are right. At this point, we should only be dealing with active sessions. All sessionZero and setup state stuff will get handled down at line 121."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "command_table.cpp",
                    "type": "MODIFIED",
                    "insertions": 13,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 13,
            "sizeDeletions": 3
        },
        {
            "number": 3,
            "revision": "cfb34ca17cbe54514f3a77cf37afea68d2a875cc",
            "parents": [
                "779e7e179e48ce5fefb3d85add04b1814a57e9e0"
            ],
            "ref": "refs/changes/88/43988/3",
            "uploader": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "createdOn": 1623527076,
            "author": {
                "name": "Vernon Mauery",
                "email": "vernon.mauery@linux.intel.com",
                "username": "vmauery"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 18,
                    "deletions": 0
                },
                {
                    "file": "command_table.cpp",
                    "type": "MODIFIED",
                    "insertions": 25,
                    "deletions": -3
                }
            ],
            "sizeInsertions": 25,
            "sizeDeletions": 3
        }
    ]
}