{
    "project": "openbmc/dbus-sensors",
    "branch": "master",
    "id": "Ic907153ddcc3cf0a42a4209bcfb5ee2ab75f0766",
    "number": 45844,
    "subject": "dbus-sensors: Send PSU sensor warning/critical event signal",
    "owner": {
        "name": "Willy Tu",
        "email": "wltu@google.com",
        "username": "wltu"
    },
    "url": "https://gerrit.openbmc-project.xyz/c/openbmc/dbus-sensors/+/45844",
    "commitMessage": "dbus-sensors: Send PSU sensor warning/critical event signal\n\nThe signal can be picked up by phosphor-sel-logger to create SEL for\nthe system to pick with IPMI handler.\n\nTested: Verified with max34451 connected to BMC\n```\n$ trigger_sensor_event(){\n  export HWMON=`grep -l 'max34451' /sys/class/hwmon/hwmon*/name | head -n1 | xargs -n1 dirname`\n  echo $HWMON\n  grep -H '' $HWMON/temp1_{input,max,crit}\n  grep -H '' $HWMON/temp1_{max_alarm,crit_alarm}\n  echo 0 > $HWMON/temp1_max; sleep 1; grep -H '' $HWMON/temp1_{input,max,max_alarm}\n  echo 327670 > $HWMON/temp1_max; sleep 1; grep -H '' $HWMON/temp1_{input,max,max_alarm}\n  echo 0 > $HWMON/temp1_crit; sleep 1; grep -H '' $HWMON/temp1_{input,crit,crit_alarm}\n  echo 327670 > $HWMON/temp1_crit; sleep 1; grep -H '' $HWMON/temp1_{input,crit,crit_alarm}\n\n  ipmitool sel list\n}\n\nroot@nkwz12-nfd:/run/initramfs# trigger_sensor_event\n/sys/class/hwmon/hwmon19\n/sys/class/hwmon/hwmon19/temp1_input:27370\n/sys/class/hwmon/hwmon19/temp1_max:327670\n/sys/class/hwmon/hwmon19/temp1_crit:327670\n/sys/class/hwmon/hwmon19/temp1_max_alarm:0\n/sys/class/hwmon/hwmon19/temp1_crit_alarm:0\n/sys/class/hwmon/hwmon19/temp1_input:27370\n/sys/class/hwmon/hwmon19/temp1_max:0\n/sys/class/hwmon/hwmon19/temp1_max_alarm:1\n/sys/class/hwmon/hwmon19/temp1_input:27370\n/sys/class/hwmon/hwmon19/temp1_max:327670\n/sys/class/hwmon/hwmon19/temp1_max_alarm:0\n/sys/class/hwmon/hwmon19/temp1_input:27370\n/sys/class/hwmon/hwmon19/temp1_crit:0\n/sys/class/hwmon/hwmon19/temp1_crit_alarm:1\n/sys/class/hwmon/hwmon19/temp1_input:27370\n/sys/class/hwmon/hwmon19/temp1_crit:327670\n/sys/class/hwmon/hwmon19/temp1_crit_alarm:0\n   1 |  Pre-Init  |0000038910| Temperature #0x52 | Upper Critical going high | Asserted\n   2 |  Pre-Init  |0000038912| Temperature #0x52 | Upper Non-critical going high | Asserted\n   3 |  Pre-Init  |0000038912| Temperature #0x52 | Upper Critical going high | Deasserted\n```\n\nChange-Id: Ic907153ddcc3cf0a42a4209bcfb5ee2ab75f0766\nSigned-off-by: Willy Tu <wltu@google.com>\n",
    "createdOn": 1628752122,
    "lastUpdated": 1631227518,
    "open": true,
    "status": "NEW",
    "comments": [
        {
            "timestamp": 1628752122,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Uploaded patch set 1."
        },
        {
            "timestamp": 1628752138,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1628752182,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 1: Verified-1\n\nBuild Failed \n\nhttps://jenkins.openbmc.org/job/ci-repository/24250/ : FAILURE"
        },
        {
            "timestamp": 1628864958,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Uploaded patch set 2."
        },
        {
            "timestamp": 1628864971,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1628864996,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Set Ready For Review"
        },
        {
            "timestamp": 1628865110,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 2: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/24338/ : SUCCESS"
        },
        {
            "timestamp": 1628865170,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Uploaded patch set 3."
        },
        {
            "timestamp": 1628865181,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1628865325,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 3: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/24339/ : SUCCESS"
        },
        {
            "timestamp": 1629170724,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 4: Patch Set 3 was rebased"
        },
        {
            "timestamp": 1629170745,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1629170971,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 4: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/24435/ : SUCCESS"
        },
        {
            "timestamp": 1629395011,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 4:\n\n(8 comments)\n\nI made it about halfway through.  Plenty of work left to do here still."
        },
        {
            "timestamp": 1629399798,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 4:\n\n(6 comments)"
        },
        {
            "timestamp": 1629409803,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Uploaded patch set 5."
        },
        {
            "timestamp": 1629409820,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Ok-To-Test+1\n\nUser approved, CI ok to start"
        },
        {
            "timestamp": 1629409957,
            "reviewer": {
                "name": "OpenBMC CI",
                "email": "openbmcbump-ci@yahoo.com",
                "username": "jenkins-openbmc-ci"
            },
            "message": "Patch Set 5: Verified+1\n\nBuild Successful \n\nhttps://jenkins.openbmc.org/job/ci-repository/24682/ : SUCCESS"
        },
        {
            "timestamp": 1629416428,
            "reviewer": {
                "name": "Josh Lehan",
                "email": "krellan@google.com",
                "username": "Krellan"
            },
            "message": "Patch Set 5:\n\n(2 comments)\n\nAlthough it makes a complex module even more complex, this is a great feature to add."
        },
        {
            "timestamp": 1629909825,
            "reviewer": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "message": "Patch Set 5:\n\n(3 comments)"
        },
        {
            "timestamp": 1631039728,
            "reviewer": {
                "name": "Ed Tanous",
                "email": "ed@tanous.net",
                "username": "edtanous"
            },
            "message": "Patch Set 5:\n\n(2 comments)\n\nComments still unaddressed."
        },
        {
            "timestamp": 1631227518,
            "reviewer": {
                "name": "Zhikui Ren",
                "email": "zhikui.ren@intel.com",
                "username": "ZhikuiRen"
            },
            "message": "Patch Set 5:\n\n(2 comments)"
        }
    ],
    "patchSets": [
        {
            "number": 1,
            "revision": "8e8f41a2a344ce563eb2a8029a4a29ebcbb92a71",
            "parents": [
                "5cf0f99210890d0cd52d5929e919316d238a5701"
            ],
            "ref": "refs/changes/44/45844/1",
            "uploader": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "createdOn": 1628752122,
            "author": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 10,
                    "deletions": 0
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 55,
                    "deletions": 0
                }
            ],
            "sizeInsertions": 55,
            "sizeDeletions": 0
        },
        {
            "number": 2,
            "revision": "dc9fa371d762a354648ba325fafa27a6e90227ac",
            "parents": [
                "5cf0f99210890d0cd52d5929e919316d238a5701"
            ],
            "ref": "refs/changes/44/45844/2",
            "uploader": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "createdOn": 1628864958,
            "author": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 52,
                    "deletions": 0
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -4
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 79,
                    "deletions": -15
                },
                {
                    "file": "src/PSUSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 52,
                    "deletions": -18
                }
            ],
            "sizeInsertions": 138,
            "sizeDeletions": 37
        },
        {
            "number": 3,
            "revision": "999e862f7f44d8086bc6d0477ccff6daa72486b3",
            "parents": [
                "5cf0f99210890d0cd52d5929e919316d238a5701"
            ],
            "ref": "refs/changes/44/45844/3",
            "uploader": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "createdOn": 1628865170,
            "author": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "kind": "REWORK",
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 52,
                    "deletions": 0
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -4
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 79,
                    "deletions": -13
                },
                {
                    "file": "src/PSUSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 36,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 122,
            "sizeDeletions": 33
        },
        {
            "number": 4,
            "revision": "f51047d880898369c26d9c5630b49d8eea37585f",
            "parents": [
                "f1ace50bbb781c0febd15387110d1a03b11391f9"
            ],
            "ref": "refs/changes/44/45844/4",
            "uploader": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "createdOn": 1629170724,
            "author": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "kind": "TRIVIAL_REBASE",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 10,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "A one sentence description is rarely enough detail for a commit message."
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "line": 34,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I'm having trouble following why this new path is needed, or what it's supposed to point to.  Maybe we need a better variable name?"
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "line": 34,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "it is the dbus path of the sensor itself.\n\nIt is used to create the SEL. It will be mark as the sender."
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "line": 34,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "is \"sensorPath\" better here?"
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "line": 85,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This worries me a little bit;  I suspect there's a better map data structure we can be using here, but without seeing the details of what the new parameter is, I'm having trouble rendering an option.  Could you take another look and see if this can be optimized?\n\nAt a minimum, the use of pair here seems like it obfuscates some variable names that would help make this simpler, but I suspect that the two paths are somehow parents/children of one another?"
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "line": 85,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "ok, I'll have to see what I can cleanup to optimize it.\n\nThis will contain two different paths.\n\nI believe the first path is the file path he the sensor itself and the other is the dbus/object path associate with it."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 278,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This whole method is effectively matching on \"Name\" which shouldn't be done as a rule.  We should be matching on severity."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 278,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "I guess that comes down to where we can get that severity information.\n\nThey are created from \n\n```\nlimitEventMatch = {{\"PredictiveFailure\", {\"max_alarm\", \"min_alarm\"}},\n                       {\"Failure\", {\"crit_alarm\", \"lcrit_alarm\"}}}\n```\n\nwhich get turn into the Name. I have to see where else contain that information."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 316,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "no error logging needed here?"
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 316,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "oh yeah, probably.\n\nI'll add some error here."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 316,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "Done"
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 319,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "This looks incorrect.  Please verify with phosphor-dbus-interfaces.  What you've put here looks like a well known name, when this method takes an interface name."
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 319,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "oh yeah. I used the service instead of the interface.\n\nIt should be one of these\n\nhttps://github.com/openbmc/phosphor-dbus-interfaces/tree/master/yaml/xyz/openbmc_project/Sensor/Threshold\n\nCritical/Warning"
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 322,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "I don't see a call to register_signal for this.  missing?"
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "line": 322,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "oh dang. I need `register_signal`?\n\nI was working without it. I wonder what happened there."
                },
                {
                    "file": "src/PSUSensorMain.cpp",
                    "line": 78,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "We should delcare this in one of the common headers.  This isn't specific to PSU sensor."
                },
                {
                    "file": "src/PSUSensorMain.cpp",
                    "line": 78,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "+1"
                },
                {
                    "file": "src/PSUSensorMain.cpp",
                    "line": 78,
                    "reviewer": {
                        "name": "Willy Tu",
                        "email": "wltu@google.com",
                        "username": "wltu"
                    },
                    "message": "Done"
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 52,
                    "deletions": 0
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -4
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 79,
                    "deletions": -13
                },
                {
                    "file": "src/PSUSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 36,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 122,
            "sizeDeletions": 33
        },
        {
            "number": 5,
            "revision": "96f36861e7541096e30e4fdf5860cbeb2d8e1ae6",
            "parents": [
                "f1ace50bbb781c0febd15387110d1a03b11391f9"
            ],
            "ref": "refs/changes/44/45844/5",
            "uploader": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "createdOn": 1629409803,
            "author": {
                "name": "Willy Tu",
                "email": "wltu@google.com",
                "username": "wltu"
            },
            "kind": "REWORK",
            "comments": [
                {
                    "file": "/COMMIT_MSG",
                    "line": 48,
                    "reviewer": {
                        "name": "Zhikui Ren",
                        "email": "zhikui.ren@intel.com",
                        "username": "ZhikuiRen"
                    },
                    "message": "Few questions:\n1. what are the corresponding sel-logger journal logs?\n2. what is the result if temp1_input > temp1_max and tem1_crit at the same time? \nFor real use cases temp1_crit > temp1_max, temp1 can be temp1_crit>temp1_input>temp1_max, temp1_input>temp1_crit>temp1_max or normal case temp1_crit?temp1_max>temp1_input\n3. what about other limits for fans, power etc."
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "line": 84,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "The type std::vector<std::pair<std::string, std::string>> seems to be often repeated throughout this patch. It's a lot of typing, too. Suggest making this a typedef or a trivial struct/class?"
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "line": 84,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "To that end, we're taking this already opaque structure, and making it more opaque by using std::pair.  I suspect we need a struct here to not only describe the data that's in the pair, but to also call out what each variable means.  Once that's done, I suspect the typedef wont be needed."
                },
                {
                    "file": "include/sensor.hpp",
                    "line": 14,
                    "reviewer": {
                        "name": "Josh Lehan",
                        "email": "krellan@google.com",
                        "username": "Krellan"
                    },
                    "message": "Does this need to be static? The other constants nearby are not static."
                },
                {
                    "file": "include/sensor.hpp",
                    "line": 14,
                    "reviewer": {
                        "name": "Ed Tanous",
                        "email": "ed@tanous.net",
                        "username": "edtanous"
                    },
                    "message": "We're not consistent on this, and in practice it doesn't change anything.  Up to willy if he wants to change it."
                }
            ],
            "files": [
                {
                    "file": "/COMMIT_MSG",
                    "type": "ADDED",
                    "insertions": 52,
                    "deletions": 0
                },
                {
                    "file": "include/PSUEvent.hpp",
                    "type": "MODIFIED",
                    "insertions": 7,
                    "deletions": -4
                },
                {
                    "file": "include/sensor.hpp",
                    "type": "MODIFIED",
                    "insertions": 2,
                    "deletions": 0
                },
                {
                    "file": "src/IpmbSensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 0,
                    "deletions": -2
                },
                {
                    "file": "src/PSUEvent.cpp",
                    "type": "MODIFIED",
                    "insertions": 81,
                    "deletions": -13
                },
                {
                    "file": "src/PSUSensor.cpp",
                    "type": "MODIFIED",
                    "insertions": 0,
                    "deletions": -2
                },
                {
                    "file": "src/PSUSensorMain.cpp",
                    "type": "MODIFIED",
                    "insertions": 34,
                    "deletions": -16
                }
            ],
            "sizeInsertions": 124,
            "sizeDeletions": 37
        }
    ]
}